<!doctype html>
<html lang="en" class="h-full scroll-smooth">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>SmartCore Technology â€” Practical Technology. Built to Last.</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

  <!-- Tailwind CDN (ok for now) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { sans: ["Inter","ui-sans-serif","system-ui","Segoe UI","Roboto","Arial"] },
          colors: {
            ink: "#070A12",
            line: "rgba(255,255,255,0.10)",
            line2:"rgba(255,255,255,0.20)",
            accent: "#6FA3FF",
          },
          borderRadius: { xl2: "16px" }
        }
      }
    }
  </script>

  <style>
    :root { color-scheme: dark; }
    html, body { height: 100%; overflow-x: hidden; }
    body{
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:
        radial-gradient(900px 520px at 50% 18%, rgba(66,120,255,.20), rgba(0,0,0,0) 65%),
        radial-gradient(800px 480px at 50% 110%, rgba(66,120,255,.10), rgba(0,0,0,0) 70%),
        linear-gradient(180deg, #070A12 0%, #070A12 100%);
    }
    .glass {
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.10);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }
    .reveal { opacity: 0; transform: translateY(10px); transition: opacity .65s ease, transform .65s ease; }
    .reveal.show { opacity: 1; transform: translateY(0); }

    /* hero bubbles */
    .bubbles-layer, .bubble, .bubble * { pointer-events: none !important; }
    .bubble {
      position: absolute;
      width: var(--s, 180px);
      height: var(--s, 180px);
      left: var(--x, 10%);
      top: var(--y, 10%);
      opacity: var(--o, .08);
      border-radius: 9999px;
      border: 1px solid rgba(255,255,255,0.08);
      background: rgba(255,255,255,0.022);
      backdrop-filter: blur(6px);
      -webkit-backdrop-filter: blur(6px);
      display: grid;
      place-items: center;
      z-index: 1;
    }
    .bubble svg { width: 40%; height: 40%; opacity: .9; }
    .hero-content { position: relative; z-index: 10; }

    /* nav hide when leaving hero */
    .navHidden { transform: translateY(-14px); opacity: 0; pointer-events: none; }
    .navShown { transform: translateY(0); opacity: 1; pointer-events: auto; }

    /* modals */
    .modal-backdrop {
      background: rgba(0,0,0,0.60);
      backdrop-filter: blur(6px);
      -webkit-backdrop-filter: blur(6px);
    }
  </style>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

<body class="min-h-screen text-white/90">

  <!-- TOP NAV -->
  <header id="topNav" class="fixed top-4 left-0 right-0 z-50 transition-all duration-300 navShown">
    <div class="mx-auto max-w-6xl px-4">
      <div class="glass rounded-xl border border-line px-3 sm:px-4 py-2 flex items-center justify-between">
        <div class="flex items-center gap-3">
          <div class="w-10 h-10 rounded-lg overflow-hidden bg-black/35 border border-line flex items-center justify-center">
            <img
              src="SmartCore%20Official%20Logos/SC%20Icon%20-%20Black%20Background.png"
              alt="SmartCore"
              class="w-[92%] h-[92%] object-contain translate-y-[-2px]"
            />
          </div>
          <div class="leading-tight">
            <div class="text-sm font-semibold text-white">SmartCore Technology</div>
            <div class="text-[11px] text-white/55">Practical Technology. Built to Last.</div>
          </div>
        </div>

        <div class="flex items-center gap-2">
          <button id="navDashboardBtn" class="hidden px-3 py-1.5 rounded-lg border border-line hover:bg-white/5 text-sm transition">
            Dashboard
          </button>
          <button id="navLoginBtn" class="px-3 py-1.5 rounded-lg border border-line hover:bg-white/5 text-sm transition">
            Log in
          </button>
          <button id="navLogoutBtn" class="hidden px-3 py-1.5 rounded-lg border border-line bg-white/5 hover:bg-white/8 text-sm transition">
            Log out
          </button>
        </div>
      </div>
    </div>
  </header>

  <!-- HOME VIEW -->
  <main id="viewHome">
    <!-- HERO -->
    <section id="home" class="relative min-h-[100svh] flex items-center">
      <div aria-hidden="true" class="bubbles-layer absolute inset-0 overflow-hidden">
        <!-- 8 scattered bubbles/icons -->
        <div class="bubble hidden md:grid" style="--x: 8%; --y: 16%; --s: 220px; --o:.07">
          <svg viewBox="0 0 24 24" fill="none" stroke="rgba(255,255,255,0.65)" stroke-width="1.8" stroke-linecap="round">
            <path d="M12 5v14M5 12h14"/>
          </svg>
        </div>
        <div class="bubble hidden md:grid" style="--x: 28%; --y: 64%; --s: 240px; --o:.07">
          <svg viewBox="0 0 24 24" fill="none" stroke="rgba(255,255,255,0.65)" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
            <rect x="5" y="4.5" width="14" height="15" rx="2.5"/>
            <path d="M8 9l1.3 1.3L12 7.6"/>
            <path d="M8 14h8"/>
          </svg>
        </div>
        <div class="bubble hidden md:grid" style="--x: 78%; --y: 14%; --s: 210px; --o:.06">
          <svg viewBox="0 0 24 24" fill="none" stroke="rgba(255,255,255,0.65)" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
            <rect x="3" y="6.5" width="18" height="12" rx="2.5"/>
            <path d="M7 10h10M7 14h6"/>
          </svg>
        </div>
        <div class="bubble hidden md:grid" style="--x: 70%; --y: 60%; --s: 230px; --o:.06">
          <svg viewBox="0 0 24 24" fill="none" stroke="rgba(255,255,255,0.65)" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
            <path d="M12 2.8l7 4v7.2l-7 4-7-4V6.8l7-4z"/>
            <path d="M12 8v8"/>
          </svg>
        </div>
        <div class="bubble hidden md:grid" style="--x: 18%; --y: 36%; --s: 200px; --o:.055">
          <svg viewBox="0 0 24 24" fill="none" stroke="rgba(255,255,255,0.65)" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
            <path d="M12 21s8-4.5 8-10V7l-8-4-8 4v4c0 5.5 8 10 8 10z"/>
            <path d="M9.5 12l1.6 1.6L14.8 10"/>
          </svg>
        </div>
        <div class="bubble hidden md:grid" style="--x: 46%; --y: 12%; --s: 190px; --o:.05">
          <svg viewBox="0 0 24 24" fill="none" stroke="rgba(255,255,255,0.65)" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
            <path d="M4 7h16M7 4v6M17 4v6"/>
            <path d="M6 13h6M6 17h10"/>
          </svg>
        </div>
        <div class="bubble hidden md:grid" style="--x: 86%; --y: 36%; --s: 200px; --o:.05">
          <svg viewBox="0 0 24 24" fill="none" stroke="rgba(255,255,255,0.65)" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
            <path d="M10 20h4"/>
            <path d="M12 4a6 6 0 0 0-3.6 10.8c.3.2.6.6.7 1l.3 1.2h5.2l.3-1.2c.1-.4.4-.8.7-1A6 6 0 0 0 12 4z"/>
          </svg>
        </div>
        <div class="bubble hidden md:grid" style="--x: 52%; --y: 72%; --s: 220px; --o:.06">
          <svg viewBox="0 0 24 24" fill="none" stroke="rgba(255,255,255,0.65)" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
            <path d="M4 12h16"/>
            <path d="M12 4v16"/>
          </svg>
        </div>

        <!-- mobile: just 2 bubbles so text never clashes -->
        <div class="bubble md:hidden" style="--x: 10%; --y: 12%; --s: 160px; --o:.06">
          <svg viewBox="0 0 24 24" fill="none" stroke="rgba(255,255,255,0.65)" stroke-width="1.8" stroke-linecap="round">
            <path d="M12 5v14M5 12h14"/>
          </svg>
        </div>
        <div class="bubble md:hidden" style="--x: 76%; --y: 78%; --s: 160px; --o:.05">
          <svg viewBox="0 0 24 24" fill="none" stroke="rgba(255,255,255,0.65)" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
            <rect x="6" y="11" width="12" height="10" rx="2.5"/>
            <path d="M8 11V8.5A4 4 0 0 1 12 4.5a4 4 0 0 1 4 4V11"/>
          </svg>
        </div>
      </div>

      <!-- sentinel used for hiding nav when scrolling past hero -->
      <div id="heroSentinel" class="absolute bottom-0 left-0 right-0 h-2"></div>

      <div class="mx-auto max-w-6xl px-4 w-full">
        <div class="hero-content pt-28 pb-16 md:pt-32 md:pb-24">
          <div class="max-w-3xl">
            <div class="inline-flex items-center gap-2 px-3 py-1 rounded-full border border-line bg-white/5 text-xs text-white/70 reveal">
              <span class="inline-block w-1.5 h-1.5 rounded-full bg-accent"></span>
              Calm systems for real workplaces
            </div>

            <h1 class="mt-5 font-extrabold tracking-tight text-white reveal
                       text-5xl sm:text-6xl md:text-7xl lg:text-[88px] leading-[0.95]">
              SmartCore<br><span class="text-white/70">Technology</span>
            </h1>

            <p class="mt-6 text-white/70 max-w-xl reveal text-base sm:text-lg md:text-xl">
              Practical, reliable systems that businesses can depend on every day.
            </p>

            <div class="mt-8 flex flex-wrap items-center gap-3 reveal">
              <button id="goBuildPlanBtn"
                class="px-4 py-2.5 rounded-xl border border-line bg-white/5 hover:bg-white/8 transition text-sm font-medium">
                Build your plan â†’
              </button>

              <button id="goEmployeeSignupBtn"
                class="px-4 py-2.5 rounded-xl border border-line bg-transparent hover:bg-white/5 transition text-sm font-medium">
                Sign up as an employee
              </button>
            </div>

            <div class="mt-8 reveal">
              <button id="downArrowBtn"
                class="inline-flex items-center gap-2 px-4 py-2.5 rounded-xl border border-line bg-transparent hover:bg-white/5 transition text-sm">
                Scroll down
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="rgba(255,255,255,0.75)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M6 9l6 6 6-6"></path>
                </svg>
              </button>
            </div>

          </div>
        </div>
      </div>
    </section>

    <!-- BUILD PLAN -->
    <section id="pricing" class="relative">
      <div class="mx-auto max-w-6xl px-4 pb-20">
        <div class="pt-24 md:pt-28">
          <div class="flex items-end justify-between gap-6">
            <div class="max-w-xl reveal">
              <h2 class="text-xl font-semibold text-white">Build your plan</h2>
              <p class="mt-2 text-sm text-white/60">Select company size, then modules. Checkout will verify your email.</p>
            </div>
            <div class="hidden sm:block text-xs text-white/50 reveal">Monthly subscription (GBP)</div>
          </div>

          <div class="mt-6 glass rounded-xl2 p-4 md:p-5 reveal">
            <div class="flex items-center justify-between">
              <div class="text-sm font-medium text-white/85">Select your company size</div>
              <div id="sizeHint" class="text-xs text-white/45">Select one</div>
            </div>
            <div id="companySizeGrid" class="mt-4 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3"></div>
          </div>

          <div id="modulesWrap" class="mt-6 glass rounded-xl2 p-4 md:p-5 hidden">
            <div class="flex items-center justify-between">
              <div class="text-sm font-medium text-white/85">Select your modules</div>
              <div class="text-xs text-white/45">Select any</div>
            </div>
            <div id="modulesGrid" class="mt-4 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3"></div>
          </div>

          <!-- Summary bar hidden until company size selected -->
          <div id="summaryBar" class="fixed left-0 right-0 bottom-4 z-40 hidden">
            <div class="mx-auto max-w-6xl px-4">
              <div class="glass rounded-xl2 border border-line px-4 py-3 flex items-center justify-between gap-4">
                <div class="min-w-0">
                  <div class="text-xs text-white/55">Monthly total</div>
                  <div class="text-base font-semibold text-white" id="totalText">Â£0 / month</div>
                  <div class="text-[11px] text-white/45 truncate" id="totalSub">Select a company size to begin</div>
                </div>
                <div class="flex items-center gap-2">
                  <button id="clearBtn" class="px-3 py-2 rounded-xl border border-line bg-transparent hover:bg-white/5 transition text-sm">
                    Clear
                  </button>
                  <button id="checkoutBtn" class="px-4 py-2 rounded-xl border border-line bg-white/5 hover:bg-white/8 transition text-sm font-medium">
                    Checkout â†’
                  </button>
                </div>
              </div>
            </div>
          </div>

        </div>
      </div>
    </section>

    <!-- ABOUT -->
    <section id="about" class="relative">
      <div class="mx-auto max-w-6xl px-4 pb-16">
        <div class="glass rounded-xl2 p-5 md:p-6 reveal">
          <h3 class="text-lg font-semibold text-white">About SmartCore Technology</h3>

          <div class="mt-4 space-y-4 text-sm text-white/65 leading-relaxed">
            <p>
              SmartCore Technology was built by Finley Hassall, a young founder with a long-standing passion for technology and a strong business mindset. Interested in IT from the age of six, Finley always knew he wanted to build a career creating systems that solve real-world problems.
            </p>
            <p>
              Rather than focusing on trends or hype, SmartCore Technology was created with a clear goal: to build practical, reliable systems that businesses can depend on every day.
            </p>
            <p>
              The company was developed with guidance and support from Finleyâ€™s mother, a business owner herself, but every system within SmartCore has been hand-crafted from the ground up by Finley. Each feature, workflow, and decision has been designed with real workplaces in mind â€” prioritising clarity, usability, and long-term reliability over unnecessary complexity.
            </p>
            <p>
              SmartCore Technology is not about flashy software. Itâ€™s about building tools that work properly, scale sensibly, and quietly do their job in the background.
            </p>

            <div class="pt-2">
              <div class="text-white/85 font-medium">The SmartCore Technology Approach</div>
              <p class="mt-2">SmartCore Technology is built on a simple philosophy: technology should make work easier, not more complicated.</p>
              <ul class="mt-3 list-disc pl-5 space-y-1">
                <li>solve a specific, real business problem</li>
                <li>be easy to understand and use</li>
                <li>create clear, auditable records</li>
                <li>scale as organisations grow</li>
                <li>remain reliable over time</li>
              </ul>
              <p class="mt-3">
                Instead of offering one large, bloated platform, SmartCore provides modular systems that companies can choose and combine based on their actual needs. This keeps costs fair, reduces complexity, and allows businesses to stay in control of how they operate.
              </p>
              <p class="mt-3">
                SmartCore Technology focuses on the areas that matter most â€” people, safety, and operational clarity â€” delivering tools that support organisations without getting in the way.
              </p>
            </div>
          </div>

          <div class="mt-5 text-sm text-white/60">
            Support: <a class="text-accent hover:underline" href="mailto:support@smartcoretechnology.co.uk">support@smartcoretechnology.co.uk</a>
          </div>
        </div>

        <footer class="mt-6 glass rounded-xl2 p-4 flex items-center justify-between text-xs text-white/55 reveal">
          <div>
            <div class="text-white/80 font-semibold">SmartCore Technology</div>
            <div>Practical Technology. Built to Last.</div>
          </div>
          <div>
            <a class="text-accent hover:underline" href="mailto:support@smartcoretechnology.co.uk">support@smartcoretechnology.co.uk</a>
          </div>
        </footer>
      </div>
    </section>
  </main>

  <!-- DASHBOARD VIEW -->
  <main id="viewDashboard" class="hidden">
    <section class="pt-28 pb-16">
      <div class="mx-auto max-w-6xl px-4">
        <div class="glass rounded-xl2 p-5 md:p-6">
          <div class="flex items-start justify-between gap-4">
            <div>
              <h2 class="text-xl font-semibold text-white">Dashboard</h2>
              <p class="mt-1 text-sm text-white/60">Company details, owned systems, onboarding, and employee setup.</p>
            </div>
            <div class="text-right text-xs text-white/55">
              <div id="dashCompanyCode" class="font-semibold text-white/80"></div>
              <div id="dashUserEmail"></div>
            </div>
          </div>

          <!-- Company onboarding -->
          <div class="mt-6 grid grid-cols-1 lg:grid-cols-2 gap-4">
            <div class="glass rounded-xl2 p-4 border border-line">
              <div class="text-sm font-semibold text-white/85">Company onboarding</div>
              <p class="mt-1 text-xs text-white/55">Upload a logo, confirm full name and address.</p>

              <div class="mt-4 grid grid-cols-1 gap-3">
                <label class="block">
                  <div class="text-xs text-white/55 mb-1">Company logo (PNG preferred)</div>
                  <input id="companyLogo" type="file" accept="image/*"
                    class="w-full text-xs file:mr-3 file:py-2 file:px-3 file:rounded-xl file:border file:border-line file:bg-white/5 file:text-white/80 file:hover:bg-white/10" />
                </label>

                <label class="block">
                  <div class="text-xs text-white/55 mb-1">Full company name</div>
                  <input id="companyName" class="w-full px-3 py-2 rounded-xl bg-white/5 border border-line focus:outline-none focus:ring-2 focus:ring-accent/40" />
                </label>

                <label class="block">
                  <div class="text-xs text-white/55 mb-1">Address</div>
                  <textarea id="companyAddress" rows="3"
                    class="w-full px-3 py-2 rounded-xl bg-white/5 border border-line focus:outline-none focus:ring-2 focus:ring-accent/40"></textarea>
                </label>

                <div class="flex items-center gap-2">
                  <button id="saveCompanyBtn" class="px-4 py-2.5 rounded-xl border border-line bg-white/5 hover:bg-white/8 transition text-sm font-medium">
                    Save company
                  </button>
                  <div id="companySaveMsg" class="text-sm text-white/65"></div>
                </div>
              </div>
            </div>

            <!-- Owned modules / Buy more -->
            <div class="glass rounded-xl2 p-4 border border-line">
              <div class="text-sm font-semibold text-white/85">Your systems</div>
              <p class="mt-1 text-xs text-white/55">Links only show for systems your company owns (temporary links for now).</p>

              <div class="mt-4">
                <div class="text-xs text-white/55 mb-2">Owned</div>
                <div id="ownedLinks" class="grid grid-cols-1 sm:grid-cols-2 gap-2"></div>

                <div class="mt-5 pt-4 border-t border-line">
                  <div class="text-xs text-white/55 mb-2">Buy more systems (testing = free)</div>
                  <div id="buyMoreGrid" class="grid grid-cols-1 sm:grid-cols-2 gap-2"></div>
                  <button id="saveModulesBtn" class="mt-3 w-full px-4 py-2.5 rounded-xl border border-line bg-white/5 hover:bg-white/8 transition text-sm font-medium">
                    Continue (free testing) â†’
                  </button>
                  <div id="modulesSaveMsg" class="mt-2 text-sm text-white/65"></div>
                </div>
              </div>
            </div>
          </div>

          <!-- Employees -->
          <div class="mt-6 glass rounded-xl2 p-4 border border-line">
            <div class="flex items-start justify-between gap-4">
              <div>
                <div class="text-sm font-semibold text-white/85">Employees</div>
                <p class="mt-1 text-xs text-white/55">Add employees and generate unique employee IDs automatically.</p>
              </div>
              <div class="text-right text-xs text-white/55">
                <div class="font-semibold text-white/80">Company ID</div>
                <div id="dashCompanyId"></div>
              </div>
            </div>

            <div class="mt-4 grid grid-cols-1 md:grid-cols-3 gap-3">
              <label class="block">
                <div class="text-xs text-white/55 mb-1">Full name</div>
                <input id="empName" class="w-full px-3 py-2 rounded-xl bg-white/5 border border-line focus:outline-none focus:ring-2 focus:ring-accent/40" placeholder="Finley Hassall" />
              </label>
              <label class="block">
                <div class="text-xs text-white/55 mb-1">Job title</div>
                <input id="empTitle" class="w-full px-3 py-2 rounded-xl bg-white/5 border border-line focus:outline-none focus:ring-2 focus:ring-accent/40" placeholder="Founder" />
              </label>
              <label class="block">
                <div class="text-xs text-white/55 mb-1">Job category</div>
                <input id="empCategory" class="w-full px-3 py-2 rounded-xl bg-white/5 border border-line focus:outline-none focus:ring-2 focus:ring-accent/40" placeholder="Senior management team" />
              </label>
            </div>

            <div class="mt-3 flex items-center gap-2">
              <button id="addEmployeeBtn" class="px-4 py-2.5 rounded-xl border border-line bg-white/5 hover:bg-white/8 transition text-sm font-medium">
                Add employee
              </button>
              <div id="empMsg" class="text-sm text-white/65"></div>
            </div>

            <div class="mt-4 overflow-x-auto">
              <table class="w-full text-sm">
                <thead class="text-white/55">
                  <tr class="border-b border-line">
                    <th class="text-left py-2 pr-3 font-medium">Employee ID</th>
                    <th class="text-left py-2 pr-3 font-medium">Name</th>
                    <th class="text-left py-2 pr-3 font-medium">Title</th>
                    <th class="text-left py-2 pr-3 font-medium">Category</th>
                  </tr>
                </thead>
                <tbody id="empTable" class="text-white/80"></tbody>
              </table>
            </div>
          </div>

        </div>
      </div>
    </section>
  </main>

  <!-- MODAL: MODULE DETAILS -->
  <div id="moduleModal" class="fixed inset-0 z-[60] hidden">
    <div class="absolute inset-0 modal-backdrop"></div>
    <div class="absolute inset-0 overflow-y-auto p-4" style="-webkit-overflow-scrolling: touch;">
      <div class="min-h-full flex items-center justify-center">
        <div class="w-full max-w-4xl glass rounded-xl2 border border-line overflow-hidden">
          <div class="px-5 py-4 border-b border-line flex items-center justify-between">
            <div>
              <div id="modalTitle" class="text-sm font-semibold text-white/90">Module</div>
              <div id="modalPrice" class="text-xs text-white/55 mt-0.5">Â£0 / month</div>
            </div>
            <button id="closeModuleModalBtn" class="px-3 py-2 rounded-xl border border-line hover:bg-white/5 transition text-sm">Close</button>
          </div>

          <div class="p-5 grid grid-cols-1 lg:grid-cols-2 gap-4">
            <div class="glass rounded-xl2 p-4 border border-line">
              <div class="text-sm font-medium text-white/85">Preview</div>
              <div class="mt-3 aspect-video rounded-xl overflow-hidden border border-line bg-black/30">
                <iframe id="modalVideo" class="w-full h-full" src="" title="Module preview"
                  frameborder="0"
                  allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
                  allowfullscreen></iframe>
              </div>
              <div class="mt-3 text-xs text-white/50">Use fullscreen in the player controls.</div>
            </div>

            <div class="glass rounded-xl2 p-4 border border-line">
              <div class="text-sm font-medium text-white/85">Overview</div>
              <p id="modalSummary" class="mt-3 text-sm text-white/70 leading-relaxed whitespace-pre-line"></p>

              <div class="mt-4 text-sm font-medium text-white/85">Key features</div>
              <ul id="modalFeatures" class="mt-3 space-y-2 text-sm text-white/65 list-disc pl-5"></ul>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- MODAL: OWNER SIGNUP (2-step: details -> code) -->
  <div id="signupModal" class="fixed inset-0 z-[60] hidden">
    <div class="absolute inset-0 modal-backdrop"></div>
    <div class="absolute inset-0 overflow-y-auto p-4" style="-webkit-overflow-scrolling: touch;">
      <div class="min-h-full flex items-center justify-center">
        <div class="w-full max-w-lg glass rounded-xl2 border border-line overflow-hidden">
          <div class="px-5 py-4 border-b border-line flex items-center justify-between">
            <div class="text-sm font-semibold text-white/90">Create account</div>
            <button id="closeSignupBtn" class="px-3 py-2 rounded-xl border border-line hover:bg-white/5 transition text-sm">Close</button>
          </div>

          <div class="p-5 space-y-3">
            <label class="block">
              <div class="text-xs text-white/55 mb-1">Company name</div>
              <input id="suCompanyName" class="w-full px-3 py-2 rounded-xl bg-white/5 border border-line focus:outline-none focus:ring-2 focus:ring-accent/40" />
            </label>

            <label class="block">
              <div class="text-xs text-white/55 mb-1">Email</div>
              <input id="suEmail" type="email" class="w-full px-3 py-2 rounded-xl bg-white/5 border border-line focus:outline-none focus:ring-2 focus:ring-accent/40" />
            </label>

            <label class="block">
              <div class="text-xs text-white/55 mb-1">Password</div>
              <div class="relative">
                <input id="suPassword" type="password" class="w-full pr-12 px-3 py-2 rounded-xl bg-white/5 border border-line focus:outline-none focus:ring-2 focus:ring-accent/40" />
                <button id="suTogglePw" type="button" class="absolute right-2 top-1/2 -translate-y-1/2 w-9 h-9 rounded-lg border border-line bg-white/5 hover:bg-white/10 grid place-items-center">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="rgba(255,255,255,0.75)" stroke-width="2">
                    <path d="M2 12s3.5-7 10-7 10 7 10 7-3.5 7-10 7-10-7-10-7z"/>
                    <circle cx="12" cy="12" r="3"/>
                  </svg>
                </button>
              </div>
              <div class="mt-1 text-[11px] text-white/45">Min 8 characters.</div>
            </label>

            <label id="codeWrap" class="block hidden">
              <div class="text-xs text-white/55 mb-1">6-digit code</div>
              <input id="suCode" inputmode="numeric" maxlength="6"
                class="w-full px-3 py-2 rounded-xl bg-white/5 border border-line focus:outline-none focus:ring-2 focus:ring-accent/40"
                placeholder="123456" />
              <div class="mt-1 text-[11px] text-white/45">We sent a code to your email.</div>
            </label>

            <!-- Step controls -->
            <div id="signupStep1" class="grid grid-cols-1 gap-2">
              <button id="continueBtn"
                class="px-4 py-2.5 rounded-xl border border-line bg-white/5 hover:bg-white/8 transition text-sm font-medium">
                Continue â†’
              </button>
              <div class="text-[11px] text-white/45">Testing mode: checkout is free for now.</div>
            </div>

            <div id="signupStep2" class="grid grid-cols-1 sm:grid-cols-2 gap-2 hidden">
              <button id="backToDetailsBtn"
                class="px-4 py-2.5 rounded-xl border border-line bg-transparent hover:bg-white/5 transition text-sm font-medium">
                Back
              </button>
              <button id="verifyBtn"
                class="px-4 py-2.5 rounded-xl border border-line bg-white/5 hover:bg-white/8 transition text-sm font-medium">
                Verify + create â†’
              </button>
            </div>

            <div id="suMsg" class="text-sm text-white/70"></div>

            <div class="pt-3 border-t border-line">
              <button id="openLoginBtn" class="w-full px-4 py-2.5 rounded-xl border border-line bg-transparent hover:bg-white/5 transition text-sm font-medium">
                Log in instead
              </button>
            </div>
          </div>

        </div>
      </div>
    </div>
  </div>

  <!-- MODAL: LOGIN -->
  <div id="loginModal" class="fixed inset-0 z-[60] hidden">
    <div class="absolute inset-0 modal-backdrop"></div>
    <div class="absolute inset-0 overflow-y-auto p-4" style="-webkit-overflow-scrolling: touch;">
      <div class="min-h-full flex items-center justify-center">
        <div class="w-full max-w-lg glass rounded-xl2 border border-line overflow-hidden">
          <div class="px-5 py-4 border-b border-line flex items-center justify-between">
            <div class="text-sm font-semibold text-white/90">Log in</div>
            <button id="closeLoginBtn" class="px-3 py-2 rounded-xl border border-line hover:bg-white/5 transition text-sm">Close</button>
          </div>

          <div class="p-5 space-y-3">
            <label class="block">
              <div class="text-xs text-white/55 mb-1">Email</div>
              <input id="liEmail" type="email" class="w-full px-3 py-2 rounded-xl bg-white/5 border border-line focus:outline-none focus:ring-2 focus:ring-accent/40" />
            </label>

            <label class="block">
              <div class="text-xs text-white/55 mb-1">Password</div>
              <div class="relative">
                <input id="liPassword" type="password" class="w-full pr-12 px-3 py-2 rounded-xl bg-white/5 border border-line focus:outline-none focus:ring-2 focus:ring-accent/40" />
                <button id="liTogglePw" type="button" class="absolute right-2 top-1/2 -translate-y-1/2 w-9 h-9 rounded-lg border border-line bg-white/5 hover:bg-white/10 grid place-items-center">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="rgba(255,255,255,0.75)" stroke-width="2">
                    <path d="M2 12s3.5-7 10-7 10 7 10 7-3.5 7-10 7-10-7-10-7z"/>
                    <circle cx="12" cy="12" r="3"/>
                  </svg>
                </button>
              </div>
            </label>

            <button id="loginBtn" class="w-full px-4 py-2.5 rounded-xl border border-line bg-white/5 hover:bg-white/8 transition text-sm font-medium">
              Log in
            </button>

            <div id="liMsg" class="text-sm text-white/70"></div>
          </div>

        </div>
      </div>
    </div>
  </div>

  <!-- MODAL: EMPLOYEE SIGNUP (placeholder for later) -->
  <div id="employeeModal" class="fixed inset-0 z-[60] hidden">
    <div class="absolute inset-0 modal-backdrop"></div>
    <div class="absolute inset-0 overflow-y-auto p-4" style="-webkit-overflow-scrolling: touch;">
      <div class="min-h-full flex items-center justify-center">
        <div class="w-full max-w-lg glass rounded-xl2 border border-line overflow-hidden">
          <div class="px-5 py-4 border-b border-line flex items-center justify-between">
            <div class="text-sm font-semibold text-white/90">Employee sign up</div>
            <button id="closeEmployeeBtn" class="px-3 py-2 rounded-xl border border-line hover:bg-white/5 transition text-sm">Close</button>
          </div>

          <div class="p-5 space-y-3">
            <div class="text-sm text-white/70">
              Employee signup will be enabled after the owner onboarding flow is finalised.
            </div>
            <button id="closeEmployeeBtn2" class="w-full px-4 py-2.5 rounded-xl border border-line bg-white/5 hover:bg-white/8 transition text-sm font-medium">
              Close
            </button>
          </div>

        </div>
      </div>
    </div>
  </div>

  <script>
    // ====== CONFIG ======
    // Your project values:
    const SUPABASE_URL = "https://hjdpcfhozhoyeqevnupm.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhqZHBjZmhvemhveWVxZXZudXBtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY5MTk3MzYsImV4cCI6MjA4MjQ5NTczNn0.BXosJO4NmEZOe73GXSGPa3z-i_4ZzF9zBAMBIf6Mkts";
    const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // ====== DATA ======
    const COMPANY_SIZES = [
      { id: "up_to_25", label: "Up to 25 people", price_gbp: 39, note: "Â£39 / month" },
      { id: "26_100", label: "26â€“100 people", price_gbp: 79, note: "Â£79 / month" },
      { id: "101_250", label: "101â€“250 people", price_gbp: 149, note: "Â£149 / month" },
      { id: "250_plus", label: "250+ people", price_gbp: 0, note: "Contact us" }
    ];

    const YT_EMBED = "https://www.youtube.com/embed/S2kymv60ndQ?rel=0&modestbranding=1";

    const MODULES = [
      { id: "presence_fire", name: "Presence & Fire Safety", price_gbp: 10,
        summary: "A real-time presence system that shows exactly who is on site at any moment. Staff and visitors sign in and out digitally, creating a live evacuation list that can be used immediately during fire drills or real emergencies.\n\nDesigned to be simple, fast, and reliable when it matters most, with clear records for audits and incident reviews.",
        features: ["Live on-site list for staff and visitors","Instant evacuation roll call view","Audit-ready sign in/out history","Visitor sign-in with basic details","Fast kiosk-friendly workflows","Exportable logs for reviews"]
      },
      { id: "policies_handbook", name: "Policies & Staff Handbook", price_gbp: 7,
        summary: "A central location for company policies and staff handbooks, with tracking to show who has read and acknowledged each document. Managers can update policies, request re-acknowledgement, and view clear records at any time.\n\nHelps organisations demonstrate that information has been issued and acknowledged without relying on paper or email chains.",
        features: ["Central policy library","Read & acknowledgement tracking","Re-acknowledgement requests","Clear, exportable records","Version history support","Simple manager overview"]
      },
      { id: "holiday_booking", name: "Holiday Booking", price_gbp: 8,
        summary: "A straightforward holiday request and approval system that removes unnecessary back-and-forth. Staff submit requests, managers approve or decline, and teams can view upcoming absences in one place.\n\nIntentionally simple and focused, with no payroll or salary management.",
        features: ["Request + approve/decline flow","Team absence visibility","Simple calendar overview","Notes and audit trail","Approver controls","Exportable reports"]
      },
      { id: "accident_injury", name: "Accident & Injury Book", price_gbp: 3,
        summary: "A digital accident and injury reporting system that replaces paper accident books. Incidents can be logged quickly with notes, photos, and witness details, and records can be exported when required.\n\nKeeps incident records organised, secure, and easy to access if they are ever needed.",
        features: ["Fast incident logging","Photo attachments","Witness details capture","Exportable incident reports","Secure record storage","Clear audit trail"]
      },
      { id: "training_compliance", name: "Training & Compliance", price_gbp: 9,
        summary: "Tracks training expiry dates, compliance requirements, and scheduled checks across the organisation. Automatic reminders help ensure nothing is missed, from fire drills to equipment inspections and vehicle compliance.\n\nDesigned to support consistency and oversight without adding unnecessary complexity.",
        features: ["Expiry date tracking","Scheduled checks overview","Automatic reminders","Compliance status visibility","Exportable records","Simple admin controls"]
      },
      { id: "onboarding_offboarding", name: "Onboarding & Offboarding", price_gbp: 8,
        summary: "Structured checklists for new starters and leavers, helping teams complete tasks consistently across departments. From access setup to equipment returns, nothing is forgotten.\n\nProvides a clear record of what was completed and when, supporting smoother staff transitions.",
        features: ["Structured checklists","Department task ownership","Completion timestamps","Leaver equipment return tracking","Access/permissions checklist","Exportable records"]
      },
      { id: "expenses_upload", name: "Expenses Upload", price_gbp: 6,
        summary: "Allows staff to upload receipts digitally with notes and categories, removing the need to collect paper receipts. Submissions can be reviewed and exported for accounting or payroll systems.\n\nKeeps expense handling simple, organised, and traceable.",
        features: ["Receipt upload","Notes and categories","Review queue","Export for accounting","Traceable submissions","Simple audit trail"]
      },
      { id: "wellbeing_check", name: "Wellbeing Check", price_gbp: 4,
        summary: "A lightweight wellbeing check-in that allows staff to quickly select one of three options:\n\nðŸ™‚ Positive (green)\nðŸ˜ Neutral (amber)\nðŸ™ Concerned (red)\n\nOver time, this provides managers with a simple, high-level view of wellbeing trends across teams.\n\nNo medical data, no intrusive questions â€” just a clear, visual pulse check designed to support awareness while respecting privacy.",
        features: ["3-option quick check-in","Simple trend overview","Non-intrusive design","Team-level visibility","Privacy-respecting approach","Exportable summaries"]
      }
    ];

    // ====== HELPERS ======
    const $ = (id) => document.getElementById(id);
    const gbp = (n) => "Â£" + Number(n || 0).toFixed(0);

    function show(el){ el.classList.remove("hidden"); }
    function hide(el){ el.classList.add("hidden"); }

    function openModal(id){
      show($(id));
      // prevent background scroll while modal open
      document.documentElement.style.overflow = "hidden";
      document.body.style.overflow = "hidden";
    }
    function closeModal(id){
      hide($(id));
      // restore scroll if no modals are open
      const anyOpen = ["moduleModal","signupModal","loginModal","employeeModal"].some(mid => !$(mid).classList.contains("hidden"));
      if (!anyOpen){
        document.documentElement.style.overflow = "";
        document.body.style.overflow = "";
      }
    }

    function togglePw(inputId){
      const el = $(inputId);
      el.type = el.type === "password" ? "text" : "password";
    }

    // ====== NAV hide when leaving hero ======
    function initNavHide(){
      const nav = $("topNav");
      const sentinel = $("heroSentinel");
      const io = new IntersectionObserver((entries) => {
        const e = entries[0];
        if (e.isIntersecting) {
          nav.classList.remove("navHidden"); nav.classList.add("navShown");
        } else {
          nav.classList.add("navHidden"); nav.classList.remove("navShown");
        }
      }, { threshold: 0.01 });
      io.observe(sentinel);

      window.addEventListener("scroll", () => {
        if (window.scrollY < 40) { nav.classList.remove("navHidden"); nav.classList.add("navShown"); }
      }, { passive: true });
    }

    function initReveal(){
      const els = document.querySelectorAll(".reveal");
      const io = new IntersectionObserver((entries) => {
        entries.forEach(e => {
          if (e.isIntersecting){
            e.target.classList.add("show");
            io.unobserve(e.target);
          }
        });
      }, { threshold: 0.12 });
      els.forEach(el => io.observe(el));
    }

    // ====== PLAN STATE ======
    const plan = { companySize: null, modules: new Set() };

    function calcTotal(){
      const size = plan.companySize?.price_gbp ?? 0;
      let mods = 0;
      for (const id of plan.modules){
        const m = MODULES.find(x => x.id === id);
        mods += m ? m.price_gbp : 0;
      }
      return size + mods;
    }

    function updateSummary(){
      if (!plan.companySize){
        $("totalText").textContent = "Â£0 / month";
        $("totalSub").textContent = "Select a company size to begin";
        $("checkoutBtn").disabled = true;
        $("checkoutBtn").classList.add("opacity-50","pointer-events-none");
        return;
      }
      const total = calcTotal();
      $("totalText").textContent = `${gbp(total)} / month`;
      $("totalSub").textContent = `${plan.companySize.label} â€¢ ${plan.modules.size} module(s) selected`;
      $("checkoutBtn").disabled = false;
      $("checkoutBtn").classList.remove("opacity-50","pointer-events-none");
    }

    function renderCompanySizes(){
      const grid = $("companySizeGrid");
      grid.innerHTML = "";
      COMPANY_SIZES.forEach((s) => {
        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "text-left rounded-xl border border-line bg-white/5 hover:bg-white/7 transition p-4 flex items-center justify-between gap-3";
        btn.innerHTML = `
          <div class="min-w-0">
            <div class="text-sm font-semibold text-white/85">${s.label}</div>
            <div class="mt-1 text-xs text-white/55">${s.note}</div>
          </div>
          <div class="w-9 h-9 rounded-full border border-line bg-white/5 grid place-items-center text-xs text-white/70">
            <span>âœ“</span>
          </div>
        `;
        btn.addEventListener("click", () => {
          plan.companySize = s;
          $("modulesWrap").classList.remove("hidden");
          $("summaryBar").classList.remove("hidden");
          $("sizeHint").textContent = s.label;

          [...grid.children].forEach((c) => {
            c.classList.remove("bg-white/10");
            c.style.borderColor = "rgba(255,255,255,0.10)";
          });
          btn.classList.add("bg-white/10");
          btn.style.borderColor = "rgba(111,163,255,0.45)";

          renderModules();
          updateSummary();
        });
        grid.appendChild(btn);
      });
    }

    function renderModules(){
      const grid = $("modulesGrid");
      grid.innerHTML = "";

      MODULES.forEach((m) => {
        const selected = plan.modules.has(m.id);

        const card = document.createElement("div");
        card.className = "rounded-xl border border-line bg-white/5 p-4 flex flex-col gap-3 transition";
        if (selected){
          card.classList.add("bg-white/12");
          card.style.borderColor = "rgba(111,163,255,0.55)";
          card.style.boxShadow = "0 0 0 2px rgba(111,163,255,0.18), 0 22px 70px rgba(0,0,0,0.30)";
        }

        card.innerHTML = `
          <div class="flex items-start justify-between gap-3">
            <div class="min-w-0">
              <div class="text-sm font-semibold text-white/90">${m.name}</div>
              <div class="mt-1 text-xs text-white/55">Â£${m.price_gbp} / month</div>
            </div>
            <button type="button"
              class="toggleMod w-11 h-11 rounded-full border ${selected ? "border-line2 bg-white/10" : "border-line bg-white/5"}
                     hover:bg-white/10 transition grid place-items-center text-sm font-bold">
              <span>${selected ? "âœ“" : "+"}</span>
            </button>
          </div>
          <div class="flex items-center justify-between gap-3">
            <button type="button"
              class="learnMore inline-flex items-center gap-2 text-xs px-3 py-2 rounded-xl border border-line
                     bg-transparent hover:bg-white/5 transition whitespace-nowrap">
              Learn more â†’
            </button>
            <div class="text-[11px] ${selected ? "text-accent" : "text-white/45"}">${selected ? "Selected" : "Optional module"}</div>
          </div>
        `;

        card.querySelector(".toggleMod").addEventListener("click", () => {
          if (plan.modules.has(m.id)) plan.modules.delete(m.id);
          else plan.modules.add(m.id);
          renderModules();
          updateSummary();
        });

        card.querySelector(".learnMore").addEventListener("click", () => openModuleModal(m.id));
        grid.appendChild(card);
      });
    }

    function openModuleModal(id){
      const m = MODULES.find(x => x.id === id);
      if (!m) return;
      $("modalTitle").textContent = m.name;
      $("modalPrice").textContent = `Â£${m.price_gbp} / month`;
      $("modalSummary").textContent = m.summary;
      $("modalFeatures").innerHTML = "";
      m.features.forEach(f => {
        const li = document.createElement("li");
        li.textContent = f;
        $("modalFeatures").appendChild(li);
      });
      $("modalVideo").src = YT_EMBED;
      openModal("moduleModal");
    }

    function closeModuleModal(){
      $("modalVideo").src = "";
      closeModal("moduleModal");
    }

    // ====== ROUTING ======
    function showHome(){
      hide($("viewDashboard"));
      show($("viewHome"));
      window.scrollTo({ top: 0, behavior: "smooth" });
    }
    function showDashboard(){
      hide($("viewHome"));
      show($("viewDashboard"));
      window.scrollTo({ top: 0, behavior: "smooth" });
    }

    function setNavAuthed(isAuthed){
      if (isAuthed){
        show($("navLogoutBtn"));
        show($("navDashboardBtn"));
        hide($("navLoginBtn"));
      } else {
        hide($("navLogoutBtn"));
        hide($("navDashboardBtn"));
        show($("navLoginBtn"));
      }
    }

    // ====== API helpers ======
    async function apiPost(path, payload){
      const res = await fetch(path, {
        method: "POST",
        headers: { "content-type":"application/json" },
        body: JSON.stringify(payload || {})
      });
      const text = await res.text();
      if (!res.ok) throw new Error(text || "Request failed");
      return text ? JSON.parse(text) : {};
    }

    // ====== AUTH ======
    async function signIn(email, password){
      const { data, error } = await sb.auth.signInWithPassword({ email, password });
      return { data, error };
    }
    async function signOut(){ await sb.auth.signOut(); }

    // ====== DASHBOARD DATA ======
    let currentCompany = null;
    let currentSubscription = null;

    async function loadDashboard(){
      const { data: sessionData } = await sb.auth.getSession();
      const session = sessionData?.session;
      if (!session) return;

      $("dashUserEmail").textContent = session.user.email;

      // get company (owned by this user)
      const { data: companyRows, error: cErr } = await sb
        .from("companies")
        .select("id,company_code,company_name,address,logo_url,owner_user_id")
        .eq("owner_user_id", session.user.id)
        .order("created_at", { ascending: false })
        .limit(1);

      if (cErr) { $("companySaveMsg").textContent = cErr.message; return; }
      currentCompany = companyRows?.[0] || null;

      if (!currentCompany){
        $("companySaveMsg").textContent = "No company found for this user yet.";
        return;
      }

      $("dashCompanyCode").textContent = `Company ID: ${currentCompany.company_code || "â€”"}`;
      $("dashCompanyId").textContent = currentCompany.company_code || "â€”";

      $("companyName").value = currentCompany.company_name || "";
      $("companyAddress").value = currentCompany.address || "";

      // subscription
      const { data: subRows } = await sb
        .from("subscriptions")
        .select("selected_module_ids,company_size_label,total_gbp")
        .eq("company_id", currentCompany.id)
        .limit(1);

      currentSubscription = subRows?.[0] || { selected_module_ids: [] };

      renderOwnedLinks();
      renderBuyMore();
      await loadEmployees();
    }

    function renderOwnedLinks(){
      const wrap = $("ownedLinks");
      wrap.innerHTML = "";

      const owned = new Set(currentSubscription?.selected_module_ids || []);
      if (owned.size === 0){
        const div = document.createElement("div");
        div.className = "text-xs text-white/55";
        div.textContent = "No systems selected yet.";
        wrap.appendChild(div);
        return;
      }

      MODULES.forEach((m) => {
        if (!owned.has(m.id)) return;
        const a = document.createElement("a");
        a.href = "https://smartcoretechnology.co.uk";
        a.target = "_blank";
        a.className = "glass rounded-xl px-3 py-2 border border-line hover:bg-white/10 transition text-sm flex items-center justify-between";
        a.innerHTML = `<span>${m.name}</span><span class="text-xs text-white/50">Open</span>`;
        wrap.appendChild(a);
      });
    }

    function renderBuyMore(){
      const wrap = $("buyMoreGrid");
      wrap.innerHTML = "";

      const owned = new Set(currentSubscription?.selected_module_ids || []);
      const available = MODULES.filter(m => !owned.has(m.id));

      if (available.length === 0){
        const div = document.createElement("div");
        div.className = "text-xs text-white/55";
        div.textContent = "You already have all systems.";
        wrap.appendChild(div);
        return;
      }

      available.forEach((m) => {
        const btn = document.createElement("button");
        btn.type = "button";
        btn.dataset.mid = m.id;
        btn.className = "text-left glass rounded-xl px-3 py-2 border border-line hover:bg-white/10 transition text-sm flex items-center justify-between";
        btn.innerHTML = `<span>${m.name}</span><span class="text-xs text-white/50">Add</span>`;
        btn.addEventListener("click", () => {
          btn.classList.toggle("bg-white/10");
          btn.classList.toggle("border-line2");
          btn.classList.toggle("ring-2");
          btn.classList.toggle("ring-accent/30");
          btn.classList.toggle("selectedAdd");
        });
        wrap.appendChild(btn);
      });
    }

    async function saveModules(){
      $("modulesSaveMsg").textContent = "";
      if (!currentCompany) return;

      const addIds = [...document.querySelectorAll(".selectedAdd")].map(el => el.dataset.mid);
      const current = new Set(currentSubscription?.selected_module_ids || []);
      addIds.forEach(x => current.add(x));
      const updated = Array.from(current);

      const { error } = await sb
        .from("subscriptions")
        .update({ selected_module_ids: updated, updated_at: new Date().toISOString() })
        .eq("company_id", currentCompany.id);

      if (error){ $("modulesSaveMsg").textContent = error.message; return; }
      $("modulesSaveMsg").textContent = "Saved. (Testing checkout complete)";
      await loadDashboard();
    }

    async function saveCompany(){
      $("companySaveMsg").textContent = "";
      if (!currentCompany) return;

      const company_name = $("companyName").value.trim();
      const address = $("companyAddress").value.trim();

      const { error } = await sb
        .from("companies")
        .update({ company_name, address })
        .eq("id", currentCompany.id);

      if (error){ $("companySaveMsg").textContent = error.message; return; }
      $("companySaveMsg").textContent = "Company saved.";
      await loadDashboard();
    }

    async function addEmployee() {
  $("empMsg").textContent = "";
  if (!currentCompany) {
    $("empMsg").textContent = "Company not loaded.";
    return;
  }

  const full_name = $("empName").value.trim();
  const job_title = $("empTitle").value.trim();
  const job_category = $("empCategory").value.trim();

  if (!full_name) {
    $("empMsg").textContent = "Enter a name.";
    return;
  }

  // Generate employee ID:
  // first 3 letters of name (letters only) + 9 digit number
  const prefix = full_name
    .replace(/[^a-zA-Z]/g, "")
    .slice(0, 3)
    .toUpperCase()
    .padEnd(3, "X");

  const randomDigits = Math.floor(100000000 + Math.random() * 900000000);
  const employee_id = `${prefix}${randomDigits}`;

  try {
    const { error } = await supabase
      .from("employees")
      .insert([{
        company_id: currentCompany.id,
        full_name,
        job_title,
        job_category,
        employee_code: employee_id
      }]);

    if (error) throw error;

    // Clear inputs
    $("empName").value = "";
    $("empTitle").value = "";
    $("empCategory").value = "";

    $("empMsg").textContent = "Employee added.";
    $("empMsg").className = "text-green-400 text-sm";

    // Refresh employee list (if you have one)
    if (typeof loadEmployees === "function") {
      loadEmployees();
    }

  } catch (err) {
    console.error(err);
    $("empMsg").textContent = err.message || "Failed to add employee.";
    $("empMsg").className = "text-red-400 text-sm";
  }
}


      // generate employee_code via RPC
      const { data: codeData, error: codeErr } = await sb.rpc("make_employee_code", { full_name });
      if (codeErr) { $("empMsg").textContent = codeErr.message; return; }

      const employee_code = codeData;

      const { error } = await sb
        .from("employees")
        .insert([{ company_id: currentCompany.id, full_name, job_title, job_category, employee_code }]);

      if (error){ $("empMsg").textContent = error.message; return; }

      $("empMsg").textContent = `Added: ${employee_code}`;
      $("empName").value = ""; $("empTitle").value = ""; $("empCategory").value = "";
      await loadEmployees();
    }

    async function loadEmployees(){
      const tbody = $("empTable");
      tbody.innerHTML = "";
      if (!currentCompany) return;

      const { data, error } = await sb
        .from("employees")
        .select("employee_code,full_name,job_title,job_category")
        .eq("company_id", currentCompany.id)
        .order("created_at", { ascending: false });

      if (error){
        const tr = document.createElement("tr");
        tr.innerHTML = `<td class="py-2 text-white/60" colspan="4">${error.message}</td>`;
        tbody.appendChild(tr);
        return;
      }

      if (!data || data.length === 0){
        const tr = document.createElement("tr");
        tr.innerHTML = `<td class="py-2 text-white/60" colspan="4">No employees added yet.</td>`;
        tbody.appendChild(tr);
        return;
      }

      data.forEach(r => {
        const tr = document.createElement("tr");
        tr.className = "border-b border-line/50";
        tr.innerHTML = `
          <td class="py-2 pr-3 font-mono text-xs text-white/80">${r.employee_code}</td>
          <td class="py-2 pr-3">${r.full_name || ""}</td>
          <td class="py-2 pr-3 text-white/75">${r.job_title || ""}</td>
          <td class="py-2 pr-3 text-white/75">${r.job_category || ""}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    // ====== SIGNUP (2-step) ======
    let pendingSignup = null;

    function setSignupStep(step){
      if (step === 1){
        $("signupStep1").classList.remove("hidden");
        $("signupStep2").classList.add("hidden");
        $("codeWrap").classList.add("hidden");
      } else {
        $("signupStep1").classList.add("hidden");
        $("signupStep2").classList.remove("hidden");
        $("codeWrap").classList.remove("hidden");
      }
    }

    function openSignupModal(){
      pendingSignup = null;
      $("suMsg").textContent = "";
      $("suCode").value = "";
      setSignupStep(1);
      openModal("signupModal");
    }

    // ====== BUTTONS ======
    function initButtons(){
      $("goBuildPlanBtn").addEventListener("click", () => $("pricing").scrollIntoView({ behavior:"smooth", block:"start" }));
      $("downArrowBtn").addEventListener("click", () => $("pricing").scrollIntoView({ behavior:"smooth", block:"start" }));

      $("goEmployeeSignupBtn").addEventListener("click", () => openModal("employeeModal"));
      $("closeEmployeeBtn").addEventListener("click", () => closeModal("employeeModal"));
      $("closeEmployeeBtn2").addEventListener("click", () => closeModal("employeeModal"));

      $("clearBtn").addEventListener("click", () => {
        plan.companySize = null;
        plan.modules.clear();
        $("modulesWrap").classList.add("hidden");
        $("summaryBar").classList.add("hidden");
        $("sizeHint").textContent = "Select one";
        renderCompanySizes();
        renderModules();
        updateSummary();
      });

      // Module modal
      $("closeModuleModalBtn").addEventListener("click", closeModuleModal);

      // Signup modal open from checkout
      $("checkoutBtn").addEventListener("click", openSignupModal);
      $("closeSignupBtn").addEventListener("click", () => closeModal("signupModal"));

      $("openLoginBtn").addEventListener("click", () => { closeModal("signupModal"); openModal("loginModal"); });

      $("suTogglePw").addEventListener("click", () => togglePw("suPassword"));
      $("liTogglePw").addEventListener("click", () => togglePw("liPassword"));

      // Step 1: Continue -> send code
      $("continueBtn").addEventListener("click", async () => {
        $("suMsg").textContent = "";

        const company_name = $("suCompanyName").value.trim();
        const email = $("suEmail").value.trim().toLowerCase();
        const password = $("suPassword").value;

        if (!plan.companySize) { $("suMsg").textContent = "Select a company size first."; return; }
        if (!company_name) { $("suMsg").textContent = "Enter company name."; return; }
        if (!email) { $("suMsg").textContent = "Enter email."; return; }
        if (!password || password.length < 8) { $("suMsg").textContent = "Password must be at least 8 characters."; return; }

        pendingSignup = {
          company_name,
          email,
          password,
          company_size: plan.companySize,
          module_ids: Array.from(plan.modules),
          full_name: $("suFullName").value.trim()
        };

        try {
          $("continueBtn").disabled = true;
          $("continueBtn").classList.add("opacity-50");

          await apiPost("/api/send-code", { email, purpose: "owner_signup" });

          $("suMsg").textContent = "Code sent. Check your inbox.";
          setSignupStep(2);
          $("suCode").focus();

        } catch (e) {
          $("suMsg").textContent = e.message || "Failed to send code.";
        } finally {
          $("continueBtn").disabled = false;
          $("continueBtn").classList.remove("opacity-50");
        }
      });

      $("backToDetailsBtn").addEventListener("click", () => {
        $("suMsg").textContent = "";
        setSignupStep(1);
      });

      // Step 2: Verify -> create -> login -> dashboard
      $("verifyBtn").addEventListener("click", async () => {
        $("suMsg").textContent = "";
        if (!pendingSignup) { $("suMsg").textContent = "Press Continue first."; return; }

        const code = $("suCode").value.trim();
        if (!code || code.length !== 6) { $("suMsg").textContent = "Enter the 6-digit code."; return; }

        try {
          $("verifyBtn").disabled = true;
          $("verifyBtn").classList.add("opacity-50");

          await apiPost("/api/verify-code", {
            purpose: "owner_signup",
            email: pendingSignup.email,
            code,
            full_name: pendingSignup.full_name,
            password: pendingSignup.password,
            company_name: pendingSignup.company_name,
            company_size: pendingSignup.company_size,
            module_ids: pendingSignup.module_ids
          });

          // login
          const { error } = await signIn(pendingSignup.email, pendingSignup.password);
          if (error) throw new Error(error.message);

          pendingSignup = null;
          $("suCode").value = "";
          setSignupStep(1);
          closeModal("signupModal");

          setNavAuthed(true);
          showDashboard();
          await loadDashboard();

        } catch (e) {
          $("suMsg").textContent = e.message || "Verification failed.";
        } finally {
          $("verifyBtn").disabled = false;
          $("verifyBtn").classList.remove("opacity-50");
        }
      });

      // Login modal
      $("navLoginBtn").addEventListener("click", () => openModal("loginModal"));
      $("closeLoginBtn").addEventListener("click", () => closeModal("loginModal"));

      $("loginBtn").addEventListener("click", async () => {
        $("liMsg").textContent = "";
        const email = $("liEmail").value.trim().toLowerCase();
        const password = $("liPassword").value;
        if (!email || !password) { $("liMsg").textContent = "Enter email and password."; return; }

        const { error } = await signIn(email, password);
        if (error) { $("liMsg").textContent = error.message; return; }

        closeModal("loginModal");
        setNavAuthed(true);
        showDashboard();
        await loadDashboard();
      });

      // Logout
      $("navLogoutBtn").addEventListener("click", async () => {
        await signOut();
        setNavAuthed(false);
        currentCompany = null;
        currentSubscription = null;
        showHome();
      });

      $("navDashboardBtn").addEventListener("click", async () => {
        showDashboard();
        await loadDashboard();
      });

      // Dashboard actions
      $("saveCompanyBtn").addEventListener("click", saveCompany);
      $("addEmployeeBtn").addEventListener("click", addEmployee);
      $("saveModulesBtn").addEventListener("click", saveModules);

      // Escape closes
      document.addEventListener("keydown", (e) => {
        if (e.key === "Escape"){
          closeModuleModal();
          closeModal("signupModal");
          closeModal("loginModal");
          closeModal("employeeModal");
        }
      });
    }

    // ====== BOOT ======
    async function boot(){
      initNavHide();
      initReveal();
      renderCompanySizes();
      renderModules();
      updateSummary();
      initButtons();

      const { data: s } = await sb.auth.getSession();
      const session = s?.session;

      if (session){
        setNavAuthed(true);
        showDashboard();
        await loadDashboard();
      } else {
        setNavAuthed(false);
        showHome();
      }

      sb.auth.onAuthStateChange(async (_event, session2) => {
        if (session2){
          setNavAuthed(true);
          showDashboard();
          await loadDashboard();
        } else {
          setNavAuthed(false);
          showHome();
        }
      });
    }

    boot();
  </script>
</body>
</html>




