<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SmartCore Technology</title>

  <!-- Supabase client (for login/session only) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root{
      --bg0:#050913;
      --bg1:#070c1a;
      --blueGlow: rgba(76, 138, 255, .18);
      --blueGlow2: rgba(76, 138, 255, .10);
      --glass: rgba(255,255,255,.06);
      --glass2: rgba(255,255,255,.08);
      --stroke: rgba(255,255,255,.10);
      --stroke2: rgba(255,255,255,.14);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.72);
      --muted2: rgba(255,255,255,.55);
      --shadow: 0 18px 60px rgba(0,0,0,.55);
      --radius: 18px;
      --radius2: 24px;
      --accent: rgba(120, 170, 255, .95);
      --danger: rgba(255, 92, 92, .95);
      --ok: rgba(82, 255, 175, .95);
      --amber: rgba(255, 204, 92, .95);
      --maxw: 1120px;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      color:var(--text);
      background:
        radial-gradient(900px 520px at 50% 18%, var(--blueGlow), transparent 62%),
        radial-gradient(600px 420px at 15% 75%, var(--blueGlow2), transparent 62%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      overflow-x:hidden;
    }

    /* ===== Utilities ===== */
    .wrap{ width:min(var(--maxw), calc(100% - 40px)); margin:0 auto; }
    .fadeUp{ opacity:0; transform:translateY(10px); animation: fadeUp .75s ease forwards; }
    .delay1{ animation-delay:.08s; } .delay2{ animation-delay:.16s; } .delay3{ animation-delay:.24s; } .delay4{ animation-delay:.32s; }
    @keyframes fadeUp{ to{ opacity:1; transform:translateY(0); } }

    .glass{
      background: linear-gradient(180deg, rgba(255,255,255,.075), rgba(255,255,255,.045));
      border: 1px solid var(--stroke);
      box-shadow: var(--shadow);
      backdrop-filter: blur(18px);
      -webkit-backdrop-filter: blur(18px);
      border-radius: var(--radius2);
    }
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.070), rgba(255,255,255,.040));
      border: 1px solid var(--stroke);
      box-shadow: 0 10px 40px rgba(0,0,0,.35);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      border-radius: var(--radius);
    }

    .btn{
      appearance:none;
      border: 1px solid var(--stroke2);
      background: rgba(255,255,255,.06);
      color: var(--text);
      border-radius: 999px;
      padding: 10px 14px;
      font-weight: 650;
      letter-spacing:.2px;
      cursor:pointer;
      transition: transform .12s ease, background .2s ease, border-color .2s ease;
      display:inline-flex;
      align-items:center;
      gap:8px;
      user-select:none;
    }
    .btn:hover{ background: rgba(255,255,255,.09); transform: translateY(-1px); border-color: rgba(255,255,255,.18); }
    .btn:active{ transform: translateY(0); }
    .btn.primary{
      background: rgba(120, 170, 255, .14);
      border-color: rgba(120, 170, 255, .28);
    }
    .btn.primary:hover{ background: rgba(120, 170, 255, .20); }
    .btn.ghost{ background: rgba(255,255,255,.045); }
    .btn.danger{ border-color: rgba(255,92,92,.35); background: rgba(255,92,92,.08); }
    .btn.danger:hover{ background: rgba(255,92,92,.12); }
    .btn:disabled{ opacity:.5; cursor:not-allowed; transform:none; }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 7px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      color: var(--muted);
      font-size: 12px;
      width: fit-content;
    }

    .h1{
      font-size: clamp(46px, 6vw, 78px);
      line-height: .98;
      margin: 16px 0 10px;
      letter-spacing: -1.2px;
    }
    .h1 .tech{
      opacity:.72; /* user request */
      display:block;
    }
    .lead{
      font-size: 16px;
      color: var(--muted);
      line-height: 1.55;
      max-width: 58ch;
      margin: 0 0 18px;
    }

    /* ===== NAV ===== */
    .navWrap{
      position: fixed;
      top: 18px;
      left: 0;
      right: 0;
      z-index: 50;
      transition: transform .28s ease, opacity .28s ease;
      pointer-events: none;
    }
    .navWrap .nav{
      pointer-events: auto;
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 14px;
      padding: 10px 12px;
    }
    .brand{
      display:flex;
      align-items:center;
      gap: 10px;
      padding: 6px 8px;
      border-radius: 14px;
    }
    .brand img{
      width: 34px;
      height: 34px;
      border-radius: 10px;
      object-fit: cover;
      display:block;
    }
    .brandText{
      display:flex;
      flex-direction: column;
      line-height: 1.05;
      padding-top: 2px; /* fixes g/y clipping feel */
    }
    .brandText strong{ font-size: 13px; }
    .brandText span{ font-size: 11px; color: var(--muted2); }

    .navRight{ display:flex; gap:10px; align-items:center; }
    .navHidden{ transform: translateY(-24px); opacity:0; pointer-events:none; }

    /* ===== HERO ===== */
    .hero{
      min-height: 100vh;
      display:flex;
      align-items:center;
      padding-top: 86px; /* space for fixed nav */
      padding-bottom: 30px;
      position: relative;
      overflow:hidden;
    }
    .heroInner{
      display:grid;
      grid-template-columns: 1.1fr;
      gap: 26px;
      align-items:center;
      position:relative;
      z-index: 2;
    }

    /* scattered icon layer */
    .iconLayer{
      position:absolute;
      inset:0;
      z-index: 1;
      pointer-events:none;
      overflow:hidden;
    }
    .bubble{
      position:absolute;
      width: 132px;
      height: 132px;
      border-radius: 999px;
      background: rgba(255,255,255,.03);
      border: 1px solid rgba(255,255,255,.08);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      display:flex;
      align-items:center;
      justify-content:center;
      opacity:.16; /* lower opacity request */
      filter: drop-shadow(0 18px 30px rgba(0,0,0,.35));
      animation: floaty 8s ease-in-out infinite;
      will-change: transform;
    }
    .bubble svg{
      width: 54px;
      height: 54px;
      opacity:.8;
    }
    @keyframes floaty{
      0%,100%{ transform: translate3d(0,0,0); }
      50%{ transform: translate3d(0, -10px, 0); }
    }

    /* mask so bubbles never block text area */
    .textSafeZone{
      position:absolute;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      z-index: 3;
      pointer-events:none;
    }
    .safeBox{
      position:absolute;
      left: 50%;
      top: 50%;
      transform: translate(-50%,-50%);
      width: min(760px, calc(100% - 34px));
      height: min(460px, calc(100% - 160px));
      border-radius: 30px;
      background: radial-gradient(closest-side, rgba(0,0,0,.42), transparent 70%);
    }

    .heroCTA{
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 12px;
    }
    .scrollBtn{
      margin-top: 14px;
      display:inline-flex;
      align-items:center;
      gap:10px;
      color: var(--muted2);
      background: transparent;
      border: none;
      cursor:pointer;
      padding: 8px 2px;
    }
    .arrow{
      width: 34px;
      height: 34px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.05);
      display:flex;
      align-items:center;
      justify-content:center;
      transition: transform .2s ease, background .2s ease;
    }
    .scrollBtn:hover .arrow{ transform: translateY(1px); background: rgba(255,255,255,.08); }

    /* ===== Build Plan ===== */
    .section{
      padding: 70px 0;
    }
    .sectionTitle{
      font-size: 18px;
      margin: 0 0 8px;
      letter-spacing: -.2px;
    }
    .sectionSub{
      color: var(--muted2);
      font-size: 13px;
      margin: 0 0 18px;
    }

    .planGrid{
      display:grid;
      gap: 14px;
      grid-template-columns: repeat(4, 1fr);
    }
    .sizeCard, .modCard{
      padding: 14px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.05);
      cursor:pointer;
      transition: transform .12s ease, border-color .2s ease, background .2s ease;
      display:flex;
      justify-content: space-between;
      gap: 10px;
      min-height: 84px;
    }
    .sizeCard:hover,.modCard:hover{ transform: translateY(-1px); border-color: rgba(255,255,255,.18); background: rgba(255,255,255,.07); }
    .selected{
      border-color: rgba(120,170,255,.55) !important;
      box-shadow: 0 0 0 2px rgba(120,170,255,.22) inset;
    }
    .tick{
      width: 26px; height: 26px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.06);
      display:flex;
      align-items:center;
      justify-content:center;
      flex: 0 0 auto;
      margin-top: 4px;
    }
    .tick.on{
      background: rgba(120,170,255,.22);
      border-color: rgba(120,170,255,.45);
    }
    .tick.on:before{
      content:"‚úì";
      font-weight:800;
      font-size: 14px;
    }

    .modGrid{
      display:grid;
      gap: 14px;
      grid-template-columns: repeat(3, 1fr);
      margin-top: 12px;
    }
    .modMeta{
      display:flex;
      flex-direction: column;
      gap: 4px;
      min-width: 0;
    }
    .modName{ font-weight: 720; font-size: 13px; }
    .modPrice{ color: var(--muted2); font-size: 12px; }
    .modActions{
      display:flex;
      gap: 8px;
      align-items:center;
      margin-top: 8px;
    }
    .learnBtn{
      font-size: 12px;
      padding: 7px 10px;
      white-space: nowrap; /* one line */
    }

    /* total bar */
    .totalBar{
      margin-top: 18px; /* pushed down */
      padding: 14px;
      display:flex;
      justify-content: space-between;
      align-items:center;
      gap: 12px;
    }
    .totalLeft{
      display:flex; flex-direction:column; gap:4px;
    }
    .totalLeft strong{ font-size: 14px; }
    .totalLeft span{ font-size: 12px; color: var(--muted2); }
    .totalRight{ display:flex; gap: 10px; align-items:center; }

    /* About */
    .about p{ color: var(--muted); font-size: 13px; line-height: 1.7; }
    .about h3{ margin: 16px 0 8px; font-size: 14px; }
    .about ul{ margin: 8px 0 0 18px; color: var(--muted); font-size: 13px; line-height: 1.7; }

    /* ===== Modal ===== */
    .backdrop{
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.58);
      display:none;
      align-items:center;
      justify-content:center;
      padding: 20px;
      z-index: 80;
    }
    .backdrop.show{ display:flex; }
    .modal{
      width: min(720px, 100%);
      max-height: min(82vh, 780px);
      overflow:auto;
      padding: 16px;
      border-radius: 20px;
    }
    .modalHeader{
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 10px;
      margin-bottom: 10px;
      position: sticky;
      top: 0;
      background: linear-gradient(180deg, rgba(9,14,28,.96), rgba(9,14,28,.80));
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      border-bottom: 1px solid rgba(255,255,255,.08);
      padding: 10px 10px 12px;
      border-radius: 14px;
    }
    .modalHeader strong{ font-size: 13px; }
    .fieldRow{ display:grid; gap: 10px; grid-template-columns: 1fr; }
    .field{ display:flex; flex-direction:column; gap:6px; margin-top: 10px; }
    .label{ font-size: 12px; color: var(--muted2); }
    .input{
      width: 100%;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.05);
      color: var(--text);
      padding: 12px 12px;
      outline:none;
      transition: border-color .2s ease, background .2s ease;
    }
    .input:focus{ border-color: rgba(120,170,255,.40); background: rgba(255,255,255,.07); }
    .msg{ margin-top: 10px; color: var(--muted); font-size: 13px; }
    .msg.err{ color: rgba(255,140,140,.95); }
    .msg.ok{ color: rgba(120,255,190,.95); }
    .row2{ display:grid; gap: 10px; grid-template-columns: 1fr 1fr; }
    @media (max-width: 900px){
      .planGrid{ grid-template-columns: 1fr 1fr; }
      .modGrid{ grid-template-columns: 1fr; }
      .row2{ grid-template-columns: 1fr; }
    }

    /* custom file + checkbox */
    .fileWrap{
      display:flex; gap:10px; align-items:center; flex-wrap:wrap;
    }
    .fileBtn{
      display:inline-flex; align-items:center; gap:8px;
      padding: 10px 12px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      cursor:pointer;
      font-weight:650;
      font-size: 13px;
    }
    input[type="file"]{ display:none; }

    .check{
      display:flex; align-items:center; gap:10px;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.05);
      width: fit-content;
    }
    .toggle{
      width: 44px; height: 26px; border-radius: 999px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      position: relative;
      cursor:pointer;
    }
    .toggle:before{
      content:"";
      position:absolute;
      top: 3px; left: 3px;
      width: 20px; height: 20px;
      border-radius: 999px;
      background: rgba(255,255,255,.72);
      transition: transform .18s ease, background .18s ease;
    }
    .toggle.on{
      background: rgba(120,170,255,.18);
      border-color: rgba(120,170,255,.30);
    }
    .toggle.on:before{
      transform: translateX(18px);
      background: rgba(255,255,255,.92);
    }

    /* Dashboard */
    .dash{
      display:none;
      padding-top: 96px;
      padding-bottom: 60px;
    }
    .dash.show{ display:block; }
    .topBar{
      display:flex; align-items:center; justify-content:space-between; gap: 10px;
      padding: 14px;
      margin-top: 18px;
    }
    .grid2{ display:grid; gap: 14px; grid-template-columns: 1.1fr .9fr; margin-top: 14px; }
    .grid2 .card{ padding: 14px; }
    @media (max-width: 980px){ .grid2{ grid-template-columns: 1fr; } }

    .empRow{
      display:grid;
      grid-template-columns: 1fr auto auto;
      gap: 10px;
      align-items:center;
      padding: 10px 10px;
      border: 1px solid rgba(255,255,255,.08);
      background: rgba(255,255,255,.04);
      border-radius: 14px;
      margin-top: 10px;
    }
    .empMeta{ display:flex; flex-direction:column; gap:3px; min-width:0; }
    .empMeta strong{ font-size: 13px; white-space:nowrap; overflow:hidden; text-overflow: ellipsis; }
    .empMeta span{ font-size: 12px; color: var(--muted2); white-space:nowrap; overflow:hidden; text-overflow: ellipsis; }
    .iconBtn{
      width: 38px; height: 38px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.05);
      display:flex; align-items:center; justify-content:center;
      cursor:pointer;
      transition: background .2s ease, transform .12s ease;
    }
    .iconBtn:hover{ background: rgba(255,255,255,.08); transform: translateY(-1px); }
    .iconBtn.danger{ border-color: rgba(255,92,92,.25); }
    .iconBtn svg{ width: 18px; height: 18px; opacity:.85; }

    footer{
      padding: 26px 0 40px;
      color: var(--muted2);
      font-size: 12px;
    }

    a.link{ color: rgba(160,200,255,.95); text-decoration: none; }
    a.link:hover{ text-decoration: underline; }

  </style>
</head>

<body>
  <!-- NAV -->
  <div class="navWrap" id="navWrap">
    <div class="wrap">
      <div class="nav glass">
        <div class="brand">
          <img
            alt="SmartCore"
            src="SmartCore%20Official%20Logos/SC%20Icon%20-%20Black%20Background.png"
          />
          <div class="brandText">
            <strong>SmartCore Technology</strong>
            <span>Practical Technology. Built to Last.</span>
          </div>
        </div>
        <div class="navRight">
          <button class="btn ghost" id="loginTopBtn">Log In</button>
        </div>
      </div>
    </div>
  </div>

  <!-- HERO -->
  <section class="hero" id="home">
    <div class="iconLayer" id="iconLayer"></div>
    <div class="textSafeZone"><div class="safeBox"></div></div>

    <div class="wrap">
      <div class="heroInner">
        <div>
          <div class="pill fadeUp delay1">
            <span style="display:inline-block;width:7px;height:7px;border-radius:999px;background:rgba(120,170,255,.8)"></span>
            Calm systems for real workplaces
          </div>

          <h1 class="h1 fadeUp delay2">
            SmartCore <span class="tech">Technology</span>
          </h1>

          <p class="lead fadeUp delay3">
            Reliable software systems for workspace management ‚Äî practical tools that stay clean, consistent, and easy to run.
          </p>

          <div class="heroCTA fadeUp delay4">
            <button class="btn primary" id="buildPlanBtn">Build Your Plan ‚Üí</button>
            <button class="btn" id="employeeBtn">Sign Up As An Employee</button>
          </div>

          <button class="scrollBtn" id="scrollDownBtn">
            <span class="arrow">‚Üì</span>
            <span>Scroll Down</span>
          </button>
        </div>
      </div>
    </div>
  </section>

  <!-- BUILD PLAN -->
  <section class="section" id="plan">
    <div class="wrap">
      <div class="card" style="padding:18px;">
        <div style="display:flex;justify-content:space-between;gap:12px;align-items:flex-start;flex-wrap:wrap;">
          <div>
            <h2 class="sectionTitle">Build your plan</h2>
            <p class="sectionSub">Choose your company size, then select modules. Totals update live.</p>
          </div>
          <div style="text-align:right; color:var(--muted2); font-size:12px;">
            Monthly subscription (GBP)
            <div style="margin-top:6px; font-weight:800; color:var(--text);" id="planSummary">Select a company size</div>
          </div>
        </div>

        <div class="sectionTitle" style="font-size:13px; margin-top:14px;">Select your company size</div>
        <div class="planGrid" id="sizeGrid"></div>

        <div id="size250Box" style="display:none; margin-top:12px;">
          <div class="row2">
            <div class="field">
              <div class="label">Approx company size (required to contact)</div>
              <input class="input" id="approxSize" type="number" min="1" placeholder="e.g. 520" />
              <div class="label" id="approxWarn" style="display:none;color:rgba(255,200,110,.95)">Are you sure you want the 250+ plan if your company is under 250?</div>
            </div>
            <div class="field">
              <div class="label"> </div>
              <button class="btn primary" id="contact250Btn" disabled>Contact Us ‚Üí</button>
              <div class="label" style="margin-top:8px;">We‚Äôll open a pre-filled email to support.</div>
            </div>
          </div>
        </div>

        <div id="modulesWrap" style="display:none;">
          <div class="sectionTitle" style="font-size:13px; margin-top:18px;">Select your modules</div>
          <div class="modGrid" id="modGrid"></div>

          <div class="totalBar card" style="border-radius:18px;">
            <div class="totalLeft">
              <strong id="totalLine">¬£0 / month</strong>
              <span id="totalHint">Select modules to begin</span>
            </div>
            <div class="totalRight">
              <button class="btn" id="clearPlanBtn">Clear</button>
              <button class="btn primary" id="checkoutBtn" disabled>Continue ‚Üí</button>
            </div>
          </div>
        </div>
      </div>

      <div class="card about" style="padding:18px; margin-top:18px;">
        <h2 class="sectionTitle">About SmartCore Technology</h2>

        <p>
          SmartCore Technology was built by Finley Hassall, a young founder with a long-standing passion for technology and a strong business mindset.
          Interested in IT from the age of six, Finley always knew he wanted to build a career creating systems that solve real-world problems.
        </p>

        <p>
          Rather than focusing on trends or hype, SmartCore Technology was created with a clear goal: to build practical, reliable systems that businesses can depend on every day.
        </p>

        <p>
          The company was developed with guidance and support from Finley‚Äôs mother, a business owner herself, but every system within SmartCore has been hand-crafted from the ground up by Finley.
          Each feature, workflow, and decision has been designed with real workplaces in mind ‚Äî prioritising clarity, usability, and long-term reliability over unnecessary complexity.
        </p>

        <p>
          SmartCore Technology is not about flashy software. It‚Äôs about building tools that work properly, scale sensibly, and quietly do their job in the background.
        </p>

        <h3>The SmartCore Technology Approach</h3>
        <p>SmartCore Technology is built on a simple philosophy: technology should make work easier, not more complicated.</p>
        <ul>
          <li>solve a specific, real business problem</li>
          <li>be easy to understand and use</li>
          <li>create clear, auditable records</li>
          <li>scale as organisations grow</li>
          <li>remain reliable over time</li>
        </ul>

        <p style="margin-top:12px;">
          Instead of offering one large, bloated platform, SmartCore provides modular systems that companies can choose and combine based on their actual needs.
          This keeps costs fair, reduces complexity, and allows businesses to stay in control of how they operate.
        </p>
      </div>

      <footer class="wrap">
        SmartCore Technology ‚Äî Practical Technology. Built to Last. ¬∑ Support:
        <a class="link" href="mailto:support@smartcoretechnology.co.uk">support@smartcoretechnology.co.uk</a>
      </footer>
    </div>
  </section>

  <!-- DASHBOARD -->
  <section class="dash" id="dash">
    <div class="wrap">
      <div class="topBar glass">
        <div>
          <div style="font-weight:800;font-size:14px;" id="dashTitle">Dashboard</div>
          <div style="color:var(--muted2);font-size:12px;" id="dashSub">Loading‚Ä¶</div>
        </div>
        <div style="display:flex;gap:10px;align-items:center;">
          <button class="btn" id="buyMoreBtn">Buy More Systems</button>
          <button class="btn danger" id="signOutBtn">Sign Out</button>
        </div>
      </div>

      <div class="grid2">
        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;">
            <div style="font-weight:800;">Company Onboarding</div>
            <div style="color:var(--muted2);font-size:12px;" id="onboardStep">Step 1 of 4</div>
          </div>
          <div class="msg" id="onboardMsg"></div>

          <!-- Step panels -->
          <div id="step1" style="margin-top:10px;">
            <div class="field">
              <div class="label">Full Company Name</div>
              <input class="input" id="coName" placeholder="e.g. SmartFits Installations Ltd" />
            </div>
            <button class="btn primary" id="step1Next" style="margin-top:12px;">Continue ‚Üí</button>
          </div>

          <div id="step2" style="display:none; margin-top:10px;">
            <div class="field">
              <div class="label">Full Company Address</div>
              <input class="input" id="coAddr" placeholder="Full address" />
            </div>
            <button class="btn primary" id="step2Next" style="margin-top:12px;">Continue ‚Üí</button>
          </div>

          <div id="step3" style="display:none; margin-top:10px;">
            <div class="field">
              <div class="label">Company Logo (preferably no background)</div>
              <div class="fileWrap">
                <label class="fileBtn" for="coLogoFile">Choose Logo</label>
                <span style="color:var(--muted2);font-size:12px;" id="logoFileName">No file selected</span>
              </div>
              <input type="file" id="coLogoFile" accept="image/*" />
            </div>
            <button class="btn primary" id="step3Next" style="margin-top:12px;">Continue ‚Üí</button>
          </div>

          <div id="step4" style="display:none; margin-top:10px;">
            <div style="font-weight:800; margin-bottom:8px;">Tell Us About You</div>
            <div class="fieldRow">
              <div class="field">
                <div class="label">Full name</div>
                <input class="input" id="meName" placeholder="e.g. Finley Hassall" />
              </div>
              <div class="row2">
                <div class="field">
                  <div class="label">Job title</div>
                  <input class="input" id="meTitle" placeholder="e.g. Founder" />
                </div>
                <div class="field">
                  <div class="label">Job category</div>
                  <input class="input" id="meCat" placeholder="e.g. Senior management team" />
                </div>
              </div>

              <div class="check" style="margin-top:6px;">
                <div class="toggle" id="adminToggle" title="Admin access"></div>
                <div>
                  <div style="font-weight:750;font-size:13px;">Admin Access</div>
                  <div style="color:var(--muted2);font-size:12px;">Can manage employees & settings.</div>
                </div>
              </div>

              <button class="btn primary" id="finishOnboarding" style="margin-top:12px;">Finish ‚Üí</button>
            </div>
          </div>
        </div>

        <div class="card">
          <div style="font-weight:800;">Company Details</div>
          <div class="msg" id="companyMeta"></div>

          <div style="margin-top:12px; display:flex; flex-direction:column; gap:10px;">
            <div class="card" style="padding:12px;">
              <div style="font-weight:800;font-size:13px;">Company Code</div>
              <div style="color:var(--muted2);font-size:12px;" id="companyCode">‚Äî</div>
            </div>

            <div class="card" style="padding:12px;">
              <div style="font-weight:800;font-size:13px;">Company Colours</div>
              <div class="row2" style="margin-top:10px;">
                <input class="input" id="colPrimary" placeholder="Primary (e.g. #ff0000)" />
                <input class="input" id="colSecondary" placeholder="Secondary (e.g. #000000)" />
              </div>
              <div style="margin-top:10px;">
                <input class="input" id="colText" placeholder="Text (e.g. #ffffff)" />
              </div>
              <button class="btn primary" id="saveColours" style="margin-top:10px;">Save</button>
            </div>

            <div class="card" style="padding:12px;">
              <div style="font-weight:800;font-size:13px;">Owned Systems</div>
              <div style="color:var(--muted2);font-size:12px; margin-top:6px;" id="ownedList">‚Äî</div>
              <div style="margin-top:10px; display:flex; flex-wrap:wrap; gap:10px;" id="quickLinks"></div>
            </div>
          </div>
        </div>
      </div>

      <div class="card" style="padding:18px; margin-top:14px;">
        <div style="display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap;">
          <div>
            <div style="font-weight:900;">Employees</div>
            <div style="color:var(--muted2); font-size:12px;" id="empLimitLine">‚Äî</div>
          </div>
          <button class="btn primary" id="addEmpBtn">Add Employee</button>
        </div>

        <div id="empMsg" class="msg"></div>
        <div id="empList"></div>
      </div>
    </div>
  </section>

  <!-- Module Learn More Modal -->
  <div class="backdrop" id="learnModal">
    <div class="modal glass" role="dialog" aria-modal="true">
      <div class="modalHeader">
        <strong id="learnTitle">Module</strong>
        <button class="btn" id="learnClose">Close</button>
      </div>

      <div style="padding: 6px 10px 14px;">
        <div style="color:var(--muted); font-size:13px; line-height:1.7;" id="learnBody"></div>

        <div style="margin-top:14px;">
          <div class="card" style="padding:12px;">
            <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;">
              <div style="font-weight:900;">Preview</div>
              <a class="link" href="https://youtu.be/S2kymv60ndQ?si=7AGk-tN09k0g5qf3" target="_blank" rel="noreferrer">Open in YouTube</a>
            </div>
            <div style="margin-top:10px; border-radius:14px; overflow:hidden; border:1px solid rgba(255,255,255,.08);">
              <iframe
                title="Preview"
                width="100%"
                height="315"
                src="https://www.youtube.com/embed/S2kymv60ndQ"
                allowfullscreen
                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                style="display:block;border:0;background:#000;">
              </iframe>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Sign Up Owner Modal -->
  <div class="backdrop" id="signupModal">
    <div class="modal glass" role="dialog" aria-modal="true">
      <div class="modalHeader">
        <strong>Create Account</strong>
        <button class="btn" id="suClose">Close</button>
      </div>

      <div style="padding: 6px 10px 14px;">
        <div class="field">
          <div class="label">Company name</div>
          <input class="input" id="suCompany" />
        </div>
        <div class="field">
          <div class="label">Email</div>
          <input class="input" id="suEmail" type="email" />
        </div>

        <div class="field">
          <div class="label">Password</div>
          <div style="position:relative;">
            <input class="input" id="suPass" type="password" minlength="8" />
            <button class="btn" type="button" id="suEye" style="position:absolute;right:8px;top:7px;padding:8px 10px;">üëÅ</button>
          </div>
          <div class="label">Min 8 characters.</div>
        </div>

        <div id="suStepCode" style="display:none;">
          <div class="field">
            <div class="label">6-digit code</div>
            <input class="input" id="suCode" inputmode="numeric" maxlength="6" placeholder="Enter the code" />
            <div class="label">We sent a code to your email.</div>
          </div>
        </div>

        <div class="msg err" id="suMsg"></div>

        <div style="display:flex; gap:10px; margin-top: 12px; justify-content:flex-end; flex-wrap:wrap;">
          <button class="btn" id="suBack" style="display:none;">Back</button>
          <button class="btn primary" id="suContinue">Continue ‚Üí</button>
        </div>

        <div style="margin-top:14px;">
          <div style="color:var(--muted2); font-size:12px; line-height:1.5;">
            <div id="loginInsteadRow" style="margin-top:10px;">
              <a class="link" href="#" id="suLoginInstead">Log in instead</a>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Login Modal -->
  <div class="backdrop" id="loginModal">
    <div class="modal glass" role="dialog" aria-modal="true">
      <div class="modalHeader">
        <strong>Log In</strong>
        <button class="btn" id="liClose">Close</button>
      </div>

      <div style="padding: 6px 10px 14px;">
        <div class="field">
          <div class="label">Email</div>
          <input class="input" id="liEmail" type="email" />
        </div>
        <div class="field">
          <div class="label">Password</div>
          <input class="input" id="liPass" type="password" />
        </div>

        <div class="msg err" id="liMsg" style="display:none;"></div>

        <div style="display:flex; justify-content:flex-end; margin-top:12px;">
          <button class="btn primary" id="liGo">Log In ‚Üí</button>
        </div>

        <div style="margin-top:14px;">
          <div style="color:var(--muted2); font-size:12px;">
            <div style="margin-top:10px;">
              <a class="link" href="#" id="liNoAccount">Don‚Äôt have an account?</a>
            </div>
            <div style="margin-top:10px; display:none;" id="liBadCredsRow">
              <a class="link" href="#" id="liBadCreds">Incorrect credentials ‚Äî Forgot your password?</a>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Employee Signup Modal -->
  <div class="backdrop" id="empModal">
    <div class="modal glass" role="dialog" aria-modal="true">
      <div class="modalHeader">
        <strong>Employee Sign Up</strong>
        <button class="btn" id="empClose">Close</button>
      </div>

      <div style="padding: 6px 10px 14px;">
        <div class="field">
          <div class="label">Company code</div>
          <input class="input" id="empCompanyCode" placeholder="e.g. SMA624564" />
        </div>
        <div class="field">
          <div class="label">Full name (must match the company‚Äôs employee list)</div>
          <input class="input" id="empFullName" placeholder="e.g. Finley Hassall" />
        </div>
        <div class="field">
          <div class="label">Email</div>
          <input class="input" id="empEmail" type="email" />
        </div>
        <div class="field">
          <div class="label">Password</div>
          <input class="input" id="empPass" type="password" minlength="8" />
        </div>

        <div id="empStepCode" style="display:none;">
          <div class="field">
            <div class="label">6-digit code</div>
            <input class="input" id="empCode" inputmode="numeric" maxlength="6" placeholder="Enter the code" />
          </div>
        </div>

        <div class="msg err" id="empSUmsg"></div>

        <div style="display:flex; gap:10px; margin-top:12px; justify-content:flex-end; flex-wrap:wrap;">
          <button class="btn" id="empBack" style="display:none;">Back</button>
          <button class="btn primary" id="empContinue">Continue ‚Üí</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Generic Confirm Modal -->
  <div class="backdrop" id="confirmModal">
    <div class="modal glass" role="dialog" aria-modal="true" style="width:min(520px,100%);">
      <div class="modalHeader">
        <strong id="confirmTitle">Confirm</strong>
        <button class="btn" id="confirmClose">Close</button>
      </div>
      <div style="padding: 6px 10px 14px;">
        <div style="color:var(--muted); font-size:13px; line-height:1.6;" id="confirmText"></div>
        <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:14px;">
          <button class="btn" id="confirmNo">No</button>
          <button class="btn primary" id="confirmYes">Yes</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    /***********************
     * CONFIG
     ***********************/
    const SUPABASE_URL = "https://hjdpcfhozhoyeqevnupm.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhqZHBjZmhvemhveWVxZXZudXBtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY5MTk3MzYsImV4cCI6MjA4MjQ5NTczNn0.BXosJO4NmEZOe73GXSGPa3z-i_4ZzF9zBAMBIf6Mkts";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const $ = (id)=>document.getElementById(id);
    const show = (el)=> el.classList.add("show");
    const hide = (el)=> el.classList.remove("show");

    function titleCase(s){
      return (s||"").split(" ").map(w=>{
        if(!w) return w;
        if (w.length <= 2) return w.toLowerCase();
        return w[0].toUpperCase()+w.slice(1).toLowerCase();
      }).join(" ");
    }

    /***********************
     * ICONS (scattered, never behind text)
     ***********************/
    const ICON_SVGS = [
      `<svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="1.6"><path d="M12 5v14M5 12h14"/></svg>`,
      `<svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="1.6"><path d="M7 12l3 3 7-7"/></svg>`,
      `<svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="1.6"><path d="M12 2l7 4v12l-7 4-7-4V6l7-4z"/></svg>`,
      `<svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="1.6"><path d="M4 7h16M4 12h16M4 17h16"/></svg>`,
      `<svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="1.6"><path d="M8 11V7a4 4 0 118 0v4"/><rect x="6" y="11" width="12" height="10" rx="2"/></svg>`,
      `<svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="1.6"><circle cx="12" cy="12" r="7"/><path d="M12 8v4l3 2"/></svg>`,
      `<svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="1.6"><path d="M6 7h12v10H6z"/><path d="M9 7V4h6v3"/></svg>`,
      `<svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="1.6"><circle cx="12" cy="12" r="3"/><path d="M12 2v3M12 19v3M2 12h3M19 12h3"/></svg>`,
    ];

    function placeScatteredIcons(){
      const layer = $("iconLayer");
      layer.innerHTML = "";

      // Keep bubbles away from the center safe zone
      const safe = { x: 50, y: 50, w: 52, h: 48 }; // percent

      const bubbles = 8;
      for(let i=0;i<bubbles;i++){
        const b = document.createElement("div");
        b.className = "bubble";
        b.style.animationDelay = `${Math.random()*1.5}s`;

        // random size variation but not huge
        const size = 110 + Math.random()*55;
        b.style.width = `${size}px`;
        b.style.height = `${size}px`;

        // Find position not overlapping safe zone
        let x,y,tries=0;
        while(true){
          tries++;
          x = Math.random()*100;
          y = Math.random()*100;

          const inSafe =
            x > (safe.x - safe.w/2) && x < (safe.x + safe.w/2) &&
            y > (safe.y - safe.h/2) && y < (safe.y + safe.h/2);

          if(!inSafe) break;
          if(tries>60) break;
        }

        b.style.left = `calc(${x}% - ${size/2}px)`;
        b.style.top  = `calc(${y}% - ${size/2}px)`;

        const svg = ICON_SVGS[i % ICON_SVGS.length];
        b.innerHTML = svg;
        layer.appendChild(b);
      }
    }
    placeScatteredIcons();
    window.addEventListener("resize", placeScatteredIcons);

    /***********************
     * NAV hide on scroll down (show on scroll up)
     ***********************/
    let lastY = window.scrollY;
    window.addEventListener("scroll", ()=>{
      const y = window.scrollY;
      const nav = $("navWrap");

      const goingDown = y > lastY + 6;
      const goingUp   = y < lastY - 6;

      if (goingDown && y > 120) nav.classList.add("navHidden");
      if (goingUp) nav.classList.remove("navHidden");

      lastY = y;
    });

    /***********************
     * DATA: plans + modules
     ***********************/
    const COMPANY_SIZES = [
      { id:"up_to_25", label:"Up to 25 people", price:39, max:25, note:"¬£39 / month" },
      { id:"26_100", label:"26‚Äì100 people", price:79, max:100, note:"¬£79 / month" },
      { id:"101_250", label:"101‚Äì250 people", price:149, max:250, note:"¬£149 / month" },
      { id:"250_plus", label:"250+ people", price:null, max:null, note:"Contact us" },
    ];

    const MODULES = [
      {
        id:"presence_fire", name:"Presence & Fire Safety", price:10,
        learn:`A real-time presence system that shows exactly who is on site at any moment. Staff and visitors sign in and out digitally, creating a live evacuation list that can be used immediately during fire drills or real emergencies.

Designed to be simple, fast, and reliable when it matters most, with clear records for audits and incident reviews.`
      },
      {
        id:"policies_handbook", name:"Policies & Staff Handbook", price:7,
        learn:`A central location for company policies and staff handbooks, with tracking to show who has read and acknowledged each document. Managers can update policies, request re-acknowledgement, and view clear records at any time.

Helps organisations demonstrate that information has been issued and acknowledged without relying on paper or email chains.`
      },
      {
        id:"holiday_booking", name:"Holiday Booking", price:8,
        learn:`A straightforward holiday request and approval system that removes unnecessary back-and-forth. Staff submit requests, managers approve or decline, and teams can view upcoming absences in one place.

Intentionally simple and focused, with no payroll or salary management.`
      },
      {
        id:"accident_book", name:"Accident & Injury Book", price:3,
        learn:`A digital accident and injury reporting system that replaces paper accident books. Incidents can be logged quickly with notes, photos, and witness details, and records can be exported when required.

Keeps incident records organised, secure, and easy to access if they are ever needed.`
      },
      {
        id:"training_compliance", name:"Training & Compliance", price:9,
        learn:`Tracks training expiry dates, compliance requirements, and scheduled checks across the organisation. Automatic reminders help ensure nothing is missed, from fire drills to equipment inspections and vehicle compliance.

Designed to support consistency and oversight without adding unnecessary complexity.`
      },
      {
        id:"onboarding_offboarding", name:"Onboarding & Offboarding", price:8,
        learn:`Structured checklists for new starters and leavers, helping teams complete tasks consistently across departments. From access setup to equipment returns, nothing is forgotten.

Provides a clear record of what was completed and when, supporting smoother staff transitions.`
      },
      {
        id:"expenses_upload", name:"Expenses Upload", price:6,
        learn:`Allows staff to upload receipts digitally with notes and categories, removing the need to collect paper receipts. Submissions can be reviewed and exported for accounting or payroll systems.

Keeps expense handling simple, organised, and traceable.`
      },
      {
        id:"wellbeing_check", name:"Wellbeing Check", price:4,
        learn:`A lightweight wellbeing check-in that allows staff to quickly select one of three options:

üôÇ Positive (green)
üòê Neutral (amber)
üôÅ Concerned (red)

Over time, this provides managers with a simple, high-level view of wellbeing trends across teams, helping highlight when additional attention may be needed.

No medical data, no intrusive questions ‚Äî just a clear, visual pulse check designed to support awareness while respecting privacy.`
      }
    ];

    let selectedSize = null;
    let selectedMods = new Set();

    function money(n){
      if (n == null) return "‚Äî";
      return "¬£" + Number(n).toFixed(0);
    }

    function renderSizes(){
      const grid = $("sizeGrid");
      grid.innerHTML = "";
      COMPANY_SIZES.forEach(s=>{
        const d = document.createElement("div");
        d.className = "sizeCard";
        d.innerHTML = `
          <div style="min-width:0;">
            <div style="font-weight:900;font-size:13px;">${s.label}</div>
            <div style="color:var(--muted2);font-size:12px;margin-top:4px;">${s.note}</div>
          </div>
          <div class="tick ${selectedSize?.id===s.id?'on':''}"></div>
        `;
        d.addEventListener("click", ()=>selectSize(s.id));
        if (selectedSize?.id===s.id) d.classList.add("selected");
        grid.appendChild(d);
      });
    }

    function selectSize(id){
      selectedSize = COMPANY_SIZES.find(x=>x.id===id);
      selectedMods = new Set(); // reset modules when size changes

      $("planSummary").textContent = selectedSize.label;

      // 250+ special box
      const is250 = selectedSize.id === "250_plus";
      $("size250Box").style.display = is250 ? "block" : "none";

      // modules shown for ALL sizes including 250+
      $("modulesWrap").style.display = "block";

      $("checkoutBtn").disabled = true;
      updateTotals();
      renderSizes();
      renderMods();
    }

    function renderMods(){
      const grid = $("modGrid");
      grid.innerHTML = "";

      MODULES.forEach(m=>{
        const on = selectedMods.has(m.id);
        const card = document.createElement("div");
        card.className = "modCard" + (on ? " selected" : "");
        card.innerHTML = `
          <div class="modMeta">
            <div class="modName">${m.name}</div>
            <div class="modPrice">${money(m.price)} / month</div>
            <div class="modActions">
              <button class="btn learnBtn" type="button" data-learn="${m.id}">Learn more</button>
            </div>
          </div>
          <div class="tick ${on ? "on" : ""}"></div>
        `;

        // toggle select on card click (but not on learn more click)
        card.addEventListener("click", (e)=>{
          if (e.target && e.target.closest && e.target.closest("[data-learn]")) return;
          if (!selectedSize) return;

          if (selectedMods.has(m.id)) selectedMods.delete(m.id);
          else selectedMods.add(m.id);

          updateTotals();
          renderMods();
        });

        // learn more
        card.querySelector("[data-learn]").addEventListener("click", ()=>{
          $("learnTitle").textContent = m.name;
          $("learnBody").textContent = m.learn;
          show($("learnModal"));
        });

        grid.appendChild(card);
      });
    }

    function updateTotals(){
      const size = selectedSize;
      const mods = Array.from(selectedMods).map(id=>MODULES.find(m=>m.id===id)).filter(Boolean);

      let total = 0;
      if (size && size.price != null) total += size.price;
      mods.forEach(m=> total += m.price || 0);

      // If 250+ plan, the normal checkout becomes "Contact Us"
      const is250 = size?.id === "250_plus";

      $("totalLine").textContent = is250 ? "Contact us" : `${money(total)} / month`;
      $("totalHint").textContent = size ? (is250 ? "Tell us your size and modules" : `${size.label} ¬∑ ${mods.length} module${mods.length===1?'':'s'}`) : "Select a company size to begin";

      // enable checkout only if size selected and at least 1 module selected
      const canContinue = !!size && selectedMods.size > 0 && !is250;
      $("checkoutBtn").disabled = !canContinue;

      // 250+ contact button logic
      if (is250){
        const approx = Number($("approxSize").value || 0);
        const canContact = approx >= 1 && selectedMods.size > 0;
        $("contact250Btn").disabled = !canContact;
      }
    }

    renderSizes();

    // 250+ input behavior + warning
    $("approxSize").addEventListener("input", ()=>{
      const v = Number($("approxSize").value || 0);
      const warn = v > 0 && v < 250;
      $("approxWarn").style.display = warn ? "block" : "none";
      updateTotals();
    });

    // 250+ Contact Us click -> mailto
    $("contact250Btn").addEventListener("click", ()=>{
      const approx = Number($("approxSize").value || 0);
      if (!approx) return;

      // warn confirmation if < 250
      if (approx < 250){
        confirmDialog(
          "Check Company Size",
          "You entered a company size under 250, but selected the 250+ plan. Are you sure you want to continue with this package?",
          ()=>{
            open250Email(approx);
          }
        );
        return;
      }
      open250Email(approx);
    });

    function open250Email(approx){
      const mods = Array.from(selectedMods).map(id=>MODULES.find(m=>m.id===id)?.name).filter(Boolean);
      const subject = `250+ Person Company - Wanting to Sign Up`;
      const body =
`Hello SmartCore Technology,

We would like to enquire about signing up for SmartCore Technology.

Approx company size: ${approx}

Modules of interest:
${mods.map(m=>"‚Ä¢ "+m).join("\n")}

Please let us know next steps, pricing, and onboarding.

Kind regards,
(Your name)
(Company name)`;

      const mailto = `mailto:support@smartcoretechnology.co.uk?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
      window.location.href = mailto;
    }

    /***********************
     * Learn modal close
     ***********************/
    $("learnClose").addEventListener("click", ()=>hide($("learnModal")));
    $("learnModal").addEventListener("click", (e)=>{ if(e.target === $("learnModal")) hide($("learnModal")); });

    /***********************
     * Scroll down button
     ***********************/
    $("scrollDownBtn").addEventListener("click", ()=>{
      $("plan").scrollIntoView({ behavior:"smooth", block:"start" });
    });
    $("buildPlanBtn").addEventListener("click", ()=>{
      $("plan").scrollIntoView({ behavior:"smooth", block:"start" });
    });

    /***********************
     * CONFIRM modal helper
     ***********************/
    let confirmYesCb = null;
    function confirmDialog(title, text, yesCb){
      confirmYesCb = yesCb;
      $("confirmTitle").textContent = title;
      $("confirmText").textContent = text;
      show($("confirmModal"));
    }
    $("confirmClose").addEventListener("click", ()=>hide($("confirmModal")));
    $("confirmNo").addEventListener("click", ()=>hide($("confirmModal")));
    $("confirmYes").addEventListener("click", ()=>{
      hide($("confirmModal"));
      if (typeof confirmYesCb === "function") confirmYesCb();
      confirmYesCb = null;
    });

    /***********************
     * API helpers
     ***********************/
    async function apiPost(path, payload, token){
      const res = await fetch(path, {
        method: "POST",
        headers: {
          "content-type":"application/json",
          ...(token ? { "authorization": `Bearer ${token}` } : {})
        },
        body: JSON.stringify(payload || {})
      });
      const text = await res.text();
      let data = null;
      try { data = JSON.parse(text); } catch { data = text; }
      if (!res.ok) throw new Error(typeof data === "string" ? data : (data.error || data.message || "Request failed"));
      return data;
    }

    /***********************
     * AUTH modals / flow
     * Owner: Continue -> send code, then Continue -> verify/create, then dashboard
     ***********************/
    let pendingSignup = null;

    function openSignup(){
      $("suMsg").textContent = "";
      $("suStepCode").style.display = "none";
      $("suBack").style.display = "none";
      $("suContinue").textContent = "Continue ‚Üí";

      $("suCompany").value = "";
      $("suEmail").value = "";
      $("suPass").value = "";
      $("suCode").value = "";

      pendingSignup = null;
      show($("signupModal"));
    }

    $("checkoutBtn").addEventListener("click", ()=>{
      // if email already exists we handle that in verify function / API response too
      openSignup();
      $("suCompany").value = ($("suCompany").value || "").trim();
    });

    $("suClose").addEventListener("click", ()=>hide($("signupModal")));
    $("signupModal").addEventListener("click", (e)=>{ if(e.target === $("signupModal")) hide($("signupModal")); });

    $("suEye").addEventListener("click", ()=>{
      const inp = $("suPass");
      inp.type = inp.type === "password" ? "text" : "password";
    });

    $("suLoginInstead").addEventListener("click", (e)=>{
      e.preventDefault();
      hide($("signupModal"));
      openLogin();
    });

    $("loginTopBtn").addEventListener("click", openLogin);

    function openLogin(){
      $("liMsg").style.display = "none";
      $("liMsg").textContent = "";
      $("liBadCredsRow").style.display = "none";
      $("liEmail").value = "";
      $("liPass").value = "";
      show($("loginModal"));
    }

    $("liClose").addEventListener("click", ()=>hide($("loginModal")));
    $("loginModal").addEventListener("click", (e)=>{ if(e.target === $("loginModal")) hide($("loginModal")); });

    $("liNoAccount").addEventListener("click", (e)=>{
      e.preventDefault();
      confirmDialog(
        "Sign Up Options",
        "If your company is already using SmartCore, choose ‚ÄúSign Up As An Employee‚Äù. Otherwise, build your plan, select modules, and create your account to join SmartCore.",
        ()=>{
          hide($("loginModal"));
        }
      );
    });

    $("liBadCreds").addEventListener("click", async (e)=>{
      e.preventDefault();
      const email = $("liEmail").value.trim().toLowerCase();
      if (!email) return;
      try{
        await apiPost("/api/request-password-reset", { email });
        $("liMsg").style.display = "block";
        $("liMsg").textContent = "Password reset email sent. Please check your inbox.";
      }catch(err){
        $("liMsg").style.display = "block";
        $("liMsg").textContent = err.message || "Failed to send reset email.";
      }
    });

    $("liGo").addEventListener("click", async ()=>{
      $("liMsg").style.display = "none";
      $("liMsg").textContent = "";

      const email = $("liEmail").value.trim().toLowerCase();
      const password = $("liPass").value;

      try{
        const { data, error } = await supabase.auth.signInWithPassword({ email, password });
        if (error) throw error;

        hide($("loginModal"));
        await routeToDashboard();
      }catch(err){
        $("liBadCredsRow").style.display = "block";
        $("liMsg").style.display = "block";
        $("liMsg").textContent = "Incorrect credentials.";
      }
    });

    // Owner signup flow
    $("suContinue").addEventListener("click", async ()=>{
      $("suMsg").textContent = "";

      // Step A: collect and send code
      if (!pendingSignup){
        const company_name = $("suCompany").value.trim();
        const email = $("suEmail").value.trim().toLowerCase();
        const password = $("suPass").value;

        if (!company_name) { $("suMsg").textContent = "Enter your company name."; return; }
        if (!email) { $("suMsg").textContent = "Enter your email."; return; }
        if (!password || password.length < 8) { $("suMsg").textContent = "Password must be at least 8 characters."; return; }
        if (!selectedSize) { $("suMsg").textContent = "Select a company size first."; return; }
        if (selectedMods.size === 0) { $("suMsg").textContent = "Select at least one module."; return; }

        // Save pending plan details
        pendingSignup = {
          company_name,
          email,
          password,
          company_size: selectedSize.id,
          module_ids: Array.from(selectedMods)
        };

        // send code
        $("suContinue").disabled = true;
        try{
          await apiPost("/api/send-code", { email, purpose:"owner_signup" });
          $("suStepCode").style.display = "block";
          $("suBack").style.display = "inline-flex";
          $("suContinue").textContent = "Continue ‚Üí"; // user request
          $("suMsg").textContent = "";
        }catch(err){
          const msg = String(err.message||"");
          if (msg.toLowerCase().includes("already")){
            $("suMsg").textContent = "This email is already registered to a SmartCore account ‚Äî Log in instead?";
          } else {
            $("suMsg").textContent = msg;
          }
        }finally{
          $("suContinue").disabled = false;
        }
        return;
      }

      // Step B: verify and create
      const code = $("suCode").value.trim();
      if (!code || code.length !== 6) { $("suMsg").textContent = "Enter the 6-digit code."; return; }

      // NOTE: full_name collected later during onboarding; we send placeholder here for profile
      const payload = {
        purpose: "owner_signup",
        email: pendingSignup.email,
        code,
        password: pendingSignup.password,
        company_name: pendingSignup.company_name,
        company_size: pendingSignup.company_size,
        module_ids: pendingSignup.module_ids
      };

      $("suContinue").disabled = true;
      try{
        const out = await apiPost("/api/verify-code", payload);
        // login immediately
        const { data, error } = await supabase.auth.signInWithPassword({ email: pendingSignup.email, password: pendingSignup.password });
        if (error) throw error;

        hide($("signupModal"));
        await routeToDashboard();
      }catch(err){
        $("suMsg").textContent = err.message || "Create account failed.";
      }finally{
        $("suContinue").disabled = false;
      }
    });

    $("suBack").addEventListener("click", ()=>{
      pendingSignup = null;
      $("suStepCode").style.display = "none";
      $("suBack").style.display = "none";
      $("suContinue").textContent = "Continue ‚Üí";
      $("suMsg").textContent = "";
    });

    /***********************
     * Employee signup flow (checks employees table server-side BEFORE code send)
     ***********************/
    let pendingEmp = null;

    $("employeeBtn").addEventListener("click", ()=>{
      $("empSUmsg").textContent = "";
      $("empStepCode").style.display = "none";
      $("empBack").style.display = "none";
      $("empContinue").textContent = "Continue ‚Üí";
      $("empCompanyCode").value = "";
      $("empFullName").value = "";
      $("empEmail").value = "";
      $("empPass").value = "";
      $("empCode").value = "";
      pendingEmp = null;
      show($("empModal"));
    });

    $("empClose").addEventListener("click", ()=>hide($("empModal")));
    $("empModal").addEventListener("click", (e)=>{ if(e.target === $("empModal")) hide($("empModal")); });

    $("empContinue").addEventListener("click", async ()=>{
      $("empSUmsg").textContent = "";

      if (!pendingEmp){
        const company_code = $("empCompanyCode").value.trim().toUpperCase();
        const full_name = $("empFullName").value.trim();
        const email = $("empEmail").value.trim().toLowerCase();
        const password = $("empPass").value;

        if (!company_code) { $("empSUmsg").textContent = "Enter your company code."; return; }
        if (!full_name) { $("empSUmsg").textContent = "Enter your full name."; return; }
        if (!email) { $("empSUmsg").textContent = "Enter your email."; return; }
        if (!password || password.length < 8) { $("empSUmsg").textContent = "Password must be at least 8 characters."; return; }

        pendingEmp = { company_code, full_name, email, password };

        $("empContinue").disabled = true;
        try{
          await apiPost("/api/send-code", {
            email,
            purpose:"employee_signup",
            company_code,
            full_name
          });

          $("empStepCode").style.display = "block";
          $("empBack").style.display = "inline-flex";
          $("empContinue").textContent = "Continue ‚Üí";
        }catch(err){
          $("empSUmsg").textContent = err.message || "Could not send code.";
          pendingEmp = null;
        }finally{
          $("empContinue").disabled = false;
        }
        return;
      }

      const code = $("empCode").value.trim();
      if (!code || code.length !== 6) { $("empSUmsg").textContent = "Enter the 6-digit code."; return; }

      $("empContinue").disabled = true;
      try{
        await apiPost("/api/verify-code", {
          purpose:"employee_signup",
          email: pendingEmp.email,
          code,
          password: pendingEmp.password,
          company_code: pendingEmp.company_code,
          full_name: pendingEmp.full_name
        });

        const { data, error } = await supabase.auth.signInWithPassword({ email: pendingEmp.email, password: pendingEmp.password });
        if (error) throw error;

        hide($("empModal"));
        await routeToDashboard();
      }catch(err){
        $("empSUmsg").textContent = err.message || "Create employee account failed.";
      }finally{
        $("empContinue").disabled = false;
      }
    });

    $("empBack").addEventListener("click", ()=>{
      pendingEmp = null;
      $("empStepCode").style.display = "none";
      $("empBack").style.display = "none";
      $("empContinue").textContent = "Continue ‚Üí";
      $("empSUmsg").textContent = "";
    });

    /***********************
     * DASHBOARD ROUTING
     ***********************/
    function showDashboard(){
      $("dash").classList.add("show");
      $("home").style.display = "none";
      $("plan").style.display = "none";
      window.scrollTo({ top: 0, behavior: "instant" });
    }
    function showHome(){
      $("dash").classList.remove("show");
      $("home").style.display = "";
      $("plan").style.display = "";
    }

    $("signOutBtn").addEventListener("click", async ()=>{
      await supabase.auth.signOut();
      showHome();
      window.location.hash = "";
      // back to top
      window.scrollTo({ top: 0, behavior: "smooth" });
    });

    $("buyMoreBtn").addEventListener("click", ()=>{
      // for now just back to plan
      showHome();
      $("plan").scrollIntoView({ behavior:"smooth", block:"start" });
    });

    // Dashboard state
    let currentCompany = null;
    let currentProfile = null;
    let ownedModules = [];
    let employees = [];

    async function routeToDashboard(){
      const { data: sess } = await supabase.auth.getSession();
      const token = sess?.session?.access_token;
      if (!token) return;

      // fetch dashboard data
      const data = await apiPost("/api/get-dashboard", {}, token);

      currentCompany = data.company || null;
      currentProfile = data.profile || null;
      ownedModules = data.modules || [];
      employees = data.employees || [];

      showDashboard();
      renderDashboard();
      // onboarding gate
      startOnboardingFlow();
    }

    function renderDashboard(){
      const companyName = currentCompany?.company_name || "Your Company";
      $("dashTitle").textContent = companyName;
      $("dashSub").textContent = `Company code: ${currentCompany?.company_code || "‚Äî"} ¬∑ Plan: ${currentCompany?.company_size || "‚Äî"}`;

      $("companyCode").textContent = currentCompany?.company_code || "‚Äî";
      $("companyMeta").textContent = currentCompany
        ? `${currentCompany.company_name || ""}${currentCompany.address ? " ¬∑ " + currentCompany.address : ""}`
        : "No company found yet.";

      // colours
      $("colPrimary").value = currentCompany?.primary_color || "";
      $("colSecondary").value = currentCompany?.secondary_color || "";
      $("colText").value = currentCompany?.text_color || "";

      // owned systems list + quick links (only owned)
      $("ownedList").textContent = ownedModules.length ? ownedModules.map(m=>m.name).join(" ¬∑ ") : "No systems yet.";
      const q = $("quickLinks");
      q.innerHTML = "";
      ownedModules.forEach(m=>{
        const a = document.createElement("a");
        a.className = "btn";
        a.href = "https://smartcoretechnology.co.uk"; // per request (temporary)
        a.target = "_blank";
        a.rel = "noreferrer";
        a.textContent = titleCase(m.name);
        q.appendChild(a);
      });

      // employee limit line
      const max = currentCompany?.max_employees ?? null;
      const used = employees.length;
      $("empLimitLine").textContent = (max ? `Employees: ${used} / ${max}` : `Employees: ${used}`);

      renderEmployees();
    }

    function startOnboardingFlow(){
      // If company missing details -> step through
      const needsCompanyName = !currentCompany?.company_name;
      const needsAddr = !currentCompany?.address;
      const needsLogo = !currentCompany?.logo_url;
      const needsMe = !(currentProfile?.full_name && currentProfile?.job_title && currentProfile?.job_category);

      // preload company name in onboarding input
      $("coName").value = currentCompany?.company_name || "";
      $("coAddr").value = currentCompany?.address || "";

      // Steps in order
      let step = 1;
      if (!needsCompanyName) step = 2;
      if (!needsCompanyName && !needsAddr) step = 3;
      if (!needsCompanyName && !needsAddr && !needsLogo) step = 4;
      if (!needsCompanyName && !needsAddr && !needsLogo && !needsMe) {
        // done
        setStep(0);
        $("onboardMsg").textContent = "Onboarding complete.";
        $("onboardStep").textContent = "Complete";
        return;
      }
      setStep(step);
    }

    function setStep(n){
      $("step1").style.display = (n===1) ? "block" : "none";
      $("step2").style.display = (n===2) ? "block" : "none";
      $("step3").style.display = (n===3) ? "block" : "none";
      $("step4").style.display = (n===4) ? "block" : "none";

      if (n>=1 && n<=4) $("onboardStep").textContent = `Step ${n} of 4`;
      if (n===0) $("onboardStep").textContent = "Complete";
    }

    $("coLogoFile").addEventListener("change", ()=>{
      const f = $("coLogoFile").files?.[0];
      $("logoFileName").textContent = f ? f.name : "No file selected";
    });

    async function token(){
      const { data } = await supabase.auth.getSession();
      return data?.session?.access_token || null;
    }

    $("step1Next").addEventListener("click", async ()=>{
      const name = $("coName").value.trim();
      if (!name) { $("onboardMsg").textContent="Enter your company name."; return; }
      try{
        $("onboardMsg").textContent="";
        const t = await token();
        const out = await apiPost("/api/update-company", { company_name:name }, t);
        currentCompany = out.company;
        setStep(2);
        renderDashboard();
      }catch(e){ $("onboardMsg").textContent = e.message; }
    });

    $("step2Next").addEventListener("click", async ()=>{
      const address = $("coAddr").value.trim();
      if (!address) { $("onboardMsg").textContent="Enter your company address."; return; }
      try{
        $("onboardMsg").textContent="";
        const t = await token();
        const out = await apiPost("/api/update-company", { address }, t);
        currentCompany = out.company;
        setStep(3);
        renderDashboard();
      }catch(e){ $("onboardMsg").textContent = e.message; }
    });

    $("step3Next").addEventListener("click", async ()=>{
      const f = $("coLogoFile").files?.[0];
      if (!f) { $("onboardMsg").textContent="Choose a logo file."; return; }

      // For now: store as base64 in DB (quick & works on Pages). Later you can move to Supabase Storage.
      try{
        $("onboardMsg").textContent="";
        const base64 = await fileToBase64(f);
        const t = await token();
        const out = await apiPost("/api/update-company", { logo_url: base64 }, t);
        currentCompany = out.company;
        setStep(4);
        renderDashboard();
      }catch(e){ $("onboardMsg").textContent = e.message; }
    });

    function fileToBase64(file){
      return new Promise((resolve,reject)=>{
        const r = new FileReader();
        r.onload = ()=> resolve(r.result);
        r.onerror = ()=> reject(new Error("Failed to read file"));
        r.readAsDataURL(file);
      });
    }

    // Admin toggle (owner is role; admin is optional checkbox)
    let adminOn = false;
    $("adminToggle").addEventListener("click", ()=>{
      adminOn = !adminOn;
      $("adminToggle").classList.toggle("on", adminOn);
    });

    $("finishOnboarding").addEventListener("click", async ()=>{
      const full_name = $("meName").value.trim();
      const job_title = $("meTitle").value.trim();
      const job_category = $("meCat").value.trim();

      if (!full_name || !job_title || !job_category){
        $("onboardMsg").textContent = "Please fill in your details.";
        return;
      }

      try{
        $("onboardMsg").textContent="";
        const t = await token();
        const out = await apiPost("/api/update-profile", {
          full_name, job_title, job_category,
          role: "owner",
          is_admin: !!adminOn,
          company_name: currentCompany?.company_name || null
        }, t);

        currentProfile = out.profile;
        setStep(0);
        $("onboardMsg").textContent="Onboarding complete.";
        $("onboardStep").textContent="Complete";
      }catch(e){
        $("onboardMsg").textContent = e.message;
      }
    });

    // Save colours in company settings
    $("saveColours").addEventListener("click", async ()=>{
      try{
        const t = await token();
        const out = await apiPost("/api/update-company", {
          primary_color: $("colPrimary").value.trim() || null,
          secondary_color: $("colSecondary").value.trim() || null,
          text_color: $("colText").value.trim() || null,
        }, t);
        currentCompany = out.company;
        renderDashboard();
      }catch(e){
        $("companyMeta").textContent = e.message;
      }
    });

    /***********************
     * EMPLOYEES
     ***********************/
    $("addEmpBtn").addEventListener("click", ()=>openAddEmployee());

    function openAddEmployee(){
      // reuse confirm modal as a mini form? We'll do a simple prompt flow with confirm modal inputs not ideal.
      // Instead, open Learn modal as a small input form:
      $("learnTitle").textContent = "Add Employee";
      $("learnBody").innerHTML = `
        <div class="field">
          <div class="label">Full name</div>
          <input class="input" id="empNameInp" placeholder="e.g. Finley Hassall">
        </div>
        <div class="row2">
          <div class="field">
            <div class="label">Job title</div>
            <input class="input" id="empTitleInp" placeholder="e.g. Engineer">
          </div>
          <div class="field">
            <div class="label">Job category</div>
            <input class="input" id="empCatInp" placeholder="e.g. Operations">
          </div>
        </div>
        <div style="margin-top:12px; display:flex; justify-content:flex-end;">
          <button class="btn primary" id="empAddConfirm">Add Employee ‚Üí</button>
        </div>
      `;
      show($("learnModal"));

      setTimeout(()=>{
        const btn = document.getElementById("empAddConfirm");
        if (!btn) return;
        btn.addEventListener("click", addEmployee);
      }, 0);
    }

    async function addEmployee(){
      $("empMsg").textContent = "";

      const full_name = document.getElementById("empNameInp")?.value?.trim() || "";
      const job_title = document.getElementById("empTitleInp")?.value?.trim() || "";
      const job_category = document.getElementById("empCatInp")?.value?.trim() || "";

      if (!full_name) { $("empMsg").textContent = "Enter a name."; return; }

      try{
        const t = await token();
        const out = await apiPost("/api/add-employee", { full_name, job_title, job_category }, t);

        employees = out.employees || employees;
        currentCompany = out.company || currentCompany;

        hide($("learnModal"));
        renderDashboard();
      }catch(e){
        $("empMsg").textContent = e.message;
      }
    }

    function renderEmployees(){
      const list = $("empList");
      list.innerHTML = "";
      employees.forEach(emp=>{
        const row = document.createElement("div");
        row.className = "empRow";
        row.innerHTML = `
          <div class="empMeta">
            <strong>${emp.full_name || "‚Äî"} <span style="color:var(--muted2);font-weight:700;">¬∑ ${emp.employee_id || ""}</span></strong>
            <span>${[emp.job_title, emp.job_category].filter(Boolean).join(" ¬∑ ")}</span>
          </div>

          <button class="iconBtn" title="Edit" data-edit="${emp.id}">
            <svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="1.8">
              <path d="M12 20h9"/>
              <path d="M16.5 3.5a2.1 2.1 0 013 3L8 18l-4 1 1-4 11.5-11.5z"/>
            </svg>
          </button>

          <button class="iconBtn danger" title="Remove" data-del="${emp.id}">
            <svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="1.8">
              <path d="M18 6L6 18M6 6l12 12"/>
            </svg>
          </button>
        `;
        list.appendChild(row);

        row.querySelector("[data-edit]").addEventListener("click", ()=>editEmployee(emp));
        row.querySelector("[data-del]").addEventListener("click", ()=>deleteEmployee(emp));
      });
    }

    function editEmployee(emp){
      $("learnTitle").textContent = "Edit Employee";
      $("learnBody").innerHTML = `
        <div style="color:var(--muted2);font-size:12px;margin-bottom:10px;">Employee ID stays the same: <strong>${emp.employee_id}</strong></div>
        <div class="field">
          <div class="label">Full name</div>
          <input class="input" id="eeName" value="${escapeHtml(emp.full_name||"")}">
        </div>
        <div class="row2">
          <div class="field">
            <div class="label">Job title</div>
            <input class="input" id="eeTitle" value="${escapeHtml(emp.job_title||"")}">
          </div>
          <div class="field">
            <div class="label">Job category</div>
            <input class="input" id="eeCat" value="${escapeHtml(emp.job_category||"")}">
          </div>
        </div>
        <div style="margin-top:12px; display:flex; justify-content:flex-end;">
          <button class="btn primary" id="eeSave">Save ‚Üí</button>
        </div>
      `;
      show($("learnModal"));
      setTimeout(()=>{
        document.getElementById("eeSave")?.addEventListener("click", async ()=>{
          try{
            const t = await token();
            const out = await apiPost("/api/update-employee", {
              id: emp.id,
              full_name: document.getElementById("eeName").value.trim(),
              job_title: document.getElementById("eeTitle").value.trim(),
              job_category: document.getElementById("eeCat").value.trim()
            }, t);

            employees = out.employees || employees;
            hide($("learnModal"));
            renderDashboard();
          }catch(e){
            $("empMsg").textContent = e.message;
          }
        });
      },0);
    }

    function deleteEmployee(emp){
      const companyName = currentCompany?.company_name || "your company";
      const apost = companyName.endsWith("s") ? "'" : "'s";
      const msg = `Are you sure you would like to remove ${emp.full_name} from ${companyName}${apost} SmartDatabase? This action can not be undone.`;

      confirmDialog("Remove Employee", msg, async ()=>{
        try{
          const t = await token();
          const out = await apiPost("/api/delete-employee", { id: emp.id }, t);
          employees = out.employees || employees;
          renderDashboard();
        }catch(e){
          $("empMsg").textContent = e.message;
        }
      });
    }

    function escapeHtml(s){
      return String(s).replace(/[&<>"']/g, c=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[c]));
    }

    /***********************
     * Initial: if already signed in -> dashboard
     ***********************/
    (async ()=>{
      const { data } = await supabase.auth.getSession();
      if (data?.session?.access_token){
        try{ await routeToDashboard(); }catch{ /* ignore */ }
      }
    })();

    // Close learn modal (click outside)
    $("learnModal").addEventListener("click", (e)=>{ if(e.target === $("learnModal")) hide($("learnModal")); });

    // Clear plan
    $("clearPlanBtn").addEventListener("click", ()=>{
      selectedSize = null;
      selectedMods = new Set();
      $("modulesWrap").style.display = "none";
      $("size250Box").style.display = "none";
      $("planSummary").textContent = "Select a company size";
      updateTotals();
      renderSizes();
      $("modGrid").innerHTML = "";
    });

    // Keep totals updated
    document.addEventListener("click", ()=>{
      updateTotals();
    });
  </script>
</body>
</html>
