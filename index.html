<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SmartCore Technology</title>

  <!-- Tailwind (CDN ok for now while building) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Inter -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

  <!-- Supabase JS v2 -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root{
      --bg0:#020617;      /* near-black */
      --bg1:#06153a;      /* deep navy */
      --panelA: rgba(8, 12, 28, .62);
      --panelB: rgba(8, 12, 28, .45);
      --stroke: rgba(255,255,255,.12);
      --stroke2: rgba(255,255,255,.08);
      --text: #eaf0ff;
      --muted: rgba(234,240,255,.74);
      --muted2: rgba(234,240,255,.58);
      --accent: rgba(120,170,255,.95);
      --accentSoft: rgba(120,170,255,.18);
      --shadow: 0 26px 80px rgba(0,0,0,.55);
      --shadow2: 0 18px 55px rgba(0,0,0,.45);
      --r1: 22px;
      --r2: 16px;
      --blur: 16px;
    }

    html,body{height:100%}
    body{
      margin:0;
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color: var(--text);
      background:
        radial-gradient(1100px 800px at 50% 10%, rgba(70,120,255,.20), transparent 60%),
        radial-gradient(1200px 900px at 50% 60%, rgba(35,80,220,.14), transparent 62%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      overflow-x:hidden;
    }

    /* Glass */
    .glass{
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04));
      border:1px solid var(--stroke);
      backdrop-filter: blur(var(--blur));
      -webkit-backdrop-filter: blur(var(--blur));
      border-radius: var(--r1);
      box-shadow: var(--shadow);
    }
    .glass2{
      background: rgba(255,255,255,.045);
      border:1px solid var(--stroke2);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      border-radius: var(--r2);
      box-shadow: var(--shadow2);
    }

    /* Subtle animation */
    .fadeUp{
      opacity:0;
      transform: translateY(10px);
      transition: opacity .45s ease, transform .45s ease;
    }
    .fadeUp.in{
      opacity:1;
      transform: translateY(0);
    }

    /* Nav hide animation */
    .navHide{
      transform: translateY(-120%);
      transition: transform .28s ease;
    }
    .navShow{
      transform: translateY(0);
      transition: transform .28s ease;
    }

    /* Hero */
    .hero{
      min-height: 100vh;
      position: relative;
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 120px 16px 80px;
      overflow:hidden;
    }

    /* Icon bubbles */
    .iconField{
      position:absolute;
      inset:0;
      pointer-events:none;
      z-index:0;
    }
    .bubble{
      position:absolute;
      width:110px;
      height:110px;
      border-radius:999px;
      background: rgba(255,255,255,.04);
      border:1px solid rgba(255,255,255,.10);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      display:flex;
      align-items:center;
      justify-content:center;
      box-shadow: 0 18px 50px rgba(0,0,0,.35);
      opacity:.35;
      transform: translate3d(var(--tx,0px), var(--ty,0px), 0);
      transition: transform .12s ease;
    }
    .bubble svg{
      width:44px;
      height:44px;
      opacity:.9;
    }

    /* Modal */
    .modalBackdrop{
      position:fixed;
      inset:0;
      background: rgba(0,0,0,.62);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:50;
      padding: 18px;
    }
    .modalBackdrop.show{display:flex;}
    .modal{
      max-width: 980px;
      width: 100%;
      max-height: 86vh;
      overflow: auto;
      border-radius: 20px;
    }
    .noScroll{overflow:hidden;}

    /* Form inputs */
    .inp{
      width:100%;
      border-radius: 14px;
      border:1px solid var(--stroke2);
      background: rgba(255,255,255,.05);
      padding: 12px 12px;
      outline:none;
      color: var(--text);
    }
    .inp::placeholder{color: rgba(234,240,255,.45);}
    .inp:focus{
      border-color: rgba(120,170,255,.35);
      box-shadow: 0 0 0 3px rgba(120,170,255,.10);
    }

    /* Custom file */
    input[type="file"]{display:none;}
    .fileBtn{
      display:inline-flex;
      align-items:center;
      gap:10px;
      padding: 11px 14px;
      border-radius: 14px;
      border:1px solid var(--stroke2);
      background: rgba(255,255,255,.05);
      cursor:pointer;
      transition: background .15s ease;
      user-select:none;
    }
    .fileBtn:hover{background: rgba(255,255,255,.08);}

    /* Custom checkbox */
    .chkWrap{display:flex; align-items:center; gap:10px; user-select:none; cursor:pointer;}
    .chk{
      width:18px; height:18px; border-radius:6px;
      border:1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.04);
      display:flex; align-items:center; justify-content:center;
      transition: background .15s ease, border-color .15s ease;
    }
    .chk.on{
      background: rgba(120,170,255,.22);
      border-color: rgba(120,170,255,.38);
    }

    /* Eye hover: subtle (no “drop” effect) */
    .eyeBtn{
      border:1px solid var(--stroke2);
      background: rgba(255,255,255,.04);
      border-radius: 12px;
      padding: 10px 12px;
      transition: transform .10s ease, background .10s ease;
      transform-origin:center;
    }
    .eyeBtn:hover{
      background: rgba(255,255,255,.07);
      transform: scale(0.96);
    }

    /* Card selected */
    .selected{
      outline: 2px solid rgba(120,170,255,.30);
      background: rgba(120,170,255,.10) !important;
    }
    .tickDot{
      width:10px; height:10px; border-radius:999px;
      background: rgba(255,255,255,.22);
    }
    .selected .tickDot{
      background: rgba(120,170,255,.95);
      box-shadow: 0 0 0 4px rgba(120,170,255,.14);
    }

    html { scroll-behavior: smooth; }
  </style>

  <script>
    // IMPORTANT: keep these EXACTLY as your working Supabase keys
    // (and make sure the URL string is correctly closed)
    window.__SUPABASE_URL = window.__SUPABASE_URL || "https://hjdpcfhozhoyeqevnupm.supabase.co";
    window.__SUPABASE_ANON = window.__SUPABASE_ANON || "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhqZHBjZmhvemhveWVxZXZudXBtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY5MTk3MzYsImV4cCI6MjA4MjQ5NTczNn0.BXosJO4NmEZOe73GXSGPa3z-i_4ZzF9zBAMBIf6Mkts";
  </script>
</head>

<body>

  <!-- NAV -->
  <header id="nav" class="fixed top-4 left-0 right-0 z-40 navShow">
    <div class="max-w-6xl mx-auto px-4">
      <div class="glass2 flex items-center justify-between px-4 py-3">
        <div class="flex items-center gap-3 min-w-0">
          <div class="w-10 h-10 rounded-2xl overflow-hidden bg-black/30 border border-white/10 flex items-center justify-center shrink-0">
            <img
              src="SmartCore Official Logos/SC Icon - Black Background.png"
              alt="SmartCore"
              class="w-8 h-8 object-contain translate-y-[-1px]"
              onerror="this.style.display='none'"
            />
          </div>
          <div class="min-w-0">
            <div class="font-semibold tracking-tight leading-tight">
              SmartCore <span class="opacity-70">Technology</span>
            </div>
            <div class="text-xs opacity-70 leading-tight">Practical Technology. Built to Last.</div>
          </div>
        </div>

        <div class="flex items-center gap-2">
          <button id="navHome" class="px-3 py-2 rounded-xl border border-white/10 bg-white/5 hover:bg-white/8 text-sm">
            Home
          </button>
          <button id="navLogin" class="px-3 py-2 rounded-xl border border-white/10 bg-white/5 hover:bg-white/8 text-sm">
            Log In
          </button>
        </div>
      </div>
    </div>
  </header>

  <!-- HERO -->
  <section id="hero" class="hero">
    <div id="iconField" class="iconField"></div>

    <div class="relative z-10 w-full max-w-6xl mx-auto px-4">
      <div class="max-w-3xl">
        <div class="fadeUp" data-anim>
          <div class="inline-flex items-center gap-2 px-3 py-1.5 rounded-full border border-white/10 bg-white/5 text-xs opacity-80">
            <span class="w-2.5 h-2.5 rounded-full" style="background: rgba(120,170,255,.85)"></span>
            SmartCore Platform
          </div>
        </div>

        <h1 class="mt-5 font-extrabold tracking-tight leading-[1.02] fadeUp" data-anim style="font-size: clamp(56px, 7vw, 92px);">
          SmartCore <br>
          <span style="opacity:.72">Technology</span>
        </h1>

        <p class="mt-4 text-[15px] sm:text-[17px] leading-relaxed fadeUp" data-anim style="color: var(--muted); max-width: 42rem;">
          Practical, reliable systems for people, safety, and operational clarity.
          Built to scale sensibly, and designed to work quietly in the background.
        </p>

        <div class="mt-7 flex flex-wrap items-center gap-3 fadeUp" data-anim>
          <button id="heroBuild" class="px-4 py-3 rounded-2xl border border-[rgba(120,170,255,.35)] bg-[rgba(120,170,255,.16)] hover:bg-[rgba(120,170,255,.22)] text-sm font-medium">
            Build Your Plan
          </button>
          <button id="heroEmployee" class="px-4 py-3 rounded-2xl border border-white/10 bg-white/5 hover:bg-white/8 text-sm font-medium">
            Sign Up As An Employee
          </button>
          <button id="heroDown" class="px-3 py-3 rounded-2xl border border-white/10 bg-white/5 hover:bg-white/8" aria-label="Scroll down">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
              <path d="M12 5v12" stroke="white" stroke-opacity=".9" stroke-width="2" stroke-linecap="round"/>
              <path d="M7 14l5 5 5-5" stroke="white" stroke-opacity=".9" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </button>
        </div>

        <div class="mt-8 fadeUp" data-anim>
          <div class="text-xs opacity-60">
            Support: <a class="underline hover:opacity-100" href="mailto:support@smartcoretechnology.co.uk">support@smartcoretechnology.co.uk</a>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- MAIN -->
  <main id="main" class="relative z-10">
    <!-- BUILD PLAN -->
    <section id="packages" class="max-w-6xl mx-auto px-4 pb-24">
      <div class="pt-10 sm:pt-16">
        <div class="fadeUp" data-anim>
          <h2 class="text-2xl sm:text-3xl font-bold tracking-tight">Build Your Plan</h2>
          <p class="mt-2 text-sm sm:text-[15px]" style="color: var(--muted); max-width: 52rem;">
            Choose a company size, then add only the systems you need. Clear pricing, modular setup, and a calm, reliable experience.
          </p>
        </div>

        <!-- Company size cards -->
        <div class="mt-6 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3 fadeUp" data-anim>
          <button class="glass2 p-4 text-left hover:bg-white/6 transition" data-size="s25">
            <div class="flex items-center justify-between">
              <div class="font-semibold">Up to 25 People</div>
              <div class="tickDot"></div>
            </div>
            <div class="mt-1 text-sm opacity-80">£39 / month</div>
            <div class="mt-2 text-xs opacity-60">Ideal for small teams and single sites.</div>
          </button>

          <button class="glass2 p-4 text-left hover:bg-white/6 transition" data-size="s100">
            <div class="flex items-center justify-between">
              <div class="font-semibold">26–100 People</div>
              <div class="tickDot"></div>
            </div>
            <div class="mt-1 text-sm opacity-80">£79 / month</div>
            <div class="mt-2 text-xs opacity-60">For growing businesses and multiple teams.</div>
          </button>

          <button class="glass2 p-4 text-left hover:bg-white/6 transition" data-size="s250">
            <div class="flex items-center justify-between">
              <div class="font-semibold">101–250 People</div>
              <div class="tickDot"></div>
            </div>
            <div class="mt-1 text-sm opacity-80">£149 / month</div>
            <div class="mt-2 text-xs opacity-60">For structured ops and larger organisations.</div>
          </button>

          <button class="glass2 p-4 text-left hover:bg-white/6 transition" data-size="s250plus">
            <div class="flex items-center justify-between">
              <div class="font-semibold">250+ People</div>
              <div class="tickDot"></div>
            </div>
            <div class="mt-1 text-sm opacity-80">Contact us</div>
            <div class="mt-2 text-xs opacity-60">We’ll tailor the plan sensibly.</div>
          </button>
        </div>

        <!-- 250+ extra input -->
        <div id="plusBox" class="mt-4 hidden fadeUp" data-anim>
          <div class="glass2 p-4">
            <div class="font-semibold">250+ Company Size</div>
            <p class="mt-1 text-sm opacity-75">Enter an approximate headcount. This is required before you can contact us.</p>
            <div class="mt-3 grid grid-cols-1 sm:grid-cols-2 gap-3">
              <div>
                <label class="text-xs opacity-70">Approx. employee count</label>
                <input id="plusCount" class="inp mt-1" type="number" min="1" placeholder="e.g. 420">
                <div id="plusWarn" class="mt-2 text-xs text-red-300 hidden"></div>
              </div>
              <div>
                <label class="text-xs opacity-70">Additional notes (optional)</label>
                <input id="plusNotes" class="inp mt-1" type="text" placeholder="Anything helpful for us to know">
              </div>
            </div>
          </div>
        </div>

        <!-- Modules (hidden until company size chosen) -->
        <div id="modulesWrap" class="mt-8 hidden">
          <div class="fadeUp" data-anim>
            <h3 class="text-lg font-semibold">System Modules</h3>
            <p class="mt-1 text-sm" style="color: var(--muted);">Select the modules you want to include in your plan.</p>
          </div>

          <div id="modulesGrid" class="mt-4 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3"></div>
        </div>

        <!-- About -->
        <div class="mt-14 fadeUp" data-anim>
          <div class="glass p-6 sm:p-8">
            <h3 class="text-xl sm:text-2xl font-bold tracking-tight">About SmartCore Technology</h3>

            <p class="mt-4 text-sm sm:text-[15px] leading-relaxed" style="color: var(--muted);">
              SmartCore Technology was built by Finley Hassall, a young founder with a long-standing passion for technology and a strong business mindset.
              Interested in IT from the age of six, Finley always knew he wanted to build a career creating systems that solve real-world problems.
            </p>

            <p class="mt-4 text-sm sm:text-[15px] leading-relaxed" style="color: var(--muted);">
              Rather than focusing on trends or hype, SmartCore Technology was created with a clear goal: to build practical, reliable systems that businesses can depend on every day.
            </p>

            <p class="mt-4 text-sm sm:text-[15px] leading-relaxed" style="color: var(--muted);">
              The company was developed with guidance and support from Finley’s mother, a business owner herself, but every system within SmartCore has been hand-crafted from the ground up by Finley.
              Each feature, workflow, and decision has been designed with real workplaces in mind — prioritising clarity, usability, and long-term reliability over unnecessary complexity.
            </p>

            <p class="mt-4 text-sm sm:text-[15px] leading-relaxed" style="color: var(--muted);">
              SmartCore Technology is not about flashy software. It’s about building tools that work properly, scale sensibly, and quietly do their job in the background.
            </p>

            <div class="mt-7">
              <h4 class="text-lg font-semibold">The SmartCore Technology Approach</h4>
              <p class="mt-3 text-sm sm:text-[15px] leading-relaxed" style="color: var(--muted);">
                SmartCore Technology is built on a simple philosophy: technology should make work easier, not more complicated.
              </p>

              <ul class="mt-4 grid sm:grid-cols-2 gap-2 text-sm" style="color: var(--muted);">
                <li class="flex gap-2"><span class="opacity-80">•</span> solve a specific, real business problem</li>
                <li class="flex gap-2"><span class="opacity-80">•</span> be easy to understand and use</li>
                <li class="flex gap-2"><span class="opacity-80">•</span> create clear, auditable records</li>
                <li class="flex gap-2"><span class="opacity-80">•</span> scale as organisations grow</li>
                <li class="flex gap-2"><span class="opacity-80">•</span> remain reliable over time</li>
              </ul>

              <p class="mt-4 text-sm sm:text-[15px] leading-relaxed" style="color: var(--muted);">
                Instead of offering one large, bloated platform, SmartCore provides modular systems that companies can choose and combine based on their actual needs.
                This keeps costs fair, reduces complexity, and allows businesses to stay in control of how they operate.
              </p>

              <p class="mt-4 text-sm sm:text-[15px] leading-relaxed" style="color: var(--muted);">
                SmartCore Technology focuses on the areas that matter most — people, safety, and operational clarity — delivering tools that support organisations without getting in the way.
              </p>
            </div>
          </div>
        </div>

      </div>
    </section>

    <!-- FOOTER -->
    <footer class="max-w-6xl mx-auto px-4 pb-10">
      <div class="glass2 p-5 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2">
        <div class="text-sm opacity-80">SmartCore Technology</div>
        <a class="text-sm opacity-80 underline hover:opacity-100" href="mailto:support@smartcoretechnology.co.uk">
          support@smartcoretechnology.co.uk
        </a>
      </div>
    </footer>
  </main>

  <!-- STICKY SUMMARY -->
  <div id="summaryBar" class="fixed bottom-4 left-0 right-0 z-30 hidden">
    <div class="max-w-6xl mx-auto px-4">
      <div class="glass2 p-4 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
        <div class="flex items-center justify-between sm:justify-start gap-6">
          <div>
            <div class="text-xs opacity-70">Monthly total</div>
            <div class="text-lg font-semibold" id="totalText">£0 / month</div>
          </div>
          <div class="hidden sm:block text-xs opacity-60" id="summaryMini">Select a company size to begin.</div>
        </div>

        <button id="checkoutBtn" class="px-4 py-3 rounded-2xl border border-[rgba(120,170,255,.35)] bg-[rgba(120,170,255,.16)] hover:bg-[rgba(120,170,255,.22)] text-sm font-medium">
          Continue
        </button>
      </div>
    </div>
  </div>

  <!-- MODAL: Module Learn More -->
  <div id="moduleModalBackdrop" class="modalBackdrop">
    <div class="modal glass p-5 sm:p-6">
      <div class="flex items-start justify-between gap-3">
        <div>
          <div id="mmTitle" class="text-xl sm:text-2xl font-bold"></div>
          <div id="mmPrice" class="mt-1 text-sm opacity-80"></div>
        </div>
        <button id="mmClose" class="px-3 py-2 rounded-xl border border-white/10 bg-white/5 hover:bg-white/8 text-sm">Close</button>
      </div>

      <div class="mt-4 grid grid-cols-1 lg:grid-cols-2 gap-4">
        <div class="glass2 p-4">
          <div class="text-sm font-semibold">Preview</div>
          <div class="mt-3 rounded-2xl overflow-hidden border border-white/10 bg-black/30">
            <iframe
              id="mmVideo"
              class="w-full aspect-video"
              src="https://www.youtube.com/embed/S2kymv60ndQ"
              title="Module preview"
              allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; fullscreen"
              allowfullscreen
            ></iframe>
          </div>
          <div class="mt-2 text-xs opacity-60">Open fullscreen using the video player controls.</div>
        </div>

        <div class="glass2 p-4">
          <div class="text-sm font-semibold">Summary</div>
          <p id="mmSummary" class="mt-2 text-sm leading-relaxed opacity-80"></p>

          <div class="mt-4 text-sm font-semibold">Key features</div>
          <ul id="mmBullets" class="mt-2 space-y-2 text-sm opacity-80"></ul>
        </div>
      </div>
    </div>
  </div>

  <!-- MODAL: Signup entry -->
  <div id="signupModalBackdrop" class="modalBackdrop">
    <div class="modal glass p-5 sm:p-6" style="max-width: 720px;">
      <div class="flex items-start justify-between gap-3">
        <div>
          <div class="text-xl sm:text-2xl font-bold">Create your company account</div>
          <div class="mt-1 text-sm opacity-75">Enter your details, then verify with a 6-digit code.</div>
        </div>
        <button id="suClose" class="px-3 py-2 rounded-xl border border-white/10 bg-white/5 hover:bg-white/8 text-sm">Close</button>
      </div>

      <div class="mt-5 grid grid-cols-1 sm:grid-cols-2 gap-3">
        <div class="sm:col-span-2">
          <label class="text-xs opacity-70">Company name</label>
          <input id="suCompanyName" class="inp mt-1" placeholder="e.g. SmartFits Installations Ltd" />
        </div>

        <div class="sm:col-span-2">
          <label class="text-xs opacity-70">Email</label>
          <input id="suEmail" type="email" class="inp mt-1" placeholder="name@company.co.uk" />
        </div>

        <div class="sm:col-span-2">
          <label class="text-xs opacity-70">Password</label>
          <div class="mt-1 flex gap-2">
            <input id="suPassword" type="password" class="inp" placeholder="Minimum 8 characters" />
            <button id="suEye" type="button" class="eyeBtn" aria-label="Show/hide password">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
                <path d="M2.5 12s3.5-7 9.5-7 9.5 7 9.5 7-3.5 7-9.5 7-9.5-7-9.5-7Z" stroke="white" stroke-opacity=".85" stroke-width="2"/>
                <path d="M12 15a3 3 0 1 0 0-6 3 3 0 0 0 0 6Z" stroke="white" stroke-opacity=".85" stroke-width="2"/>
              </svg>
            </button>
          </div>
          <div class="mt-2 text-xs opacity-60">We’ll only create your account after verification.</div>
        </div>
      </div>

      <div id="suMsg" class="mt-4 text-sm text-red-300 hidden"></div>

      <div class="mt-5 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
        <button id="suContinue" class="px-4 py-3 rounded-2xl border border-[rgba(120,170,255,.35)] bg-[rgba(120,170,255,.16)] hover:bg-[rgba(120,170,255,.22)] text-sm font-medium">
          Continue
        </button>

        <div class="text-sm opacity-70">
          <div class="block">Already have an account?</div>
          <button id="suGoLogin" class="underline hover:opacity-100">Log In Instead</button>
        </div>
      </div>
    </div>
  </div>

  <!-- MODAL: Verify code -->
  <div id="verifyModalBackdrop" class="modalBackdrop">
    <div class="modal glass p-5 sm:p-6" style="max-width: 620px;">
      <div class="flex items-start justify-between gap-3">
        <div>
          <div class="text-xl sm:text-2xl font-bold">Verify your email</div>
          <div class="mt-1 text-sm opacity-75">Enter the 6-digit code we sent to <span id="vEmail" class="font-medium"></span>.</div>
        </div>
        <button id="vClose" class="px-3 py-2 rounded-xl border border-white/10 bg-white/5 hover:bg-white/8 text-sm">Close</button>
      </div>

      <div class="mt-5">
        <label class="text-xs opacity-70">6-digit code</label>
        <input id="vCode" class="inp mt-1 text-center tracking-[0.4em]" maxlength="6" placeholder="123456" />
      </div>

      <div id="vMsg" class="mt-4 text-sm text-red-300 hidden"></div>

      <div class="mt-5 flex items-center justify-between gap-3">
        <button id="vVerify" class="px-4 py-3 rounded-2xl border border-[rgba(120,170,255,.35)] bg-[rgba(120,170,255,.16)] hover:bg-[rgba(120,170,255,.22)] text-sm font-medium">
          Continue
        </button>
        <button id="vResend" class="px-3 py-3 rounded-2xl border border-white/10 bg-white/5 hover:bg-white/8 text-sm">
          Resend code
        </button>
      </div>
    </div>
  </div>

  <!-- MODAL: Payment placeholder -->
  <div id="payModalBackdrop" class="modalBackdrop">
    <div class="modal glass p-5 sm:p-6" style="max-width: 720px;">
      <div class="flex items-start justify-between gap-3">
        <div>
          <div class="text-xl sm:text-2xl font-bold">Payment</div>
          <div class="mt-1 text-sm opacity-75">Testing mode: accept or decline.</div>
        </div>
        <button id="payClose" class="px-3 py-2 rounded-xl border border-white/10 bg-white/5 hover:bg-white/8 text-sm">Close</button>
      </div>

      <div class="mt-5 glass2 p-4">
        <div class="text-sm opacity-80">Plan summary</div>
        <div class="mt-2 text-lg font-semibold" id="payTotal">£0 / month</div>
        <div class="mt-2 text-xs opacity-60" id="paySummary"></div>
      </div>

      <div id="payMsg" class="mt-4 text-sm text-red-300 hidden"></div>

      <div class="mt-5 flex flex-col sm:flex-row gap-3">
        <button id="payAccept" class="flex-1 px-4 py-3 rounded-2xl border border-[rgba(120,170,255,.35)] bg-[rgba(120,170,255,.16)] hover:bg-[rgba(120,170,255,.22)] text-sm font-medium">
          Accept
        </button>
        <button id="payDecline" class="flex-1 px-4 py-3 rounded-2xl border border-white/10 bg-white/5 hover:bg-white/8 text-sm font-medium">
          Decline
        </button>
      </div>
    </div>
  </div>

  <!-- MODAL: Login -->
  <div id="loginModalBackdrop" class="modalBackdrop">
    <div class="modal glass p-5 sm:p-6" style="max-width: 680px;">
      <div class="flex items-start justify-between gap-3">
        <div>
          <div class="text-xl sm:text-2xl font-bold">Log in</div>
          <div class="mt-1 text-sm opacity-75">Access your dashboard and systems.</div>
        </div>
        <button id="liClose" class="px-3 py-2 rounded-xl border border-white/10 bg-white/5 hover:bg-white/8 text-sm">Close</button>
      </div>

      <div class="mt-5 grid grid-cols-1 gap-3">
        <div>
          <label class="text-xs opacity-70">Email</label>
          <input id="liEmail" class="inp mt-1" type="email" placeholder="name@company.co.uk" />
        </div>
        <div>
          <label class="text-xs opacity-70">Password</label>
          <div class="mt-1 flex gap-2">
            <input id="liPassword" class="inp" type="password" placeholder="Your password" />
            <button id="liEye" type="button" class="eyeBtn" aria-label="Show/hide password">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
                <path d="M2.5 12s3.5-7 9.5-7 9.5 7 9.5 7-3.5 7-9.5 7-9.5-7-9.5-7Z" stroke="white" stroke-opacity=".85" stroke-width="2"/>
                <path d="M12 15a3 3 0 1 0 0-6 3 3 0 0 0 0 6Z" stroke="white" stroke-opacity=".85" stroke-width="2"/>
              </svg>
            </button>
          </div>
        </div>
      </div>

      <div id="liMsg" class="mt-4 text-sm text-red-300 hidden"></div>

      <div class="mt-5 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
        <button id="liLogin" class="px-4 py-3 rounded-2xl border border-[rgba(120,170,255,.35)] bg-[rgba(120,170,255,.16)] hover:bg-[rgba(120,170,255,.22)] text-sm font-medium">
          Log In
        </button>

        <div class="text-sm opacity-70">
          <div id="liWrong" class="hidden">
            <button id="liReset" class="underline hover:opacity-100">Incorrect credentials — Forgot your password?</button>
          </div>
          <div class="mt-2">
            <button id="liNoAcc" class="underline hover:opacity-100">Don’t have an account?</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- MODAL: “Don’t have an account?” -->
  <div id="noAccModalBackdrop" class="modalBackdrop">
    <div class="modal glass p-5 sm:p-6" style="max-width: 780px;">
      <div class="flex items-start justify-between gap-3">
        <div>
          <div class="text-xl sm:text-2xl font-bold">Getting started</div>
          <div class="mt-1 text-sm opacity-75">Choose the right route based on your company.</div>
        </div>
        <button id="noAccClose" class="px-3 py-2 rounded-xl border border-white/10 bg-white/5 hover:bg-white/8 text-sm">Close</button>
      </div>

      <div class="mt-5 grid grid-cols-1 sm:grid-cols-2 gap-3">
        <div class="glass2 p-4">
          <div class="font-semibold">Sign up as an employee</div>
          <p class="mt-2 text-sm opacity-80">
            If your company already uses SmartCore, ask your admin for the company code and sign up as an employee.
          </p>
          <button id="noAccEmployee" class="mt-4 px-4 py-3 rounded-2xl border border-white/10 bg-white/5 hover:bg-white/8 text-sm font-medium">
            Sign Up As An Employee
          </button>
        </div>

        <div class="glass2 p-4">
          <div class="font-semibold">Build your plan</div>
          <p class="mt-2 text-sm opacity-80">
            If your company is new to SmartCore, build a plan, select modules, and create a company account.
          </p>
          <button id="noAccBuild" class="mt-4 px-4 py-3 rounded-2xl border border-[rgba(120,170,255,.35)] bg-[rgba(120,170,255,.16)] hover:bg-[rgba(120,170,255,.22)] text-sm font-medium">
            Build Your Plan
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- MODAL: Employee signup -->
  <div id="empModalBackdrop" class="modalBackdrop">
    <div class="modal glass p-5 sm:p-6" style="max-width: 760px;">
      <div class="flex items-start justify-between gap-3">
        <div>
          <div class="text-xl sm:text-2xl font-bold">Employee sign-up</div>
          <div class="mt-1 text-sm opacity-75">Enter your company code and your name exactly as your admin added it.</div>
        </div>
        <button id="empClose" class="px-3 py-2 rounded-xl border border-white/10 bg-white/5 hover:bg-white/8 text-sm">Close</button>
      </div>

      <div class="mt-5 grid grid-cols-1 sm:grid-cols-2 gap-3">
        <div class="sm:col-span-2">
          <label class="text-xs opacity-70">Company code</label>
          <input id="empCompanyCode" class="inp mt-1" placeholder="e.g. SMA624564" />
        </div>
        <div class="sm:col-span-2">
          <label class="text-xs opacity-70">Full name</label>
          <input id="empFullName" class="inp mt-1" placeholder="e.g. Finley Hassall" />
        </div>
        <div class="sm:col-span-2">
          <label class="text-xs opacity-70">Email</label>
          <input id="empEmail" class="inp mt-1" type="email" placeholder="you@company.co.uk" />
        </div>
        <div class="sm:col-span-2">
          <label class="text-xs opacity-70">Password</label>
          <div class="mt-1 flex gap-2">
            <input id="empPassword" class="inp" type="password" placeholder="Minimum 8 characters" />
            <button id="empEye" type="button" class="eyeBtn" aria-label="Show/hide password">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
                <path d="M2.5 12s3.5-7 9.5-7 9.5 7 9.5 7-3.5 7-9.5 7-9.5-7-9.5-7Z" stroke="white" stroke-opacity=".85" stroke-width="2"/>
                <path d="M12 15a3 3 0 1 0 0-6 3 3 0 0 0 0 6Z" stroke="white" stroke-opacity=".85" stroke-width="2"/>
              </svg>
            </button>
          </div>
        </div>
      </div>

      <div id="empMsg" class="mt-4 text-sm text-red-300 hidden"></div>

      <div class="mt-5 flex items-center justify-between gap-3">
        <button id="empSend" class="px-4 py-3 rounded-2xl border border-[rgba(120,170,255,.35)] bg-[rgba(120,170,255,.16)] hover:bg-[rgba(120,170,255,.22)] text-sm font-medium">
          Continue
        </button>
      </div>

      <div id="empVerifyBox" class="mt-5 hidden glass2 p-4">
        <div class="font-semibold">Verify</div>
        <div class="mt-2 text-sm opacity-75">Enter the 6-digit code sent to your email.</div>

        <div class="mt-3">
          <label class="text-xs opacity-70">6-digit code</label>
          <input id="empCode" class="inp mt-1 text-center tracking-[0.4em]" maxlength="6" placeholder="123456" />
        </div>

        <div id="empVerifyMsg" class="mt-3 text-sm text-red-300 hidden"></div>

        <div class="mt-4 flex gap-3">
          <button id="empVerify" class="flex-1 px-4 py-3 rounded-2xl border border-[rgba(120,170,255,.35)] bg-[rgba(120,170,255,.16)] hover:bg-[rgba(120,170,255,.22)] text-sm font-medium">
            Continue
          </button>
          <button id="empResend" class="px-4 py-3 rounded-2xl border border-white/10 bg-white/5 hover:bg-white/8 text-sm font-medium">
            Resend
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- DASHBOARD -->
  <section id="dashboard" class="hidden">
    <div class="max-w-6xl mx-auto px-4 pt-28 pb-24">
      <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
        <div class="fadeUp" data-anim>
          <h2 class="text-2xl sm:text-3xl font-bold tracking-tight">Dashboard</h2>
          <p id="dashSub" class="mt-1 text-sm" style="color: var(--muted);">Loading your account…</p>
        </div>

        <div class="flex items-center gap-2">
          <button id="dashBuyMore" class="px-3 py-2 rounded-xl border border-white/10 bg-white/5 hover:bg-white/8 text-sm">
            Buy more systems
          </button>
          <button id="dashSignOut" class="px-3 py-2 rounded-xl border border-white/10 bg-white/5 hover:bg-white/8 text-sm">
            Sign out
          </button>
        </div>
      </div>

      <div class="mt-6 grid grid-cols-1 lg:grid-cols-3 gap-4">
        <div class="glass p-5">
          <div class="text-sm opacity-80 font-semibold">Company</div>
          <div class="mt-3 space-y-2 text-sm">
            <div><span class="opacity-60">Name:</span> <span id="dashCompanyName" class="font-medium"></span></div>
            <div><span class="opacity-60">Address:</span> <span id="dashCompanyAddress" class="font-medium"></span></div>
            <div><span class="opacity-60">Company code:</span> <span id="dashCompanyCode" class="font-medium"></span></div>
            <div><span class="opacity-60">Plan:</span> <span id="dashPlan" class="font-medium"></span></div>
            <div><span class="opacity-60">Max employees:</span> <span id="dashMaxEmp" class="font-medium"></span></div>
          </div>

          <div class="mt-4">
            <button id="dashSettingsBtn" class="px-3 py-2 rounded-xl border border-white/10 bg-white/5 hover:bg-white/8 text-sm">
              Company settings
            </button>
          </div>
        </div>

        <div class="glass p-5 lg:col-span-2">
          <div class="flex items-center justify-between gap-3">
            <div>
              <div class="text-sm opacity-80 font-semibold">Your systems</div>
              <div class="mt-1 text-sm opacity-70">Quick links for the modules you own.</div>
            </div>
            <div class="text-sm opacity-70" id="dashTotal"></div>
          </div>

          <div id="dashSystems" class="mt-4 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3"></div>
        </div>
      </div>

      <!-- ONBOARDING WIZARD -->
      <div class="mt-6 glass p-5">
        <div class="flex items-center justify-between gap-3">
          <div>
            <div class="text-sm opacity-80 font-semibold">Company onboarding</div>
            <div id="onbHint" class="mt-1 text-sm opacity-70">Complete the steps below to finish setup.</div>
          </div>
          <div class="text-xs opacity-60" id="onbStepLabel"></div>
        </div>

        <div id="onbStepBox" class="mt-4 glass2 p-4"></div>
      </div>

      <!-- EMPLOYEES -->
      <div class="mt-6 glass p-5">
        <div class="flex items-center justify-between gap-3">
          <div>
            <div class="text-sm opacity-80 font-semibold">Employees</div>
            <div class="mt-1 text-sm opacity-70">Add, edit, and remove employees. IDs are generated automatically.</div>
          </div>
          <button id="empAddBtn" class="px-3 py-2 rounded-xl border border-[rgba(120,170,255,.35)] bg-[rgba(120,170,255,.16)] hover:bg-[rgba(120,170,255,.22)] text-sm font-medium">
            Add employee
          </button>
        </div>

        <div id="empLimitMsg" class="mt-3 text-sm text-red-300 hidden"></div>

        <div class="mt-4 overflow-x-auto">
          <table class="w-full text-sm">
            <thead class="text-left opacity-70">
              <tr>
                <th class="py-2 pr-3">Employee</th>
                <th class="py-2 pr-3">Role</th>
                <th class="py-2 pr-3">Category</th>
                <th class="py-2 pr-3">ID</th>
                <th class="py-2 pr-3">Admin</th>
                <th class="py-2 pr-3 text-right">Actions</th>
              </tr>
            </thead>
            <tbody id="empTable"></tbody>
          </table>
        </div>
      </div>

    </div>
  </section>

  <!-- MODAL: Company settings -->
  <div id="settingsModalBackdrop" class="modalBackdrop">
    <div class="modal glass p-5 sm:p-6" style="max-width: 820px;">
      <div class="flex items-start justify-between gap-3">
        <div>
          <div class="text-xl sm:text-2xl font-bold">Company settings</div>
          <div class="mt-1 text-sm opacity-75">Update details and colours. These can be used across SmartCore systems.</div>
        </div>
        <button id="setClose" class="px-3 py-2 rounded-xl border border-white/10 bg-white/5 hover:bg-white/8 text-sm">Close</button>
      </div>

      <div class="mt-5 grid grid-cols-1 sm:grid-cols-2 gap-3">
        <div class="sm:col-span-2">
          <label class="text-xs opacity-70">Company name</label>
          <input id="setName" class="inp mt-1" />
        </div>
        <div class="sm:col-span-2">
          <label class="text-xs opacity-70">Company address</label>
          <input id="setAddr" class="inp mt-1" />
        </div>
        <div>
          <label class="text-xs opacity-70">Primary colour</label>
          <input id="setPrimary" class="inp mt-1" placeholder="#ff0000" />
        </div>
        <div>
          <label class="text-xs opacity-70">Secondary colour</label>
          <input id="setSecondary" class="inp mt-1" placeholder="#000000" />
        </div>
        <div class="sm:col-span-2">
          <label class="text-xs opacity-70">Text colour</label>
          <input id="setText" class="inp mt-1" placeholder="#ffffff" />
        </div>
      </div>

      <div id="setMsg" class="mt-4 text-sm text-red-300 hidden"></div>

      <div class="mt-5 flex justify-end gap-3">
        <button id="setSave" class="px-4 py-3 rounded-2xl border border-[rgba(120,170,255,.35)] bg-[rgba(120,170,255,.16)] hover:bg-[rgba(120,170,255,.22)] text-sm font-medium">
          Save changes
        </button>
      </div>
    </div>
  </div>

  <!-- MODAL: Add/Edit employee -->
  <div id="empEditModalBackdrop" class="modalBackdrop">
    <div class="modal glass p-5 sm:p-6" style="max-width: 820px;">
      <div class="flex items-start justify-between gap-3">
        <div>
          <div id="empEditTitle" class="text-xl sm:text-2xl font-bold">Add employee</div>
          <div class="mt-1 text-sm opacity-75">Names must match for employee self sign-up.</div>
        </div>
        <button id="empEditClose" class="px-3 py-2 rounded-xl border border-white/10 bg-white/5 hover:bg-white/8 text-sm">Close</button>
      </div>

      <div class="mt-5 grid grid-cols-1 sm:grid-cols-2 gap-3">
        <div class="sm:col-span-2">
          <label class="text-xs opacity-70">Full name</label>
          <input id="empEName" class="inp mt-1" placeholder="e.g. Finley Hassall" />
        </div>
        <div>
          <label class="text-xs opacity-70">Job title</label>
          <input id="empETitle" class="inp mt-1" placeholder="e.g. Founder" />
        </div>
        <div>
          <label class="text-xs opacity-70">Job category</label>
          <input id="empECategory" class="inp mt-1" placeholder="e.g. Senior management team" />
        </div>

        <div class="sm:col-span-2 mt-1">
          <div class="chkWrap" id="empEAdminWrap">
            <div class="chk" id="empEAdminChk">
              <svg id="empEAdminTick" width="14" height="14" viewBox="0 0 24 24" fill="none" class="hidden">
                <path d="M20 6L9 17l-5-5" stroke="white" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </div>
            <div>
              <div class="text-sm font-medium">Admin access</div>
              <div class="text-xs opacity-70">Admins can manage employees and system settings.</div>
            </div>
          </div>
        </div>
      </div>

      <div id="empEditMsg" class="mt-4 text-sm text-red-300 hidden"></div>

      <div class="mt-5 flex justify-end gap-3">
        <button id="empESave" class="px-4 py-3 rounded-2xl border border-[rgba(120,170,255,.35)] bg-[rgba(120,170,255,.16)] hover:bg-[rgba(120,170,255,.22)] text-sm font-medium">
          Save
        </button>
      </div>
    </div>
  </div>

  <!-- MODAL: Confirm remove -->
  <div id="confirmModalBackdrop" class="modalBackdrop">
    <div class="modal glass p-5 sm:p-6" style="max-width: 720px;">
      <div class="flex items-start justify-between gap-3">
        <div>
          <div class="text-xl sm:text-2xl font-bold">Confirm removal</div>
          <div id="confirmText" class="mt-2 text-sm opacity-80"></div>
        </div>
        <button id="confirmClose" class="px-3 py-2 rounded-xl border border-white/10 bg-white/5 hover:bg-white/8 text-sm">Close</button>
      </div>

      <div class="mt-6 flex flex-col sm:flex-row gap-3">
        <button id="confirmYes" class="flex-1 px-4 py-3 rounded-2xl border border-[rgba(255,80,80,.35)] bg-[rgba(255,80,80,.12)] hover:bg-[rgba(255,80,80,.18)] text-sm font-medium">
          Yes, remove
        </button>
        <button id="confirmNo" class="flex-1 px-4 py-3 rounded-2xl border border-white/10 bg-white/5 hover:bg-white/8 text-sm font-medium">
          No, keep
        </button>
      </div>
    </div>
  </div>

  <script>
    /******************************************************************
      UTIL
    ******************************************************************/
    const $ = (id) => document.getElementById(id);

    function show(el){ el.classList.remove("hidden"); }
    function hide(el){ el.classList.add("hidden"); }
    function setText(el, t){ el.textContent = t; }

    function openModal(backdrop){
      backdrop.classList.add("show");
      document.body.classList.add("noScroll");
    }
    function closeModal(backdrop){
      backdrop.classList.remove("show");
      document.body.classList.remove("noScroll");
    }

    function showErr(el, msg){
      el.textContent = msg;
      el.classList.remove("hidden");
      el.classList.remove("text-green-300");
      el.classList.add("text-red-300");
    }
    function showOk(el, msg){
      el.textContent = msg;
      el.classList.remove("hidden");
      el.classList.remove("text-red-300");
      el.classList.add("text-green-300");
    }
    function clearErr(el){
      el.textContent = "";
      el.classList.add("hidden");
      el.classList.remove("text-green-300");
      el.classList.add("text-red-300");
    }

    function money(n){
      const v = Number(n || 0);
      return "£" + v.toFixed(0);
    }

    function companyPrefix(name){
      const clean = (name||"").replace(/[^a-zA-Z]/g,"").toUpperCase();
      return (clean.slice(0,3) || "COM").padEnd(3,"X");
    }
    function randDigits(len){
      let out = "";
      for(let i=0;i<len;i++) out += Math.floor(Math.random()*10);
      return out;
    }

    // Exact-match-friendly message
    const EMP_NOT_FOUND_MSG =
      "We couldn’t find your details linked to this company. Please contact your system admin and ask them to confirm your name has been added exactly as shown.";

    /******************************************************************
      SUPABASE (single init, avoids “already declared”)
    ******************************************************************/
    let sb = window.__SB_CLIENT;
    if (!sb){
      sb = window.supabase.createClient(window.__SUPABASE_URL, window.__SUPABASE_ANON);
      window.__SB_CLIENT = sb;
    }

    /******************************************************************
      DB COLUMN MAP (matches your screenshots)
      companies: company_name, address, logo_url, company_code, company_size, max_employees, primary_color, secondary_color, text_color, owner_user_id
      profiles: user_id, email, company_id, company_name, full_name, job_title, job_category, role, is_admin (TEXT in your table)
      employees: company_id, employee_code, full_name, job_title, job_category (+ optional is_admin if you add it later)
      subscriptions: user_id, company_size_id, company_size_label, company_size_price, selected_modules (jsonb), modules_total, total_monthly, currency, status, selected_modules_ids
    ******************************************************************/
    const DB = {
      companies: {
        id: "id",
        name: "company_name",
        address: "address",
        code: "company_code",
        logo: "logo_url",
        size: "company_size",
        maxEmp: "max_employees",
        primary: "primary_color",
        secondary: "secondary_color",
        text: "text_color",
        owner: "owner_user_id",
      },
      profiles: {
        userId: "user_id",
        email: "email",
        companyId: "company_id",
        companyName: "company_name",
        fullName: "full_name",
        jobTitle: "job_title",
        jobCat: "job_category",
        role: "role",
        isAdmin: "is_admin", // in your table this is TEXT
      }
    };

    /******************************************************************
      DATA
    ******************************************************************/
    const COMPANY_SIZES = [
      { id:"s25", label:"Up to 25 People", price:39, maxEmployees:25 },
      { id:"s100", label:"26–100 People", price:79, maxEmployees:100 },
      { id:"s250", label:"101–250 People", price:149, maxEmployees:250 },
      { id:"s250plus", label:"250+ People", price:0, maxEmployees:null }
    ];

    const MODULES = [
      { id:"presence_fire", name:"Presence & Fire Safety", price:10,
        summary:"A real-time presence system that shows exactly who is on site at any moment.",
        full:
`A real-time presence system that shows exactly who is on site at any moment. Staff and visitors sign in and out digitally, creating a live evacuation list that can be used immediately during fire drills or real emergencies.

Designed to be simple, fast, and reliable when it matters most, with clear records for audits and incident reviews.`,
        bullets:["Live on-site list for staff and visitors","Instant evacuation roll call","Fire drill & incident reporting support","Clear, auditable sign-in history","Fast kiosk-friendly workflows"]
      },
      { id:"policies_handbook", name:"Policies & Staff Handbook", price:7,
        summary:"A central location for policies and staff handbooks with acknowledgement tracking.",
        full:
`A central location for company policies and staff handbooks, with tracking to show who has read and acknowledged each document. Managers can update policies, request re-acknowledgement, and view clear records at any time.

Helps organisations demonstrate that information has been issued and acknowledged without relying on paper or email chains.`,
        bullets:["Policy library with versioning","Read & acknowledge tracking","Manager visibility and reporting","Re-acknowledgement requests","Simple exports for audits"]
      },
      { id:"holiday_booking", name:"Holiday Booking", price:8,
        summary:"A straightforward holiday request and approval system with a clean team view.",
        full:
`A straightforward holiday request and approval system that removes unnecessary back-and-forth. Staff submit requests, managers approve or decline, and teams can view upcoming absences in one place.

Intentionally simple and focused, with no payroll or salary management.`,
        bullets:["Clean request → approve/decline flow","Team calendar view of absences","Clear audit history of decisions","Designed to stay simple","No payroll complexity"]
      },
      { id:"accident_injury", name:"Accident & Injury Book", price:3,
        summary:"Digital accident and injury reporting that replaces paper books and stays organised.",
        full:
`A digital accident and injury reporting system that replaces paper accident books. Incidents can be logged quickly with notes, photos, and witness details, and records can be exported when required.

Keeps incident records organised, secure, and easy to access if they are ever needed.`,
        bullets:["Quick incident logging","Photos and witness details","Secure searchable records","Export when required","Better organisation than paper"]
      },
      { id:"training_compliance", name:"Training & Compliance", price:9,
        summary:"Tracks training expiry dates, compliance requirements and scheduled checks.",
        full:
`Tracks training expiry dates, compliance requirements, and scheduled checks across the organisation. Automatic reminders help ensure nothing is missed, from fire drills to equipment inspections and vehicle compliance.

Designed to support consistency and oversight without adding unnecessary complexity.`,
        bullets:["Expiry date tracking","Automated reminders","Compliance calendar view","Simple oversight for managers","Supports consistent standards"]
      },
      { id:"onboarding_offboarding", name:"Onboarding & Offboarding", price:8,
        summary:"Structured checklists for starters and leavers, keeping transitions consistent.",
        full:
`Structured checklists for new starters and leavers, helping teams complete tasks consistently across departments. From access setup to equipment returns, nothing is forgotten.

Provides a clear record of what was completed and when, supporting smoother staff transitions.`,
        bullets:["Starter & leaver checklists","Clear ownership of tasks","Audit trail of completion","Avoid missed steps","Consistent transitions"]
      },
      { id:"expenses_upload", name:"Expenses Upload", price:6,
        summary:"Upload receipts digitally with notes and categories, then export for accounts.",
        full:
`Allows staff to upload receipts digitally with notes and categories, removing the need to collect paper receipts. Submissions can be reviewed and exported for accounting or payroll systems.

Keeps expense handling simple, organised, and traceable.`,
        bullets:["Receipt uploads with notes","Simple categories","Review & approval flow","Exports for accounts/payroll","No paper chasing"]
      },
      { id:"wellbeing_check", name:"Wellbeing Check", price:4,
        summary:"A lightweight wellbeing check-in with a simple, privacy-respecting pulse view.",
        full:
`A lightweight wellbeing check-in that allows staff to quickly select one of three options:

🙂 Positive (green)
😐 Neutral (amber)
🙁 Concerned (red)

Over time, this provides managers with a simple, high-level view of wellbeing trends across teams, helping highlight when additional attention may be needed.

No medical data, no intrusive questions — just a clear, visual pulse check designed to support awareness while respecting privacy.`,
        bullets:["Simple 3-state wellbeing pulse","Trend visibility over time","Privacy-respecting (no medical data)","Lightweight and quick to use","Helps surface support needs"]
      }
    ];

    /******************************************************************
      STATE
    ******************************************************************/
    const state = {
      size: null,
      selectedModules: new Set(),
      pendingSignup: null,
      pendingEmployee: null,
      session: null,
      profile: null,
      company: null,
      subscription: null,
      employees: [],
      onboardingStep: 1,
      editingEmployee: null,
      confirmAction: null
    };

    /******************************************************************
      ICON BUBBLES (desktop only)
    ******************************************************************/
    const iconField = $("iconField");
    const iconSVGs = [
      `<svg viewBox="0 0 24 24" fill="none"><path d="M12 3l8 4v6c0 5-3.5 8.5-8 8.5S4 18 4 13V7l8-4Z" stroke="white" stroke-opacity=".92" stroke-width="2"/></svg>`,
      `<svg viewBox="0 0 24 24" fill="none"><path d="M12 15a3 3 0 100-6 3 3 0 000 6Z" stroke="white" stroke-opacity=".92" stroke-width="2"/><path d="M19.4 15a8 8 0 10-14.8 0" stroke="white" stroke-opacity=".55" stroke-width="2"/></svg>`,
      `<svg viewBox="0 0 24 24" fill="none"><path d="M7 7h10v10H7V7Z" stroke="white" stroke-opacity=".92" stroke-width="2"/><path d="M4 10V4h6" stroke="white" stroke-opacity=".6" stroke-width="2"/><path d="M20 14v6h-6" stroke="white" stroke-opacity=".6" stroke-width="2"/></svg>`,
      `<svg viewBox="0 0 24 24" fill="none"><path d="M8 12h8" stroke="white" stroke-opacity=".92" stroke-width="2" stroke-linecap="round"/><path d="M12 8v8" stroke="white" stroke-opacity=".92" stroke-width="2" stroke-linecap="round"/></svg>`,
      `<svg viewBox="0 0 24 24" fill="none"><path d="M6 19h12M9 19V9l3-4 3 4v10" stroke="white" stroke-opacity=".85" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>`,
      `<svg viewBox="0 0 24 24" fill="none"><path d="M4 12h16" stroke="white" stroke-opacity=".8" stroke-width="2"/><path d="M12 4v16" stroke="white" stroke-opacity=".8" stroke-width="2"/></svg>`
    ];
    const bubbles = [];

    function buildBubbles(){
      iconField.innerHTML = "";
      bubbles.length = 0;

      const isDesktop = window.matchMedia("(pointer:fine)").matches && window.innerWidth >= 900;
      if (!isDesktop) return;

      const positions = [
        {x: 12, y: 18}, {x: 72, y: 16}, {x: 86, y: 48}, {x: 58, y: 62},
        {x: 18, y: 60}, {x: 36, y: 36}, {x: 84, y: 78}, {x: 10, y: 82}
      ];

      positions.forEach((p, i) => {
        const b = document.createElement("div");
        b.className = "bubble";
        b.style.left = p.x + "%";
        b.style.top = p.y + "%";
        b.innerHTML = iconSVGs[i % iconSVGs.length];
        b.style.setProperty("--tx", "0px");
        b.style.setProperty("--ty", "0px");
        iconField.appendChild(b);
        bubbles.push(b);
      });
    }

    function bubbleParallax(e){
      if (!bubbles.length) return;
      const rect = $("hero").getBoundingClientRect();
      const cx = rect.left + rect.width/2;
      const cy = rect.top + rect.height/2;
      const dx = (e.clientX - cx) / rect.width;
      const dy = (e.clientY - cy) / rect.height;

      bubbles.forEach((b, idx) => {
        const strength = 18 + (idx % 3) * 6;
        const tx = (dx * strength * -1);
        const ty = (dy * strength * -1);
        b.style.setProperty("--tx", tx.toFixed(1) + "px");
        b.style.setProperty("--ty", ty.toFixed(1) + "px");
      });
    }

    /******************************************************************
      ANIMATIONS
    ******************************************************************/
    function initAnim(){
      const els = document.querySelectorAll("[data-anim]");
      const io = new IntersectionObserver((entries)=>{
        entries.forEach(en=>{
          if(en.isIntersecting) en.target.classList.add("in");
        });
      }, { threshold: 0.12 });
      els.forEach(el=>{
        el.classList.add("fadeUp");
        io.observe(el);
      });
    }

    function initNavHide(){
      const nav = $("nav");
      const hero = $("hero");
      const io = new IntersectionObserver((entries)=>{
        const en = entries[0];
        if(en.isIntersecting){
          nav.classList.remove("navHide");
          nav.classList.add("navShow");
        }else{
          nav.classList.remove("navShow");
          nav.classList.add("navHide");
        }
      }, { threshold: 0.10 });
      io.observe(hero);
    }

    /******************************************************************
      MODULES UI
    ******************************************************************/
    function renderModules(){
      const grid = $("modulesGrid");
      grid.innerHTML = "";

      MODULES.forEach(m => {
        const selected = state.selectedModules.has(m.id);
        const card = document.createElement("div");
        card.className = "glass2 p-4 flex flex-col gap-3 hover:bg-white/6 transition cursor-pointer";
        if (selected) card.classList.add("selected");

        card.innerHTML = `
          <div class="flex items-start justify-between gap-3">
            <div>
              <div class="font-semibold leading-tight">${m.name}</div>
              <div class="text-sm opacity-80 mt-1">${money(m.price)} / month</div>
            </div>
            <div class="tickDot mt-1"></div>
          </div>

          <div class="flex items-center justify-between gap-3 mt-1">
            <button class="learnMore px-3 py-2 rounded-xl border border-white/10 bg-white/5 hover:bg-white/8 text-sm whitespace-nowrap">
              Learn more
            </button>
            <div class="text-xs opacity-60">${selected ? "Selected" : "Click to select"}</div>
          </div>
        `;

        card.addEventListener("click", (e) => {
          if (e.target && e.target.classList.contains("learnMore")) return;
          toggleModule(m.id);
        });

        card.querySelector(".learnMore").addEventListener("click", (e) => {
          e.preventDefault();
          e.stopPropagation();
          openModuleModal(m.id);
        });

        grid.appendChild(card);
      });

      updateTotal();
    }

    function toggleModule(id){
      if (state.selectedModules.has(id)) state.selectedModules.delete(id);
      else state.selectedModules.add(id);
      renderModules();
    }

    function openModuleModal(id){
      const m = MODULES.find(x=>x.id===id);
      if(!m) return;

      setText($("mmTitle"), m.name);
      setText($("mmPrice"), `${money(m.price)} / month`);
      setText($("mmSummary"), m.full);

      const bullets = $("mmBullets");
      bullets.innerHTML = "";
      m.bullets.forEach(b=>{
        const li = document.createElement("li");
        li.className = "flex gap-2";
        li.innerHTML = `<span class="opacity-70">•</span><span>${b}</span>`;
        bullets.appendChild(li);
      });

      $("mmVideo").src = "https://www.youtube.com/embed/S2kymv60ndQ";
      openModal($("moduleModalBackdrop"));
    }

    /******************************************************************
      COMPANY SIZE
    ******************************************************************/
    function setCompanySize(sizeId){
      const size = COMPANY_SIZES.find(s=>s.id===sizeId);
      state.size = size || null;

      document.querySelectorAll("[data-size]").forEach(btn=>{
        btn.classList.remove("selected");
        if(btn.dataset.size === sizeId) btn.classList.add("selected");
      });

      if(state.size){
        show($("modulesWrap"));
        show($("summaryBar"));
        if (state.size.id === "s250plus"){
          show($("plusBox"));
        } else {
          hide($("plusBox"));
          $("plusCount").value = "";
          $("plusNotes").value = "";
          hide($("plusWarn"));
        }
      } else {
        hide($("modulesWrap"));
        hide($("summaryBar"));
        hide($("plusBox"));
      }

      renderModules();
      updateTotal();
    }

    function computeTotal(){
      const base = state.size?.price || 0;
      let mods = 0;
      state.selectedModules.forEach(id=>{
        const m = MODULES.find(x=>x.id===id);
        mods += (m?.price || 0);
      });
      return base + mods;
    }

    function updateTotal(){
      const totalEl = $("totalText");
      const mini = $("summaryMini");

      if(!state.size){
        setText(totalEl, "£0 / month");
        setText(mini, "Select a company size to begin.");
        return;
      }

      const total = computeTotal();
      setText(totalEl, `${money(total)} / month`);
      setText(mini, `${state.size.label} + ${state.selectedModules.size} module(s)`);

      $("checkoutBtn").textContent = (state.size.id === "s250plus") ? "Contact us" : "Continue";
    }

    /******************************************************************
      250+ CONTACT EMAIL
    ******************************************************************/
    function buildContactEmail(){
      const approx = Number($("plusCount").value || 0);
      const notes = ($("plusNotes").value || "").trim();

      if(!approx || approx < 1){
        showErr($("plusWarn"), "Please enter an approximate company size to continue.");
        return null;
      }
      hide($("plusWarn"));

      if(approx < 250){
        return { confirm: true, approx, notes };
      }

      const selected = Array.from(state.selectedModules).map(id => MODULES.find(m=>m.id===id)?.name).filter(Boolean);
      const subject = "250+ Person Company - Wanting to Sign Up";

      const bodyLines = [
        "Hello SmartCore Technology,",
        "",
        "We would like to discuss a SmartCore subscription for a 250+ person organisation.",
        "",
        `Approximate headcount: ${approx}`,
        "",
        "Requested systems:",
        selected.length ? selected.map(s=>`- ${s}`).join("\n") : "- (none selected yet)",
        "",
        notes ? `Additional notes:\n${notes}\n` : "",
        "Please let us know the next steps and any information you need from us.",
        "",
        "Kind regards,",
        "(Your name)"
      ].join("\n");

      const mailto = `mailto:support@smartcoretechnology.co.uk?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(bodyLines)}`;
      return { mailto };
    }

    /******************************************************************
      API HELPERS (Cloudflare Functions)
    ******************************************************************/
    async function apiPost(path, payload){
      const res = await fetch(path, {
        method:"POST",
        headers: { "content-type":"application/json" },
        body: JSON.stringify(payload || {})
      });
      const txt = await res.text();
      let data = null;
      try{ data = JSON.parse(txt); }catch(_){}
      if(!res.ok){
        const msg = (data && (data.error || data.message)) ? (data.error || data.message) : txt;
        throw new Error(msg || ("Request failed: " + res.status));
      }
      return data ?? {};
    }

    /******************************************************************
      SIGNUP FLOW (OWNER)
      FIX: after verify, we now ensure the auth user actually exists
      and we can start a session (prevents “invalid login credentials”)
    ******************************************************************/
    async function ownerSendCode(){
      clearErr($("suMsg"));

      if(!state.size){
        showErr($("suMsg"), "Please select a company size first.");
        return;
      }

      const company_name = $("suCompanyName").value.trim();
      const email = $("suEmail").value.trim().toLowerCase();
      const password = $("suPassword").value;

      if(!company_name) return showErr($("suMsg"), "Please enter your company name.");
      if(!email) return showErr($("suMsg"), "Please enter your email.");
      if(!password || password.length < 8) return showErr($("suMsg"), "Password must be at least 8 characters.");

      if(state.size.id === "s250plus"){
        showErr($("suMsg"), "Please use Contact us for 250+ companies.");
        return;
      }

      state.pendingSignup = {
        company_name,
        email,
        password,
        company_size_id: state.size.id,
        company_size_label: state.size.label,
        company_size_price: state.size.price,
        max_employees: state.size.maxEmployees,
        module_ids: Array.from(state.selectedModules),
      };

      $("suContinue").disabled = true;
      $("suContinue").classList.add("opacity-60");

      try{
        await apiPost("/api/send-code", { email, purpose:"owner_signup" });
        closeModal($("signupModalBackdrop"));
        setText($("vEmail"), email);
        $("vCode").value = "";
        clearErr($("vMsg"));
        openModal($("verifyModalBackdrop"));
      }catch(e){
        const msg = String(e.message || "");
        if(msg.toLowerCase().includes("already") || msg.toLowerCase().includes("registered")){
          showErr($("suMsg"), "This email is already registered to a SmartCore account — log in instead?");
          return;
        }
        showErr($("suMsg"), msg || "Failed to send code.");
      }finally{
        $("suContinue").disabled = false;
        $("suContinue").classList.remove("opacity-60");
      }
    }

    async function ownerVerifyAndCreate(){
  clearErr($("vMsg"));

  const code = $("vCode").value.trim();
  if (!code || code.length !== 6) {
    showErr($("vMsg"), "Please enter the 6-digit code.");
    return;
  }

  // ✅ These must be stored from the signup screen
  const email = state.pendingSignup?.email;
  const password = state.pendingSignup?.password;
  const company_name = state.pendingSignup?.company_name;
  const company_size = state.pendingSignup?.company_size; // or company_size_id/label depending on how you store it
  const module_ids = state.pendingSignup?.module_ids || [];

  if (!email || !password || !company_name) {
    showErr($("vMsg"), "Signup details missing. Please close and try again.");
    return;
  }

  try {
    // 1) VERIFY (checks code, returns verify_token)
    const verifyRes = await apiPost("/api/verify-code", {
      phase: "verify",
      purpose: "owner_signup",
      email,
      code
    });

    if (!verifyRes?.ok || !verifyRes?.verify_token) {
      throw new Error(verifyRes?.error || "Verification failed.");
    }

    // 2) FINALISE (creates auth user + company + profile)
    const finalRes = await apiPost("/api/verify-code", {
      phase: "finalise",
      purpose: "owner_signup",
      email,
      code,
      verify_token: verifyRes.verify_token,

      // ✅ MUST include password here
      password,

      // If you don’t want to collect full_name yet, send a placeholder
      full_name: "Owner",

      company_name,
      company_size,       // match your backend expectation
      module_ids
    });

    if (!finalRes?.ok) throw new Error(finalRes?.error || "Finalise failed.");

    // ✅ Now the user exists, so login will work
    const { error } = await sb.auth.signInWithPassword({ email, password });
    if (error) throw new Error(error.message);

    closeModal($("verifyModalBackdrop"));
    openModal($("payModalBackdrop")); // or your next step

  } catch (e) {
    showErr($("vMsg"), String(e.message || e));
  }
}


    // Payment placeholder
    const total = computeTotal();
    setText($("payTotal"), `${money(total)} / month`);
    setText($("paySummary"), buildPaySummaryText());
    clearErr($("payMsg"));
    openModal($("payModalBackdrop"));

  }catch(e){
    showErr($("vMsg"), String(e.message || "Verification failed."));
  }finally{
    $("vVerify").disabled = false;
    $("vVerify").classList.remove("opacity-60");
  }
}

    async function resendOwnerCode(){
      clearErr($("vMsg"));
      if(!state.pendingSignup) return showErr($("vMsg"), "Start signup again first.");
      try{
        await apiPost("/api/send-code", { email: state.pendingSignup.email, purpose:"owner_signup" });
        showOk($("vMsg"), "New code sent. Please check your inbox.");
      }catch(e){
        showErr($("vMsg"), String(e.message || "Failed to resend code."));
      }
    }

    function buildPaySummaryText(){
      const sizeLabel = state.size?.label || "—";
      const modules = Array.from(state.selectedModules).map(id => MODULES.find(m=>m.id===id)?.name).filter(Boolean);
      const mText = modules.length ? modules.join(", ") : "No modules selected";
      return `Plan: ${sizeLabel}. Modules: ${mText}.`;
    }

    /******************************************************************
      PAYMENT (Accept/Decline)
      FIX: subscriptions table columns match your screenshot
    ******************************************************************/
    async function paymentAccept(){
      clearErr($("payMsg"));

      try{
        const { data: { user }, error: uerr } = await sb.auth.getUser();
        if(uerr) throw new Error(uerr.message);
        if(!user) throw new Error("Not signed in.");

        // Ensure account objects loaded (company/profile) but don't hard fail if backend hasn't created rows yet
        await loadAccount();

        const total = computeTotal();
        const moduleTotal = Array.from(state.selectedModules).reduce((sum, id)=>{
          const m = MODULES.find(x=>x.id===id);
          return sum + (m?.price || 0);
        }, 0);

        const selectedModules = Array.from(state.selectedModules).map(id=>{
          const m = MODULES.find(x=>x.id===id);
          return m ? ({ id: m.id, name: m.name, price: m.price }) : null;
        }).filter(Boolean);

        const subRow = {
          user_id: user.id,
          company_size_id: state.size?.id || null,
          company_size_label: state.size?.label || null,
          company_size_price: state.size?.price || 0,
          selected_modules: selectedModules,                 // jsonb
          selected_modules_ids: Array.from(state.selectedModules), // jsonb (as array)
          modules_total: moduleTotal,
          total_monthly: total,
          currency: "GBP",
          status: "active"
        };

        const { error: insErr } = await sb.from("subscriptions").insert(subRow);
        if(insErr) throw new Error("Subscription save failed: " + insErr.message);

        closeModal($("payModalBackdrop"));

        // Reload + show dashboard
        await loadAccount();
        showDashboard();

      }catch(e){
        showErr($("payMsg"), String(e.message || "Payment accept failed."));
      }
    }

    async function paymentDecline(){
      closeModal($("payModalBackdrop"));
      alert("Payment declined (testing). No subscription has been saved.");
    }

    /******************************************************************
      LOGIN FLOW
    ******************************************************************/
    async function login(){
      clearErr($("liMsg"));
      $("liWrong").classList.add("hidden");

      const email = $("liEmail").value.trim().toLowerCase();
      const password = $("liPassword").value;

      if(!email) return showErr($("liMsg"), "Please enter your email.");
      if(!password) return showErr($("liMsg"), "Please enter your password.");

      $("liLogin").disabled = true;
      $("liLogin").classList.add("opacity-60");

      try{
        const { data, error } = await sb.auth.signInWithPassword({ email, password });
        if(error){
          $("liWrong").classList.remove("hidden");
          throw new Error(error.message);
        }

        closeModal($("loginModalBackdrop"));
        await loadAccount();
        showDashboard();

      }catch(e){
        showErr($("liMsg"), String(e.message || "Login failed."));
      }finally{
        $("liLogin").disabled = false;
        $("liLogin").classList.remove("opacity-60");
      }
    }

    async function resetPassword(){
      clearErr($("liMsg"));
      const email = $("liEmail").value.trim().toLowerCase();
      if(!email) return showErr($("liMsg"), "Enter your email above, then click the reset link again.");

      try{
        const { error } = await sb.auth.resetPasswordForEmail(email, { redirectTo: window.location.origin + "/#reset" });
        if(error) throw new Error(error.message);
        showOk($("liMsg"), "Password reset email sent. Please check your inbox.");
      }catch(e){
        showErr($("liMsg"), String(e.message || "Failed to send reset email."));
      }
    }

    async function signOut(){
      await sb.auth.signOut();
      state.session = null;
      state.profile = null;
      state.company = null;
      state.subscription = null;
      state.employees = [];
      hide($("dashboard"));
      show($("main"));
      window.scrollTo({ top:0, behavior:"smooth" });
    }

    /******************************************************************
      EMPLOYEE SIGNUP
      FIX: employees table does NOT have company_code column.
      So: company_code -> find company.id -> then employees where company_id + exact name (case-insensitive in JS)
    ******************************************************************/
    async function employeeSendCode(){
      clearErr($("empMsg"));
      clearErr($("empVerifyMsg"));

      const company_code = $("empCompanyCode").value.trim().toUpperCase();
      const full_name = $("empFullName").value.trim();
      const email = $("empEmail").value.trim().toLowerCase();
      const password = $("empPassword").value;

      if(!company_code) return showErr($("empMsg"), "Please enter your company code.");
      if(!full_name) return showErr($("empMsg"), "Please enter your full name.");
      if(!email) return showErr($("empMsg"), "Please enter your email.");
      if(!password || password.length < 8) return showErr($("empMsg"), "Password must be at least 8 characters.");

      try{
        const { data: comp, error: cErr } = await sb
          .from("companies")
          .select("id, company_name, company_code")
          .eq(DB.companies.code, company_code)
          .maybeSingle();

        if(cErr) throw new Error(cErr.message);
        if(!comp) return showErr($("empMsg"), EMP_NOT_FOUND_MSG);

        const { data: emps, error: eErr } = await sb
          .from("employees")
          .select("id, full_name")
          .eq("company_id", comp.id);

        if(eErr) throw new Error(eErr.message);

        const needle = full_name.replace(/\s+/g," ").trim().toLowerCase();
        const match = (emps || []).find(x => (x.full_name||"").replace(/\s+/g," ").trim().toLowerCase() === needle);

        if(!match){
          showErr($("empMsg"), EMP_NOT_FOUND_MSG);
          return;
        }

        state.pendingEmployee = { company_code, full_name, email, password };

        await apiPost("/api/send-code", { email, purpose:"employee_signup", company_code });

        show($("empVerifyBox"));
        $("empCode").value = "";
        $("empMsg").classList.add("hidden");

      }catch(e){
        showErr($("empMsg"), String(e.message || "Failed to send code."));
      }
    }

    async function employeeVerifyAndCreate(){
      clearErr($("empVerifyMsg"));
      if(!state.pendingEmployee) return showErr($("empVerifyMsg"), "Start again from the employee sign-up form.");

      const code = $("empCode").value.trim();
      if(!code || code.length !== 6) return showErr($("empVerifyMsg"), "Enter the 6-digit code.");

      try{
        await apiPost("/api/verify-code", {
          purpose: "employee_signup",
          email: state.pendingEmployee.email,
          code,
          company_code: state.pendingEmployee.company_code,
          full_name: state.pendingEmployee.full_name
        });

        // Ensure auth user exists + log in (same fallback idea)
        const email = state.pendingEmployee.email;
        const password = state.pendingEmployee.password;

        const { data: si, error: siErr } = await sb.auth.signInWithPassword({ email, password });
        if(siErr){
          const { data: su, error: suErr } = await sb.auth.signUp({ email, password });
          if(suErr){
            const { error: si2Err } = await sb.auth.signInWithPassword({ email, password });
            if(si2Err) throw new Error(si2Err.message || "Invalid login credentials.");
          } else if(!su.session){
            throw new Error("Account created, but email confirmation is required in Supabase Auth settings. Confirm email then log in.");
          }
        }

        closeModal($("empModalBackdrop"));
        await loadAccount();
        showDashboard();

      }catch(e){
        showErr($("empVerifyMsg"), String(e.message || "Verification failed."));
      }
    }

    async function employeeResend(){
      clearErr($("empVerifyMsg"));
      if(!state.pendingEmployee) return showErr($("empVerifyMsg"), "Start again first.");
      try{
        await apiPost("/api/send-code", { email: state.pendingEmployee.email, purpose:"employee_signup", company_code: state.pendingEmployee.company_code });
        showOk($("empVerifyMsg"), "New code sent. Please check your inbox.");
      }catch(e){
        showErr($("empVerifyMsg"), String(e.message || "Failed to resend code."));
      }
    }

    /******************************************************************
      ACCOUNT LOADING + DASHBOARD
      FIX: profiles primary key is user_id, NOT id
    ******************************************************************/
    async function loadAccount(){
      const { data: { session } } = await sb.auth.getSession();
      state.session = session || null;

      if(!state.session?.user){
        state.profile = null;
        state.company = null;
        state.subscription = null;
        state.employees = [];
        return;
      }

      const uid = state.session.user.id;

      // profile by user_id (NOT id)
      const { data: prof, error: pErr } = await sb
        .from("profiles")
        .select("*")
        .eq(DB.profiles.userId, uid)
        .maybeSingle();

      if(pErr) throw new Error("Profile load failed: " + pErr.message);
      state.profile = prof || null;

      // company by profile.company_id or owner_user_id
      let comp = null;
      if(state.profile?.[DB.profiles.companyId]){
        const { data, error } = await sb
          .from("companies")
          .select("*")
          .eq("id", state.profile[DB.profiles.companyId])
          .maybeSingle();
        if(error) throw new Error("Company load failed: " + error.message);
        comp = data;
      } else {
        const { data, error } = await sb
          .from("companies")
          .select("*")
          .eq(DB.companies.owner, uid)
          .maybeSingle();
        if(error) throw new Error("Company load failed: " + error.message);
        comp = data;
      }
      state.company = comp || null;

      // subscription by user_id (your table has user_id, not company_id)
      const { data: sub, error: sErr } = await sb
        .from("subscriptions")
        .select("*")
        .eq("user_id", uid)
        .order("created_at", { ascending:false })
        .limit(1)
        .maybeSingle();

      state.subscription = sErr ? null : (sub || null);

      // employees by company_id
      if(state.company?.id){
        const { data: emps, error: eErr } = await sb
          .from("employees")
          .select("*")
          .eq("company_id", state.company.id)
          .order("created_at", { ascending:true });

        state.employees = eErr ? [] : (emps || []);
      } else {
        state.employees = [];
      }
    }

    function showDashboard(){
      hide($("main"));
      show($("dashboard"));

      const c = state.company || {};
      const plan = state.subscription?.company_size_label || c[DB.companies.size] || "(not set)";
      const max = c[DB.companies.maxEmp] ?? null;

      setText($("dashCompanyName"), c[DB.companies.name] || "(not set)");
      setText($("dashCompanyAddress"), c[DB.companies.address] || "(not set)");
      setText($("dashCompanyCode"), c[DB.companies.code] || "(not set)");
      setText($("dashPlan"), plan);
      setText($("dashMaxEmp"), (max ? String(max) : "Unlimited"));

      const total = state.subscription?.total_monthly ?? null;
      setText($("dashTotal"), total ? `${money(total)} / month` : "");

      setText($("dashSub"), "Manage your company, systems, and employees.");

      renderSystems();
      renderEmployees();
      computeOnboardingStep();
      renderOnboardingStep();

      window.location.hash = "#dashboard";
      window.scrollTo({ top:0, behavior:"smooth" });
    }

    function renderSystems(){
      const wrap = $("dashSystems");
      wrap.innerHTML = "";

      // Your subs table stores selected_modules_ids (jsonb) OR selected_modules
      const ownedIds = Array.isArray(state.subscription?.selected_modules_ids)
        ? state.subscription.selected_modules_ids
        : (Array.isArray(state.subscription?.selected_modules)
            ? state.subscription.selected_modules.map(x=>x?.id).filter(Boolean)
            : []);

      const owned = MODULES.filter(m => ownedIds.includes(m.id));

      if(!owned.length){
        wrap.innerHTML = `
          <div class="glass2 p-4 sm:col-span-2 lg:col-span-3">
            <div class="font-semibold">No modules found</div>
            <div class="mt-1 text-sm opacity-75">Once you complete payment (testing), your modules will appear here.</div>
          </div>
        `;
        return;
      }

      owned.forEach(m=>{
        const a = document.createElement("a");
        a.href = "https://smartfits.co.uk";
        a.target = "_blank";
        a.rel = "noopener";
        a.className = "glass2 p-4 hover:bg-white/6 transition block";
        a.innerHTML = `
          <div class="font-semibold">${m.name}</div>
          <div class="mt-1 text-sm opacity-75">Open system</div>
        `;
        wrap.appendChild(a);
      });
    }

    /******************************************************************
      ONBOARDING WIZARD
      FIX: companies columns are company_name, address, logo_url
      profiles columns are user_id, full_name, job_title, job_category, role, is_admin (text)
    ******************************************************************/
    function computeOnboardingStep(){
      const c = state.company || {};
      const p = state.profile || {};

      if(!c[DB.companies.name]) { state.onboardingStep = 1; return; }
      if(!c[DB.companies.address]) { state.onboardingStep = 2; return; }
      if(!c[DB.companies.logo]) { state.onboardingStep = 3; return; }
      if(!p[DB.profiles.fullName] || !p[DB.profiles.jobTitle] || !p[DB.profiles.jobCat]) { state.onboardingStep = 4; return; }
      if(!state.employees || state.employees.length < 1) { state.onboardingStep = 5; return; }

      state.onboardingStep = 6;
    }

    function renderOnboardingStep(){
      const box = $("onbStepBox");
      const label = $("onbStepLabel");
      box.innerHTML = "";

      if(state.onboardingStep === 6){
        setText(label, "Completed");
        box.innerHTML = `
          <div class="font-semibold">Onboarding complete</div>
          <div class="mt-2 text-sm opacity-75">Your company is set up and ready to use.</div>
        `;
        return;
      }

      setText(label, `Step ${state.onboardingStep} of 5`);

      if(state.onboardingStep === 1){
        box.innerHTML = `
          <div class="font-semibold">Company name</div>
          <div class="mt-2 text-sm opacity-75">Enter your full company name.</div>
          <div class="mt-3">
            <input id="onbCompanyName" class="inp" placeholder="Full company name" value="${(state.company?.[DB.companies.name]||"")}" />
          </div>
          <div class="mt-4">
            <button id="onbNext1" class="px-4 py-3 rounded-2xl border border-[rgba(120,170,255,.35)] bg-[rgba(120,170,255,.16)] hover:bg-[rgba(120,170,255,.22)] text-sm font-medium">Continue</button>
            <div id="onbMsg" class="mt-3 text-sm text-red-300 hidden"></div>
          </div>
        `;
        $("onbNext1").onclick = async ()=>{
          const v = $("onbCompanyName").value.trim();
          if(!v) return showErr($("onbMsg"), "Please enter your company name.");
          await updateCompany({ [DB.companies.name]: v });
        };
        return;
      }

      if(state.onboardingStep === 2){
        box.innerHTML = `
          <div class="font-semibold">Company address</div>
          <div class="mt-2 text-sm opacity-75">Enter the full company address.</div>
          <div class="mt-3">
            <input id="onbCompanyAddr" class="inp" placeholder="Full company address" value="${(state.company?.[DB.companies.address]||"")}" />
          </div>
          <div class="mt-4">
            <button id="onbNext2" class="px-4 py-3 rounded-2xl border border-[rgba(120,170,255,.35)] bg-[rgba(120,170,255,.16)] hover:bg-[rgba(120,170,255,.22)] text-sm font-medium">Continue</button>
            <div id="onbMsg" class="mt-3 text-sm text-red-300 hidden"></div>
          </div>
        `;
        $("onbNext2").onclick = async ()=>{
          const v = $("onbCompanyAddr").value.trim();
          if(!v) return showErr($("onbMsg"), "Please enter your company address.");
          await updateCompany({ [DB.companies.address]: v });
        };
        return;
      }

      if(state.onboardingStep === 3){
        box.innerHTML = `
          <div class="font-semibold">Company logo</div>
          <div class="mt-2 text-sm opacity-75">Upload a logo (preferably with no background).</div>
          <div class="mt-3 flex flex-wrap items-center gap-3">
            <label class="fileBtn">
              <input id="onbLogoFile" type="file" accept="image/*" />
              <span class="text-sm font-medium">Choose logo</span>
            </label>
            <div id="onbLogoName" class="text-sm opacity-70">No file selected</div>
          </div>
          <div class="mt-4">
            <button id="onbNext3" class="px-4 py-3 rounded-2xl border border-[rgba(120,170,255,.35)] bg-[rgba(120,170,255,.16)] hover:bg-[rgba(120,170,255,.22)] text-sm font-medium">Continue</button>
            <div id="onbMsg" class="mt-3 text-sm text-red-300 hidden"></div>
          </div>
        `;
        $("onbLogoFile").onchange = ()=>{
          const f = $("onbLogoFile").files?.[0];
          setText($("onbLogoName"), f ? f.name : "No file selected");
        };
        $("onbNext3").onclick = async ()=>{
          const f = $("onbLogoFile").files?.[0];
          if(!f) return showErr($("onbMsg"), "Please choose a logo file.");
          await uploadCompanyLogo(f);
        };
        return;
      }

      if(state.onboardingStep === 4){
        box.innerHTML = `
          <div class="font-semibold">Tell us about you</div>
          <div class="mt-2 text-sm opacity-75">This helps set the owner profile and permissions.</div>

          <div class="mt-3 grid grid-cols-1 sm:grid-cols-2 gap-3">
            <div class="sm:col-span-2">
              <label class="text-xs opacity-70">Full name</label>
              <input id="onbFullName" class="inp mt-1" placeholder="e.g. Finley Hassall" value="${(state.profile?.[DB.profiles.fullName]||"")}" />
            </div>
            <div>
              <label class="text-xs opacity-70">Job title</label>
              <input id="onbJobTitle" class="inp mt-1" placeholder="e.g. Founder" value="${(state.profile?.[DB.profiles.jobTitle]||"")}" />
            </div>
            <div>
              <label class="text-xs opacity-70">Job category</label>
              <input id="onbJobCategory" class="inp mt-1" placeholder="e.g. Senior management team" value="${(state.profile?.[DB.profiles.jobCat]||"")}" />
            </div>

            <div class="sm:col-span-2 mt-1">
              <div class="chkWrap" id="onbAdminWrap">
                <div class="chk on" id="onbAdminChk">
                  <svg width="14" height="14" viewBox="0 0 24 24" fill="none">
                    <path d="M20 6L9 17l-5-5" stroke="white" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/>
                  </svg>
                </div>
                <div>
                  <div class="text-sm font-medium">Admin access</div>
                  <div class="text-xs opacity-70">Owners are admins by default. You can adjust employee admins later.</div>
                </div>
              </div>
            </div>
          </div>

          <div class="mt-4">
            <button id="onbNext4" class="px-4 py-3 rounded-2xl border border-[rgba(120,170,255,.35)] bg-[rgba(120,170,255,.16)] hover:bg-[rgba(120,170,255,.22)] text-sm font-medium">Continue</button>
            <div id="onbMsg" class="mt-3 text-sm text-red-300 hidden"></div>
          </div>
        `;
        $("onbNext4").onclick = async ()=>{
          const full_name = $("onbFullName").value.trim();
          const job_title = $("onbJobTitle").value.trim();
          const job_category = $("onbJobCategory").value.trim();
          if(!full_name) return showErr($("onbMsg"), "Please enter your full name.");
          if(!job_title) return showErr($("onbMsg"), "Please enter your job title.");
          if(!job_category) return showErr($("onbMsg"), "Please enter your job category.");

          // is_admin is TEXT in your table: store "true"/"false"
          await updateProfile({
            [DB.profiles.fullName]: full_name,
            [DB.profiles.jobTitle]: job_title,
            [DB.profiles.jobCat]: job_category,
            [DB.profiles.role]: "owner",
            [DB.profiles.isAdmin]: "true"
          });
        };
        return;
      }

      if(state.onboardingStep === 5){
        box.innerHTML = `
          <div class="font-semibold">Add employees</div>
          <div class="mt-2 text-sm opacity-75">Add at least one employee. You can add more at any time.</div>

          <div class="mt-4">
            <button id="onbAddEmp" class="px-4 py-3 rounded-2xl border border-white/10 bg-white/5 hover:bg-white/8 text-sm font-medium">
              Add your first employee
            </button>
          </div>

          <div id="onbMsg" class="mt-3 text-sm text-red-300 hidden"></div>
        `;
        $("onbAddEmp").onclick = ()=> openEmployeeEditor(null);
        return;
      }
    }

    async function updateCompany(patch){
      const c = state.company;
      if(!c?.id) return;
      const { error } = await sb.from("companies").update(patch).eq("id", c.id);
      if(error) return showErr($("onbMsg"), error.message);
      await loadAccount();
      showDashboard();
    }

    async function updateProfile(patch){
      const uid = state.session?.user?.id;
      if(!uid) return;

      const { error } = await sb.from("profiles").update(patch).eq(DB.profiles.userId, uid);
      if(error) return showErr($("onbMsg"), error.message);

      await loadAccount();
      showDashboard();
    }

    async function uploadCompanyLogo(file){
      try{
        const companyId = state.company?.id;
        if(!companyId) throw new Error("Company not found.");

        const ext = (file.name.split(".").pop() || "png").toLowerCase();
        const path = `${companyId}/logo.${ext}`;

        const up = await sb.storage.from("company-logos").upload(path, file, { upsert:true, contentType: file.type });
        if(up.error) throw new Error(up.error.message);

        const pub = sb.storage.from("company-logos").getPublicUrl(path);
        const url = pub?.data?.publicUrl;
        if(!url) throw new Error("Could not get logo URL.");

        await updateCompany({ [DB.companies.logo]: url });

      }catch(e){
        showErr($("onbMsg"), String(e.message || "Logo upload failed."));
      }
    }

    /******************************************************************
      EMPLOYEE CRUD
      NOTE: your employees table currently DOES NOT have is_admin.
      We keep the UI, but writes are “safe”:
      - try with is_admin, if column missing -> retry without
    ******************************************************************/
    function renderEmployees(){
      const tbody = $("empTable");
      tbody.innerHTML = "";

      const max = Number(state.company?.[DB.companies.maxEmp] || 0) || null;
      const count = state.employees?.length || 0;

      if(max && count >= max){
        showErr($("empLimitMsg"), `You’ve reached your plan limit (${max} employees). Upgrade your plan to add more.`);
      } else {
        clearErr($("empLimitMsg"));
      }

      (state.employees || []).forEach(emp=>{
        const isAdmin = (emp.is_admin === true || emp.is_admin === "true"); // handles if you add column later
        const tr = document.createElement("tr");
        tr.className = "border-t border-white/5";
        tr.innerHTML = `
          <td class="py-3 pr-3"><div class="font-medium">${emp.full_name || ""}</div></td>
          <td class="py-3 pr-3">${emp.job_title || ""}</td>
          <td class="py-3 pr-3">${emp.job_category || ""}</td>
          <td class="py-3 pr-3 font-mono text-xs opacity-80">${emp.employee_code || ""}</td>
          <td class="py-3 pr-3">
            ${isAdmin ? `<span class="px-2 py-1 rounded-lg bg-[rgba(120,170,255,.14)] border border-[rgba(120,170,255,.20)] text-xs">Admin</span>` : `<span class="text-xs opacity-60">—</span>`}
          </td>
          <td class="py-3 pr-1 text-right">
            <div class="inline-flex gap-2">
              <button class="edit px-3 py-2 rounded-xl border border-white/10 bg-white/5 hover:bg-white/8 text-xs" title="Edit">✎</button>
              <button class="del px-3 py-2 rounded-xl border border-white/10 bg-white/5 hover:bg-white/8 text-xs" title="Remove">✕</button>
            </div>
          </td>
        `;
        tr.querySelector(".edit").onclick = ()=> openEmployeeEditor(emp);
        tr.querySelector(".del").onclick = ()=> confirmRemoveEmployee(emp);
        tbody.appendChild(tr);
      });
    }

    function openEmployeeEditor(emp){
      const max = Number(state.company?.[DB.companies.maxEmp] || 0) || null;
      const count = state.employees?.length || 0;
      if(!emp && max && count >= max){
        alert(`You’ve reached your plan limit (${max} employees). Upgrade your plan to add more.`);
        return;
      }

      state.editingEmployee = emp ? { ...emp } : null;
      setText($("empEditTitle"), emp ? "Edit employee" : "Add employee");

      $("empEName").value = emp?.full_name || "";
      $("empETitle").value = emp?.job_title || "";
      $("empECategory").value = emp?.job_category || "";

      const isOn = (emp?.is_admin === true || emp?.is_admin === "true");
      setAdminChk(!!isOn);

      clearErr($("empEditMsg"));
      openModal($("empEditModalBackdrop"));
    }

    function setAdminChk(on){
      const box = $("empEAdminChk");
      const tick = $("empEAdminTick");
      if(on){
        box.classList.add("on");
        tick.classList.remove("hidden");
      }else{
        box.classList.remove("on");
        tick.classList.add("hidden");
      }
      box.dataset.on = on ? "1" : "0";
    }

    async function saveEmployee(){
      clearErr($("empEditMsg"));

      const full_name = $("empEName").value.trim();
      const job_title = $("empETitle").value.trim();
      const job_category = $("empECategory").value.trim();
      const is_admin = $("empEAdminChk").dataset.on === "1";

      if(!full_name) return showErr($("empEditMsg"), "Please enter the employee name.");
      const company = state.company;
      if(!company?.id) return showErr($("empEditMsg"), "Company not loaded.");

      try{
        if(state.editingEmployee){
          // update
          const patchA = { full_name, job_title, job_category, is_admin };
          let { error } = await sb.from("employees").update(patchA).eq("id", state.editingEmployee.id);

          // if is_admin column doesn't exist -> retry without it
          if(error && (error.message || "").toLowerCase().includes("column") && (error.message || "").toLowerCase().includes("is_admin")){
            const patchB = { full_name, job_title, job_category };
            const r2 = await sb.from("employees").update(patchB).eq("id", state.editingEmployee.id);
            error = r2.error;
          }
          if(error) throw new Error(error.message);

        } else {
          const prefix = companyPrefix(company[DB.companies.name] || "COM");
          let code = "";
          let tries = 0;

          while(tries < 6){
            code = prefix + randDigits(9);
            const { data, error } = await sb.from("employees").select("id").eq("employee_code", code).limit(1);
            if(error) throw new Error(error.message);
            if(!data || !data.length) break;
            tries++;
          }
          if(!code) throw new Error("Could not generate a unique employee ID.");

          const rowA = {
            company_id: company.id,
            full_name,
            job_title,
            job_category,
            employee_code: code,
            is_admin
          };

          let { error: insErr } = await sb.from("employees").insert(rowA);

          // retry if is_admin column missing
          if(insErr && (insErr.message || "").toLowerCase().includes("column") && (insErr.message || "").toLowerCase().includes("is_admin")){
            const rowB = { company_id: company.id, full_name, job_title, job_category, employee_code: code };
            const r2 = await sb.from("employees").insert(rowB);
            insErr = r2.error;
          }

          if(insErr) throw new Error(insErr.message);
        }

        closeModal($("empEditModalBackdrop"));
        await loadAccount();
        showDashboard();

      }catch(e){
        showErr($("empEditMsg"), String(e.message || "Save failed."));
      }
    }

    function confirmRemoveEmployee(emp){
      const cname = state.company?.[DB.companies.name] || "this company";
      const endsWithS = cname.trim().toLowerCase().endsWith("s");
      const possessive = endsWithS ? `${cname}'` : `${cname}'s`;

      const msg = `Are you sure you would like to remove ${emp.full_name} from ${possessive} SmartDatabase? This action cannot be undone.`;
      setText($("confirmText"), msg);

      state.confirmAction = async () => {
        try{
          const { error } = await sb.from("employees").delete().eq("id", emp.id);
          if(error) throw new Error(error.message);
          closeModal($("confirmModalBackdrop"));
          await loadAccount();
          showDashboard();
        }catch(e){
          alert("Remove failed: " + (e.message || e));
        }
      };

      openModal($("confirmModalBackdrop"));
    }

    /******************************************************************
      COMPANY SETTINGS
    ******************************************************************/
    function openSettings(){
      clearErr($("setMsg"));
      $("setName").value = state.company?.[DB.companies.name] || "";
      $("setAddr").value = state.company?.[DB.companies.address] || "";
      $("setPrimary").value = state.company?.[DB.companies.primary] || "";
      $("setSecondary").value = state.company?.[DB.companies.secondary] || "";
      $("setText").value = state.company?.[DB.companies.text] || "";
      openModal($("settingsModalBackdrop"));
    }

    async function saveSettings(){
      clearErr($("setMsg"));

      const patch = {
        [DB.companies.name]: $("setName").value.trim(),
        [DB.companies.address]: $("setAddr").value.trim(),
        [DB.companies.primary]: $("setPrimary").value.trim() || null,
        [DB.companies.secondary]: $("setSecondary").value.trim() || null,
        [DB.companies.text]: $("setText").value.trim() || null
      };

      if(!patch[DB.companies.name]) return showErr($("setMsg"), "Company name is required.");
      if(!patch[DB.companies.address]) return showErr($("setMsg"), "Company address is required.");

      try{
        const { error } = await sb.from("companies").update(patch).eq("id", state.company.id);
        if(error) throw new Error(error.message);
        closeModal($("settingsModalBackdrop"));
        await loadAccount();
        showDashboard();
      }catch(e){
        showErr($("setMsg"), String(e.message || "Save failed."));
      }
    }

    function buyMore(){
      hide($("dashboard"));
      show($("main"));
      window.location.hash = "#packages";
      $("packages").scrollIntoView({ behavior:"smooth", block:"start" });
    }

    /******************************************************************
      EVENTS
    ******************************************************************/
    function wire(){
      $("heroBuild").onclick = ()=> $("packages").scrollIntoView({ behavior:"smooth", block:"start" });
      $("heroEmployee").onclick = ()=> { openModal($("empModalBackdrop")); };
      $("heroDown").onclick = ()=> $("packages").scrollIntoView({ behavior:"smooth", block:"start" });

      $("navHome").onclick = ()=> { hide($("dashboard")); show($("main")); window.scrollTo({ top:0, behavior:"smooth" }); };
      $("navLogin").onclick = ()=> openModal($("loginModalBackdrop"));

      document.querySelectorAll("[data-size]").forEach(btn=>{
        btn.addEventListener("click", ()=> setCompanySize(btn.dataset.size));
      });

      $("plusCount").addEventListener("input", ()=> hide($("plusWarn")));

      $("checkoutBtn").onclick = async ()=>{
        if(!state.size){
          alert("Select a company size first.");
          return;
        }

        if(state.size.id === "s250plus"){
          const info = buildContactEmail();
          if(!info) return;

          if(info.confirm){
            const ok = confirm("That number is under 250. Are you sure you want the 250+ package?");
            if(!ok) return;
          }

          window.location.href = info.mailto;
          return;
        }

        openModal($("signupModalBackdrop"));
      };

      $("mmClose").onclick = ()=> closeModal($("moduleModalBackdrop"));
      $("moduleModalBackdrop").addEventListener("click", (e)=>{ if(e.target === $("moduleModalBackdrop")) closeModal($("moduleModalBackdrop")); });

      $("suClose").onclick = ()=> closeModal($("signupModalBackdrop"));
      $("suContinue").onclick = ownerSendCode;
      $("suGoLogin").onclick = ()=>{ closeModal($("signupModalBackdrop")); openModal($("loginModalBackdrop")); };
      $("suEye").onclick = ()=>{ const p = $("suPassword"); p.type = (p.type === "password") ? "text" : "password"; };

      $("vClose").onclick = ()=> closeModal($("verifyModalBackdrop"));
      $("vVerify").onclick = ownerVerifyAndCreate;
      $("vResend").onclick = resendOwnerCode;

      $("payClose").onclick = ()=> closeModal($("payModalBackdrop"));
      $("payAccept").onclick = paymentAccept;
      $("payDecline").onclick = paymentDecline;

      $("liClose").onclick = ()=> closeModal($("loginModalBackdrop"));
      $("liEye").onclick = ()=>{ const p = $("liPassword"); p.type = (p.type === "password") ? "text" : "password"; };
      $("liLogin").onclick = login;
      $("liReset").onclick = resetPassword;
      $("liNoAcc").onclick = ()=>{ closeModal($("loginModalBackdrop")); openModal($("noAccModalBackdrop")); };

      $("noAccClose").onclick = ()=> closeModal($("noAccModalBackdrop"));
      $("noAccEmployee").onclick = ()=>{ closeModal($("noAccModalBackdrop")); openModal($("empModalBackdrop")); };
      $("noAccBuild").onclick = ()=>{ closeModal($("noAccModalBackdrop")); $("packages").scrollIntoView({ behavior:"smooth", block:"start" }); };

      $("empClose").onclick = ()=> closeModal($("empModalBackdrop"));
      $("empSend").onclick = employeeSendCode;
      $("empVerify").onclick = employeeVerifyAndCreate;
      $("empResend").onclick = employeeResend;
      $("empEye").onclick = ()=>{ const p = $("empPassword"); p.type = (p.type === "password") ? "text" : "password"; };

      $("dashSignOut").onclick = signOut;
      $("dashBuyMore").onclick = buyMore;
      $("dashSettingsBtn").onclick = openSettings;

      $("setClose").onclick = ()=> closeModal($("settingsModalBackdrop"));
      $("setSave").onclick = saveSettings;

      $("empAddBtn").onclick = ()=> openEmployeeEditor(null);
      $("empEditClose").onclick = ()=> closeModal($("empEditModalBackdrop"));
      $("empESave").onclick = saveEmployee;
      $("empEAdminWrap").onclick = ()=>{
        const cur = $("empEAdminChk").dataset.on === "1";
        setAdminChk(!cur);
      };

      $("confirmClose").onclick = ()=> closeModal($("confirmModalBackdrop"));
      $("confirmNo").onclick = ()=> closeModal($("confirmModalBackdrop"));
      $("confirmYes").onclick = async ()=>{ if(typeof state.confirmAction === "function") await state.confirmAction(); };

      [
        $("signupModalBackdrop"),
        $("verifyModalBackdrop"),
        $("payModalBackdrop"),
        $("loginModalBackdrop"),
        $("noAccModalBackdrop"),
        $("empModalBackdrop"),
        $("settingsModalBackdrop"),
        $("empEditModalBackdrop"),
        $("confirmModalBackdrop")
      ].forEach(b=>{
        b.addEventListener("click", (e)=>{ if(e.target === b) closeModal(b); });
      });

      window.addEventListener("mousemove", bubbleParallax, { passive:true });
      window.addEventListener("resize", ()=> buildBubbles(), { passive:true });
    }

    /******************************************************************
      INIT
    ******************************************************************/
    async function init(){
      buildBubbles();
      initAnim();
      initNavHide();
      wire();

      renderModules();
      updateTotal();

      await loadAccount();
      if(state.session?.user){
        showDashboard();
      }
    }

    init().catch(err=>{
      console.error(err);
      alert("Init error: " + (err.message || err));
    });
  </script>

</body>
</html>


