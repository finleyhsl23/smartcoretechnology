<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SmartCore Technology</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

  <!-- Supabase JS (client auth only) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root{
      --bg0:#040714;
      --bg1:#050a1c;
      --bg2:#06102a;
      --glow: rgba(56,189,248,.18);
      --glow2: rgba(99,102,241,.18);

      --card: rgba(255,255,255,.06);
      --card2: rgba(255,255,255,.08);
      --stroke: rgba(255,255,255,.12);
      --stroke2: rgba(255,255,255,.18);

      --text:#e9eefb;
      --muted: rgba(233,238,251,.72);
      --muted2: rgba(233,238,251,.52);

      --primary:#3b82f6;
      --primary2:#60a5fa;

      --danger:#ef4444;
      --ok:#22c55e;
      --amber:#f59e0b;

      --radius: 18px;
      --shadow: 0 20px 60px rgba(0,0,0,.55);
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: Inter, system-ui, -apple-system, Segoe UI, Arial, sans-serif;
      color: var(--text);
      background:
        radial-gradient(900px 500px at 50% 18%, rgba(56,189,248,.20), transparent 60%),
        radial-gradient(700px 380px at 52% 28%, rgba(99,102,241,.20), transparent 65%),
        radial-gradient(900px 520px at 50% 92%, rgba(56,189,248,.10), transparent 65%),
        linear-gradient(180deg, var(--bg0), var(--bg1) 40%, var(--bg0) 100%);
      overflow-x:hidden;
    }

    /* Top nav */
    .nav{
      position: fixed;
      top: 16px;
      left: 50%;
      transform: translateX(-50%);
      width: min(1080px, calc(100% - 24px));
      z-index: 50;
      transition: transform .35s ease, opacity .35s ease;
    }
    .nav.hidden{
      transform: translateX(-50%) translateY(-120%);
      opacity: 0;
      pointer-events: none;
    }
    .nav-inner{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding: 10px 14px;
      border-radius: 16px;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.10);
      backdrop-filter: blur(16px);
      box-shadow: 0 14px 40px rgba(0,0,0,.45);
    }
    .brand{
      display:flex; align-items:center; gap:10px;
      min-width: 0;
    }
    .brand img{
      width: 34px; height: 34px;
      border-radius: 10px;
      display:block;
      object-fit: cover;
      background:#000;
      border: 1px solid rgba(255,255,255,.18);
    }
    .brand .txt{ min-width:0; }
    .brand .name{
      font-weight: 700;
      letter-spacing: .2px;
      line-height: 1.05;
      margin: 0;
      font-size: 14px;
      display:flex; gap:6px; align-items:baseline;
    }
    .brand .tag{
      margin:0;
      font-size: 11px;
      color: rgba(233,238,251,.68);
      line-height: 1.1;
      transform: translateY(-1px);
    }
    .brand .name .tech{
      opacity: .72; /* requested */
      font-weight: 700;
    }

    .nav-actions{
      display:flex; gap:10px; align-items:center;
    }

    /* Buttons */
    .btn{
      appearance:none;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      color: var(--text);
      padding: 10px 14px;
      border-radius: 14px;
      cursor:pointer;
      font-weight: 600;
      letter-spacing: .3px;
      transition: transform .12s ease, background .2s ease, border-color .2s ease;
      backdrop-filter: blur(16px);
    }
    .btn:hover{
      transform: translateY(-1px);
      border-color: rgba(255,255,255,.22);
      background: rgba(255,255,255,.08);
    }
    .btn.primary{
      border-color: rgba(96,165,250,.35);
      background: linear-gradient(180deg, rgba(59,130,246,.26), rgba(59,130,246,.10));
    }
    .btn.danger{
      border-color: rgba(239,68,68,.35);
      background: linear-gradient(180deg, rgba(239,68,68,.25), rgba(239,68,68,.10));
    }
    .btn.link{
      background: transparent;
      border: none;
      padding: 0;
      color: rgba(233,238,251,.78);
      text-decoration: underline;
      text-underline-offset: 3px;
      cursor:pointer;
    }
    .btn.icon{
      padding: 9px 11px;
      display:inline-flex; align-items:center; gap:8px;
    }

    /* Layout */
    .wrap{
      width: min(1100px, calc(100% - 24px));
      margin: 0 auto;
    }
    .hero{
      position: relative;
      min-height: 100vh;
      display:flex;
      align-items:center;
      padding: 120px 0 60px;
    }
    .hero-inner{
      position: relative;
      z-index: 2;
      max-width: 780px;
    }
    .pill{
      display:inline-flex;
      gap:8px;
      align-items:center;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      color: rgba(233,238,251,.72);
      font-size: 12px;
      backdrop-filter: blur(16px);
    }
    h1{
      margin: 14px 0 10px;
      font-size: clamp(48px, 7.0vw, 88px); /* bigger */
      line-height: .98;
      letter-spacing: -1.2px;
    }
    h1 .line2{ opacity: .78; font-weight: 800; }
    .sub{
      margin: 0 0 22px;
      color: rgba(233,238,251,.74);
      font-size: clamp(16px, 1.7vw, 20px);
      max-width: 62ch;
    }
    .cta-row{
      display:flex; gap:10px; flex-wrap:wrap;
      align-items:center;
    }

    .scroll-btn{
      margin-top: 18px;
      display:inline-flex;
      align-items:center;
      gap:8px;
      font-size: 12px;
      color: rgba(233,238,251,.72);
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      padding: 10px 12px;
      border-radius: 999px;
      cursor:pointer;
      backdrop-filter: blur(16px);
    }

    /* Floating hero icons (scattered) */
    .float-layer{
      position:absolute;
      inset:0;
      z-index:1;
      pointer-events:none;
      overflow:hidden;
    }
    .bubble{
      position:absolute;
      width: 180px;
      height: 180px;
      border-radius: 999px;
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.12), rgba(255,255,255,.03) 65%, transparent 70%);
      border: 1px solid rgba(255,255,255,.10);
      backdrop-filter: blur(10px);
      opacity: .22; /* lower opacity */
      display:flex;
      align-items:center;
      justify-content:center;
      filter: drop-shadow(0 16px 50px rgba(0,0,0,.6));
      transform: translateZ(0);
    }
    .bubble svg{
      width: 66px;
      height: 66px;
      opacity: .68;
    }

    /* Sections */
    .section{
      padding: 56px 0;
    }

    /* Build plan */
    .plan{
      margin-top: 38px; /* push lower so it sits lower on background */
    }
    .glass{
      border-radius: var(--radius);
      background: rgba(255,255,255,.055);
      border: 1px solid rgba(255,255,255,.10);
      backdrop-filter: blur(18px);
      box-shadow: var(--shadow);
    }
    .panel{
      padding: 18px;
    }
    .panel h2{
      margin:0 0 6px;
      font-size: 16px;
      letter-spacing:.2px;
    }
    .panel p{
      margin:0 0 14px;
      color: rgba(233,238,251,.70);
      font-size: 13px;
    }

    .grid4{
      display:grid;
      grid-template-columns: repeat(4, minmax(0,1fr));
      gap: 10px;
    }
    .grid3{
      display:grid;
      grid-template-columns: repeat(3, minmax(0,1fr));
      gap: 10px;
    }
    @media (max-width: 980px){
      .grid4{ grid-template-columns: repeat(2, minmax(0,1fr)); }
      .grid3{ grid-template-columns: repeat(2, minmax(0,1fr)); }
    }
    @media (max-width: 560px){
      .grid4, .grid3{ grid-template-columns: 1fr; }
    }

    .choice{
      padding: 12px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      cursor:pointer;
      transition: transform .12s ease, border-color .2s ease, background .2s ease;
      position: relative;
      overflow:hidden;
    }
    .choice:hover{
      transform: translateY(-1px);
      border-color: rgba(255,255,255,.18);
      background: rgba(255,255,255,.06);
    }
    .choice.selected{
      border-color: rgba(96,165,250,.45);
      background: linear-gradient(180deg, rgba(59,130,246,.20), rgba(59,130,246,.06));
      box-shadow: 0 0 0 1px rgba(96,165,250,.14) inset;
    }
    .choice .top{
      display:flex; align-items:flex-start; justify-content:space-between; gap:10px;
    }
    .choice .label{ font-weight: 700; font-size: 13px; }
    .choice .price{ color: rgba(233,238,251,.70); font-size: 12px; margin-top:4px; }
    .badge{
      width: 26px; height: 26px; border-radius: 999px;
      display:flex; align-items:center; justify-content:center;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.14);
      color: rgba(233,238,251,.85);
      flex: 0 0 auto;
    }
    .choice.selected .badge{
      border-color: rgba(96,165,250,.65);
      background: rgba(59,130,246,.18);
      color: white;
    }

    .small{
      font-size: 12px;
      color: rgba(233,238,251,.60);
      margin-top: 6px;
    }

    .module-row{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      margin-top: 10px;
    }
    .learn{
      white-space: nowrap; /* one line */
      padding: 8px 12px;
      border-radius: 999px;
      font-size: 12px;
    }

    /* Checkout bar */
    .checkout{
      margin-top: 18px; /* pushed down a bit so it isn't touching module boxes */
      padding: 14px;
      display:flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      border-radius: 18px;
      background: rgba(0,0,0,.18);
      border: 1px solid rgba(255,255,255,.12);
      backdrop-filter: blur(18px);
    }
    .total{
      display:flex; flex-direction:column; gap:2px;
    }
    .total .amt{
      font-size: 18px;
      font-weight: 800;
      letter-spacing:.2px;
    }
    .total .subt{
      font-size: 12px;
      color: rgba(233,238,251,.65);
    }
    .checkout .actions{
      display:flex; gap:10px; align-items:center;
    }

    /* About */
    .about{
      margin-top: 18px;
      padding: 18px;
    }
    .about h3{ margin:0 0 10px; font-size: 14px; }
    .about p{ margin: 0 0 10px; color: rgba(233,238,251,.70); font-size: 12.5px; line-height:1.6; }
    .about ul{ margin: 8px 0 0 16px; color: rgba(233,238,251,.68); font-size: 12.5px; }
    .about li{ margin: 4px 0; }

    footer{
      padding: 30px 0 60px;
      color: rgba(233,238,251,.55);
      font-size: 12px;
    }

    /* Modal */
    .modal{
      position: fixed;
      inset: 0;
      z-index: 80;
      display:none;
      align-items:center;
      justify-content:center;
      padding: 18px;
      background: rgba(0,0,0,.52);
      backdrop-filter: blur(8px);
    }
    .modal.show{ display:flex; }
    .modal-card{
      width: min(760px, 100%);
      border-radius: 18px;
      background: rgba(12,18,40,.70); /* darker glass */
      border: 1px solid rgba(255,255,255,.12);
      box-shadow: 0 30px 90px rgba(0,0,0,.68);
      backdrop-filter: blur(22px);
      overflow:hidden;
      max-height: min(86vh, 900px);
      display:flex;
      flex-direction:column;
    }
    .modal-head{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      padding: 14px 14px;
      border-bottom: 1px solid rgba(255,255,255,.08);
    }
    .modal-title{
      font-weight: 800;
      font-size: 13px;
      letter-spacing:.2px;
    }
    .modal-body{
      padding: 14px;
      overflow:auto; /* scrolling INSIDE modal */
      -webkit-overflow-scrolling: touch;
      overscroll-behavior: contain;
    }
    .field{
      display:flex; flex-direction:column; gap:6px;
      margin-bottom: 10px;
    }
    label{
      font-size: 12px;
      color: rgba(233,238,251,.70);
    }
    input, textarea, select{
      width: 100%;
      padding: 11px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      color: var(--text);
      outline:none;
    }
    textarea{ min-height: 90px; resize: vertical; }
    .row2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    @media (max-width: 560px){
      .row2{ grid-template-columns: 1fr; }
    }

    .pw-wrap{ position: relative; }
    .eye{
      position:absolute;
      right: 10px;
      top: 50%;
      transform: translateY(-50%);
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      border-radius: 10px;
      padding: 7px 9px;
      cursor:pointer;
      color: rgba(233,238,251,.78);
      font-size: 12px;
      user-select:none;
    }

    .msg{
      margin-top: 10px;
      font-size: 12px;
      color: rgba(233,238,251,.72);
    }
    .msg.err{ color: rgba(239,68,68,.95); }
    .msg.ok{ color: rgba(34,197,94,.95); }

    .stepper{
      display:flex; gap:8px; flex-wrap:wrap; align-items:center;
      padding: 0 14px 12px;
      border-bottom: 1px solid rgba(255,255,255,.08);
      color: rgba(233,238,251,.64);
      font-size: 12px;
    }
    .dot{
      width: 9px; height: 9px; border-radius: 99px;
      border: 1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.06);
    }
    .dot.on{
      background: rgba(59,130,246,.45);
      border-color: rgba(96,165,250,.65);
    }

    /* Dashboard */
    .dash{
      display:none;
      padding: 120px 0 70px;
    }
    .dash.show{ display:block; }
    .dash-grid{
      display:grid;
      grid-template-columns: 1.15fr .85fr;
      gap: 14px;
    }
    @media (max-width: 980px){
      .dash-grid{ grid-template-columns: 1fr; }
    }
    .card{
      padding: 16px;
      border-radius: 18px;
      background: rgba(255,255,255,.055);
      border: 1px solid rgba(255,255,255,.10);
      backdrop-filter: blur(18px);
      box-shadow: var(--shadow);
    }
    .card h3{ margin:0 0 8px; font-size: 14px; }
    .muted{ color: rgba(233,238,251,.70); font-size: 12px; }

    .emp-list{
      display:flex;
      flex-direction:column;
      gap: 8px;
      margin-top: 10px;
    }
    .emp{
      padding: 10px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.14);
      display:flex;
      justify-content: space-between;
      gap: 10px;
      align-items:flex-start;
    }
    .emp .left{ min-width:0; }
    .emp .nm{ font-weight: 800; font-size: 13px; }
    .emp .meta{ color: rgba(233,238,251,.65); font-size: 12px; margin-top:4px; }
    .pillcode{
      display:inline-flex; gap:8px; align-items:center;
      font-size: 12px;
      color: rgba(233,238,251,.72);
      margin-top: 6px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
    }
    .xbtn{
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.20);
      color: rgba(233,238,251,.80);
      border-radius: 10px;
      padding: 7px 10px;
      cursor:pointer;
    }
    .xbtn:hover{ border-color: rgba(255,255,255,.18); }

    /* Prevent background scroll when modal open */
    body.modal-open{
      overflow:hidden;
      touch-action: none;
    }
  </style>
</head>

<body>
  <!-- NAV -->
  <div class="nav" id="nav">
    <div class="nav-inner">
      <div class="brand">
        <img src="SmartCore%20Official%20LoGOS/SC%20Icon%20-%20Black%20Background.png" alt="SC">
        <div class="txt">
          <p class="name">
            <span>SmartCore</span> <span class="tech">Technology</span>
          </p>
          <p class="tag">Practical Technology. Built to Last.</p>
        </div>
      </div>
      <div class="nav-actions">
        <button class="btn icon" id="loginBtn">LOG IN</button>
      </div>
    </div>
  </div>

  <!-- HERO -->
  <section class="hero">
    <div class="float-layer" id="floatLayer"></div>

    <div class="wrap">
      <div class="hero-inner">
        <span class="pill">‚óè Calm systems for real workplaces</span>
        <h1>
          SmartCore<br><span class="line2">Technology</span>
        </h1>
        <p class="sub">
          Practical, reliable systems that businesses can depend on every day.
        </p>

        <div class="cta-row">
          <button class="btn primary" id="buildBtn">BUILD YOUR PLAN</button>
          <button class="btn" id="employeeBtn">SIGN UP AS AN EMPLOYEE</button>
        </div>

        <button class="scroll-btn" id="scrollBtn">SCROLL DOWN ‚Üì</button>
      </div>

      <!-- BUILD PLAN -->
      <div class="section plan" id="plan">
        <div class="glass panel">
          <div style="display:flex;justify-content:space-between;gap:10px;align-items:flex-start;flex-wrap:wrap;">
            <div>
              <h2>Build your plan</h2>
              <p>Choose your company size, then select modules. Totals update live.</p>
            </div>
            <div style="text-align:right;color:rgba(233,238,251,.62);font-size:12px">
              Monthly subscription (GBP)
              <div style="margin-top:6px;font-weight:800;color:rgba(233,238,251,.85)" id="selSizeNote">Select a size</div>
            </div>
          </div>

          <div style="margin-top:12px;font-size:12px;color:rgba(233,238,251,.72);font-weight:700;">Select your company size</div>
          <div class="grid4" id="sizeGrid" style="margin-top:10px;"></div>

          <div id="custom250Wrap" style="display:none;margin-top:12px;">
            <div class="row2">
              <div class="field">
                <label>Approx company size (e.g. 540)</label>
                <input id="size250Input" placeholder="Enter your headcount">
              </div>
              <div class="field">
                <label>Notes (optional)</label>
                <input id="size250Notes" placeholder="Anything helpful (multi-sites, departments, etc.)">
              </div>
            </div>
          </div>

          <div id="modulesWrap" style="display:none;margin-top:18px;">
            <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap;">
              <div style="font-size:12px;color:rgba(233,238,251,.72);font-weight:700;">Select your modules</div>
              <div style="font-size:12px;color:rgba(233,238,251,.52)">Select any</div>
            </div>

            <div class="grid3" id="moduleGrid" style="margin-top:10px;"></div>

            <div class="checkout" id="checkoutBar" style="display:none;">
              <div class="total">
                <div class="amt" id="totalAmt">¬£0 / month</div>
                <div class="subt" id="totalSub">Select a company size to begin</div>
              </div>
              <div class="actions">
                <button class="btn" id="clearBtn">CLEAR</button>
                <button class="btn primary" id="checkoutBtn">CONTINUE ‚Üí</button>
              </div>
            </div>

            <div class="checkout" id="contactBar" style="display:none;">
              <div class="total">
                <div class="amt">250+ people</div>
                <div class="subt">We‚Äôll quote based on requirements.</div>
              </div>
              <div class="actions">
                <button class="btn" id="clear250Btn">CLEAR</button>
                <button class="btn primary" id="contactBtn">CONTACT US ‚Üí</button>
              </div>
            </div>
          </div>
        </div>

        <!-- About -->
        <div class="glass about">
          <h3>About SmartCore Technology</h3>
          <p>
            SmartCore Technology was built by Finley Hassall, a young founder with a long-standing passion for technology and a strong business mindset. Interested in IT from the age of six, Finley always knew he wanted to build a career creating systems that solve real-world problems.
          </p>
          <p>
            Rather than focusing on trends or hype, SmartCore Technology was created with a clear goal: to build practical, reliable systems that businesses can depend on every day.
          </p>
          <p>
            The company was developed with guidance and support from Finley‚Äôs mother, a business owner herself, but every system within SmartCore has been hand-crafted from the ground up by Finley. Each feature, workflow, and decision has been designed with real workplaces in mind ‚Äî prioritising clarity, usability, and long-term reliability over unnecessary complexity.
          </p>
          <p>
            SmartCore Technology is not about flashy software. It‚Äôs about building tools that work properly, scale sensibly, and quietly do their job in the background.
          </p>

          <h3 style="margin-top:14px;">The SmartCore Technology Approach</h3>
          <p>SmartCore Technology is built on a simple philosophy: technology should make work easier, not more complicated.</p>
          <ul>
            <li>solve a specific, real business problem</li>
            <li>be easy to understand and use</li>
            <li>create clear, auditable records</li>
            <li>scale as organisations grow</li>
            <li>remain reliable over time</li>
          </ul>
          <p style="margin-top:10px;">
            Instead of offering one large, bloated platform, SmartCore provides modular systems that companies can choose and combine based on their actual needs. This keeps costs fair, reduces complexity, and allows businesses to stay in control of how they operate.
          </p>
          <p>
            SmartCore Technology focuses on the areas that matter most ‚Äî people, safety, and operational clarity ‚Äî delivering tools that support organisations without getting in the way.
          </p>
        </div>

        <footer class="wrap">
          SmartCore Technology ‚Äî Practical Technology. Built to Last.
          <span style="float:right;">Support: support@smartcoretechnology.co.uk</span>
        </footer>
      </div>

      <!-- DASHBOARD -->
      <section class="dash wrap" id="dashboard">
        <div class="dash-grid">
          <div class="card">
            <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:10px;flex-wrap:wrap;">
              <div>
                <h3>Dashboard</h3>
                <div class="muted" id="dashWelcome">Loading‚Ä¶</div>
              </div>
              <div style="display:flex;gap:10px;align-items:center;">
                <button class="btn" id="companySettingsBtn">COMPANY SETTINGS</button>
                <button class="btn danger" id="signOutBtn">SIGN OUT</button>
              </div>
            </div>

            <div style="margin-top:12px;" class="muted" id="companySummary"></div>

            <!-- Onboarding Wizard (sequential) -->
            <div id="onboardWizard" style="margin-top:14px; display:none;">
              <div class="glass" style="padding:14px; border-radius:18px;">
                <div style="font-weight:900; font-size:13px; letter-spacing:.2px;">Company Onboarding</div>
                <div class="muted" style="margin-top:6px;">Complete the steps below to finish setting up your SmartCore account.</div>

                <div style="margin-top:12px;">
                  <div class="stepper" id="stepper"></div>
                </div>

                <div id="stepBody" style="margin-top:12px;"></div>

                <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:12px;flex-wrap:wrap;">
                  <button class="btn" id="stepBackBtn" style="display:none;">BACK</button>
                  <button class="btn primary" id="stepNextBtn">CONTINUE ‚Üí</button>
                </div>

                <div class="msg" id="stepMsg"></div>
              </div>
            </div>

            <hr style="border:none;border-top:1px solid rgba(255,255,255,.08);margin:16px 0;">

            <h3 style="margin:0;">Your Systems</h3>
            <div class="muted">Quick links only show systems owned by your account (testing links currently point to smartcoretechnology.co.uk).</div>
            <div id="ownedLinks" class="module-row" style="margin-top:10px;"></div>

            <hr style="border:none;border-top:1px solid rgba(255,255,255,.08);margin:16px 0;">

            <h3 style="margin:0;">Buy More Systems</h3>
            <div class="muted">Add extra modules to your plan (testing mode ‚Äî free).</div>
            <div class="module-row" id="buyMoreRow" style="margin-top:10px;"></div>
          </div>

          <div class="card">
            <h3>Employees</h3>
            <div class="muted">Add employees to your SmartDatabase. Employees can only sign up if their name matches exactly.</div>

            <div style="margin-top:12px;" class="row2">
              <div class="field">
                <label>Employee full name</label>
                <input id="empName" placeholder="e.g. Finley Hassall">
              </div>
              <div class="field">
                <label>Job role</label>
                <input id="empTitle" placeholder="e.g. Founder">
              </div>
            </div>

            <div class="row2">
              <div class="field">
                <label>Job category</label>
                <input id="empCategory" placeholder="e.g. Senior Management Team">
              </div>
              <div class="field">
                <label style="display:flex;align-items:center;gap:10px;">
                  <input type="checkbox" id="empIsAdmin" style="width:18px;height:18px;accent-color:#60a5fa;">
                  Admin access
                </label>
                <div class="muted" style="margin-top:-4px;">Admins can manage employees and company settings.</div>
              </div>
            </div>

            <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-top:6px;">
              <button class="btn primary" id="addEmpBtn">ADD EMPLOYEE</button>
              <div class="msg" id="empMsg"></div>
            </div>

            <div class="emp-list" id="empList"></div>
          </div>
        </div>
      </section>
    </div>
  </section>

  <!-- MODULE LEARN MORE MODAL (wider, less cluttered, close only) -->
  <div class="modal" id="learnModal" aria-hidden="true">
    <div class="modal-card" style="width:min(900px, 100%);">
      <div class="modal-head">
        <div class="modal-title" id="learnTitle">Module</div>
        <button class="btn" id="learnClose">CLOSE</button>
      </div>
      <div class="modal-body">
        <div class="muted" id="learnPrice"></div>
        <p id="learnDesc" style="color:rgba(233,238,251,.74);font-size:13px;line-height:1.65;margin-top:10px;"></p>

        <div style="margin-top:14px;">
          <div style="font-weight:800;font-size:12px;color:rgba(233,238,251,.78);margin-bottom:8px;">Preview</div>
          <div class="glass" style="border-radius:16px;overflow:hidden;border:1px solid rgba(255,255,255,.10);">
            <iframe
              id="learnVideo"
              width="100%"
              height="380"
              style="display:block;border:0;background:#000;"
              src=""
              allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; fullscreen"
              allowfullscreen></iframe>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- AUTH MODAL (Owner signup + Employee signup + Login + Reset) -->
  <div class="modal" id="authModal" aria-hidden="true">
    <div class="modal-card" style="width:min(520px, 100%);">
      <div class="modal-head">
        <div class="modal-title" id="authTitle">Log In</div>
        <button class="btn" id="authClose">CLOSE</button>
      </div>

      <div class="modal-body">
        <!-- LOGIN VIEW -->
        <div id="viewLogin">
          <div class="field">
            <label>Email</label>
            <input id="liEmail" type="email" placeholder="you@company.co.uk">
          </div>

          <div class="field">
            <label>Password</label>
            <div class="pw-wrap">
              <input id="liPass" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
              <span class="eye" id="liEye">üëÅ</span>
            </div>
          </div>

          <button class="btn primary" id="liBtn" style="width:100%;">LOG IN ‚Üí</button>
          <div class="msg" id="liMsg"></div>

          <div style="margin-top:12px;display:flex;justify-content:space-between;align-items:center;gap:10px;">
            <button class="btn link" id="forgotBtn">Incorrect credentials? Forgot your password?</button>
            <button class="btn link" id="noAccountBtn">Don‚Äôt have an account?</button>
          </div>
        </div>

        <!-- OWNER SIGNUP VIEW (Continue -> code -> Continue) -->
        <div id="viewOwner" style="display:none;">
          <div class="field">
            <label>Company name</label>
            <input id="suCompany" placeholder="e.g. SmartFits Installations LTD">
          </div>
          <div class="field">
            <label>Email</label>
            <input id="suEmail" type="email" placeholder="you@company.co.uk">
          </div>
          <div class="field">
            <label>Password</label>
            <div class="pw-wrap">
              <input id="suPass" type="password" placeholder="Min 8 characters">
              <span class="eye" id="suEye">üëÅ</span>
            </div>
          </div>

          <button class="btn primary" id="suContinue" style="width:100%;">CONTINUE ‚Üí</button>
          <div class="msg" id="suMsg"></div>

          <div id="codeWrap" style="display:none;margin-top:12px;">
            <div class="field">
              <label>6-digit code</label>
              <input id="suCode" inputmode="numeric" maxlength="6" placeholder="Enter code from email">
            </div>
            <button class="btn primary" id="suVerify" style="width:100%;">CONTINUE ‚Üí</button>
            <div class="msg" id="suMsg2"></div>
          </div>
        </div>

        <!-- EMPLOYEE SIGNUP VIEW -->
        <div id="viewEmployee" style="display:none;">
          <div class="field">
            <label>Company ID</label>
            <input id="empCompanyCode" placeholder="e.g. SMA624564">
          </div>
          <div class="field">
            <label>Your full name</label>
            <input id="empFullName" placeholder="Must match what your admin entered">
          </div>
          <div class="field">
            <label>Email</label>
            <input id="empEmail" type="email" placeholder="you@company.co.uk">
          </div>
          <div class="field">
            <label>Password</label>
            <div class="pw-wrap">
              <input id="empPass" type="password" placeholder="Min 8 characters">
              <span class="eye" id="empEye">üëÅ</span>
            </div>
          </div>

          <button class="btn primary" id="empContinue" style="width:100%;">CONTINUE ‚Üí</button>
          <div class="msg" id="empSuMsg"></div>

          <div id="empCodeWrap" style="display:none;margin-top:12px;">
            <div class="field">
              <label>6-digit code</label>
              <input id="empCode" inputmode="numeric" maxlength="6" placeholder="Enter code from email">
            </div>
            <button class="btn primary" id="empVerify" style="width:100%;">CONTINUE ‚Üí</button>
            <div class="msg" id="empSuMsg2"></div>
          </div>
        </div>

        <!-- ‚ÄúDon‚Äôt have an account?‚Äù popup copy -->
        <div id="viewNoAccount" style="display:none;">
          <div class="glass" style="padding:14px;border-radius:18px;">
            <div style="font-weight:900;font-size:13px;">Not registered yet?</div>
            <p class="muted" style="line-height:1.65;margin-top:8px;">
              If your company is already on SmartCore, choose <b>Sign Up As An Employee</b> and enter your Company ID.
              If not, use <b>Build Your Plan</b> to select your modules and create your company account.
              <br><br>
              <b>Join the best. Join SmartCore.</b>
            </p>
            <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:10px;">
              <button class="btn" id="backToLogin">BACK</button>
              <button class="btn primary" id="gotoOwner">BUILD YOUR PLAN ‚Üí</button>
              <button class="btn" id="gotoEmployee">SIGN UP AS AN EMPLOYEE ‚Üí</button>
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>

  <!-- Confirm Delete Employee Modal -->
  <div class="modal" id="confirmModal" aria-hidden="true">
    <div class="modal-card" style="width:min(520px, 100%);">
      <div class="modal-head">
        <div class="modal-title">Confirm removal</div>
        <button class="btn" id="confirmClose">CLOSE</button>
      </div>
      <div class="modal-body">
        <p id="confirmText" style="color:rgba(233,238,251,.76);line-height:1.65;margin:0;"></p>
        <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:14px;">
          <button class="btn" id="confirmCancel">CANCEL</button>
          <button class="btn danger" id="confirmYes">REMOVE</button>
        </div>
        <div class="msg" id="confirmMsg"></div>
      </div>
    </div>
  </div>

  <!-- Company settings modal -->
  <div class="modal" id="settingsModal" aria-hidden="true">
    <div class="modal-card" style="width:min(600px, 100%);">
      <div class="modal-head">
        <div class="modal-title">Company settings</div>
        <button class="btn" id="settingsClose">CLOSE</button>
      </div>
      <div class="modal-body">
        <div class="row2">
          <div class="field">
            <label>Primary colour</label>
            <input id="colPrimary" type="color" value="#ff0000">
          </div>
          <div class="field">
            <label>Secondary colour</label>
            <input id="colSecondary" type="color" value="#000000">
          </div>
        </div>
        <div class="field">
          <label>Text colour</label>
          <input id="colText" type="color" value="#ffffff">
        </div>
        <button class="btn primary" id="saveColours" style="width:100%;">SAVE ‚Üí</button>
        <div class="msg" id="settingsMsg"></div>
      </div>
    </div>
  </div>

<script>
/* =========================
   CONFIG (Supabase)
========================= */
const SUPABASE_URL = "https://hjdpcfhozhoyeqevnupm.supabase.co";
const SUPABASE_ANON_KEY = "REPLACE_WITH_YOUR_ANON_KEY"; // keep your anon key here
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* =========================
   Utilities
========================= */
const $ = (id) => document.getElementById(id);

function titleCaps(str){
  // ‚ÄúBUILD YOUR PLAN‚Äù, ‚ÄúSIGN UP AS AN EMPLOYEE‚Äù already caps; this helper keeps style consistent if needed
  return String(str || "").toUpperCase();
}
function esc(s){ return String(s||"").replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[m])); }

async function apiPost(path, body){
  const res = await fetch(path, {
    method: "POST",
    headers: { "content-type":"application/json" },
    body: JSON.stringify(body || {})
  });
  const txt = await res.text();
  let data = null;
  try { data = JSON.parse(txt); } catch { data = { ok:false, error: txt || `HTTP ${res.status}` }; }
  if (!res.ok || data?.ok === false) throw new Error(data?.error || `Request failed (${res.status})`);
  return data;
}

function openModal(modalId){
  document.body.classList.add("modal-open");
  $(modalId).classList.add("show");
}
function closeModal(modalId){
  $(modalId).classList.remove("show");
  const anyOpen = document.querySelector(".modal.show");
  if (!anyOpen) document.body.classList.remove("modal-open");
}

/* =========================
   Floating hero icons (8 scattered)
========================= */
function iconSvg(kind){
  const base = 'stroke="rgba(233,238,251,.92)" stroke-width="2.2" fill="none" stroke-linecap="round" stroke-linejoin="round"';
  if (kind === "plus") return `<svg viewBox="0 0 48 48"><path ${base} d="M24 10v28M10 24h28"/></svg>`;
  if (kind === "check") return `<svg viewBox="0 0 48 48"><path ${base} d="M14 24l7 7 13-15"/><path ${base} d="M12 10h24a4 4 0 0 1 4 4v24a4 4 0 0 1-4 4H12a4 4 0 0 1-4-4V14a4 4 0 0 1 4-4z"/></svg>`;
  if (kind === "shield") return `<svg viewBox="0 0 48 48"><path ${base} d="M24 6l16 6v12c0 10-6 16-16 18C14 40 8 34 8 24V12z"/><path ${base} d="M18 24l4 4 8-10"/></svg>`;
  if (kind === "clock") return `<svg viewBox="0 0 48 48"><path ${base} d="M24 42a18 18 0 1 0-18-18 18 18 0 0 0 18 18z"/><path ${base} d="M24 14v12l8 4"/></svg>`;
  if (kind === "lock") return `<svg viewBox="0 0 48 48"><path ${base} d="M14 22h20v18H14z"/><path ${base} d="M18 22v-6a6 6 0 0 1 12 0v6"/></svg>`;
  if (kind === "target") return `<svg viewBox="0 0 48 48"><path ${base} d="M24 42a18 18 0 1 0-18-18 18 18 0 0 0 18 18z"/><path ${base} d="M24 30a6 6 0 1 0-6-6 6 6 0 0 0 6 6z"/><path ${base} d="M24 6v6M42 24h-6M24 42v-6M6 24h6"/></svg>`;
  if (kind === "briefcase") return `<svg viewBox="0 0 48 48"><path ${base} d="M16 14v-2a4 4 0 0 1 4-4h8a4 4 0 0 1 4 4v2"/><path ${base} d="M10 14h28v24H10z"/><path ${base} d="M10 22h28"/></svg>`;
  return `<svg viewBox="0 0 48 48"><path ${base} d="M8 14h32M8 24h32M8 34h32"/></svg>`;
}
function placeBubbles(){
  const layer = $("floatLayer");
  layer.innerHTML = "";

  const bubbles = [
    {k:"plus", x:6,  y:20, s:190},
    {k:"check",x:10, y:58, s:170},
    {k:"clock",x:14, y:82, s:185},
    {k:"target",x:58,y:26, s:200},
    {k:"lock", x:82,y:62, s:190},
    {k:"briefcase",x:84,y:78, s:170},
    {k:"shield",x:72,y:44, s:210},
    {k:"lines",x:55,y:74, s:195},
  ];

  // responsive tweak for small screens: keep bubbles away from center text area
  const isSmall = window.innerWidth < 680;
  bubbles.forEach((b, idx) => {
    const el = document.createElement("div");
    el.className = "bubble";
    const size = isSmall ? Math.max(140, b.s - 40) : b.s;
    el.style.width = size + "px";
    el.style.height = size + "px";

    // scatter with slight randomness but stable per load
    const jitterX = (idx % 2 ? 2.2 : -2.2);
    const jitterY = (idx % 3 ? 1.6 : -1.6);
    let x = b.x + jitterX;
    let y = b.y + jitterY;

    // keep a ‚Äúsafe zone‚Äù around center for readability on mobile
    if (isSmall){
      // if in middle band, push it out
      if (x > 32 && x < 70 && y > 22 && y < 70){
        x = x < 50 ? 22 : 78;
        y = y < 50 ? 14 : 82;
      }
    }

    el.style.left = x + "%";
    el.style.top = y + "%";
    el.style.transform = "translate(-50%,-50%)";
    el.innerHTML = iconSvg(b.k === "lines" ? "lines" : b.k);
    layer.appendChild(el);
  });
}
placeBubbles();
window.addEventListener("resize", placeBubbles);

/* =========================
   Nav hide on scroll past hero
========================= */
const nav = $("nav");
function updateNav(){
  const heroH = document.querySelector(".hero").getBoundingClientRect().height;
  const scY = window.scrollY || 0;
  // hide once you‚Äôre clearly past hero
  nav.classList.toggle("hidden", scY > (heroH - 140));
}
updateNav();
window.addEventListener("scroll", updateNav, { passive:true });

/* =========================
   Data: sizes + modules
========================= */
const COMPANY_SIZES = [
  { id:"up_to_25", label:"Up to 25 people", price:39, note:"¬£39 / month" },
  { id:"26_100",  label:"26‚Äì100 people",  price:79, note:"¬£79 / month" },
  { id:"101_250", label:"101‚Äì250 people", price:149, note:"¬£149 / month" },
  { id:"250_plus",label:"250+ people",    price:null, note:"Contact us" }
];

const MODULES = [
  {
    id:"presence_fire",
    name:"Presence & Fire Safety",
    price:10,
    desc:`A real-time presence system that shows exactly who is on site at any moment. Staff and visitors sign in and out digitally, creating a live evacuation list that can be used immediately during fire drills or real emergencies.

Designed to be simple, fast, and reliable when it matters most, with clear records for audits and incident reviews.`
  },
  {
    id:"policies_handbook",
    name:"Policies & Staff Handbook",
    price:7,
    desc:`A central location for company policies and staff handbooks, with tracking to show who has read and acknowledged each document. Managers can update policies, request re-acknowledgement, and view clear records at any time.

Helps organisations demonstrate that information has been issued and acknowledged without relying on paper or email chains.`
  },
  {
    id:"holiday_booking",
    name:"Holiday Booking",
    price:8,
    desc:`A straightforward holiday request and approval system that removes unnecessary back-and-forth. Staff submit requests, managers approve or decline, and teams can view upcoming absences in one place.

Intentionally simple and focused, with no payroll or salary management.`
  },
  {
    id:"accident_injury",
    name:"Accident & Injury Book",
    price:3,
    desc:`A digital accident and injury reporting system that replaces paper accident books. Incidents can be logged quickly with notes, photos, and witness details, and records can be exported when required.

Keeps incident records organised, secure, and easy to access if they are ever needed.`
  },
  {
    id:"training_compliance",
    name:"Training & Compliance",
    price:9,
    desc:`Tracks training expiry dates, compliance requirements, and scheduled checks across the organisation. Automatic reminders help ensure nothing is missed, from fire drills to equipment inspections and vehicle compliance.

Designed to support consistency and oversight without adding unnecessary complexity.`
  },
  {
    id:"onboarding_offboarding",
    name:"Onboarding & Offboarding",
    price:8,
    desc:`Structured checklists for new starters and leavers, helping teams complete tasks consistently across departments. From access setup to equipment returns, nothing is forgotten.

Provides a clear record of what was completed and when, supporting smoother staff transitions.`
  },
  {
    id:"expenses_upload",
    name:"Expenses Upload",
    price:6,
    desc:`Allows staff to upload receipts digitally with notes and categories, removing the need to collect paper receipts. Submissions can be reviewed and exported for accounting or payroll systems.

Keeps expense handling simple, organised, and traceable.`
  },
  {
    id:"wellbeing_check",
    name:"Wellbeing Check",
    price:4,
    desc:`A lightweight wellbeing check-in that allows staff to quickly select one of three options:

üôÇ Positive (green)
üòê Neutral (amber)
üôÅ Concerned (red)

Over time, this provides managers with a simple, high-level view of wellbeing trends across teams, helping highlight when additional attention may be needed.

No medical data, no intrusive questions ‚Äî just a clear, visual pulse check designed to support awareness while respecting privacy.`
  }
];

const PREVIEW_YT = "https://youtu.be/S2kymv60ndQ?si=7AGk-tN09k0g5qf3";
function ytEmbed(url){
  // Convert to embed (basic)
  // Handles youtu.be/<id>?...
  try{
    const u = new URL(url);
    if (u.hostname.includes("youtu.be")){
      const id = u.pathname.replace("/","");
      return `https://www.youtube.com/embed/${id}?rel=0&modestbranding=1`;
    }
    if (u.hostname.includes("youtube.com")){
      const id = u.searchParams.get("v");
      if (id) return `https://www.youtube.com/embed/${id}?rel=0&modestbranding=1`;
    }
  }catch{}
  return "https://www.youtube.com/embed/S2kymv60ndQ?rel=0&modestbranding=1";
}

/* =========================
   Plan selection state
========================= */
let selectedSize = null;
let selectedModules = new Set();

function renderSizes(){
  const grid = $("sizeGrid");
  grid.innerHTML = "";
  COMPANY_SIZES.forEach(s => {
    const el = document.createElement("div");
    el.className = "choice" + (selectedSize?.id === s.id ? " selected" : "");
    el.innerHTML = `
      <div class="top">
        <div>
          <div class="label">${esc(s.label)}</div>
          <div class="price">${esc(s.note)}</div>
        </div>
        <div class="badge">${selectedSize?.id === s.id ? "‚úì" : "+"}</div>
      </div>
    `;
    el.addEventListener("click", () => {
      selectedSize = s;
      $("selSizeNote").textContent = s.label;
      selectedModules = new Set();
      renderSizes();
      renderModules();
      updateTotals();
      // show custom input for 250+
      $("custom250Wrap").style.display = (s.id === "250_plus") ? "block" : "none";
      $("modulesWrap").style.display = "block";
      // show contact bar vs checkout bar
      $("checkoutBar").style.display = (s.id === "250_plus") ? "none" : "flex";
      $("contactBar").style.display = (s.id === "250_plus") ? "flex" : "none";
    });
    grid.appendChild(el);
  });
}

function renderModules(){
  const grid = $("moduleGrid");
  grid.innerHTML = "";

  // modules should only appear once they have selected company size
  if (!selectedSize){
    $("modulesWrap").style.display = "none";
    return;
  }
  $("modulesWrap").style.display = "block";

  MODULES.forEach(m => {
    const on = selectedModules.has(m.id);
    const el = document.createElement("div");
    el.className = "choice" + (on ? " selected" : "");
    el.innerHTML = `
      <div class="top">
        <div>
          <div class="label">${esc(m.name)}</div>
          <div class="price">¬£${m.price} / month</div>
        </div>
        <div class="badge">${on ? "‚úì" : "+"}</div>
      </div>

      <div class="module-row">
        <button class="btn learn" data-learn="${esc(m.id)}">LEARN MORE</button>
        <span class="small" style="display:none;"></span>
      </div>
    `;

    el.addEventListener("click", (e) => {
      // if clicking learn more, don't toggle selection twice
      if (e.target && e.target.closest("[data-learn]")) return;
      if (on) selectedModules.delete(m.id);
      else selectedModules.add(m.id);
      renderModules();
      updateTotals();
    });

    el.querySelector("[data-learn]").addEventListener("click", () => openLearn(m.id));
    grid.appendChild(el);
  });

  updateTotals();
}

function updateTotals(){
  if (!selectedSize){
    $("totalAmt").textContent = "¬£0 / month";
    $("totalSub").textContent = "Select a company size to begin";
    return;
  }
  if (selectedSize.id === "250_plus"){
    // contact flow
    return;
  }

  const base = selectedSize.price || 0;
  const mods = Array.from(selectedModules).reduce((sum, id) => sum + (MODULES.find(m=>m.id===id)?.price || 0), 0);
  const total = base + mods;

  $("totalAmt").textContent = `¬£${total} / month`;
  const modCount = selectedModules.size;
  $("totalSub").textContent = `${selectedSize.label} ‚Ä¢ ${modCount} module${modCount===1?"":"s"} selected`;
}

renderSizes();
renderModules();

/* =========================
   Learn more modal
========================= */
function openLearn(moduleId){
  const m = MODULES.find(x=>x.id===moduleId);
  if (!m) return;
  $("learnTitle").textContent = m.name;
  $("learnPrice").textContent = `¬£${m.price} / month`;
  $("learnDesc").textContent = m.desc;
  $("learnVideo").src = ytEmbed(PREVIEW_YT);
  openModal("learnModal");
}
$("learnClose").addEventListener("click", ()=> closeModal("learnModal"));
$("learnModal").addEventListener("click", (e)=>{ if(e.target === $("learnModal")) closeModal("learnModal"); });

/* =========================
   Scroll
========================= */
$("scrollBtn").addEventListener("click", ()=>{
  $("plan").scrollIntoView({ behavior:"smooth", block:"start" });
});
$("buildBtn").addEventListener("click", ()=>{
  $("plan").scrollIntoView({ behavior:"smooth", block:"start" });
});

/* =========================
   250+ contact email
========================= */
$("contactBtn").addEventListener("click", ()=>{
  const headcount = ($("size250Input").value || "").trim();
  const notes = ($("size250Notes").value || "").trim();
  const chosen = Array.from(selectedModules).map(id => MODULES.find(m=>m.id===id)?.name).filter(Boolean);

  const subject = "250+ Person Company - Wanting to Sign Up";
  const companySizeLine = headcount ? `Approx company size: ${headcount}` : "Approx company size: (please advise)";
  const modulesLine = chosen.length ? chosen.map(x=>`‚Ä¢ ${x}`).join("\n") : "‚Ä¢ (modules not selected yet)";
  const extra = notes ? `\nAdditional notes:\n${notes}\n` : "";

  const body =
`Hello SmartCore Technology,

We would like to sign up to SmartCore for a 250+ person organisation.

${companySizeLine}

Modules we are interested in:
${modulesLine}
${extra}
Please contact us with next steps and onboarding requirements.

Kind regards,`;

  const mailto = `mailto:support@smartcoretechnology.co.uk?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
  window.location.href = mailto;
});

/* =========================
   Clear selection
========================= */
$("clearBtn").addEventListener("click", ()=>{
  selectedModules = new Set();
  renderModules();
  updateTotals();
});
$("clear250Btn").addEventListener("click", ()=>{
  selectedModules = new Set();
  $("size250Input").value = "";
  $("size250Notes").value = "";
  renderModules();
});

/* =========================
   Auth modal (login / owner signup / employee signup)
========================= */
let pendingOwner = null;
let pendingEmployee = null;

function showAuthView(which){
  $("viewLogin").style.display = (which==="login") ? "block" : "none";
  $("viewOwner").style.display = (which==="owner") ? "block" : "none";
  $("viewEmployee").style.display = (which==="employee") ? "block" : "none";
  $("viewNoAccount").style.display = (which==="noAccount") ? "block" : "none";

  $("authTitle").textContent =
    which==="login" ? "Log In" :
    which==="owner" ? "Create account" :
    which==="employee" ? "Employee sign up" :
    "Create your account";
}

$("loginBtn").addEventListener("click", ()=>{ showAuthView("login"); openModal("authModal"); });
$("authClose").addEventListener("click", ()=> closeModal("authModal"));
$("authModal").addEventListener("click", (e)=>{ if(e.target === $("authModal")) closeModal("authModal"); });

$("employeeBtn").addEventListener("click", ()=>{
  showAuthView("employee");
  openModal("authModal");
});

$("checkoutBtn").addEventListener("click", ()=>{
  // if no size selected, do nothing
  if (!selectedSize){
    $("plan").scrollIntoView({ behavior:"smooth" });
    return;
  }
  // if user already logged in, go dashboard and let them buy more from there
  if (currentSession?.user){
    location.hash = "#dashboard";
    showDashboard();
    return;
  }
  // open owner signup (no login button here)
  showAuthView("owner");
  openModal("authModal");
});

/* Eye toggles */
function wireEye(btnId, inputId){
  $(btnId).addEventListener("click", ()=>{
    const inp = $(inputId);
    inp.type = (inp.type === "password") ? "text" : "password";
  });
}
wireEye("liEye","liPass");
wireEye("suEye","suPass");
wireEye("empEye","empPass");

/* ‚ÄúDon't have an account?‚Äù copy */
$("noAccountBtn").addEventListener("click", ()=> showAuthView("noAccount"));
$("backToLogin").addEventListener("click", ()=> showAuthView("login"));
$("gotoOwner").addEventListener("click", ()=>{
  closeModal("authModal");
  $("plan").scrollIntoView({ behavior:"smooth" });
  showAuthView("owner");
  openModal("authModal");
});
$("gotoEmployee").addEventListener("click", ()=>{
  showAuthView("employee");
});

/* =========================
   Login + Reset password
========================= */
let currentSession = null;
let currentCompany = null;
let currentProfile = null;
let currentSubs = null;
let employees = [];

async function refreshSession(){
  const { data } = await sb.auth.getSession();
  currentSession = data.session || null;
  return currentSession;
}

$("liBtn").addEventListener("click", async ()=>{
  $("liMsg").textContent = "";
  $("liMsg").className = "msg";

  const email = $("liEmail").value.trim().toLowerCase();
  const password = $("liPass").value;
  if (!email || !password){
    $("liMsg").textContent = "Please enter your email and password.";
    $("liMsg").classList.add("err");
    return;
  }

  try{
    const { data, error } = await sb.auth.signInWithPassword({ email, password });
    if (error) throw error;

    currentSession = data.session;
    closeModal("authModal");
    location.hash = "#dashboard";
    await showDashboard();
  }catch(e){
    $("liMsg").textContent = "Incorrect credentials. Forgot your password?";
    $("liMsg").classList.add("err");
  }
});

$("forgotBtn").addEventListener("click", async ()=>{
  $("liMsg").textContent = "";
  $("liMsg").className = "msg";
  const email = $("liEmail").value.trim().toLowerCase();
  if (!email){
    $("liMsg").textContent = "Enter your email first, then click here to send a reset link.";
    $("liMsg").classList.add("err");
    return;
  }
  try{
    const { error } = await sb.auth.resetPasswordForEmail(email, {
      redirectTo: location.origin + "/#reset"
    });
    if (error) throw error;
    $("liMsg").textContent = "Password reset email sent. Check your inbox.";
    $("liMsg").classList.add("ok");
  }catch(e){
    $("liMsg").textContent = "Could not send reset email. Please try again.";
    $("liMsg").classList.add("err");
  }
});

/* If email already exists (owner signup), your verify endpoint will return: EMAIL_EXISTS */
function showEmailExistsPrompt(){
  $("suMsg2").textContent = "This email is already registered to a SmartCore account ‚Äî Log in instead?";
  $("suMsg2").className = "msg err";
  // bounce user to login
  setTimeout(()=> showAuthView("login"), 1200);
}

/* =========================
   OWNER SIGNUP: Continue -> send code -> Continue (verify+create)
   IMPORTANT: account is NOT created until verify succeeds.
========================= */
$("suContinue").addEventListener("click", async ()=>{
  $("suMsg").textContent = "";
  $("suMsg").className = "msg";

  const company_name = $("suCompany").value.trim();
  const email = $("suEmail").value.trim().toLowerCase();
  const password = $("suPass").value;

  if (!company_name){ $("suMsg").textContent="Enter your company name."; $("suMsg").classList.add("err"); return; }
  if (!email){ $("suMsg").textContent="Enter your email."; $("suMsg").classList.add("err"); return; }
  if (!password || password.length < 8){ $("suMsg").textContent="Password must be at least 8 characters."; $("suMsg").classList.add("err"); return; }

  // If they haven‚Äôt selected modules/size, still allow signup (but we‚Äôll store their plan)
  const size_id = selectedSize?.id || null;
  const module_ids = Array.from(selectedModules);

  // send code
  try{
    // If already registered, advise login
    const { data: existsData } = await sb.auth.signInWithOtp({ email, options: { shouldCreateUser: false } });
    // That call doesn't reliably detect existing; we let verify-code enforce.
    // Sign out immediately so we don't create anything.
    await sb.auth.signOut();

    await apiPost("/api/send-code", { email, purpose:"owner_signup" });
    pendingOwner = { company_name, email, password, company_size: size_id, module_ids };
    $("codeWrap").style.display = "block";
    $("suMsg").textContent = "We‚Äôve sent a 6-digit code to your email.";
    $("suMsg").classList.add("ok");
  }catch(e){
    $("suMsg").textContent = e.message || "Could not send code. Please try again.";
    $("suMsg").classList.add("err");
  }
});

$("suVerify").addEventListener("click", async ()=>{
  $("suMsg2").textContent = "";
  $("suMsg2").className = "msg";

  if (!pendingOwner){ $("suMsg2").textContent="Press Continue first."; $("suMsg2").classList.add("err"); return; }
  const code = $("suCode").value.trim();
  if (!code || code.length !== 6){ $("suMsg2").textContent="Enter the 6-digit code."; $("suMsg2").classList.add("err"); return; }

  try{
    const res = await apiPost("/api/verify-code", {
      purpose: "owner_signup",
      email: pendingOwner.email,
      code,
      password: pendingOwner.password,
      company_name: pendingOwner.company_name,
      company_size: pendingOwner.company_size,
      module_ids: pendingOwner.module_ids
    });

    if (res?.status === "EMAIL_EXISTS"){
      showEmailExistsPrompt();
      return;
    }

    // now login via supabase client
    const { data, error } = await sb.auth.signInWithPassword({ email: pendingOwner.email, password: pendingOwner.password });
    if (error) throw error;

    currentSession = data.session;
    closeModal("authModal");
    location.hash = "#dashboard";
    await showDashboard();
  }catch(e){
    $("suMsg2").textContent = e.message || "Could not create account.";
    $("suMsg2").classList.add("err");
  }
});

/* =========================
   EMPLOYEE SIGNUP: Continue -> send code -> Continue -> verify -> create/link
========================= */
$("empContinue").addEventListener("click", async ()=>{
  $("empSuMsg").textContent = "";
  $("empSuMsg").className = "msg";

  const company_code = $("empCompanyCode").value.trim().toUpperCase();
  const full_name = $("empFullName").value.trim();
  const email = $("empEmail").value.trim().toLowerCase();
  const password = $("empPass").value;

  if (!company_code){ $("empSuMsg").textContent="Enter your Company ID."; $("empSuMsg").classList.add("err"); return; }
  if (!full_name){ $("empSuMsg").textContent="Enter your full name."; $("empSuMsg").classList.add("err"); return; }
  if (!email){ $("empSuMsg").textContent="Enter your email."; $("empSuMsg").classList.add("err"); return; }
  if (!password || password.length < 8){ $("empSuMsg").textContent="Password must be at least 8 characters."; $("empSuMsg").classList.add("err"); return; }

  try{
    await apiPost("/api/send-code", { email, purpose:"employee_signup", company_code });
    pendingEmployee = { company_code, full_name, email, password };
    $("empCodeWrap").style.display = "block";
    $("empSuMsg").textContent = "We‚Äôve sent a 6-digit code to your email.";
    $("empSuMsg").classList.add("ok");
  }catch(e){
    $("empSuMsg").textContent = e.message || "Could not send code.";
    $("empSuMsg").classList.add("err");
  }
});

$("empVerify").addEventListener("click", async ()=>{
  $("empSuMsg2").textContent = "";
  $("empSuMsg2").className = "msg";

  if (!pendingEmployee){ $("empSuMsg2").textContent="Press Continue first."; $("empSuMsg2").classList.add("err"); return; }
  const code = $("empCode").value.trim();
  if (!code || code.length !== 6){ $("empSuMsg2").textContent="Enter the 6-digit code."; $("empSuMsg2").classList.add("err"); return; }

  try{
    // verify code and create user + link to employee row
    await apiPost("/api/employee-link", {
      email: pendingEmployee.email,
      code,
      password: pendingEmployee.password,
      company_code: pendingEmployee.company_code,
      full_name: pendingEmployee.full_name
    });

    const { data, error } = await sb.auth.signInWithPassword({ email: pendingEmployee.email, password: pendingEmployee.password });
    if (error) throw error;

    currentSession = data.session;
    closeModal("authModal");
    location.hash = "#dashboard";
    await showDashboard();
  }catch(e){
    $("empSuMsg2").textContent = e.message || "Could not create your employee account.";
    $("empSuMsg2").classList.add("err");
  }
});

/* =========================
   Dashboard + onboarding wizard
========================= */
function goHome(){
  $("dashboard").classList.remove("show");
  document.querySelector(".section.plan").style.display = "block";
  window.scrollTo({ top:0, behavior:"smooth" });
  location.hash = "";
}

$("signOutBtn").addEventListener("click", async ()=>{
  await sb.auth.signOut();
  currentSession = null;
  currentCompany = null;
  currentProfile = null;
  goHome();
});

$("companySettingsBtn").addEventListener("click", ()=>{
  if (!currentCompany) return;
  $("colPrimary").value = currentCompany.primary_color || "#ff0000";
  $("colSecondary").value = currentCompany.secondary_color || "#000000";
  $("colText").value = currentCompany.text_color || "#ffffff";
  $("settingsMsg").textContent = "";
  openModal("settingsModal");
});
$("settingsClose").addEventListener("click", ()=> closeModal("settingsModal"));
$("saveColours").addEventListener("click", async ()=>{
  $("settingsMsg").textContent = "";
  $("settingsMsg").className = "msg";
  try{
    await apiPost("/api/update-company", {
      company_id: currentCompany.id,
      primary_color: $("colPrimary").value,
      secondary_color: $("colSecondary").value,
      text_color: $("colText").value
    });
    $("settingsMsg").textContent = "Saved.";
    $("settingsMsg").classList.add("ok");
    await loadDashboardData();
  }catch(e){
    $("settingsMsg").textContent = e.message || "Failed to save.";
    $("settingsMsg").classList.add("err");
  }
});

async function loadDashboardData(){
  await refreshSession();
  if (!currentSession?.user) return;

  const uid = currentSession.user.id;

  // Get profile
  const { data: prof } = await sb.from("profiles").select("*").eq("user_id", uid).maybeSingle();
  currentProfile = prof || null;

  // Get company (via profiles.company_id or companies.owner_user_id)
  let company = null;
  if (currentProfile?.company_id){
    const { data } = await sb.from("companies").select("*").eq("id", currentProfile.company_id).maybeSingle();
    company = data || null;
  }else{
    const { data } = await sb.from("companies").select("*").eq("owner_user_id", uid).maybeSingle();
    company = data || null;
  }
  currentCompany = company;

  // subscriptions (owned modules)
  if (currentCompany){
    const { data: subs } = await sb.from("subscriptions").select("*").eq("company_id", currentCompany.id).maybeSingle();
    currentSubs = subs || null;

    // employees
    const { data: emps } = await sb.from("employees").select("*").eq("company_id", currentCompany.id).order("created_at", { ascending:true });
    employees = emps || [];
  }else{
    currentSubs = null;
    employees = [];
  }

  // UI
  $("dashWelcome").textContent = `Signed in as ${currentSession.user.email}`;
  if (currentCompany){
    $("companySummary").innerHTML = `
      <div class="muted"><b>Company:</b> ${esc(currentCompany.company_name || "(not set)")}</div>
      <div class="muted" style="margin-top:4px;"><b>Company ID:</b> ${esc(currentCompany.company_code || "(not generated)")}</div>
      <div class="muted" style="margin-top:4px;"><b>Address:</b> ${esc(currentCompany.address || "(not set)")}</div>
    `;
  }else{
    $("companySummary").innerHTML = `<div class="muted">No company record found yet.</div>`;
  }

  renderEmployees();
  renderOwnedLinks();
  renderBuyMore();
  renderOnboardingWizard();
}

async function showDashboard(){
  await refreshSession();
  if (!currentSession?.user){
    showAuthView("login");
    openModal("authModal");
    return;
  }
  // hide plan content and show dash
  document.querySelector(".section.plan").style.display = "none";
  $("dashboard").classList.add("show");
  await loadDashboardData();
}

function renderOwnedLinks(){
  const wrap = $("ownedLinks");
  wrap.innerHTML = "";
  const owned = (currentSubs?.module_ids || []);
  if (!owned.length){
    wrap.innerHTML = `<span class="muted">No modules owned yet.</span>`;
    return;
  }
  owned.forEach(id=>{
    const m = MODULES.find(x=>x.id===id);
    if (!m) return;
    const a = document.createElement("a");
    a.href = "https://smartcoretechnology.co.uk";
    a.target = "_blank";
    a.className = "btn";
    a.textContent = m.name.toUpperCase();
    wrap.appendChild(a);
  });
}

function renderBuyMore(){
  const wrap = $("buyMoreRow");
  wrap.innerHTML = "";

  const owned = new Set(currentSubs?.module_ids || []);
  MODULES.filter(m=>!owned.has(m.id)).forEach(m=>{
    const b = document.createElement("button");
    b.className = "btn";
    b.textContent = `ADD ${m.name}`.toUpperCase();
    b.addEventListener("click", async ()=>{
      // testing mode: just store the module to subscriptions
      try{
        const newIds = Array.from(new Set([...(currentSubs?.module_ids || []), m.id]));
        await sb.from("subscriptions").upsert({
          company_id: currentCompany.id,
          module_ids: newIds
        }, { onConflict:"company_id" });
        await loadDashboardData();
      }catch(e){
        alert("Could not add module yet.");
      }
    });
    wrap.appendChild(b);
  });

  if (!wrap.childElementCount){
    wrap.innerHTML = `<span class="muted">You already own all modules.</span>`;
  }
}

/* Employees */
function smartApos(companyName){
  const n = (companyName || "").trim();
  if (!n) return "the company's";
  // if ends with s/S -> use apostrophe only
  return /s$/i.test(n) ? `${n}'` : `${n}'s`;
}

let pendingDelete = null;

function renderEmployees(){
  const list = $("empList");
  list.innerHTML = "";

  if (!employees.length){
    list.innerHTML = `<div class="muted" style="margin-top:10px;">No employees added yet.</div>`;
    return;
  }

  employees.forEach(emp=>{
    const row = document.createElement("div");
    row.className = "emp";
    row.innerHTML = `
      <div class="left">
        <div class="nm">${esc(emp.full_name)}</div>
        <div class="meta">${esc(emp.job_title || "")} ‚Ä¢ ${esc(emp.job_category || "")}${emp.is_admin ? " ‚Ä¢ Admin" : ""}</div>
        <div class="pillcode"><b>ID</b> ${esc(emp.employee_code || "")}</div>
      </div>
      <button class="xbtn" title="Remove">‚úï</button>
    `;
    row.querySelector(".xbtn").addEventListener("click", ()=>{
      pendingDelete = emp;
      const comp = currentCompany?.company_name || "this company";
      const apos = smartApos(comp);
      $("confirmText").textContent =
        `Are you sure you would like to remove ${emp.full_name} from ${apos} SmartDatabase? This action cannot be undone.`;
      $("confirmMsg").textContent = "";
      openModal("confirmModal");
    });
    list.appendChild(row);
  });
}

$("confirmClose").addEventListener("click", ()=> closeModal("confirmModal"));
$("confirmCancel").addEventListener("click", ()=> closeModal("confirmModal"));
$("confirmYes").addEventListener("click", async ()=>{
  if (!pendingDelete) return;
  $("confirmMsg").textContent = "";
  $("confirmMsg").className = "msg";
  try{
    await apiPost("/api/delete-employee", {
      company_id: currentCompany.id,
      employee_id: pendingDelete.id
    });
    closeModal("confirmModal");
    pendingDelete = null;
    await loadDashboardData();
  }catch(e){
    $("confirmMsg").textContent = e.message || "Failed to remove employee.";
    $("confirmMsg").classList.add("err");
  }
});

/* Add employee */
$("addEmpBtn").addEventListener("click", async ()=>{
  $("empMsg").textContent = "";
  $("empMsg").className = "msg";
  if (!currentCompany){ $("empMsg").textContent="No company loaded."; $("empMsg").classList.add("err"); return; }

  const full_name = $("empName").value.trim();
  const job_title = $("empTitle").value.trim();
  const job_category = $("empCategory").value.trim();
  const is_admin = $("empIsAdmin").checked;

  if (!full_name){ $("empMsg").textContent="Enter a name."; $("empMsg").classList.add("err"); return; }

  try{
    await apiPost("/api/add-employee", {
      company_id: currentCompany.id,
      company_code: currentCompany.company_code,
      full_name,
      job_title,
      job_category,
      is_admin
    });

    $("empName").value = "";
    $("empTitle").value = "";
    $("empCategory").value = "";
    $("empIsAdmin").checked = false;

    $("empMsg").textContent = "Employee added.";
    $("empMsg").classList.add("ok");
    await loadDashboardData();
  }catch(e){
    $("empMsg").textContent = e.message || "Failed to add employee.";
    $("empMsg").classList.add("err");
  }
});

/* =========================
   Sequential onboarding wizard
   Steps:
    1) Company full name
    2) Company address
    3) Upload company logo
    4) Tell us about you (full name, job title, job category, admin yes)
    5) Add employees (can add multiple; finish)
========================= */
let wizardStep = 0;

function stepDots(total, active){
  const wrap = $("stepper");
  wrap.innerHTML = "";
  for (let i=0;i<total;i++){
    const d = document.createElement("div");
    d.className = "dot" + (i<=active ? " on":"");
    wrap.appendChild(d);
  }
}

function needsOnboarding(){
  if (!currentCompany) return true;

  const missingCompany = !currentCompany.company_name || !currentCompany.address || !currentCompany.logo_url;
  const missingYou = !currentProfile || !currentProfile.full_name || !currentProfile.job_title || !currentProfile.job_category;
  return missingCompany || missingYou;
}

function renderOnboardingWizard(){
  const wiz = $("onboardWizard");
  if (!needsOnboarding()){
    wiz.style.display = "none";
    return;
  }
  wiz.style.display = "block";

  const stepsTotal = 5;
  stepDots(stepsTotal, wizardStep);

  $("stepBackBtn").style.display = wizardStep > 0 ? "inline-flex" : "none";
  $("stepMsg").textContent = "";

  const body = $("stepBody");
  body.innerHTML = "";

  // Step 0: company name
  if (wizardStep === 0){
    body.innerHTML = `
      <div class="field">
        <label>Company full name</label>
        <input id="wCompanyName" value="${esc(currentCompany?.company_name || "")}" placeholder="e.g. SmartFits Installations LTD">
      </div>
      <div class="muted">This will appear across your SmartCore systems and documentation.</div>
    `;
  }

  // Step 1: address
  if (wizardStep === 1){
    body.innerHTML = `
      <div class="field">
        <label>Company address</label>
        <textarea id="wCompanyAddress" placeholder="Full registered address">${esc(currentCompany?.address || "")}</textarea>
      </div>
    `;
  }

  // Step 2: logo
  if (wizardStep === 2){
    body.innerHTML = `
      <div class="field">
        <label>Company logo (preferably transparent background)</label>
        <input id="wLogo" type="file" accept="image/*">
      </div>
      <div class="muted">We‚Äôll store the logo for your dashboard and system headers (testing mode).</div>
    `;
  }

  // Step 3: tell us about you
  if (wizardStep === 3){
    body.innerHTML = `
      <div style="font-weight:900;font-size:13px;margin-bottom:8px;">Tell Us About You</div>
      <div class="field">
        <label>Full name</label>
        <input id="wYourName" value="${esc(currentProfile?.full_name || "")}" placeholder="e.g. Finley Hassall">
      </div>
      <div class="row2">
        <div class="field">
          <label>Job title</label>
          <input id="wYourTitle" value="${esc(currentProfile?.job_title || "")}" placeholder="e.g. Founder">
        </div>
        <div class="field">
          <label>Job category</label>
          <input id="wYourCategory" value="${esc(currentProfile?.job_category || "")}" placeholder="e.g. Senior Management Team">
        </div>
      </div>
      <label style="display:flex;align-items:center;gap:10px;margin-top:6px;">
        <input type="checkbox" id="wYourAdmin" style="width:18px;height:18px;accent-color:#60a5fa;" ${currentProfile?.is_admin ? "checked":""}>
        Admin access
      </label>
      <div class="muted" style="margin-top:4px;">Admins can manage employees, subscriptions and company settings.</div>
    `;
  }

  // Step 4: employees (just instructions; the employee panel is already on the right)
  if (wizardStep === 4){
    const code = currentCompany?.company_code ? `<b>${esc(currentCompany.company_code)}</b>` : "<b>(generating‚Ä¶)</b>";
    body.innerHTML = `
      <div style="font-weight:900;font-size:13px;margin-bottom:8px;">Add Your Employees</div>
      <div class="muted" style="line-height:1.65;">
        Use the panel on the right to add employees. Each employee will receive a unique employee ID.
        <br><br>
        Employees can sign up using your <b>Company ID</b>: ${code}
        <br><br>
        When employees sign up, their name must match what you entered here.
      </div>
      <div class="muted" style="margin-top:10px;">
        When you‚Äôre ready, click <b>Finish</b> to complete onboarding.
      </div>
    `;
    $("stepNextBtn").textContent = "FINISH ‚Üí";
  } else {
    $("stepNextBtn").textContent = "CONTINUE ‚Üí";
  }
}

$("stepBackBtn").addEventListener("click", ()=>{
  wizardStep = Math.max(0, wizardStep - 1);
  renderOnboardingWizard();
});

$("stepNextBtn").addEventListener("click", async ()=>{
  $("stepMsg").textContent = "";
  $("stepMsg").className = "msg";

  try{
    // Save each step
    if (wizardStep === 0){
      const nm = $("wCompanyName").value.trim();
      if (!nm) throw new Error("Please enter your company name.");
      await apiPost("/api/update-company", { company_id: currentCompany.id, company_name: nm });
      wizardStep++;
    }
    else if (wizardStep === 1){
      const addr = $("wCompanyAddress").value.trim();
      if (!addr) throw new Error("Please enter your company address.");
      await apiPost("/api/update-company", { company_id: currentCompany.id, address: addr });
      wizardStep++;
    }
    else if (wizardStep === 2){
      const file = $("wLogo").files?.[0];
      if (!file) throw new Error("Please upload a logo.");
      // store as data URL for now (testing)
      const dataUrl = await new Promise((resolve, reject)=>{
        const r = new FileReader();
        r.onload = ()=> resolve(r.result);
        r.onerror = ()=> reject(new Error("Could not read image."));
        r.readAsDataURL(file);
      });
      await apiPost("/api/update-company", { company_id: currentCompany.id, logo_url: dataUrl });
      wizardStep++;
    }
    else if (wizardStep === 3){
      const full_name = $("wYourName").value.trim();
      const job_title = $("wYourTitle").value.trim();
      const job_category = $("wYourCategory").value.trim();
      const is_admin = $("wYourAdmin").checked;

      if (!full_name) throw new Error("Please enter your full name.");
      if (!job_title) throw new Error("Please enter your job title.");
      if (!job_category) throw new Error("Please enter your job category.");

      // Update profile using Supabase client (RLS should allow self)
      const uid = currentSession.user.id;
      const { error } = await sb.from("profiles").upsert({
        user_id: uid,
        company_id: currentCompany.id,
        full_name,
        job_title,
        job_category,
        is_admin
      }, { onConflict:"user_id" });
      if (error) throw error;

      wizardStep++;
    }
    else if (wizardStep === 4){
      // finish
      $("stepMsg").textContent = "Onboarding complete.";
      $("stepMsg").classList.add("ok");
      wizardStep = 0;
      await loadDashboardData();
      return;
    }

    await loadDashboardData();
    renderOnboardingWizard();
  }catch(e){
    $("stepMsg").textContent = e.message || "Could not save this step.";
    $("stepMsg").classList.add("err");
  }
});

/* =========================
   Routing
========================= */
function renderRoute(){
  const h = location.hash || "";
  if (h === "#dashboard"){
    showDashboard();
  } else {
    // home
    $("dashboard").classList.remove("show");
    document.querySelector(".section.plan").style.display = "block";
  }
}
window.addEventListener("hashchange", renderRoute);
renderRoute();

/* Auto-show dashboard if already logged in */
(async ()=>{
  await refreshSession();
  if (currentSession?.user && location.hash === "#dashboard"){
    await showDashboard();
  }
})();

</script>
</body>
</html>
