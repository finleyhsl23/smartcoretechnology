<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SmartCore • Onboarding</title>

  <link rel="icon" type="image/png" href="SmartCore Official Logos/SC Icon - Black Background.png">
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root{
      --bg0:#020617;
      --bg1:#06153a;
      --stroke: rgba(255,255,255,.12);
      --stroke2: rgba(255,255,255,.08);
      --text: #eaf0ff;
      --muted: rgba(234,240,255,.74);
      --shadow: 0 26px 80px rgba(0,0,0,.55);
      --r1: 22px;
      --r2: 16px;
      --blur: 16px;
    }
    html,body{height:100%}
    body{
      margin:0;
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color: var(--text);
      background:
        radial-gradient(1100px 800px at 50% 10%, rgba(70,120,255,.20), transparent 60%),
        radial-gradient(1200px 900px at 50% 60%, rgba(35,80,220,.14), transparent 62%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      overflow-x:hidden;
    }
    .glass{
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04));
      border:1px solid var(--stroke);
      backdrop-filter: blur(var(--blur));
      -webkit-backdrop-filter: blur(var(--blur));
      border-radius: var(--r1);
      box-shadow: var(--shadow);
    }
    .glass2{
      background: rgba(255,255,255,.045);
      border:1px solid var(--stroke2);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      border-radius: var(--r2);
    }
    .inp{
      width:100%;
      border-radius: 14px;
      border:1px solid var(--stroke2);
      background: rgba(255,255,255,.05);
      padding: 12px 12px;
      outline:none;
      color: var(--text);
    }
    .inp::placeholder{ color: rgba(234,240,255,.45); }
    .inp:focus{
      border-color: rgba(120,170,255,.35);
      box-shadow: 0 0 0 3px rgba(120,170,255,.10);
    }
    .btn{
      width:100%;
      padding: 12px 14px;
      border-radius: 16px;
      border: 1px solid rgba(120,170,255,.35);
      background: rgba(120,170,255,.16);
      transition: background .12s ease, transform .12s ease;
      font-weight: 600;
    }
    .btn:hover{ background: rgba(120,170,255,.22); transform: translateY(-1px); }
    .msgErr{ color: #fca5a5; }
    .msgOk{ color: #86efac; }
  </style>

  <script>
    window.__SUPABASE_URL  = "https://hjdpcfhozhoyeqevnupm.supabase.co";
    window.__SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhqZHBjZmhvemhveWVxZXZudXBtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY5MTk3MzYsImV4cCI6MjA4MjQ5NTczNn0.BXosJO4NmEZOe73GXSGPa3z-i_4ZzF9zBAMBIf6Mkts";
  </script>
</head>

<body>
  <header class="fixed top-4 left-0 right-0 z-40">
    <div class="max-w-5xl mx-auto px-4">
      <div class="glass2 flex items-center justify-between px-4 py-3">
        <div class="flex items-center gap-3 min-w-0">
          <div class="w-10 h-10 rounded-2xl overflow-hidden bg-black/30 border border-white/10 flex items-center justify-center shrink-0">
            <img src="SmartCore Official Logos/SC Icon - Black Background.png" alt="SmartCore" class="w-8 h-8 object-contain" onerror="this.style.display='none'">
          </div>
          <div class="min-w-0">
            <div class="font-semibold tracking-tight leading-tight">
              SmartCore <span class="opacity-70">Technology</span>
            </div>
            <div class="text-xs opacity-70 leading-tight">Onboarding</div>
          </div>
        </div>

        <a href="https://smartcoretechnology.co.uk" class="text-sm opacity-80 underline hover:opacity-100">Back</a>
      </div>
    </div>
  </header>

  <main class="max-w-5xl mx-auto px-4 pt-28 pb-24">
    <div class="glass p-6 sm:p-9">
      <h1 class="text-2xl sm:text-3xl font-extrabold tracking-tight">Complete your details</h1>
      <p class="mt-2 text-sm sm:text-[15px]" style="color: rgba(234,240,255,.74);">
        Please fill this in to finish onboarding. Your link expires automatically.
      </p>

      <div id="statusMsg" class="mt-4 text-sm msgErr hidden"></div>

      <div id="blocked" class="mt-6 hidden">
        <div class="glass2 p-4">
          <div class="font-semibold">This link can’t be used</div>
          <div class="mt-1 text-sm opacity-75">
            It may be expired, already completed, or missing the required token.
          </div>
        </div>
      </div>

      <div id="formWrap" class="mt-6 hidden">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div class="md:col-span-2 glass2 p-4">
            <div class="text-sm font-semibold opacity-90">Password</div>
            <div class="mt-2 text-sm opacity-70">
              Set a password now so you can log in using your <b>work email</b>.
            </div>

            <div class="mt-3 grid grid-cols-1 md:grid-cols-2 gap-3">
              <div>
                <label class="text-xs opacity-70">New password</label>
                <input id="pw1" class="inp mt-1" type="password" placeholder="Minimum 8 characters">
              </div>
              <div>
                <label class="text-xs opacity-70">Confirm password</label>
                <input id="pw2" class="inp mt-1" type="password" placeholder="Repeat password">
              </div>
            </div>

            <button id="savePwBtn" class="btn mt-3" type="button">Save password</button>
            <div id="pwMsg" class="mt-3 text-sm hidden"></div>
          </div>

          <div>
            <label class="text-xs opacity-70">Full name</label>
            <input id="full_name" class="inp mt-1" placeholder="Your full name">
          </div>

          <div>
            <label class="text-xs opacity-70">Title (optional)</label>
            <input id="title" class="inp mt-1" placeholder="e.g. Mr, Mrs, Ms, Dr">
          </div>

          <div>
            <label class="text-xs opacity-70">Pronouns (optional)</label>
            <input id="pronouns" class="inp mt-1" placeholder="e.g. she/her, he/him, they/them">
          </div>

          <div>
            <label class="text-xs opacity-70">Gender</label>
            <input id="gender" class="inp mt-1" placeholder="Gender">
          </div>

          <div>
            <label class="text-xs opacity-70">Date of birth</label>
            <input id="dob" class="inp mt-1" type="date">
          </div>

          <div>
            <label class="text-xs opacity-70">Nationality</label>
            <input id="nationality" class="inp mt-1" placeholder="Nationality">
          </div>

          <div>
            <label class="text-xs opacity-70">National Insurance Number (optional)</label>
            <input id="ni_number" class="inp mt-1" placeholder="NI Number">
          </div>

          <div>
            <label class="text-xs opacity-70">Driving Licence Number (optional)</label>
            <input id="driving_licence" class="inp mt-1" placeholder="Licence number">
          </div>

          <div>
            <label class="text-xs opacity-70">Personal email</label>
            <input id="personal_email" class="inp mt-1" type="email" placeholder="Personal email">
          </div>

          <div>
            <label class="text-xs opacity-70">Personal telephone</label>
            <input id="personal_phone" class="inp mt-1" placeholder="Phone number">
          </div>

          <div class="md:col-span-2">
            <label class="text-xs opacity-70">Address</label>
            <textarea id="address" class="inp mt-1" rows="3" placeholder="Full address"></textarea>
          </div>
        </div>

        <button id="saveBtn" class="btn mt-5" type="button">Submit details</button>
        <div id="saveMsg" class="mt-3 text-sm hidden"></div>
      </div>
    </div>
  </main>

  <script>
    const sb = window.supabase.createClient(window.__SUPABASE_URL, window.__SUPABASE_ANON);
    const $ = (id) => document.getElementById(id);

    function show(el){ el.classList.remove("hidden"); }
    function hide(el){ el.classList.add("hidden"); }
    function setMsg(el, msg, ok){
      el.textContent = msg;
      el.classList.remove("hidden");
      el.classList.toggle("msgOk", !!ok);
      el.classList.toggle("msgErr", !ok);
    }

    function getTokenFromQuery(){
      const p = new URLSearchParams(location.search);
      return p.get("token");
    }

    function getHashParams(){
      const raw = (location.hash || "").replace(/^#/, "");
      const p = new URLSearchParams(raw);
      return {
        access_token: p.get("access_token"),
        refresh_token: p.get("refresh_token"),
        type: p.get("type")
      };
    }

    async function setSessionFromHash(){
      const h = getHashParams();
      if (!h.access_token || !h.refresh_token) return false;

      const { error } = await sb.auth.setSession({
        access_token: h.access_token,
        refresh_token: h.refresh_token
      });
      if (error) throw error;
      return true;
    }

    async function loadEmployeeByToken(token){
      // This requires RLS to allow a user to read the row by onboarding_token
      // If your RLS blocks it, tell me and I’ll give you the policy.
      const { data, error } = await sb
        .from("employees")
        .select("id, full_name, personal_email, onboarding_expires")
        .eq("onboarding_token", token)
        .maybeSingle();

      if (error) throw error;
      return data || null;
    }

    async function savePassword(){
      const a = $("pw1").value;
      const b = $("pw2").value;
      if (!a || a.length < 8) return setMsg($("pwMsg"), "Password must be at least 8 characters.", false);
      if (a !== b) return setMsg($("pwMsg"), "Passwords do not match.", false);

      $("savePwBtn").disabled = true;
      try{
        const { error } = await sb.auth.updateUser({ password: a });
        if (error) throw error;
        setMsg($("pwMsg"), "Password saved.", true);
      }catch(e){
        setMsg($("pwMsg"), e.message || "Failed to save password.", false);
      }finally{
        $("savePwBtn").disabled = false;
      }
    }

    async function submitDetails(employeeId, token){
      const payload = {
        full_name: $("full_name").value.trim(),
        title: $("title").value.trim() || null,
        pronouns: $("pronouns").value.trim() || null,
        gender: $("gender").value.trim() || null,
        dob: $("dob").value || null,
        nationality: $("nationality").value.trim() || null,
        ni_number: $("ni_number").value.trim() || null,
        driving_licence: $("driving_licence").value.trim() || null,
        personal_email: $("personal_email").value.trim().toLowerCase(),
        personal_phone: $("personal_phone").value.trim() || null,
        address: $("address").value.trim() || null,

        onboarding_token: null,
        onboarding_expires: null,
        onboarding_completed_at: new Date().toISOString()
      };

      if (!payload.full_name) throw new Error("Full name is required.");
      if (!payload.personal_email) throw new Error("Personal email is required.");

      // Update ONLY the row that matches this token (prevents random edits)
      const { error } = await sb
        .from("employees")
        .update(payload)
        .eq("id", employeeId)
        .eq("onboarding_token", token);

      if (error) throw error;
    }

    async function init(){
      try{
        const token = getTokenFromQuery();
        if (!token){
          show($("blocked"));
          setMsg($("statusMsg"), "Missing token in URL.", false);
          return;
        }

        // Must have auth hash tokens from Supabase invite link
        const didSet = await setSessionFromHash();
        if (!didSet){
          show($("blocked"));
          setMsg($("statusMsg"), "This link is missing secure login tokens. Please use the email link again.", false);
          return;
        }

        const emp = await loadEmployeeByToken(token);
        if (!emp){
          show($("blocked"));
          setMsg($("statusMsg"), "This onboarding token is invalid or already used.", false);
          return;
        }

        // Prefill basics
        $("full_name").value = emp.full_name || "";
        $("personal_email").value = (emp.personal_email || "");

        hide($("blocked"));
        show($("formWrap"));
        setMsg($("statusMsg"), "You’re signed in. Please complete the form.", true);

        $("savePwBtn").onclick = savePassword;

        $("saveBtn").onclick = async ()=>{
          $("saveBtn").disabled = true;
          try{
            await submitDetails(emp.id, token);
            setMsg($("saveMsg"), "Details saved. You can now close this page and log in with your work email.", true);

            // Remove hash tokens from URL for safety
            history.replaceState(null, "", location.pathname + location.search);
          }catch(e){
            setMsg($("saveMsg"), e.message || "Failed to save details.", false);
          }finally{
            $("saveBtn").disabled = false;
          }
        };

      }catch(e){
        show($("blocked"));
        setMsg($("statusMsg"), e.message || "Onboarding failed.", false);
      }
    }

    init();
  </script>
</body>
</html>
