<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SmartCore • Onboarding</title>

  <link rel="icon" type="image/png" href="SmartCore Official Logos/SC Icon - Black Background.png">
  <link rel="apple-touch-icon" href="SmartCore Official Logos/SC Icon - Black Background.png">

  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root{
      --bg0:#020617;
      --bg1:#06153a;
      --stroke: rgba(255,255,255,.12);
      --stroke2: rgba(255,255,255,.08);
      --text: #eaf0ff;
      --muted: rgba(234,240,255,.74);
      --accent: rgba(120,170,255,.95);
      --shadow: 0 26px 80px rgba(0,0,0,.55);
      --shadow2: 0 18px 55px rgba(0,0,0,.45);
      --r1: 22px;
      --r2: 16px;
      --blur: 16px;
    }
    html,body{height:100%}
    body{
      margin:0;
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color: var(--text);
      background:
        radial-gradient(1100px 800px at 50% 10%, rgba(70,120,255,.20), transparent 60%),
        radial-gradient(1200px 900px at 50% 60%, rgba(35,80,220,.14), transparent 62%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      overflow-x:hidden;
    }
    .glass{
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04));
      border:1px solid var(--stroke);
      backdrop-filter: blur(var(--blur));
      -webkit-backdrop-filter: blur(var(--blur));
      border-radius: var(--r1);
      box-shadow: var(--shadow);
    }
    .glass2{
      background: rgba(255,255,255,.045);
      border:1px solid var(--stroke2);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      border-radius: var(--r2);
      box-shadow: var(--shadow2);
    }
    .inp{
      width:100%;
      border-radius: 14px;
      border:1px solid var(--stroke2);
      background: rgba(255,255,255,.05);
      padding: 12px 12px;
      outline:none;
      color: var(--text);
    }
    .inp::placeholder{ color: rgba(234,240,255,.45); }
    .inp:focus{
      border-color: rgba(120,170,255,.35);
      box-shadow: 0 0 0 3px rgba(120,170,255,.10);
    }
    .btn{
      padding: 12px 14px;
      border-radius: 16px;
      border: 1px solid rgba(120,170,255,.35);
      background: rgba(120,170,255,.16);
      transition: background .12s ease, transform .12s ease, opacity .12s ease;
      font-weight: 600;
    }
    .btn:hover{ background: rgba(120,170,255,.22); transform: translateY(-1px); }
    .btn:disabled{ opacity:.6; cursor:not-allowed; transform:none; }
    .rowBtn{
      padding: 8px 10px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.05);
      transition: background .12s ease, transform .12s ease;
      font-size: 13px;
      white-space: nowrap;
    }
    .rowBtn:hover{ background: rgba(255,255,255,.08); transform: translateY(-1px); }

    /* Custom dropdown */
    .ddWrap{ position: relative; }
    .ddBtn{
      width:100%;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      border-radius: 14px;
      border:1px solid var(--stroke2);
      background: rgba(255,255,255,.05);
      padding: 12px 12px;
      color: var(--text);
      cursor:pointer;
      transition: background .12s ease, transform .12s ease;
    }
    .ddBtn:hover{ background: rgba(255,255,255,.07); transform: translateY(-1px); }
    .ddMenu{
      position:absolute;
      left:0; right:0;
      top: calc(100% + 8px);
      z-index: 40;
      border-radius: 16px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(8, 12, 28, .92);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      box-shadow: 0 18px 55px rgba(0,0,0,.45);
      overflow:hidden;
      display:none;
    }
    .ddMenu.show{ display:block; }
    .ddItem{
      padding: 12px 12px;
      cursor:pointer;
      border-top: 1px solid rgba(255,255,255,.06);
      display:flex; align-items:center; justify-content:space-between;
      gap: 10px;
      font-size: 13px;
    }
    .ddItem:first-child{ border-top:0; }
    .ddItem:hover{ background: rgba(255,255,255,.06); }
    .ddTick{
      width: 10px; height: 10px; border-radius: 999px;
      background: rgba(255,255,255,.18);
    }
    .ddItem.on .ddTick{
      background: rgba(120,170,255,.95);
      box-shadow: 0 0 0 4px rgba(120,170,255,.14);
    }
    .chev{ opacity:.8; }
  </style>

  <script>
    // ✅ Your Supabase project
    window.__SUPABASE_URL  = "https://hjdpcfhozhoyeqevnupm.supabase.co";
    window.__SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhqZHBjZmhvemhveWVxZXZudXBtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY5MTk3MzYsImV4cCI6MjA4MjQ5NTczNn0.BXosJO4NmEZOe73GXSGPa3z-i_4ZzF9zBAMBIf6Mkts";
  </script>
</head>

<body>

  <!-- NAV -->
  <header class="fixed top-4 left-0 right-0 z-40">
    <div class="max-w-6xl mx-auto px-4">
      <div class="glass2 flex items-center justify-between px-4 py-3">
        <div class="flex items-center gap-3 min-w-0">
          <div class="w-10 h-10 rounded-2xl overflow-hidden bg-black/30 border border-white/10 flex items-center justify-center shrink-0">
            <img
              src="SmartCore Official Logos/SC Icon - Black Background.png"
              alt="SmartCore"
              class="w-8 h-8 object-contain translate-y-[-1px]"
              onerror="this.style.display='none'"
            />
          </div>
          <div class="min-w-0">
            <div class="font-semibold tracking-tight leading-tight">
              SmartCore <span class="opacity-70">Technology</span>
            </div>
            <div class="text-xs opacity-70 leading-tight">Onboarding</div>
          </div>
        </div>

        <div class="flex items-center gap-2">
          <button id="btnSignOut" class="rowBtn hidden">Sign out</button>
        </div>
      </div>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 pt-28 pb-24">
    <!-- LOADING -->
    <section id="screenLoading" class="glass p-7 sm:p-10">
      <div class="text-sm opacity-75">Please wait…</div>
      <div class="mt-2 text-2xl font-bold tracking-tight">Preparing your onboarding</div>
      <div id="loadingMsg" class="mt-4 text-sm" style="color: var(--muted);">Validating your link…</div>
    </section>

    <!-- ERROR -->
    <section id="screenError" class="glass p-7 sm:p-10 hidden">
      <div class="text-2xl font-bold tracking-tight">This link can’t be used</div>
      <p id="errMsg" class="mt-3 text-sm" style="color: var(--muted); max-width: 52rem;">
        The onboarding link is missing or expired.
      </p>
      <div class="mt-6 flex flex-wrap gap-3">
        <a href="https://smartcoretechnology.co.uk" class="rowBtn">Go to main site</a>
        <a href="mailto:support@smartcoretechnology.co.uk" class="rowBtn">Contact support</a>
      </div>
    </section>

    <!-- STEP 1: SET PASSWORD -->
    <section id="screenPassword" class="glass p-7 sm:p-10 hidden">
      <div class="inline-flex items-center gap-2 px-3 py-1.5 rounded-full border border-white/10 bg-white/5 text-xs opacity-80">
        <span class="w-2.5 h-2.5 rounded-full" style="background: rgba(120,170,255,.85)"></span>
        Step 1 of 2
      </div>

      <h1 class="mt-5 font-extrabold tracking-tight leading-[1.02]" style="font-size: clamp(30px, 4vw, 46px);">
        Set your password
      </h1>

      <p class="mt-3 text-[14px] sm:text-[15px] leading-relaxed" style="color: var(--muted); max-width: 52rem;">
        Create a secure password to activate your account. Then you’ll complete your onboarding details.
      </p>

      <div class="mt-6 grid grid-cols-1 sm:grid-cols-2 gap-4 max-w-2xl">
        <div>
          <label class="text-xs opacity-70">New password</label>
          <input id="pw1" class="inp mt-1" type="password" placeholder="Minimum 8 characters">
        </div>
        <div>
          <label class="text-xs opacity-70">Confirm password</label>
          <input id="pw2" class="inp mt-1" type="password" placeholder="Repeat password">
        </div>
      </div>

      <div id="pwMsg" class="mt-4 text-sm text-red-300 hidden"></div>

      <div class="mt-6 flex flex-wrap items-center gap-3">
        <button id="btnSavePw" class="btn">Save password</button>
        <button id="btnShowPw" class="rowBtn" type="button">Show</button>
      </div>

      <div class="mt-8 text-xs opacity-60">
        Support: <a class="underline hover:opacity-100" href="mailto:support@smartcoretechnology.co.uk">support@smartcoretechnology.co.uk</a>
      </div>
    </section>

    <!-- STEP 2: DETAILS -->
    <section id="screenDetails" class="glass p-7 sm:p-10 hidden">
      <div class="inline-flex items-center gap-2 px-3 py-1.5 rounded-full border border-white/10 bg-white/5 text-xs opacity-80">
        <span class="w-2.5 h-2.5 rounded-full" style="background: rgba(120,170,255,.85)"></span>
        Step 2 of 2
      </div>

      <h2 class="mt-5 text-3xl font-bold tracking-tight">Complete your details</h2>
      <p id="subDetails" class="mt-2 text-sm" style="color: var(--muted); max-width: 52rem;">
        Please complete the fields below. Optional fields can be left blank.
      </p>

      <div class="mt-6 grid grid-cols-1 lg:grid-cols-3 gap-4">
        <!-- Personal -->
        <div class="glass2 p-5 lg:col-span-2">
          <div class="text-sm font-semibold opacity-90">Personal</div>

          <div class="mt-4 grid grid-cols-1 sm:grid-cols-2 gap-4">
            <div>
              <label class="text-xs opacity-70">Full name</label>
              <input id="fFullName" class="inp mt-1" placeholder="e.g. Jamie Smith">
            </div>

            <div>
              <label class="text-xs opacity-70">Title (optional)</label>
              <input id="fTitle" class="inp mt-1" placeholder="e.g. Mr / Ms / Dr">
            </div>

            <div>
              <label class="text-xs opacity-70">Pronouns (optional)</label>
              <input id="fPronouns" class="inp mt-1" placeholder="e.g. she/her">
            </div>

            <div>
              <label class="text-xs opacity-70">Gender</label>
              <div id="ddGender" class="mt-1"></div>
            </div>

            <div>
              <label class="text-xs opacity-70">Date of birth</label>
              <input id="fDob" class="inp mt-1" type="date">
            </div>

            <div>
              <label class="text-xs opacity-70">Nationality</label>
              <input id="fNationality" class="inp mt-1" placeholder="e.g. British">
            </div>

            <div>
              <label class="text-xs opacity-70">National Insurance Number (optional)</label>
              <input id="fNIN" class="inp mt-1" placeholder="e.g. QQ123456C">
            </div>

            <div>
              <label class="text-xs opacity-70">Driving Licence Number (optional)</label>
              <input id="fDL" class="inp mt-1" placeholder="e.g. SMITH70101...">
            </div>

            <div>
              <label class="text-xs opacity-70">Personal email</label>
              <input id="fPersonalEmail" class="inp mt-1" type="email" placeholder="e.g. jamie@gmail.com">
            </div>

            <div>
              <label class="text-xs opacity-70">Personal telephone</label>
              <input id="fPhone" class="inp mt-1" placeholder="e.g. 07...">
            </div>
          </div>
        </div>

        <!-- Address -->
        <div class="glass2 p-5">
          <div class="text-sm font-semibold opacity-90">Address</div>

          <div class="mt-4 space-y-3">
            <div>
              <label class="text-xs opacity-70">Address line 1</label>
              <input id="a1" class="inp mt-1" placeholder="House number, street">
            </div>
            <div>
              <label class="text-xs opacity-70">Address line 2 (optional)</label>
              <input id="a2" class="inp mt-1" placeholder="Apartment, area">
            </div>
            <div>
              <label class="text-xs opacity-70">Town/City</label>
              <input id="city" class="inp mt-1" placeholder="e.g. Derby">
            </div>
            <div>
              <label class="text-xs opacity-70">Postcode</label>
              <input id="postcode" class="inp mt-1" placeholder="e.g. DE1 1AA">
            </div>
            <div>
              <label class="text-xs opacity-70">Country</label>
              <input id="country" class="inp mt-1" placeholder="e.g. United Kingdom">
            </div>
          </div>
        </div>
      </div>

      <div id="doneMsg" class="mt-5 text-sm text-red-300 hidden"></div>

      <div class="mt-6 flex flex-wrap items-center gap-3">
        <button id="btnComplete" class="btn">Complete onboarding</button>
        <button id="btnBack" class="rowBtn" type="button">Back</button>
      </div>

      <div class="mt-8 text-xs opacity-60">
        Support: <a class="underline hover:opacity-100" href="mailto:support@smartcoretechnology.co.uk">support@smartcoretechnology.co.uk</a>
      </div>
    </section>

    <!-- DONE -->
    <section id="screenDone" class="glass p-7 sm:p-10 hidden">
      <div class="text-3xl font-bold tracking-tight">All set ✅</div>
      <p class="mt-3 text-sm" style="color: var(--muted); max-width: 52rem;">
        Your onboarding is complete. You can now sign in using your <b>work email</b>.
      </p>
      <div class="mt-6 flex flex-wrap gap-3">
        <a class="rowBtn" href="https://smartcoretechnology.co.uk">Go to main site</a>
        <a class="rowBtn" href="/management">Go to management</a>
      </div>
    </section>

    <footer class="mt-10 glass2 p-5 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2">
      <div class="text-sm opacity-80">SmartCore Technology</div>
      <a class="text-sm opacity-80 underline hover:opacity-100" href="mailto:support@smartcoretechnology.co.uk">
        support@smartcoretechnology.co.uk
      </a>
    </footer>
  </main>

  <script>
    /**********************
      UTIL
    **********************/
    const $ = (id) => document.getElementById(id);

    function show(el){ el.classList.remove("hidden"); }
    function hide(el){ el.classList.add("hidden"); }

    function showErr(el, msg){
      el.textContent = msg;
      el.classList.remove("hidden");
      el.classList.remove("text-green-300");
      el.classList.add("text-red-300");
    }
    function showOk(el, msg){
      el.textContent = msg;
      el.classList.remove("hidden");
      el.classList.remove("text-red-300");
      el.classList.add("text-green-300");
    }
    function clearMsg(el){
      el.textContent = "";
      el.classList.add("hidden");
      el.classList.remove("text-green-300");
      el.classList.add("text-red-300");
    }

    function showScreen(id){
      ["screenLoading","screenError","screenPassword","screenDetails","screenDone"].forEach(s=>{
        const el = $(s);
        if (!el) return;
        if (s === id) show(el); else hide(el);
      });
    }

    function esc(s){
      return String(s ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    /**********************
      SUPABASE INIT
    **********************/
    const sb = window.supabase.createClient(window._SUPABASE_URL, window._SUPABASE_ANON);

    /**********************
      CUSTOM DROPDOWN
    **********************/
    function createDropdown({ mountId, value, items, onChange }){
      const mount = $(mountId);
      if (!mount) return null;

      const wrap = document.createElement("div");
      wrap.className = "ddWrap";

      const btn = document.createElement("button");
      btn.type = "button";
      btn.className = "ddBtn";
      btn.innerHTML = <span class="ddLabel"></span><span class="chev">▾</span>;

      const menu = document.createElement("div");
      menu.className = "ddMenu";

      const labelEl = btn.querySelector(".ddLabel");

      const api = {
        value,
        set(v){
          api.value = v;
          const it = items.find(x => x.value === v) || items[0];
          labelEl.textContent = it ? it.label : String(v);
          Array.from(menu.querySelectorAll(".ddItem")).forEach(el=>{
            el.classList.toggle("on", el.dataset.value === String(v));
          });
        },
        close(){ menu.classList.remove("show"); },
      };

      items.forEach(it=>{
        const item = document.createElement("div");
        item.className = "ddItem";
        item.dataset.value = String(it.value);
        item.innerHTML = `
          <div class="min-w-0">
            <div class="font-medium">${esc(it.label)}</div>
            ${it.sub ? <div class="text-xs opacity-60 mt-0.5">${esc(it.sub)}</div> : ""}
          </div>
          <div class="ddTick"></div>
        `;
        item.addEventListener("click", ()=>{
          api.set(it.value);
          api.close();
          onChange && onChange(it.value);
        });
        menu.appendChild(item);
      });

      btn.addEventListener("click", ()=> menu.classList.toggle("show"));
      document.addEventListener("click", (e)=>{ if (!wrap.contains(e.target)) api.close(); });

      wrap.appendChild(btn);
      wrap.appendChild(menu);
      mount.innerHTML = "";
      mount.appendChild(wrap);

      api.set(value);
      return api;
    }

    /**********************
      TOKEN + HASH SESSION
      invite link will look like:
      /onboarding?token=XYZ#access_token=...&refresh_token=...&type=invite
    **********************/
    const qs = new URLSearchParams(window.location.search);
    const onboardingToken = qs.get("token");

    function parseHashParams(){
      const h = window.location.hash || "";
      if (!h.startsWith("#")) return null;
      const p = new URLSearchParams(h.slice(1));
      const at = p.get("access_token");
      const rt = p.get("refresh_token");
      const type = p.get("type");
      return { access_token: at, refresh_token: rt, type };
    }

    /**********************
      STATE
    **********************/
    const state = {
      ddGender: null,
      employeeRow: null,
      user: null
    };

    /**********************
      FETCH EMPLOYEE BY TOKEN (optional but useful)
      - This helps you pre-fill name/personal email if you stored them
    **********************/
    async function loadEmployeeByToken(){
      state.employeeRow = null;
      if (!onboardingToken) return null;

      // Pull whatever fields you have
      // NOTE: if your employee table columns differ, adjust select list.
      const { data, error } = await sb
        .from("employees")
        .select("id, full_name, personal_email, work_email, job_title, onboarding_token, onboarding_expires")
        .eq("onboarding_token", onboardingToken)
        .maybeSingle();

      if (error) return null;
      state.employeeRow = data || null;
      return state.employeeRow;
    }

    function prefillFromEmployeeRow(){
      if (!state.employeeRow) return;

      // If HR already stored some of these, prefill them
      if (state.employeeRow.full_name) $("fFullName").value = state.employeeRow.full_name;
      if (state.employeeRow.personal_email) $("fPersonalEmail").value = state.employeeRow.personal_email;

      const work = state.employeeRow.work_email || "";
      const role = state.employeeRow.job_title ? ` (${state.employeeRow.job_title})` : "";
      $("subDetails").innerHTML = You are signing in as <b>${esc(work)}</b>${esc(role)}. Please complete your details.;
    }

    /**********************
      AUTH: Set session from hash, then get user
    **********************/
    async function ensureSessionFromHash(){
      const hp = parseHashParams();

      // If we have tokens in hash, set session explicitly
      if (hp?.access_token && hp?.refresh_token){
        const { error } = await sb.auth.setSession({
          access_token: hp.access_token,
          refresh_token: hp.refresh_token
        });
        if (error) throw new Error("This link is invalid or expired. Please request a new invite.");
        // Clean hash (security)
        history.replaceState(null, "", window.location.pathname + window.location.search);
      }

      // Now get active session/user
      const { data: { session } } = await sb.auth.getSession();
      if (!session?.user) return null;

      state.user = session.user;
      return state.user;
    }

    /**********************
      SIGN OUT
    **********************/
    async function signOut(){
      try{ await sb.auth.signOut(); }catch(_){}
      window.location.href = "https://smartcoretechnology.co.uk";
    }

    /**********************
      STEP 1: PASSWORD
    **********************/
    async function savePassword(){
      clearMsg($("pwMsg"));
      const a = $("pw1").value;
      const b = $("pw2").value;

      if (!a || a.length < 8) return showErr($("pwMsg"), "Password must be at least 8 characters.");
      if (a !== b) return showErr($("pwMsg"), "Passwords do not match.");

      $("btnSavePw").disabled = true;

      try{
        const { error } = await sb.auth.updateUser({ password: a });
        if (error) throw error;

        // Continue to details
        await loadEmployeeByToken();
        prefillFromEmployeeRow();
        showScreen("screenDetails");

      }catch(e){
        showErr($("pwMsg"), "Failed to set password: " + (e.message || e));
      }finally{
        $("btnSavePw").disabled = false;
      }
    }

    /**********************
      STEP 2: COMPLETE DETAILS + LINK EMPLOYEE TO USER
      IMPORTANT:
      - This updates the employee row found by onboarding_token
      - It sets user_id = auth user id
      - It clears onboarding_token & onboarding_expires
      - It stores the employee-provided details

      Adjust field names in the update payload if your employees table columns differ.
    **********************/
    function required(v){ return String(v || "").trim(); }

    async function completeOnboarding(){
      clearMsg($("doneMsg"));

      if (!onboardingToken) return showErr($("doneMsg"), "Missing token. Please use the link you were emailed.");
      if (!state.user) return showErr($("doneMsg"), "You are not signed in. Please use the link you were emailed.");

      // Basic validation
      const full_name = required($("fFullName").value);
      const gender = state.ddGender?.value || "";
      const dob = $("fDob").value || null;
      const nationality = required($("fNationality").value);
      const personal_email = required($("fPersonalEmail").value);
      const phone = required($("fPhone").value);

      if (!full_name) return showErr($("doneMsg"), "Full name is required.");
      if (!gender) return showErr($("doneMsg"), "Gender is required.");
      if (!dob) return showErr($("doneMsg"), "Date of birth is required.");
      if (!nationality) return showErr($("doneMsg"), "Nationality is required.");
      if (!personal_email) return showErr($("doneMsg"), "Personal email is required.");
      if (!phone) return showErr($("doneMsg"), "Personal telephone is required.");

      const payload = {
        // ✅ Link to auth user
        user_id: state.user.id,

        // ✅ Clear token so it can’t be reused
        onboarding_token: null,
        onboarding_expires: null,

        // ✅ Employee-completed fields (adjust column names if needed)
        full_name: full_name,
        title: $("fTitle").value.trim() || null,
        pronouns: $("fPronouns").value.trim() || null,
        gender: gender,
        dob: dob,
        nationality: nationality,
        ni_number: $("fNIN").value.trim() || null,
        driving_licence_number: $("fDL").value.trim() || null,
        personal_email: personal_email,
        personal_phone: phone,

        address_line1: $("a1").value.trim() || null,
        address_line2: $("a2").value.trim() || null,
        city: $("city").value.trim() || null,
        postcode: $("postcode").value.trim() || null,
        country: $("country").value.trim() || null
      };

      $("btnComplete").disabled = true;

      try{
        // 1) Update employees row that matches token
        const { error } = await sb
          .from("employees")
          .update(payload)
          .eq("onboarding_token", onboardingToken);

        if (error){
          // Common cause: RLS policy not allowing update by onboarding_token
          throw new Error(error.message);
        }

        showScreen("screenDone");
      }catch(e){
        showErr($("doneMsg"),
          "Could not complete onboarding: " + (e.message || e) +
          "\n\nIf this keeps happening, it’s usually an RLS policy on employees blocking update by token."
        );
      }finally{
        $("btnComplete").disabled = false;
      }
    }

    /**********************
      INIT
    **********************/
    function initDropdowns(){
      state.ddGender = createDropdown({
        mountId: "ddGender",
        value: "",
        items: [
          { value:"", label:"Select…", sub:"Required" },
          { value:"Female", label:"Female" },
          { value:"Male", label:"Male" },
          { value:"Non-binary", label:"Non-binary" },
          { value:"Prefer not to say", label:"Prefer not to say" },
          { value:"Other", label:"Other" },
        ]
      });
    }

    function wire(){
      $("btnSignOut").onclick = signOut;

      $("btnSavePw").onclick = savePassword;
      $("btnShowPw").onclick = ()=>{
        const p1 = $("pw1"), p2 = $("pw2");
        const showNow = (p1.type === "password");
        p1.type = showNow ? "text" : "password";
        p2.type = showNow ? "text" : "password";
        $("btnShowPw").textContent = showNow ? "Hide" : "Show";
      };

      $("btnComplete").onclick = completeOnboarding;
      $("btnBack").onclick = ()=> showScreen("screenPassword");
    }

    async function init(){
      initDropdowns();
      wire();

      // Must have token in query
      if (!onboardingToken){
        showScreen("screenError");
        $("errMsg").textContent = "Missing token. Please open the onboarding link you were emailed (it must include ?token=...).";
        return;
      }

      showScreen("screenLoading");
      $("loadingMsg").textContent = "Signing you in securely…";

      try{
        const user = await ensureSessionFromHash();
        if (!user){
          showScreen("screenError");
          $("errMsg").textContent = "No active session found. Please use the invite link again (it must include #access_token and #refresh_token).";
          return;
        }

        // Show sign out
        show($("btnSignOut"));

        // Optional: load employee row for prefill / validation
        $("loadingMsg").textContent = "Validating onboarding token…";
        await loadEmployeeByToken();

        // If token doesn't match any employee row, still allow user to set password,
        // but they may not be linkable. You can enforce strict behaviour if you want:
        // if (!state.employeeRow) { throw new Error("Token not found."); }

        // Step 1: set password first
        showScreen("screenPassword");

      }catch(e){
        showScreen("screenError");
        $("errMsg").textContent = e.message || "Onboarding link invalid or expired.";
      }
    }

    init();
  </script>

  <!--
    ✅ If you get “update blocked” errors:
    You likely need an employees RLS policy like:
    - allow update when onboarding_token matches and not expired
    - allow select for token lookup

    Example (adjust table/columns):
    ------------------------------------------------
    -- SELECT by token (so onboarding page can find the row)
    create policy "employees_select_by_token"
    on public.employees for select
    using (onboarding_token is not null);

    -- UPDATE by token (employee completing onboarding)
    create policy "employees_update_by_token"
    on public.employees for update
    using (
      onboarding_token is not null
      and onboarding_token = current_setting('request.jwt.claims', true)::json->>'token'  -- (optional advanced)
    )
    with check (true);
    ------------------------------------------------

    If you don’t want advanced JWT claim stuff, simplest is:
    allow update where auth.uid() is not null AND the row onboarding_token = ?token
    (you can do this via a SECURITY DEFINER RPC instead, which is the cleanest).
  -->
</body>
</html>
