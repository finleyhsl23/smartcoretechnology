<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SmartCore Technology • Onboarding</title>

  <link rel="icon" type="image/png" href="SmartCore Official Logos/SC Icon - Black Background.png">
  <link rel="apple-touch-icon" href="SmartCore Official Logos/SC Icon - Black Background.png">

  <script src="https://cdn.tailwindcss.com"></script>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root{
      --bg0:#020617;
      --bg1:#06153a;
      --stroke: rgba(255,255,255,.12);
      --stroke2: rgba(255,255,255,.08);
      --text: #eaf0ff;
      --muted: rgba(234,240,255,.74);
      --accent: rgba(120,170,255,.95);
      --shadow: 0 26px 80px rgba(0,0,0,.55);
      --shadow2: 0 18px 55px rgba(0,0,0,.45);
      --r1: 22px;
      --r2: 16px;
      --blur: 16px;
    }
    html,body{height:100%}
    body{
      margin:0;
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color: var(--text);
      background:
        radial-gradient(1100px 800px at 50% 10%, rgba(70,120,255,.20), transparent 60%),
        radial-gradient(1200px 900px at 50% 60%, rgba(35,80,220,.14), transparent 62%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      overflow-x:hidden;
    }
    .glass{
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04));
      border:1px solid var(--stroke);
      backdrop-filter: blur(var(--blur));
      -webkit-backdrop-filter: blur(var(--blur));
      border-radius: var(--r1);
      box-shadow: var(--shadow);
    }
    .glass2{
      background: rgba(255,255,255,.045);
      border:1px solid var(--stroke2);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      border-radius: var(--r2);
      box-shadow: var(--shadow2);
    }
    .inp{
      width:100%;
      border-radius: 14px;
      border:1px solid var(--stroke2);
      background: rgba(255,255,255,.05);
      padding: 12px 12px;
      outline:none;
      color: var(--text);
    }
    .inp::placeholder{ color: rgba(234,240,255,.45); }
    .inp:focus{
      border-color: rgba(120,170,255,.35);
      box-shadow: 0 0 0 3px rgba(120,170,255,.10);
    }
    .btn{
      padding: 12px 14px;
      border-radius: 16px;
      border: 1px solid rgba(120,170,255,.35);
      background: rgba(120,170,255,.16);
      transition: background .12s ease, transform .12s ease;
      font-size: 14px;
      font-weight: 600;
    }
    .btn:hover{ background: rgba(120,170,255,.22); transform: translateY(-1px); }
    .btn:disabled{ opacity:.6; cursor:not-allowed; transform:none; }

    .rowBtn{
      padding: 8px 10px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.05);
      transition: background .12s ease, transform .12s ease;
      font-size: 13px;
      white-space: nowrap;
    }
    .rowBtn:hover{ background: rgba(255,255,255,.08); transform: translateY(-1px); }
    .tag{
      display:inline-flex; align-items:center; gap:8px;
      padding: 6px 10px; border-radius: 999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.05);
      font-size: 12px; opacity: .95;
      width: fit-content;
    }
    .tagDot{ width:8px; height:8px; border-radius:999px; background: rgba(255,255,255,.35); }
    .tagDot.green{ background: rgba(80,240,160,.9); box-shadow: 0 0 0 4px rgba(80,240,160,.12); }

    .spinner{
      width: 18px; height: 18px;
      border-radius: 999px;
      border: 2px solid rgba(255,255,255,.25);
      border-top-color: rgba(120,170,255,.9);
      animation: spin 1s linear infinite;
    }
    @keyframes spin{ to{ transform: rotate(360deg); } }
  </style>

  <script>
    // ✅ Set these to your project
    window.__SUPABASE_URL  = "https://hjdpcfhozhoyeqevnupm.supabase.co";
    window.__SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhqZHBjZmhvemhveWVxZXZudXBtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY5MTk3MzYsImV4cCI6MjA4MjQ5NTczNn0.BXosJO4NmEZOe73GXSGPa3z-i_4ZzF9zBAMBIf6Mkts";
  </script>
</head>

<body>

  <!-- NAV -->
  <header class="fixed top-4 left-0 right-0 z-40">
    <div class="max-w-4xl mx-auto px-4">
      <div class="glass2 flex items-center justify-between px-4 py-3">
        <div class="flex items-center gap-3 min-w-0">
          <div class="w-10 h-10 rounded-2xl overflow-hidden bg-black/30 border border-white/10 flex items-center justify-center shrink-0">
            <img
              src="SmartCore Official Logos/SC Icon - Black Background.png"
              alt="SmartCore"
              class="w-8 h-8 object-contain translate-y-[-1px]"
              onerror="this.style.display='none'"
            />
          </div>
          <div class="min-w-0">
            <div class="font-semibold tracking-tight leading-tight">
              SmartCore <span class="opacity-70">Technology</span>
            </div>
            <div class="text-xs opacity-70 leading-tight">Onboarding</div>
          </div>
        </div>

        <div class="flex items-center gap-2">
          <button id="btnSignOut" class="hidden rowBtn">Sign out</button>
        </div>
      </div>
    </div>
  </header>

  <main class="max-w-4xl mx-auto px-4 pt-28 pb-24">

    <!-- SCREEN: LOADING -->
    <section id="screenLoading" class="glass p-7 sm:p-10">
      <div class="inline-flex items-center gap-2 px-3 py-1.5 rounded-full border border-white/10 bg-white/5 text-xs opacity-80">
        <span class="spinner"></span>
        Please wait…
      </div>

      <h1 class="mt-5 font-extrabold tracking-tight leading-[1.02]" style="font-size: clamp(30px, 4vw, 44px);">
        Preparing your onboarding
      </h1>

      <p id="loadingMsg" class="mt-3 text-[15px] sm:text-[16px] leading-relaxed" style="color: var(--muted);">
        Validating your link…
      </p>

      <footer class="mt-10 glass2 p-5 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2">
        <div class="text-sm opacity-80">SmartCore Technology</div>
        <a class="text-sm opacity-80 underline hover:opacity-100" href="mailto:support@smartcoretechnology.co.uk">
          support@smartcoretechnology.co.uk
        </a>
      </footer>
    </section>

    <!-- SCREEN: PASSWORD -->
    <section id="screenPassword" class="hidden glass p-7 sm:p-10">
      <div class="flex items-start justify-between gap-3">
        <div>
          <div class="inline-flex items-center gap-2 px-3 py-1.5 rounded-full border border-white/10 bg-white/5 text-xs opacity-80">
            <span class="tagDot green"></span>
            Signed in securely
          </div>
          <h2 class="mt-5 text-2xl sm:text-3xl font-bold tracking-tight">Set your password</h2>
          <p class="mt-2 text-sm sm:text-[15px]" style="color: var(--muted); max-width: 46rem;">
            Create a password for your <b>work account</b>. Then you’ll complete your details.
          </p>
        </div>
      </div>

      <div class="mt-6 grid grid-cols-1 sm:grid-cols-2 gap-4">
        <div>
          <label class="text-xs opacity-70">New password</label>
          <input id="pw1" class="inp mt-1" type="password" placeholder="Minimum 8 characters">
        </div>
        <div>
          <label class="text-xs opacity-70">Confirm password</label>
          <input id="pw2" class="inp mt-1" type="password" placeholder="Repeat password">
        </div>
      </div>

      <div class="mt-5 flex flex-wrap items-center gap-3">
        <button id="btnSavePassword" class="btn">Save password</button>
        <div id="pwMsg" class="text-sm text-red-300 hidden"></div>
      </div>
    </section>

    <!-- SCREEN: DETAILS -->
    <section id="screenDetails" class="hidden glass p-7 sm:p-10">
      <div class="flex items-start justify-between gap-3">
        <div>
          <div class="inline-flex items-center gap-2 px-3 py-1.5 rounded-full border border-white/10 bg-white/5 text-xs opacity-80">
            <span class="tagDot green"></span>
            Step 2 of 2
          </div>
          <h2 class="mt-5 text-2xl sm:text-3xl font-bold tracking-tight">Complete your details</h2>
          <p class="mt-2 text-sm sm:text-[15px]" style="color: var(--muted); max-width: 52rem;">
            Fill out your personal details. (Some fields are optional.)
          </p>
        </div>
      </div>

      <div class="mt-6 grid grid-cols-1 sm:grid-cols-2 gap-4">
        <div class="sm:col-span-2 glass2 p-4">
          <div class="text-sm font-semibold opacity-90">Your onboarding record</div>
          <div class="mt-2 text-sm opacity-75">
            <div><span class="opacity-60">Company:</span> <span id="prefCompany">—</span></div>
            <div><span class="opacity-60">Work email:</span> <span id="prefWorkEmail">—</span></div>
            <div><span class="opacity-60">Job title:</span> <span id="prefJobTitle">—</span></div>
          </div>
        </div>

        <div>
          <label class="text-xs opacity-70">Full name</label>
          <input id="f_full_name" class="inp mt-1" placeholder="Your full name">
        </div>

        <div>
          <label class="text-xs opacity-70">Title (optional)</label>
          <input id="f_title" class="inp mt-1" placeholder="e.g. Mr / Mrs / Ms / Mx / Dr">
        </div>

        <div>
          <label class="text-xs opacity-70">Pronouns (optional)</label>
          <input id="f_pronouns" class="inp mt-1" placeholder="e.g. she/her, he/him, they/them">
        </div>

        <div>
          <label class="text-xs opacity-70">Gender</label>
          <select id="f_gender" class="inp mt-1">
            <option value="">Select…</option>
            <option>Female</option>
            <option>Male</option>
            <option>Non-binary</option>
            <option>Prefer not to say</option>
            <option>Other</option>
          </select>
        </div>

        <div>
          <label class="text-xs opacity-70">Date of birth</label>
          <input id="f_dob" class="inp mt-1" type="date">
        </div>

        <div>
          <label class="text-xs opacity-70">Nationality</label>
          <input id="f_nationality" class="inp mt-1" placeholder="e.g. British">
        </div>

        <div>
          <label class="text-xs opacity-70">National Insurance Number (optional)</label>
          <input id="f_ni" class="inp mt-1" placeholder="e.g. QQ123456C">
        </div>

        <div>
          <label class="text-xs opacity-70">Driving Licence Number (optional)</label>
          <input id="f_dl" class="inp mt-1" placeholder="Driving licence number">
        </div>

        <div>
          <label class="text-xs opacity-70">Personal email</label>
          <input id="f_personal_email" class="inp mt-1" type="email" placeholder="name@gmail.com">
        </div>

        <div>
          <label class="text-xs opacity-70">Personal telephone</label>
          <input id="f_phone" class="inp mt-1" placeholder="e.g. 07…">
        </div>

        <div class="sm:col-span-2">
          <label class="text-xs opacity-70">Address</label>
          <textarea id="f_address" class="inp mt-1" rows="3" placeholder="House number, street, town/city, postcode"></textarea>
        </div>
      </div>

      <div class="mt-6 flex flex-wrap items-center gap-3">
        <button id="btnSaveDetails" class="btn">Submit details</button>
        <div id="detailsMsg" class="text-sm text-red-300 hidden"></div>
      </div>
    </section>

    <!-- SCREEN: DONE -->
    <section id="screenDone" class="hidden glass p-7 sm:p-10">
      <div class="inline-flex items-center gap-2 px-3 py-1.5 rounded-full border border-white/10 bg-white/5 text-xs opacity-80">
        <span class="tagDot green"></span>
        Completed
      </div>

      <h2 class="mt-5 text-2xl sm:text-3xl font-bold tracking-tight">You’re all set</h2>
      <p class="mt-2 text-sm sm:text-[15px]" style="color: var(--muted); max-width: 46rem;">
        Your onboarding details have been saved. You can now log in using your <b>work email</b>.
      </p>

      <div class="mt-6 flex flex-wrap gap-3">
        <a href="/management" class="btn inline-block">Go to login</a>
        <a href="https://smartcoretechnology.co.uk" class="rowBtn inline-block">Go to main site</a>
      </div>
    </section>

    <!-- SCREEN: ERROR -->
    <section id="screenError" class="hidden glass p-7 sm:p-10">
      <div class="inline-flex items-center gap-2 px-3 py-1.5 rounded-full border border-red-400/20 bg-red-400/10 text-xs">
        <span class="w-2.5 h-2.5 rounded-full bg-red-300"></span>
        Something went wrong
      </div>

      <h2 class="mt-5 text-2xl sm:text-3xl font-bold tracking-tight">We couldn’t open your onboarding link</h2>
      <p id="errMsg" class="mt-2 text-sm sm:text-[15px]" style="color: var(--muted); max-width: 52rem;">
        —
      </p>

      <div class="mt-6 flex flex-wrap gap-3">
        <a href="https://smartcoretechnology.co.uk" class="btn inline-block">Back to main site</a>
        <a href="mailto:support@smartcoretechnology.co.uk" class="rowBtn inline-block">Contact support</a>
      </div>
    </section>

  </main>

  <script>
    /**********************
      UTIL
    **********************/
    const $ = (id) => document.getElementById(id);

    function show(el){ el.classList.remove("hidden"); }
    function hide(el){ el.classList.add("hidden"); }

    function showScreen(id){
      ["screenLoading","screenPassword","screenDetails","screenDone","screenError"].forEach(x=>{
        const el = $(x);
        if (!el) return;
        if (x === id) show(el); else hide(el);
      });
    }

    function showErr(msg){
      showScreen("screenError");
      $("errMsg").textContent = msg || "Unknown error.";
    }

    function showInlineMsg(el, msg, ok=false){
      el.textContent = msg || "";
      el.classList.remove("hidden");
      el.classList.toggle("text-green-300", !!ok);
      el.classList.toggle("text-red-300", !ok);
    }
    function clearInlineMsg(el){
      el.textContent = "";
      el.classList.add("hidden");
      el.classList.remove("text-green-300");
      el.classList.add("text-red-300");
    }

    function parseHashParams(){
      const h = window.location.hash || "";
      if (!h.includes("access_token=")) return null;
      const raw = h.startsWith("#") ? h.slice(1) : h;
      const p = new URLSearchParams(raw);
      return {
        access_token: p.get("access_token"),
        refresh_token: p.get("refresh_token"),
        type: p.get("type")
      };
    }

    function getTokenFromQuery(){
      const u = new URL(window.location.href);
      return u.searchParams.get("token");
    }

    function safeText(v){ return String(v ?? ""); }

    /**********************
      SUPABASE
    **********************/
    const sb = window.supabase.createClient(window._SUPABASE_URL, window._SUPABASE_ANON);

    /**********************
      STATE
    **********************/
    const state = {
      token: null,
      user: null,
      employeeRow: null,
      companyName: null
    };

    /**********************
      AUTH: ensure session is set from URL hash
    **********************/
    async function ensureSessionFromHash(){
      const hp = parseHashParams();

      // If invite/verify redirected us with tokens in hash, set them
      if (hp?.access_token && hp?.refresh_token){
        const { error } = await sb.auth.setSession({
          access_token: hp.access_token,
          refresh_token: hp.refresh_token
        });
        if (error) throw new Error("This invite link is invalid or expired. Please request a new link.");
        // Clean hash tokens from URL (optional but nice)
        // (Do NOT remove query token)
        history.replaceState(null, "", window.location.pathname + window.location.search);
      }

      const { data: { session } } = await sb.auth.getSession();
      state.user = session?.user || null;
      return state.user;
    }

    /**********************
      LOAD employee row by onboarding token
      Expected columns in employees:
        id (uuid PK), company_id, full_name, personal_email, work_email, job_title,
        onboarding_token, onboarding_expires, user_id,
        title, pronouns, gender, dob, nationality, ni_number, driving_licence_number, personal_phone, address
    **********************/
    async function loadEmployeeByToken(){
      if (!state.token) throw new Error("Missing token. Please use the exact onboarding link from your email.");
      const { data, error } = await sb
        .from("employees")
        .select("id, company_id, full_name, personal_email, work_email, job_title, onboarding_token, onboarding_expires, user_id")
        .eq("onboarding_token", state.token)
        .maybeSingle();

      if (error) throw error;
      state.employeeRow = data || null;

      if (!state.employeeRow) throw new Error("Onboarding token not found. Please request a new link.");
      if (state.employeeRow.onboarding_expires){
        const exp = new Date(state.employeeRow.onboarding_expires).getTime();
        if (Number.isFinite(exp) && Date.now() > exp) throw new Error("This onboarding link has expired. Please request a new link.");
      }
    }

    async function loadCompanyName(){
      // Optional: show company name nicely if your companies table has company_name/name
      try{
        const { data } = await sb
          .from("companies")
          .select("company_name, name, legal_name, trading_name")
          .eq("id", state.employeeRow.company_id)
          .maybeSingle();
        state.companyName = data?.company_name || data?.name || data?.legal_name || data?.trading_name || null;
      }catch(_){
        state.companyName = null;
      }
    }

    /**********************
      LINK auth user to employee row (this was the missing “#4”)
    **********************/
    async function linkUserToEmployee(){
      const { data: { user }, error: userErr } = await sb.auth.getUser();
      if (userErr || !user) throw new Error("Could not read your session. Please open the invite link again.");

      // Safety: ensure invite work email matches session user email
      const empEmail = String(state.employeeRow.work_email || "").toLowerCase();
      const sesEmail = String(user.email || "").toLowerCase();
      if (empEmail && sesEmail && empEmail !== sesEmail){
        throw new Error("This invite link is for a different work email. Please use the correct invite.");
      }

      // Link + clear token so it cannot be reused
      const { error: linkErr } = await sb
        .from("employees")
        .update({
          user_id: user.id,
          onboarding_token: null,
          onboarding_expires: null
        })
        .eq("id", state.employeeRow.id);

      if (linkErr) throw linkErr;
    }

    /**********************
      PASSWORD
    **********************/
    async function savePassword(){
      clearInlineMsg($("pwMsg"));

      const a = $("pw1").value || "";
      const b = $("pw2").value || "";

      if (a.length < 8) return showInlineMsg($("pwMsg"), "Password must be at least 8 characters.");
      if (a !== b) return showInlineMsg($("pwMsg"), "Passwords do not match.");

      $("btnSavePassword").disabled = true;

      try{
        const { error } = await sb.auth.updateUser({ password: a });
        if (error) throw error;

        showInlineMsg($("pwMsg"), "Password saved. Now complete your details…", true);

        // Move to details step
        setTimeout(()=>{
          showScreen("screenDetails");
        }, 400);

      }catch(e){
        showInlineMsg($("pwMsg"), e?.message || "Failed to save password.");
      }finally{
        $("btnSavePassword").disabled = false;
      }
    }

    /**********************
      DETAILS
    **********************/
    async function saveDetails(){
      clearInlineMsg($("detailsMsg"));

      // Basic required
      const full_name = $("f_full_name").value.trim();
      const gender = $("f_gender").value.trim();
      const dob = $("f_dob").value; // YYYY-MM-DD or ""

      const nationality = $("f_nationality").value.trim();
      const personal_email = $("f_personal_email").value.trim().toLowerCase();
      const personal_phone = $("f_phone").value.trim();
      const address = $("f_address").value.trim();

      if (!full_name) return showInlineMsg($("detailsMsg"), "Please enter your full name.");
      if (!gender) return showInlineMsg($("detailsMsg"), "Please select a gender.");
      if (!dob) return showInlineMsg($("detailsMsg"), "Please enter your date of birth.");
      if (!nationality) return showInlineMsg($("detailsMsg"), "Please enter your nationality.");
      if (!personal_email) return showInlineMsg($("detailsMsg"), "Please enter your personal email.");
      if (!personal_phone) return showInlineMsg($("detailsMsg"), "Please enter your personal telephone.");
      if (!address) return showInlineMsg($("detailsMsg"), "Please enter your address.");

      const payload = {
        full_name,
        title: $("f_title").value.trim() || null,
        pronouns: $("f_pronouns").value.trim() || null,
        gender,
        dob,
        nationality,
        ni_number: $("f_ni").value.trim() || null,
        driving_licence_number: $("f_dl").value.trim() || null,
        personal_email,
        personal_phone,
        address
      };

      $("btnSaveDetails").disabled = true;

      try{
        // Must update by user_id (best) so user can’t modify someone else
        const { data: { user } } = await sb.auth.getUser();
        if (!user?.id) throw new Error("No active session. Please open the invite link again.");

        const { error } = await sb
          .from("employees")
          .update(payload)
          .eq("user_id", user.id);

        if (error) throw error;

        showScreen("screenDone");
      }catch(e){
        showInlineMsg($("detailsMsg"), e?.message || "Failed to save details.");
      }finally{
        $("btnSaveDetails").disabled = false;
      }
    }

    /**********************
      SIGN OUT
    **********************/
    async function signOut(){
      try{ await sb.auth.signOut(); }catch(_){}
      window.location.href = "https://smartcoretechnology.co.uk";
    }

    /**********************
      INIT
    **********************/
    function fillPrefill(){
      const emp = state.employeeRow || {};
      $("prefCompany").textContent = state.companyName || "—";
      $("prefWorkEmail").textContent = safeText(emp.work_email || "—");
      $("prefJobTitle").textContent = safeText(emp.job_title || "—");

      // Prefill fields (using employee record)
      $("f_full_name").value = safeText(emp.full_name || "");
      $("f_personal_email").value = safeText(emp.personal_email || "");
    }

    async function init(){
      state.token = getTokenFromQuery();

      showScreen("screenLoading");
      $("loadingMsg").textContent = "Signing you in securely…";

      try{
        const user = await ensureSessionFromHash();
        if (!user){
          showErr("No active session found. Please open the invite link again (it must include the access token).");
          return;
        }

        // Show sign out button
        show($("btnSignOut"));

        $("loadingMsg").textContent = "Validating onboarding token…";
        await loadEmployeeByToken();

        $("loadingMsg").textContent = "Linking your account…";
        await linkUserToEmployee();

        $("loadingMsg").textContent = "Loading your details…";
        await loadCompanyName();
        fillPrefill();

        // Go to password step first
        showScreen("screenPassword");

      }catch(e){
        console.error(e);
        showErr(e?.message || "Onboarding link invalid or expired.");
      }
    }

    $("btnSignOut").addEventListener("click", signOut);
    $("btnSavePassword").addEventListener("click", savePassword);
    $("btnSaveDetails").addEventListener("click", saveDetails);

    init();
  </script>

</body>
</html>
