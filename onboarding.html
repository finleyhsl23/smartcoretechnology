<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SmartCore Technology â€¢ Onboarding</title>

  <link rel="icon" type="image/png" href="SmartCore Official Logos/SC Icon - Black Background.png">
  <link rel="apple-touch-icon" href="SmartCore Official Logos/SC Icon - Black Background.png">

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

  <!-- 1) DEFINE CONFIG FIRST (BEFORE SUPABASE + BEFORE ANY OTHER JS) -->
  <script>
    // âœ… Replace the anon key if yours differs
    window.__SUPABASE_URL  = "https://hjdpcfhozhoyeqevnupm.supabase.co";
    window.__SUPABASE_ANON = "PASTE_YOUR_ANON_PUBLIC_KEY_HERE";
  </script>

  <!-- 2) THEN LOAD SUPABASE -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root{
      --bg0:#020617;
      --bg1:#06153a;
      --stroke: rgba(255,255,255,.12);
      --stroke2: rgba(255,255,255,.08);
      --text: #eaf0ff;
      --muted: rgba(234,240,255,.74);
      --accent: rgba(120,170,255,.95);
      --shadow: 0 26px 80px rgba(0,0,0,.55);
      --shadow2: 0 18px 55px rgba(0,0,0,.45);
      --r1: 22px;
      --r2: 16px;
      --blur: 16px;
    }
    html,body{height:100%}
    body{
      margin:0;
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color: var(--text);
      background:
        radial-gradient(1100px 800px at 50% 10%, rgba(70,120,255,.20), transparent 60%),
        radial-gradient(1200px 900px at 50% 60%, rgba(35,80,220,.14), transparent 62%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      overflow-x:hidden;
    }
    .wrap{max-width: 980px; margin: 0 auto; padding: 28px 16px 64px;}
    .topbar{
      margin-top: 14px;
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      padding: 14px 14px;
      border-radius: 18px;
      border:1px solid var(--stroke2);
      background: rgba(255,255,255,.045);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      box-shadow: var(--shadow2);
    }
    .brand{display:flex; align-items:center; gap:12px; min-width:0;}
    .logo{
      width:40px; height:40px; border-radius: 14px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.25);
      display:flex; align-items:center; justify-content:center;
      overflow:hidden;
      flex: 0 0 auto;
    }
    .logo img{width:28px; height:28px; object-fit:contain;}
    .brand h1{margin:0; font-size:14px; letter-spacing:-.02em;}
    .brand p{margin:0; font-size:12px; opacity:.72; line-height:1.2}
    .card{
      margin-top: 16px;
      padding: 18px;
      border-radius: var(--r1);
      border:1px solid var(--stroke);
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04));
      backdrop-filter: blur(var(--blur));
      -webkit-backdrop-filter: blur(var(--blur));
      box-shadow: var(--shadow);
    }
    .pill{
      display:inline-flex; align-items:center; gap:10px;
      padding: 8px 12px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      font-size: 12px;
      opacity: .92;
      width: fit-content;
    }
    .spin{
      width: 14px; height: 14px;
      border-radius: 999px;
      border: 2px solid rgba(255,255,255,.18);
      border-top-color: rgba(120,170,255,.95);
      animation: rot 0.9s linear infinite;
    }
    @keyframes rot{ to{ transform: rotate(360deg); } }

    .title{
      margin: 14px 0 0 0;
      font-weight: 800;
      letter-spacing: -.03em;
      line-height: 1.05;
      font-size: clamp(28px, 4vw, 40px);
    }
    .sub{margin: 10px 0 0 0; color: var(--muted); font-size: 14px; max-width: 56rem;}

    .grid{display:grid; grid-template-columns: 1fr; gap: 12px; margin-top: 16px;}
    @media (min-width: 820px){ .grid{grid-template-columns: 1fr 1fr;} }

    label{font-size: 12px; opacity:.75;}
    .inp, .ta, select{
      width:100%;
      border-radius: 14px;
      border:1px solid var(--stroke2);
      background: rgba(255,255,255,.05);
      padding: 12px 12px;
      outline:none;
      color: var(--text);
      box-sizing: border-box;
    }
    .ta{min-height: 96px; resize: vertical;}
    .inp::placeholder, .ta::placeholder{ color: rgba(234,240,255,.45); }
    .inp:focus, .ta:focus, select:focus{
      border-color: rgba(120,170,255,.35);
      box-shadow: 0 0 0 3px rgba(120,170,255,.10);
    }
    .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-top: 14px;}
    .btn{
      padding: 12px 14px;
      border-radius: 14px;
      border: 1px solid rgba(120,170,255,.35);
      background: rgba(120,170,255,.16);
      color: var(--text);
      font-weight: 600;
      cursor: pointer;
      transition: transform .12s ease, background .12s ease;
    }
    .btn:hover{ transform: translateY(-1px); background: rgba(120,170,255,.22); }
    .btn.secondary{
      border-color: rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
    }
    .btn:disabled{opacity:.55; cursor:not-allowed; transform:none;}
    .msg{margin-top: 12px; font-size: 13px;}
    .msg.err{color: rgba(255,160,160,.95);}
    .msg.ok{color: rgba(120,255,190,.95);}

    .hide{display:none !important;}
    .foot{
      margin-top: 14px;
      padding: 14px;
      border-radius: 18px;
      border:1px solid var(--stroke2);
      background: rgba(255,255,255,.04);
      display:flex; justify-content:space-between; gap:12px; flex-wrap:wrap;
      font-size: 13px;
      opacity:.8;
    }
    a{color: var(--text); opacity:.9;}
    a:hover{opacity:1;}
    code{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="logo">
          <img src="SmartCore Official Logos/SC Icon - Black Background.png" alt="SmartCore" onerror="this.style.display='none'">
        </div>
        <div style="min-width:0">
          <h1>SmartCore Technology</h1>
          <p>Onboarding</p>
        </div>
      </div>

      <button id="btnSignOut" class="btn secondary hide" type="button">Sign out</button>
    </div>

    <!-- LOADING -->
    <section id="screenLoading" class="card">
      <div class="pill"><span class="spin"></span> Please waitâ€¦</div>
      <div class="title">Preparing your onboarding</div>
      <div id="loadingMsg" class="sub">Validating your linkâ€¦</div>
      <div class="foot" style="margin-top:18px;">
        <div>SmartCore Technology</div>
        <a href="mailto:support@smartcoretechnology.co.uk">support@smartcoretechnology.co.uk</a>
      </div>
    </section>

    <!-- PASSWORD -->
    <section id="screenPassword" class="card hide">
      <div class="pill">Step 1 of 2</div>
      <div class="title">Set your password</div>
      <div class="sub">Create a secure password to activate your account.</div>

      <div class="grid">
        <div>
          <label>New password</label>
          <input id="pw1" class="inp" type="password" placeholder="Minimum 8 characters">
        </div>
        <div>
          <label>Confirm password</label>
          <input id="pw2" class="inp" type="password" placeholder="Repeat password">
        </div>
      </div>

      <div class="row">
        <button id="btnSavePassword" class="btn" type="button">Save password</button>
      </div>

      <div id="pwMsg" class="msg err hide"></div>
    </section>

    <!-- DETAILS -->
    <section id="screenDetails" class="card hide">
      <div class="pill">Step 2 of 2</div>
      <div class="title">Your details</div>
      <div class="sub">Please complete the following information. Fields marked optional can be left blank.</div>

      <div class="grid">
        <div>
          <label>Full Name</label>
          <input id="full_name" class="inp" placeholder="e.g. Jamie Smith">
        </div>

        <div>
          <label>Title (optional)</label>
          <input id="title" class="inp" placeholder="e.g. Ms / Mr / Dr">
        </div>

        <div>
          <label>Pronouns (optional)</label>
          <input id="pronouns" class="inp" placeholder="e.g. she/her, he/him, they/them">
        </div>

        <div>
          <label>Gender</label>
          <select id="gender" class="inp">
            <option value="">Selectâ€¦</option>
            <option>Female</option>
            <option>Male</option>
            <option>Non-binary</option>
            <option>Prefer not to say</option>
            <option>Other</option>
          </select>
        </div>

        <div>
          <label>Date of birth</label>
          <input id="dob" class="inp" type="date">
        </div>

        <div>
          <label>Nationality</label>
          <input id="nationality" class="inp" placeholder="e.g. British">
        </div>

        <div>
          <label>National Insurance Number (optional)</label>
          <input id="ni_number" class="inp" placeholder="e.g. QQ123456C">
        </div>

        <div>
          <label>Driving Licence Number (optional)</label>
          <input id="driving_licence_number" class="inp" placeholder="Licence number">
        </div>

        <div>
          <label>Personal email</label>
          <input id="personal_email" class="inp" type="email" placeholder="e.g. name@gmail.com">
        </div>

        <div>
          <label>Personal telephone</label>
          <input id="personal_phone" class="inp" placeholder="e.g. 07â€¦">
        </div>
      </div>

      <div style="margin-top:12px;">
        <label>Address</label>
        <textarea id="address" class="ta" placeholder="House name/number, street, town/city, postcode"></textarea>
      </div>

      <div class="row">
        <button id="btnSubmitDetails" class="btn" type="button">Submit details</button>
      </div>

      <div id="detailsMsg" class="msg err hide"></div>
    </section>

    <!-- DONE -->
    <section id="screenDone" class="card hide">
      <div class="pill">Complete</div>
      <div class="title">All set ðŸŽ‰</div>
      <div class="sub">Your onboarding has been completed. You can now close this page and sign in using your work email.</div>

      <div class="row">
        <a class="btn" href="https://smartcoretechnology.co.uk">Go to SmartCore</a>
      </div>
    </section>

    <!-- ERROR -->
    <section id="screenError" class="card hide">
      <div class="pill">Something went wrong</div>
      <div class="title">We couldnâ€™t complete onboarding</div>
      <div id="errMsg" class="sub">Error details will appear here.</div>

      <div class="row">
        <button id="btnRetry" class="btn secondary" type="button">Retry</button>
        <a class="btn secondary" href="mailto:support@smartcoretechnology.co.uk">Email support</a>
      </div>

      <div class="foot" style="margin-top:18px;">
        <div>Support: <a href="mailto:support@smartcoretechnology.co.uk">support@smartcoretechnology.co.uk</a></div>
        <div><span style="opacity:.7">Tip:</span> Invite links must include <code>#access_token=â€¦</code></div>
      </div>
    </section>
  </div>

  <script>
    /**********************
      UTIL
    **********************/
    const $ = (id) => document.getElementById(id);
    const show = (id) => $(id).classList.remove("hide");
    const hide = (id) => $(id).classList.add("hide");

    function showOnly(id){
      ["screenLoading","screenPassword","screenDetails","screenDone","screenError"].forEach(x=>{
        if (x === id) show(x); else hide(x);
      });
    }

    function setMsg(el, txt, ok=false){
      el.textContent = txt;
      el.classList.remove("hide");
      el.classList.toggle("ok", !!ok);
      el.classList.toggle("err", !ok);
    }
    function clearMsg(el){
      el.textContent = "";
      el.classList.add("hide");
      el.classList.remove("ok","err");
    }

    function parseHash(){
      // Supabase returns: #access_token=...&refresh_token=...&type=invite
      const h = window.location.hash || "";
      if (!h.startsWith("#")) return {};
      const params = new URLSearchParams(h.slice(1));
      return {
        access_token: params.get("access_token"),
        refresh_token: params.get("refresh_token"),
        type: params.get("type")
      };
    }

    function getTokenFromQuery(){
      // Our custom onboarding token: /onboarding?token=xxxx
      const u = new URL(window.location.href);
      return u.searchParams.get("token") || "";
    }

    function safeStr(x){ return String(x ?? "").trim(); }

    /**********************
      SUPABASE INIT (robust)
    **********************/
    function getSupabaseConfig(){
      const url = safeStr(window.__SUPABASE_URL);
      const anon = safeStr(window.__SUPABASE_ANON);
      return { url, anon };
    }

    function requireSupabaseConfig(){
      const { url, anon } = getSupabaseConfig();
      if (!url || !anon || anon === "PASTE_YOUR_ANON_PUBLIC_KEY_HERE"){
        throw new Error(
          "Supabase config missing on onboarding page.\n\n" +
          "Check onboarding.html has window._SUPABASE_URL and window._SUPABASE_ANON set at the top (before loading supabase-js)."
        );
      }
      if (!window.supabase?.createClient){
        throw new Error("Supabase library not loaded. Check the supabase-js script tag.");
      }
      return { url, anon };
    }

    let sb = null;
    const state = {
      user: null,
      employeeRow: null,
      onboardingToken: ""
    };

    /**********************
      AUTH + LINKING
    **********************/
    async function ensureSessionFromHash(){
      const h = parseHash();

      // If thereâ€™s no hash token, we canâ€™t authenticate the invited user.
      if (!h.access_token || !h.refresh_token) return null;

      // Create client first
      if (!sb){
        const { url, anon } = requireSupabaseConfig();
        sb = window.supabase.createClient(url, anon);
      }

      // Set session from hash tokens
      const { error } = await sb.auth.setSession({
        access_token: h.access_token,
        refresh_token: h.refresh_token
      });
      if (error) throw new Error("Invite session error: " + error.message);

      // Clear the hash tokens for security (keeps the page path + query)
      history.replaceState(null, "", window.location.pathname + window.location.search);

      // Get user
      const { data: { user }, error: uErr } = await sb.auth.getUser();
      if (uErr) throw new Error("Could not read user: " + uErr.message);
      return user || null;
    }

    async function loadEmployeeByToken(){
      state.employeeRow = null;
      const token = state.onboardingToken;
      if (!token) return null;

      // NOTE: this requires RLS that allows reading employees by onboarding_token
      // OR you can allow only select of onboarding_token row when token matches.
      const { data, error } = await sb
        .from("employees")
        .select("*")
        .eq("onboarding_token", token)
        .limit(1)
        .maybeSingle();

      if (error) throw new Error("Could not validate onboarding token: " + error.message);

      state.employeeRow = data || null;
      return state.employeeRow;
    }

    async function linkEmployeeToUser(){
      // If no token or no employee row, we cannot reliably link the employee record.
      if (!state.onboardingToken || !state.user) return false;

      // This update must be allowed by RLS when onboarding_token matches.
      const { error } = await sb
        .from("employees")
        .update({
          user_id: state.user.id,
          onboarding_token: null,
          onboarding_expires: null
        })
        .eq("onboarding_token", state.onboardingToken);

      if (error) throw new Error("Could not link employee to user: " + error.message);
      return true;
    }

    /**********************
      SCREENS
    **********************/
    async function start(){
      showOnly("screenLoading");
      $("loadingMsg").textContent = "Validating your linkâ€¦";
      clearMsg($("pwMsg"));
      clearMsg($("detailsMsg"));

      try{
        // Init client ASAP (and fail cleanly if config missing)
        const { url, anon } = requireSupabaseConfig();
        sb = window.supabase.createClient(url, anon);

        // Read onboarding token from query
        state.onboardingToken = getTokenFromQuery();

        // Ensure session from invite hash (this is REQUIRED to proceed)
        $("loadingMsg").textContent = "Signing you in securelyâ€¦";
        const user = await ensureSessionFromHash();
        if (!user){
          throw new Error("No active invite session found. Please open the invite link again (it must include #access_token=...).");
        }
        state.user = user;

        // Show sign out button now that weâ€™re authed
        $("btnSignOut").classList.remove("hide");

        // Validate onboarding token (optional but recommended)
        if (state.onboardingToken){
          $("loadingMsg").textContent = "Validating onboarding tokenâ€¦";
          await loadEmployeeByToken();

          // Prefill some fields if we found the employee row
          if (state.employeeRow){
            $("full_name").value = state.employeeRow.full_name || "";
            $("personal_email").value = state.employeeRow.personal_email || "";
          }
        }

        // Go to password screen first (invite flow wants password set)
        showOnly("screenPassword");

      }catch(e){
        showOnly("screenError");
        $("errMsg").textContent = e?.message || String(e);
      }
    }

    async function savePassword(){
      clearMsg($("pwMsg"));
      const a = $("pw1").value || "";
      const b = $("pw2").value || "";

      if (a.length < 8) return setMsg($("pwMsg"), "Password must be at least 8 characters.");
      if (a !== b) return setMsg($("pwMsg"), "Passwords do not match.");

      $("btnSavePassword").disabled = true;

      try{
        const { error } = await sb.auth.updateUser({ password: a });
        if (error) throw new Error(error.message);

        // Link employee record to this auth user (if we have a token)
        if (state.onboardingToken){
          await linkEmployeeToUser();
        }

        // Move to details screen
        showOnly("screenDetails");

      }catch(e){
        setMsg($("pwMsg"), "Failed to set password: " + (e?.message || e));
      }finally{
        $("btnSavePassword").disabled = false;
      }
    }

    async function submitDetails(){
      clearMsg($("detailsMsg"));

      // Basic required fields
      const full_name = safeStr($("full_name").value);
      const gender = safeStr($("gender").value);
      const dob = safeStr($("dob").value);
      const nationality = safeStr($("nationality").value);
      const personal_email = safeStr($("personal_email").value);
      const personal_phone = safeStr($("personal_phone").value);
      const address = safeStr($("address").value);

      if (!full_name) return setMsg($("detailsMsg"), "Full name is required.");
      if (!gender) return setMsg($("detailsMsg"), "Gender is required.");
      if (!dob) return setMsg($("detailsMsg"), "Date of birth is required.");
      if (!nationality) return setMsg($("detailsMsg"), "Nationality is required.");
      if (!personal_email) return setMsg($("detailsMsg"), "Personal email is required.");
      if (!personal_phone) return setMsg($("detailsMsg"), "Personal telephone is required.");
      if (!address) return setMsg($("detailsMsg"), "Address is required.");

      $("btnSubmitDetails").disabled = true;

      try{
        // We update the employee row by user_id (best) OR by token (fallback)
        const payload = {
          full_name,
          title: safeStr($("title").value) || null,
          pronouns: safeStr($("pronouns").value) || null,
          gender,
          dob,
          nationality,
          ni_number: safeStr($("ni_number").value) || null,
          driving_licence_number: safeStr($("driving_licence_number").value) || null,
          personal_email,
          personal_phone,
          address
        };

        let q = sb.from("employees").update(payload);

        if (state.user?.id){
          q = q.eq("user_id", state.user.id);
        } else if (state.onboardingToken){
          q = q.eq("onboarding_token", state.onboardingToken);
        } else {
          throw new Error("Unable to identify employee record to update. Please contact support.");
        }

        const { error } = await q;
        if (error) throw new Error(error.message);

        showOnly("screenDone");

      }catch(e){
        setMsg($("detailsMsg"), "Could not save details: " + (e?.message || e));
      }finally{
        $("btnSubmitDetails").disabled = false;
      }
    }

    async function signOut(){
      try{ await sb?.auth.signOut(); }catch(_){}
      window.location.href = "https://smartcoretechnology.co.uk";
    }

    /**********************
      WIRING
    **********************/
    $("btnRetry").addEventListener("click", ()=> start());
    $("btnSavePassword").addEventListener("click", ()=> savePassword());
    $("btnSubmitDetails").addEventListener("click", ()=> submitDetails());
    $("btnSignOut").addEventListener("click", ()=> signOut());

    // Start immediately
    start();
  </script>
</body>
</html>
