<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SmartCore • Onboarding</title>

  <link rel="icon" type="image/png" href="SmartCore Official Logos/SC Icon - Black Background.png">
  <link rel="apple-touch-icon" href="SmartCore Official Logos/SC Icon - Black Background.png">

  <script src="https://cdn.tailwindcss.com"></script>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root{
      --bg0:#020617;
      --bg1:#06153a;
      --stroke: rgba(255,255,255,.12);
      --stroke2: rgba(255,255,255,.08);
      --text: #eaf0ff;
      --muted: rgba(234,240,255,.74);
      --shadow: 0 26px 80px rgba(0,0,0,.55);
      --shadow2: 0 18px 55px rgba(0,0,0,.45);
      --r1: 22px;
      --r2: 16px;
      --blur: 16px;
    }
    html,body{height:100%}
    body{
      margin:0;
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color: var(--text);
      background:
        radial-gradient(1100px 800px at 50% 10%, rgba(70,120,255,.20), transparent 60%),
        radial-gradient(1200px 900px at 50% 60%, rgba(35,80,220,.14), transparent 62%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      overflow-x:hidden;
    }
    .glass{
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04));
      border:1px solid var(--stroke);
      backdrop-filter: blur(var(--blur));
      -webkit-backdrop-filter: blur(var(--blur));
      border-radius: var(--r1);
      box-shadow: var(--shadow);
    }
    .glass2{
      background: rgba(255,255,255,.045);
      border:1px solid var(--stroke2);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      border-radius: var(--r2);
      box-shadow: var(--shadow2);
    }
    .inp{
      width:100%;
      border-radius: 14px;
      border:1px solid var(--stroke2);
      background: rgba(255,255,255,.05);
      padding: 12px 12px;
      outline:none;
      color: var(--text);
    }
    .inp::placeholder{ color: rgba(234,240,255,.45); }
    .inp:focus{
      border-color: rgba(120,170,255,.35);
      box-shadow: 0 0 0 3px rgba(120,170,255,.10);
    }
    .btn{
      padding: 12px 14px;
      border-radius: 16px;
      border: 1px solid rgba(120,170,255,.35);
      background: rgba(120,170,255,.16);
      transition: background .12s ease, transform .12s ease;
      font-weight: 600;
      font-size: 14px;
    }
    .btn:hover{ background: rgba(120,170,255,.22); transform: translateY(-1px); }
    .rowBtn{
      padding: 8px 10px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.05);
      transition: background .12s ease, transform .12s ease;
      font-size: 13px;
      white-space: nowrap;
    }
    .rowBtn:hover{ background: rgba(255,255,255,.08); transform: translateY(-1px); }
  </style>

  <script>
    window.__SUPABASE_URL  = "https://hjdpcfhozhoyeqevnupm.supabase.co";
    window.__SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhqZHBjZmhvemhveWVxZXZudXBtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY5MTk3MzYsImV4cCI6MjA4MjQ5NTczNn0.BXosJO4NmEZOe73GXSGPa3z-i_4ZzF9zBAMBIf6Mkts";
  </script>
</head>

<body>
  <main class="max-w-3xl mx-auto px-4 pt-16 pb-24">
    <div class="glass p-6 sm:p-10">
      <div class="flex items-center justify-between gap-3">
        <div class="flex items-center gap-3 min-w-0">
          <div class="w-10 h-10 rounded-2xl overflow-hidden bg-black/30 border border-white/10 flex items-center justify-center shrink-0">
            <img src="SmartCore Official Logos/SC Icon - Black Background.png" alt="SmartCore" class="w-8 h-8 object-contain" onerror="this.style.display='none'"/>
          </div>
          <div class="min-w-0">
            <div class="font-semibold tracking-tight leading-tight">SmartCore <span class="opacity-70">Technology</span></div>
            <div class="text-xs opacity-70 leading-tight">Onboarding</div>
          </div>
        </div>

        <a class="rowBtn" href="https://smartcoretechnology.co.uk">Home</a>
      </div>

      <h1 class="mt-6 text-2xl sm:text-3xl font-bold tracking-tight">Complete your details</h1>
      <p class="mt-2 text-sm sm:text-[15px] opacity-80">
        This link is secure. Please set a password and complete your onboarding form.
      </p>

      <div id="msg" class="mt-4 text-sm text-red-300 hidden"></div>

      <!-- STEP: PASSWORD -->
      <section id="pwStep" class="mt-6 glass2 p-4">
        <div class="text-sm font-semibold">Step 1: Set your password</div>
        <p class="mt-1 text-sm opacity-75">Minimum 8 characters.</p>

        <div class="mt-4 grid grid-cols-1 sm:grid-cols-2 gap-3">
          <div>
            <label class="text-xs opacity-70">New password</label>
            <input id="pw1" class="inp mt-1" type="password" placeholder="Minimum 8 characters">
          </div>
          <div>
            <label class="text-xs opacity-70">Confirm password</label>
            <input id="pw2" class="inp mt-1" type="password" placeholder="Repeat password">
          </div>
        </div>

        <button id="pwSave" class="btn mt-4">Save password</button>
      </section>

      <!-- STEP: DETAILS -->
      <section id="detailsStep" class="mt-4 glass2 p-4 hidden">
        <div class="text-sm font-semibold">Step 2: Your details</div>
        <p class="mt-1 text-sm opacity-75">
          Fill in what you can. Some fields are optional.
        </p>

        <div class="mt-4 grid grid-cols-1 sm:grid-cols-2 gap-3">
          <div class="sm:col-span-2">
            <label class="text-xs opacity-70">Full name</label>
            <input id="full_name" class="inp mt-1" placeholder="e.g. Jamie Smith">
          </div>

          <div>
            <label class="text-xs opacity-70">Title (optional)</label>
            <input id="title" class="inp mt-1" placeholder="e.g. Ms / Mr / Dr">
          </div>
          <div>
            <label class="text-xs opacity-70">Pronouns (optional)</label>
            <input id="pronouns" class="inp mt-1" placeholder="e.g. she/her">
          </div>

          <div>
            <label class="text-xs opacity-70">Gender</label>
            <input id="gender" class="inp mt-1" placeholder="e.g. Female">
          </div>
          <div>
            <label class="text-xs opacity-70">DOB</label>
            <input id="dob" class="inp mt-1" type="date">
          </div>

          <div>
            <label class="text-xs opacity-70">Nationality</label>
            <input id="nationality" class="inp mt-1" placeholder="e.g. British">
          </div>
          <div>
            <label class="text-xs opacity-70">National Insurance Number (optional)</label>
            <input id="ni_number" class="inp mt-1" placeholder="e.g. QQ123456C">
          </div>

          <div>
            <label class="text-xs opacity-70">Driving Licence Number (optional)</label>
            <input id="driving_licence" class="inp mt-1" placeholder="">
          </div>
          <div>
            <label class="text-xs opacity-70">Personal email</label>
            <input id="personal_email" class="inp mt-1" type="email" placeholder="e.g. you@gmail.com">
          </div>

          <div>
            <label class="text-xs opacity-70">Personal telephone</label>
            <input id="phone" class="inp mt-1" placeholder="e.g. 07...">
          </div>
          <div class="sm:col-span-2">
            <label class="text-xs opacity-70">Address</label>
            <input id="address" class="inp mt-1" placeholder="House number, street, town, postcode">
          </div>
        </div>

        <button id="saveDetails" class="btn mt-4">Submit onboarding</button>

        <div class="mt-3 text-xs opacity-70">
          When finished, you’ll be taken back to the main site.
        </div>
      </section>
    </div>
  </main>

  <script>
    const sb = window.supabase.createClient(window.__SUPABASE_URL, window.__SUPABASE_ANON);

    const $ = (id)=>document.getElementById(id);
    function show(el){ el.classList.remove("hidden"); }
    function hide(el){ el.classList.add("hidden"); }
    function showErr(msg){
      const el = $("msg");
      el.textContent = msg;
      el.classList.remove("hidden");
      el.classList.remove("text-green-300");
      el.classList.add("text-red-300");
    }
    function showOk(msg){
      const el = $("msg");
      el.textContent = msg;
      el.classList.remove("hidden");
      el.classList.remove("text-red-300");
      el.classList.add("text-green-300");
    }

    function getOnboardingToken(){
      return new URLSearchParams(window.location.search).get("token");
    }

    function parseHashParams(){
      // Supabase invite returns: #access_token=...&refresh_token=...&type=invite
      const h = window.location.hash || "";
      if (!h.includes("access_token=")) return null;
      const p = new URLSearchParams(h.slice(1));
      return {
        access_token: p.get("access_token"),
        refresh_token: p.get("refresh_token"),
        type: p.get("type")
      };
    }

    async function setSessionFromHash(){
      const hp = parseHashParams();
      if (!hp?.access_token || !hp?.refresh_token) {
        throw new Error("This link is missing authentication tokens. Please open the email link again.");
      }
      const { error } = await sb.auth.setSession({
        access_token: hp.access_token,
        refresh_token: hp.refresh_token
      });
      if (error) throw new Error(error.message || "Could not set session from invite link.");
      // clear tokens from URL for safety (keep ?token=...)
      history.replaceState(null, "", window.location.pathname + window.location.search);
    }

    async function preloadEmployeeBasics(){
      const token = getOnboardingToken();
      if (!token) throw new Error("Missing onboarding token in the link.");

      // IMPORTANT:
      // This assumes your RLS allows the invited user (after setSession) to read their row by onboarding_token.
      // If your RLS doesn't allow it yet, we can change to a server function later.
      const { data, error } = await sb
        .from("employees")
        .select("id, full_name, personal_email")
        .eq("onboarding_token", token)
        .limit(1)
        .maybeSingle();

      if (error) throw new Error("Could not load onboarding record. " + error.message);
      if (!data) throw new Error("This onboarding link is invalid or has already been used.");

      // prefill
      $("full_name").value = data.full_name || "";
      $("personal_email").value = data.personal_email || "";

      return data;
    }

    async function savePassword(){
      const a = $("pw1").value;
      const b = $("pw2").value;

      if (!a || a.length < 8) throw new Error("Password must be at least 8 characters.");
      if (a !== b) throw new Error("Passwords do not match.");

      const { error } = await sb.auth.updateUser({ password: a });
      if (error) throw new Error(error.message || "Failed to set password.");

      showOk("Password saved. Now complete your details.");
      hide($("pwStep"));
      show($("detailsStep"));
    }

    async function submitDetails(){
      const token = getOnboardingToken();
      if (!token) throw new Error("Missing onboarding token.");

      const payload = {
        full_name: $("full_name").value.trim(),
        title: $("title").value.trim() || null,
        pronouns: $("pronouns").value.trim() || null,
        gender: $("gender").value.trim(),
        dob: $("dob").value || null,
        nationality: $("nationality").value.trim(),
        ni_number: $("ni_number").value.trim() || null,
        driving_licence: $("driving_licence").value.trim() || null,
        personal_email: $("personal_email").value.trim().toLowerCase(),
        personal_phone: $("phone").value.trim() || null,
        address: $("address").value.trim() || null,

        onboarding_completed_at: new Date().toISOString(),
        onboarding_token: null, // burn token so it can’t be reused (recommended)
      };

      if (!payload.full_name) throw new Error("Please enter your full name.");
      if (!payload.gender) throw new Error("Please enter your gender.");
      if (!payload.nationality) throw new Error("Please enter your nationality.");
      if (!payload.personal_email) throw new Error("Please enter your personal email.");

      const { error } = await sb
        .from("employees")
        .update(payload)
        .eq("onboarding_token", token);

      if (error) throw new Error("Failed to save details: " + error.message);

      showOk("Onboarding complete. Redirecting…");
      setTimeout(()=> window.location.href = "https://smartcoretechnology.co.uk", 900);
    }

    async function init(){
      try{
        // 1) set Supabase session from invite hash tokens
        await setSessionFromHash();

        // 2) load employee row using ?token=...
        await preloadEmployeeBasics();

        // 3) show password step first
        show($("pwStep"));
      }catch(e){
        showErr(e.message || String(e));
        hide($("pwStep"));
        hide($("detailsStep"));
      }
    }

    $("pwSave").addEventListener("click", async ()=>{
      try{
        $("pwSave").disabled = true;
        await savePassword();
      }catch(e){
        showErr(e.message || String(e));
      }finally{
        $("pwSave").disabled = false;
      }
    });

    $("saveDetails").addEventListener("click", async ()=>{
      try{
        $("saveDetails").disabled = true;
        await submitDetails();
      }catch(e){
        showErr(e.message || String(e));
      }finally{
        $("saveDetails").disabled = false;
      }
    });

    init();
  </script>
</body>
</html>
