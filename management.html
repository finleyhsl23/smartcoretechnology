<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SmartCore Technology</title>

  <link rel="icon" type="image/png" href="SmartCore Official Logos/SC Icon - Black Background.png">
  <link rel="apple-touch-icon" href="SmartCore Official Logos/SC Icon - Black Background.png">

  <script src="https://cdn.tailwindcss.com"></script>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root{
      --bg0:#020617;
      --bg1:#06153a;
      --stroke: rgba(255,255,255,.12);
      --stroke2: rgba(255,255,255,.08);
      --text: #eaf0ff;
      --muted: rgba(234,240,255,.74);
      --accent: rgba(120,170,255,.95);
      --shadow: 0 26px 80px rgba(0,0,0,.55);
      --shadow2: 0 18px 55px rgba(0,0,0,.45);
      --r1: 22px;
      --r2: 16px;
      --blur: 16px;
    }
    html,body{height:100%}
    body{
      margin:0;
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color: var(--text);
      background:
        radial-gradient(1100px 800px at 50% 10%, rgba(70,120,255,.20), transparent 60%),
        radial-gradient(1200px 900px at 50% 60%, rgba(35,80,220,.14), transparent 62%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      overflow-x:hidden;
    }
    .glass{
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04));
      border:1px solid var(--stroke);
      backdrop-filter: blur(var(--blur));
      -webkit-backdrop-filter: blur(var(--blur));
      border-radius: var(--r1);
      box-shadow: var(--shadow);
    }
    .glass2{
      background: rgba(255,255,255,.045);
      border:1px solid var(--stroke2);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      border-radius: var(--r2);
      box-shadow: var(--shadow2);
    }
    .inp{
      width:100%;
      border-radius: 14px;
      border:1px solid var(--stroke2);
      background: rgba(255,255,255,.05);
      padding: 12px 12px;
      outline:none;
      color: var(--text);
    }
    .inp::placeholder{ color: rgba(234,240,255,.45); }
    .inp:focus{
      border-color: rgba(120,170,255,.35);
      box-shadow: 0 0 0 3px rgba(120,170,255,.10);
    }

    .rowBtn{
      padding: 8px 10px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.05);
      transition: background .12s ease, transform .12s ease;
      font-size: 13px;
      white-space: nowrap;
    }
    .rowBtn:hover{ background: rgba(255,255,255,.08); transform: translateY(-1px); }
    .rowBtn.danger{
      border-color: rgba(255,120,120,.18);
      background: rgba(255,120,120,.08);
    }
    .rowBtn.danger:hover{ background: rgba(255,120,120,.12); }

    .tag{
      display:inline-flex; align-items:center; gap:8px;
      padding: 6px 10px; border-radius: 999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.05);
      font-size: 12px; opacity: .95;
      width: fit-content;
    }
    .tagDot{ width:8px; height:8px; border-radius:999px; background: rgba(255,255,255,.35); }
    .tagDot.green{ background: rgba(80,240,160,.9); box-shadow: 0 0 0 4px rgba(80,240,160,.12); }
    .tagDot.amber{ background: rgba(255,205,90,.95); box-shadow: 0 0 0 4px rgba(255,205,90,.12); }

    .modalBackdrop{
      position:fixed;
      inset:0;
      background: rgba(0,0,0,.62);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:50;
      padding: 18px;
    }
    .modalBackdrop.show{display:flex;}
    .modal{
      max-width: 980px;
      width: 100%;
      max-height: 86vh;
      overflow: auto;
      border-radius: 20px;
    }
    .noScroll{ overflow:hidden; }

    /* Custom dropdown */
    .ddWrap{ position: relative; }
    .ddBtn{
      width:100%;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      border-radius: 14px;
      border:1px solid var(--stroke2);
      background: rgba(255,255,255,.05);
      padding: 12px 12px;
      color: var(--text);
      cursor:pointer;
      transition: background .12s ease, transform .12s ease;
      text-align:left;
    }
    .ddBtn:hover{ background: rgba(255,255,255,.07); transform: translateY(-1px); }
    .ddMenu{
      position:absolute;
      left:0; right:0;
      top: calc(100% + 8px);
      z-index: 40;
      border-radius: 16px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(8, 12, 28, .92);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      box-shadow: 0 18px 55px rgba(0,0,0,.45);
      overflow:hidden;
      display:none;
    }
    .ddMenu.show{ display:block; }
    .ddItem{
      padding: 12px 12px;
      cursor:pointer;
      border-top: 1px solid rgba(255,255,255,.06);
      display:flex; align-items:center; justify-content:space-between;
      gap: 10px;
      font-size: 13px;
    }
    .ddItem:first-child{ border-top:0; }
    .ddItem:hover{ background: rgba(255,255,255,.06); }
    .ddTick{
      width: 10px; height: 10px; border-radius: 999px;
      background: rgba(255,255,255,.18);
    }
    .ddItem.on .ddTick{
      background: rgba(120,170,255,.95);
      box-shadow: 0 0 0 4px rgba(120,170,255,.14);
    }
    .chev{ opacity:.8; }

    .hint{ color: var(--muted); font-size: 12px; opacity:.75; }

    code{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
  </style>

  <script>
    window.__SUPABASE_URL  = "https://hjdpcfhozhoyeqevnupm.supabase.co";
    window.__SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhqZHBjZmhvemhveWVxZXZudXBtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY5MTk3MzYsImV4cCI6MjA4MjQ5NTczNn0.BXosJO4NmEZOe73GXSGPa3z-i_4ZzF9zBAMBIf6Mkts";
  </script>
</head>

<body>

  <!-- NAV (ONLY: Log In when signed out, Sign out when signed in) -->
  <header class="fixed top-4 left-0 right-0 z-40">
    <div class="max-w-6xl mx-auto px-4">
      <div class="glass2 flex items-center justify-between px-4 py-3">
        <div class="flex items-center gap-3 min-w-0">
          <div class="w-10 h-10 rounded-2xl overflow-hidden bg-black/30 border border-white/10 flex items-center justify-center shrink-0">
            <img
              src="SmartCore Official Logos/SC Icon - Black Background.png"
              alt="SmartCore"
              class="w-8 h-8 object-contain translate-y-[-1px]"
              onerror="this.style.display='none'"
            />
          </div>
          <div class="min-w-0">
            <div class="font-semibold tracking-tight leading-tight">
              SmartCore <span class="opacity-70">Technology</span>
            </div>
            <div class="text-xs opacity-70 leading-tight">Practical Technology. Built to Last.</div>
          </div>
        </div>

        <div class="flex items-center gap-2">
          <button id="navLogout" class="hidden px-3 py-2 rounded-xl border border-white/10 bg-white/5 hover:bg-white/8 text-sm">
            Sign out
          </button>
          <button id="navLogin" class="px-3 py-2 rounded-xl border border-white/10 bg-white/5 hover:bg-white/8 text-sm">
            Log In
          </button>
        </div>
      </div>
    </div>
  </header>

  <!-- HOME -->
  <main id="home" class="max-w-6xl mx-auto px-4 pt-28 pb-24">
    <div class="glass p-7 sm:p-10">
      <div class="inline-flex items-center gap-2 px-3 py-1.5 rounded-full border border-white/10 bg-white/5 text-xs opacity-80">
        <span class="w-2.5 h-2.5 rounded-full" style="background: rgba(120,170,255,.85)"></span>
        SmartCore Platform
      </div>

      <h1 class="mt-5 font-extrabold tracking-tight leading-[1.02]" style="font-size: clamp(40px, 5vw, 68px);">
        Employee
        <span style="opacity:.72">Management</span>
      </h1>

      <p class="mt-4 text-[15px] sm:text-[17px] leading-relaxed" style="color: var(--muted); max-width: 52rem;">
        Log in to manage employees and send onboarding links.
      </p>

      <div class="mt-7 flex flex-wrap items-center gap-3">
        <button id="homeLogin" class="px-4 py-3 rounded-2xl border border-[rgba(120,170,255,.35)] bg-[rgba(120,170,255,.16)] hover:bg-[rgba(120,170,255,.22)] text-sm font-medium">
          Log In
        </button>
      </div>

      <div class="mt-8 text-xs opacity-60">
        Support: <a class="underline hover:opacity-100" href="mailto:support@smartcoretechnology.co.uk">support@smartcoretechnology.co.uk</a>
      </div>
    </div>

    <footer class="mt-10 glass2 p-5 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2">
      <div class="text-sm opacity-80">SmartCore Technology</div>
      <a class="text-sm opacity-80 underline hover:opacity-100" href="mailto:support@smartcoretechnology.co.uk">
        support@smartcoretechnology.co.uk
      </a>
    </footer>
  </main>

  <!-- ADMIN PAGE -->
  <section id="adminPage" class="hidden">
    <div class="max-w-6xl mx-auto px-4 pt-28 pb-24">
      <div class="glass p-6">
        <div class="flex items-start justify-between gap-3">
          <div>
            <h2 class="text-2xl sm:text-3xl font-bold tracking-tight">Employee Management</h2>
            <p id="adminSub" class="mt-1 text-sm" style="color: var(--muted);">Loading…</p>
          </div>
          <div class="hidden sm:flex items-center gap-2">
            <span class="tag"><span class="tagDot green"></span>signed in</span>
          </div>
        </div>

        <div class="mt-5 grid grid-cols-1 lg:grid-cols-3 gap-4">
          <!-- Company selector -->
          <div class="glass2 p-4">
            <div class="text-sm font-semibold opacity-90">Company</div>
            <div class="mt-2 text-sm opacity-70">Select which company you want to manage.</div>

            <div class="mt-3">
              <label class="text-xs opacity-70">Company</label>
              <div class="mt-1">
                <select id="companySelect" class="inp"></select>
              </div>
              <div id="companyWarn" class="mt-2 text-xs text-red-300 hidden"></div>
            </div>

            <div class="mt-4 flex flex-wrap gap-2">
              <button id="refreshCompanies" class="rowBtn">Refresh</button>
              <button id="refreshEmployees" class="rowBtn">Refresh employees</button>
            </div>

            <div id="permMsg" class="mt-4 text-sm text-red-300 hidden"></div>
          </div>

          <!-- Add employee (STEP 1 only) -->
          <div class="glass2 p-4">
            <div class="text-sm font-semibold opacity-90">Add employee</div>
            <div class="mt-2 text-sm opacity-70">
              Step 1: add the basics. Step 2 (HR) will open next.
            </div>

            <div class="mt-3 space-y-3">
              <div>
                <label class="text-xs opacity-70">Full name</label>
                <input id="addName" class="inp mt-1" placeholder="e.g. Jamie Smith">
              </div>

              <div>
                <label class="text-xs opacity-70">Personal email</label>
                <input id="addPersonalEmail" class="inp mt-1" type="email" placeholder="e.g. jamie@gmail.com">
              </div>

              <div>
                <label class="text-xs opacity-70">Job title</label>
                <input id="addJobTitle" class="inp mt-1" placeholder="e.g. Fleet Coordinator">
              </div>

              <button id="openHrStepBtn" class="w-full px-4 py-3 rounded-2xl border border-[rgba(120,170,255,.35)] bg-[rgba(120,170,255,.16)] hover:bg-[rgba(120,170,255,.22)] text-sm font-medium">
                Continue (HR details)
              </button>

              <div id="addMsg" class="text-sm text-red-300 hidden"></div>
            </div>
          </div>

          <!-- Filters -->
          <div class="glass2 p-4">
            <div class="text-sm font-semibold opacity-90">View</div>
            <div class="mt-2 text-sm opacity-70">Filter employees.</div>

            <div class="mt-3 grid grid-cols-1 gap-3">
              <div>
                <label class="text-xs opacity-70">Status</label>
                <div id="ddStatusFilter"></div>
              </div>

              <div>
                <label class="text-xs opacity-70">Search</label>
                <input id="searchBox" class="inp mt-1" placeholder="Search name or email">
              </div>
            </div>

            <div class="mt-4">
              <div class="text-xs opacity-60">Status rules</div>
              <div class="mt-2 flex flex-wrap gap-2">
                <div class="tag"><span class="tagDot green"></span>active</div>
                <div class="tag"><span class="tagDot amber"></span>archived</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Employee list -->
      <div class="mt-5 glass p-5">
        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
          <div>
            <div class="text-sm font-semibold opacity-90">Employees</div>
            <div id="empCount" class="mt-1 text-sm opacity-70">0</div>
          </div>
          <div class="text-xs opacity-60">
            Archive keeps the record. Delete removes it permanently from Supabase.
          </div>
        </div>

        <div class="mt-4 overflow-x-auto">
          <table class="w-full text-left text-sm">
            <thead class="opacity-70">
              <tr>
                <th class="py-2 pr-3">Employee ID</th>
                <th class="py-2 pr-3">Name</th>
                <th class="py-2 pr-3">Work email</th>
                <th class="py-2 pr-3">Job title</th>
                <th class="py-2 pr-3">Admin</th>
                <th class="py-2 pr-3">Status</th>
                <th class="py-2 pr-3">Actions</th>
              </tr>
            </thead>
            <tbody id="empTbody" class="align-top"></tbody>
          </table>
        </div>

        <div id="empMsg" class="mt-4 text-sm text-red-300 hidden"></div>
      </div>

      <footer class="mt-10 glass2 p-5 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2">
        <div class="text-sm opacity-80">SmartCore Technology</div>
        <a class="text-sm opacity-80 underline hover:opacity-100" href="mailto:support@smartcoretechnology.co.uk">
          support@smartcoretechnology.co.uk
        </a>
      </footer>
    </div>
  </section>

  <!-- MODAL: HR STEP (STEP 2) -->
  <div id="hrModalBackdrop" class="modalBackdrop">
    <div class="modal glass p-5 sm:p-6" style="max-width: 820px;">
      <div class="flex items-start justify-between gap-3">
        <div>
          <div class="text-xl sm:text-2xl font-bold">HR details</div>
          <div class="mt-1 text-sm opacity-75">
            Step 2: HR fills these in, then we send a secure onboarding link to the employee’s <b>personal email</b>.
          </div>
        </div>
        <button id="hrClose" class="rowBtn">Close</button>
      </div>

      <div class="mt-5 grid grid-cols-1 sm:grid-cols-2 gap-3">
        <div class="sm:col-span-2">
          <div class="glass2 p-4">
            <div class="text-sm font-semibold opacity-90">Employee basics</div>
            <div class="mt-2 text-sm opacity-75">
              <div><span class="opacity-60">Name:</span> <span id="hrPreviewName" class="font-medium"></span></div>
              <div class="mt-1"><span class="opacity-60">Personal email:</span> <span id="hrPreviewPersonal" class="font-medium"></span></div>
              <div class="mt-1"><span class="opacity-60">Job title:</span> <span id="hrPreviewJob" class="font-medium"></span></div>
              <div class="mt-2 hint">Employee ID will be created automatically.</div>
            </div>
          </div>
        </div>

        <div class="sm:col-span-2">
          <label class="text-xs opacity-70">Work email</label>
          <input id="hrWorkEmail" class="inp mt-1" type="email" placeholder="e.g. jamie@company.co.uk">
        </div>

        <div>
          <label class="text-xs opacity-70">Admin?</label>
          <div id="ddHrIsAdmin" class="mt-1"></div>
        </div>

        <div>
          <label class="text-xs opacity-70">Starting role (status)</label>
          <div id="ddHrStatus" class="mt-1"></div>
        </div>

        <div>
          <label class="text-xs opacity-70">Full time / Part time</label>
          <div id="ddHrEmployment" class="mt-1"></div>
        </div>

        <div>
          <label class="text-xs opacity-70">Notice period</label>
          <input id="hrNotice" class="inp mt-1" placeholder="e.g. 1 week / 1 month / 3 months">
        </div>

        <div class="sm:col-span-2">
          <label class="text-xs opacity-70">Start date</label>
          <input id="hrStartDate" class="inp mt-1" type="date">
        </div>
      </div>

      <div id="hrMsg" class="mt-4 text-sm text-red-300 hidden"></div>

      <div class="mt-5 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
        <div class="text-xs opacity-60">
          After continuing, the employee will be asked to fill:
          Full Name, Title (optional), Pronouns (optional), Gender, DOB, Nationality, NI (optional),
          Driving Licence (optional), Personal Email, Personal Telephone, Address.
        </div>

        <button id="hrContinue" class="px-4 py-3 rounded-2xl border border-[rgba(120,170,255,.35)] bg-[rgba(120,170,255,.16)] hover:bg-[rgba(120,170,255,.22)] text-sm font-medium">
          Create employee & send onboarding link
        </button>
      </div>
    </div>
  </div>

  <!-- MODAL: After send -->
  <div id="sentModalBackdrop" class="modalBackdrop">
    <div class="modal glass p-5 sm:p-6" style="max-width: 720px;">
      <div class="flex items-start justify-between gap-3">
        <div>
          <div class="text-xl sm:text-2xl font-bold">Invite sent</div>
          <div class="mt-1 text-sm opacity-75">
            An email has been sent to the employee’s <b>personal email</b> with a secure link to complete their details and set a password.
          </div>
        </div>
        <button id="sentClose" class="rowBtn">Close</button>
      </div>

      <div class="mt-5 glass2 p-4">
        <div class="text-sm font-semibold opacity-90">Next step</div>
        <div class="mt-2 text-sm opacity-75">
          Once they complete onboarding, they can sign in using their <b>work email</b>.
        </div>
      </div>
    </div>
  </div>

  <!-- MODAL: Login -->
  <div id="loginModalBackdrop" class="modalBackdrop">
    <div class="modal glass p-5 sm:p-6" style="max-width: 680px;">
      <div class="flex items-start justify-between gap-3">
        <div>
          <div class="text-xl sm:text-2xl font-bold">Log in</div>
          <div class="mt-1 text-sm opacity-75">Use your email and password.</div>
        </div>
        <button id="liClose" class="rowBtn">Close</button>
      </div>

      <div class="mt-5 grid grid-cols-1 gap-3">
        <div>
          <label class="text-xs opacity-70">Email</label>
          <input id="liEmail" class="inp mt-1" type="email" placeholder="name@company.co.uk" />
        </div>
        <div>
          <label class="text-xs opacity-70">Password</label>
          <div class="mt-1 flex gap-2">
            <input id="liPassword" class="inp" type="password" placeholder="Your password" />
            <button id="liEye" type="button" class="rowBtn">Show</button>
          </div>
        </div>
      </div>

      <div id="liMsg" class="mt-4 text-sm text-red-300 hidden"></div>

      <div class="mt-5 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
        <button id="liLogin" class="px-4 py-3 rounded-2xl border border-[rgba(120,170,255,.35)] bg-[rgba(120,170,255,.16)] hover:bg-[rgba(120,170,255,.22)] text-sm font-medium">
          Log In
        </button>

        <div class="text-sm opacity-70">
          <div id="liWrong" class="hidden">
            <button id="liReset" class="underline hover:opacity-100">Incorrect credentials — Forgot your password?</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    /******************************************************************
      UTIL
    ******************************************************************/
    const $ = (id) => document.getElementById(id);

    function show(el){ el.classList.remove("hidden"); }
    function hide(el){ el.classList.add("hidden"); }

    function showErr(el, msg){
      el.textContent = msg;
      el.classList.remove("hidden");
      el.classList.remove("text-green-300");
      el.classList.add("text-red-300");
    }
    function showOk(el, msg){
      el.textContent = msg;
      el.classList.remove("hidden");
      el.classList.remove("text-red-300");
      el.classList.add("text-green-300");
    }
    function clearMsg(el){
      el.textContent = "";
      el.classList.add("hidden");
      el.classList.remove("text-green-300");
      el.classList.add("text-red-300");
    }
    function esc(s){
      return String(s ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function openModal(backdrop){
      backdrop.classList.add("show");
      document.body.classList.add("noScroll");
    }
    function closeModal(backdrop){
      backdrop.classList.remove("show");
      document.body.classList.remove("noScroll");
    }

    /******************************************************************
      SUPABASE INIT
    ******************************************************************/
    const sb = window.supabase.createClient(window.__SUPABASE_URL, window.__SUPABASE_ANON);

    /******************************************************************
      CUSTOM DROPDOWN
    ******************************************************************/
    function createDropdown({ mountId, value, items, onChange }){
      const mount = $(mountId);
      if (!mount) return null;

      const wrap = document.createElement("div");
      wrap.className = "ddWrap";

      const btn = document.createElement("button");
      btn.type = "button";
      btn.className = "ddBtn";
      btn.innerHTML = `
        <span class="ddLabel opacity-90"></span>
        <span class="chev">▾</span>
      `;

      const menu = document.createElement("div");
      menu.className = "ddMenu";

      const labelEl = btn.querySelector(".ddLabel");

      const api = {
        value: value,
        set(v){
          api.value = v;
          const it = items.find(x => String(x.value) === String(v)) || items[0];
          labelEl.textContent = it ? it.label : String(v);
          Array.from(menu.querySelectorAll(".ddItem")).forEach(el=>{
            el.classList.toggle("on", el.dataset.value === String(v));
          });
        },
        close(){ menu.classList.remove("show"); },
        open(){ menu.classList.add("show"); }
      };

      items.forEach(it=>{
        const item = document.createElement("div");
        item.className = "ddItem";
        item.dataset.value = String(it.value);
        item.innerHTML = `
          <div class="min-w-0">
            <div class="font-medium">${esc(it.label)}</div>
            ${it.sub ? `<div class="text-xs opacity-60 mt-0.5">${esc(it.sub)}</div>` : ""}
          </div>
          <div class="ddTick"></div>
        `;
        item.addEventListener("click", ()=>{
          api.set(it.value);
          api.close();
          onChange && onChange(it.value);
        });
        menu.appendChild(item);
      });

      btn.addEventListener("click", ()=>{
        menu.classList.toggle("show");
      });

      document.addEventListener("click", (e)=>{
        if (!wrap.contains(e.target)) api.close();
      });

      wrap.appendChild(btn);
      wrap.appendChild(menu);
      mount.innerHTML = "";
      mount.appendChild(wrap);

      api.set(api.value);
      return api;
    }

    /******************************************************************
      STATE
    ******************************************************************/
    const state = {
      session: null,
      user: null,
      profile: null,

      companies: [],
      selectedCompanyId: null,
      employees: [],

      ddStatusFilter: null,

      // HR modal dropdowns
      ddHrIsAdmin: null,
      ddHrStatus: null,
      ddHrEmployment: null,

      // Temp new employee draft (step1 -> step2)
      newEmpDraft: null
    };

    /******************************************************************
      UI helpers
    ******************************************************************/
    function showOnly(sectionId){
      ["home","adminPage"].forEach(id=>{
        const el = $(id);
        if (!el) return;
        if (id === sectionId) show(el);
        else hide(el);
      });
    }

    function setAuthedUI(authed){
      if (authed){
        hide($("navLogin"));
        show($("navLogout"));
      } else {
        show($("navLogin"));
        hide($("navLogout"));
      }
    }

    /******************************************************************
      Permissions (keep same behaviour, but DO NOT show explanatory text)
    ******************************************************************/
    function isAdminForCompany(company){
      const p = state.profile;
      if (!p) return false;

      const role = String(p.role || "").toLowerCase();
      const roleOk = ["admin","company_admin","owner"].includes(role);
      const flagOk = (p.is_admin === true) || (p.company_admin === true);
      const companyMatch = p.company_id && String(p.company_id) === String(company.id);

      if (p.company_id) return companyMatch && (roleOk || flagOk);
      return roleOk || flagOk;
    }
    function isOwnerOfCompany(company){
      return String(company.owner_user_id || "") === String(state.user?.id || "");
    }
    function canManageCompany(company){
      return isOwnerOfCompany(company) || isAdminForCompany(company);
    }

    /******************************************************************
      Session / profile
    ******************************************************************/
    async function loadSession(){
      const { data: { session } } = await sb.auth.getSession();
      state.session = session || null;
      state.user = session?.user || null;
      setAuthedUI(!!state.user);
      return state.user;
    }

    async function loadProfile(){
  state.profile = null;
  if (!state.user) return null;

  try{
    const { data, error } = await sb
      .from("user_profiles")   // ✅ CORRECT TABLE
      .select("*")
      .eq("user_id", state.user.id)
      .maybeSingle();

    if (error) throw error;

    state.profile = data || null;
    return state.profile;

  }catch(err){
    console.error("Profile load error:", err);
    state.profile = null;
    return null;
  }
}

    /******************************************************************
      Companies (show NAME not ID)
    ******************************************************************/
    function companyDisplayName(c){
      return c.company_name || c.name || c.legal_name || c.trading_name || `Company ${String(c.id).slice(0,8)}…`;
    }

    async function loadManageableCompanies(){
      clearMsg($("permMsg"));
      clearMsg($("companyWarn"));

      if (!state.user){
        showErr($("permMsg"), "You are not logged in.");
        state.companies = [];
        return [];
      }

      const ownerRes = await sb
        .from("companies")
        .select("id, owner_user_id, company_name, name, legal_name, trading_name")
        .eq("owner_user_id", state.user.id);

      if (ownerRes.error){
        showErr($("permMsg"), "Could not load companies: " + ownerRes.error.message);
        state.companies = [];
        return [];
      }

      let companies = ownerRes.data || [];

      if (state.profile?.company_id){
        const adminRes = await sb
          .from("companies")
          .select("id, owner_user_id, company_name, name, legal_name, trading_name")
          .eq("id", state.profile.company_id)
          .maybeSingle();

        if (!adminRes.error && adminRes.data){
          const exists = companies.some(c => String(c.id) === String(adminRes.data.id));
          if (!exists) companies.push(adminRes.data);
        }
      }

      companies = companies.filter(canManageCompany);
      state.companies = companies;

      const sel = $("companySelect");
      sel.innerHTML = "";

      if (!companies.length){
        sel.innerHTML = `<option value="">No accessible companies</option>`;
        showErr($("permMsg"), "No companies found for your account.");
        return [];
      }

      companies.forEach(c=>{
        const opt = document.createElement("option");
        opt.value = c.id;
        opt.textContent = companyDisplayName(c);
        sel.appendChild(opt);
      });

      if (!state.selectedCompanyId || !companies.some(c => String(c.id) === String(state.selectedCompanyId))){
        state.selectedCompanyId = companies[0].id;
      }
      sel.value = state.selectedCompanyId;

      $("adminSub").textContent = `Signed in as ${state.user.email}. Select a company to manage employees.`;
      return companies;
    }

    function getSelectedCompany(){
      return state.companies.find(c => String(c.id) === String(state.selectedCompanyId));
    }

    /******************************************************************
      Employees
      (expects at minimum: id, company_id, full_name, work_email OR email, status, is_admin, employee_code, job_title)
    ******************************************************************/
    function normalizeStatus(s){
      const v = String(s || "").toLowerCase();
      if (v === "archived") return "archived";
      return "active";
    }

    async function loadEmployees(){
      clearMsg($("empMsg"));
      const company = getSelectedCompany();
      if (!company){
        state.employees = [];
        renderEmployees();
        return [];
      }
      if (!canManageCompany(company)){
        showErr($("empMsg"), "You do not have permission to manage this company.");
        state.employees = [];
        renderEmployees();
        return [];
      }

      // Try common column names for work email: work_email preferred; fallback to email
      const { data, error } = await sb
        .from("employees")
        .select("id, company_id, full_name, email, work_email, status, is_admin, employee_code, job_title")
        .eq("company_id", company.id)
        .order("full_name", { ascending:true });

      if (error){
        showErr($("empMsg"), "Could not load employees: " + error.message);
        state.employees = [];
        renderEmployees();
        return [];
      }

      state.employees = (data || []).map(e => ({...e, status: normalizeStatus(e.status)}));
      renderEmployees();
      return state.employees;
    }

    function currentFilters(){
      return {
        status: state.ddStatusFilter?.value || "active",
        q: ($("searchBox").value || "").trim().toLowerCase()
      };
    }

    function renderEmployees(){
      const tbody = $("empTbody");
      tbody.innerHTML = "";

      const { status, q } = currentFilters();

      let rows = [...state.employees];
      if (status !== "all") rows = rows.filter(e => normalizeStatus(e.status) === status);

      if (q){
        rows = rows.filter(e =>
          String(e.full_name || "").toLowerCase().includes(q) ||
          String(e.work_email || e.email || "").toLowerCase().includes(q) ||
          String(e.employee_code || "").toLowerCase().includes(q) ||
          String(e.job_title || "").toLowerCase().includes(q)
        );
      }

      $("empCount").textContent = `${rows.length} shown`;

      if (!rows.length){
        const tr = document.createElement("tr");
        tr.innerHTML = `<td class="py-4 opacity-60" colspan="7">No employees match your filter.</td>`;
        tbody.appendChild(tr);
        return;
      }

      rows.forEach(e=>{
        const statusVal = normalizeStatus(e.status);
        const dotClass = statusVal === "archived" ? "amber" : "green";
        const adminYes = e.is_admin === true;
        const workEmail = e.work_email || e.email || "";

        const tr = document.createElement("tr");
        tr.className = "border-t border-white/10";
        tr.innerHTML = `
          <td class="py-3 pr-3"><div class="font-medium">${esc(e.employee_code || "")}</div></td>
          <td class="py-3 pr-3"><div class="font-medium">${esc(e.full_name || "(no name)")}</div></td>
          <td class="py-3 pr-3"><div class="opacity-90">${esc(workEmail)}</div></td>
          <td class="py-3 pr-3"><div class="opacity-90">${esc(e.job_title || "")}</div></td>
          <td class="py-3 pr-3"><div class="tag"><span class="tagDot ${adminYes ? "green" : "amber"}"></span>${adminYes ? "yes" : "no"}</div></td>
          <td class="py-3 pr-3"><span class="tag"><span class="tagDot ${dotClass}"></span>${esc(statusVal)}</span></td>
          <td class="py-3 pr-3">
            <div class="flex flex-wrap gap-2">
              ${statusVal === "archived"
                ? `<button class="rowBtn" data-action="unarchive" data-id="${esc(e.id)}">Unarchive</button>`
                : `<button class="rowBtn" data-action="archive" data-id="${esc(e.id)}">Archive</button>`
              }
              <button class="rowBtn danger" data-action="delete" data-id="${esc(e.id)}">Delete</button>
            </div>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    async function setEmployeeStatus(employeeId, status){
      clearMsg($("empMsg"));
      const company = getSelectedCompany();
      if (!company) return;

      const newStatus = normalizeStatus(status);

      const { error } = await sb
        .from("employees")
        .update({ status: newStatus })
        .eq("id", employeeId)
        .eq("company_id", company.id);

      if (error){
        showErr($("empMsg"), "Update failed: " + error.message);
        return;
      }
      await loadEmployees();
    }

    async function deleteEmployee(employeeId){
      clearMsg($("empMsg"));
      const company = getSelectedCompany();
      if (!company) return;

      const emp = state.employees.find(x => String(x.id) === String(employeeId));
      const label = emp ? `${emp.full_name || "Employee"} (${emp.work_email || emp.email || ""})` : "this employee";

      const ok = confirm(`Delete ${label}?\n\nThis will permanently remove the record from Supabase.`);
      if (!ok) return;

      const { error } = await sb
        .from("employees")
        .delete()
        .eq("id", employeeId)
        .eq("company_id", company.id);

      if (error){
        showErr($("empMsg"), "Delete failed: " + error.message);
        return;
      }
      await loadEmployees();
    }

    /******************************************************************
      Employee code generation
      - prefix: first 3 letters of company name
      - suffix: 9 digits
      - checks uniqueness best-effort; you should also enforce UNIQUE in DB.
    ******************************************************************/
    function companyPrefix3(companyName){
      const letters = String(companyName || "")
        .toUpperCase()
        .replace(/[^A-Z]/g, "");
      return (letters + "XXX").slice(0,3);
    }
    function randDigits(n){
      let out = "";
      for (let i=0;i<n;i++) out += String(Math.floor(Math.random()*10));
      return out;
    }
    async function generateUniqueEmployeeCode(prefix){
      for (let i=0;i<12;i++){
        const code = `${prefix}${randDigits(9)}`;
        const { data, error } = await sb
          .from("employees")
          .select("id")
          .eq("employee_code", code)
          .limit(1);

        if (error) return code; // if RLS blocks the check, rely on UNIQUE constraint
        if (!data || data.length === 0) return code;
      }
      return `${prefix}${String(Date.now()).slice(-9)}`;
    }

    /******************************************************************
      Backend call
      - This MUST be your secure Pages Function.
      - It must:
        1) validate current user can manage company
        2) create employees row + onboarding token
        3) send email to personal email with link to onboarding page:
           https://smartcoretechnology.co.uk/onboarding?token=...
           (or whatever route you use)
    ******************************************************************/
    async function apiPost(path, payload){
      const res = await fetch(path, {
        method:"POST",
        headers: { "content-type":"application/json" },
        body: JSON.stringify(payload || {})
      });
      const txt = await res.text();
      let data = null;
      try{ data = JSON.parse(txt); }catch(_){}
      if(!res.ok){
        const msg = (data && (data.error || data.message)) ? (data.error || data.message) : txt;
        throw new Error(msg || ("Request failed: " + res.status));
      }
      return data ?? {};
    }

    /******************************************************************
      Add employee flow (Step 1 -> HR Modal -> Create + Send link)
    ******************************************************************/
    function openHrStep(){
      clearMsg($("addMsg"));
      clearMsg($("hrMsg"));

      const company = getSelectedCompany();
      if (!company) return showErr($("addMsg"), "Select a company first.");

      const full_name = $("addName").value.trim();
      const personal_email = $("addPersonalEmail").value.trim().toLowerCase();
      const job_title = $("addJobTitle").value.trim();

      if (!full_name) return showErr($("addMsg"), "Enter a full name.");
      if (!personal_email) return showErr($("addMsg"), "Enter a personal email.");
      if (!job_title) return showErr($("addMsg"), "Enter a job title.");

      state.newEmpDraft = { full_name, personal_email, job_title };

      $("hrPreviewName").textContent = full_name;
      $("hrPreviewPersonal").textContent = personal_email;
      $("hrPreviewJob").textContent = job_title;

      // clear HR fields
      $("hrWorkEmail").value = "";
      $("hrNotice").value = "";
      $("hrStartDate").value = "";

      state.ddHrIsAdmin?.set("no");
      state.ddHrStatus?.set("active");
      state.ddHrEmployment?.set("Full Time");

      openModal($("hrModalBackdrop"));
    }

    async function createEmployeeAndSendOnboarding(){
      clearMsg($("hrMsg"));

      const company = getSelectedCompany();
      if (!company) return showErr($("hrMsg"), "Select a company first.");

      const draft = state.newEmpDraft;
      if (!draft?.full_name || !draft?.personal_email || !draft?.job_title){
        return showErr($("hrMsg"), "Please start again from Add employee.");
      }

      const work_email = $("hrWorkEmail").value.trim().toLowerCase();
      const is_admin = (state.ddHrIsAdmin?.value === "yes");
      const status = normalizeStatus(state.ddHrStatus?.value || "active");
      const employment_type = String(state.ddHrEmployment?.value || "").trim() || "Full Time";
      const notice_period = $("hrNotice").value.trim();
      const start_date = $("hrStartDate").value || null;

      if (!work_email) return showErr($("hrMsg"), "Enter a work email.");
      if (!employment_type) return showErr($("hrMsg"), "Select Full Time / Part Time.");
      if (!start_date) return showErr($("hrMsg"), "Select a start date.");

      $("hrContinue").disabled = true;
      $("hrContinue").classList.add("opacity-60");

      try{
        const prefix = companyPrefix3(companyDisplayName(company));
        const employee_code = await generateUniqueEmployeeCode(prefix);

        // IMPORTANT: this endpoint should do the secure parts:
        // - insert employees row (or update if already exists)
        // - generate token
        // - send email to PERSONAL email with onboarding link
        //
        // We send everything the backend needs:
        const out = await apiPost("/api/invite-employee", {
          company_id: company.id,

          // Admin step 1
          full_name: draft.full_name,
          personal_email: draft.personal_email,
          job_title: draft.job_title,

          // HR step 2
          work_email,
          is_admin,
          status,
          employment_type,
          notice_period,
          start_date,

          // ID
          employee_code,

          // where the email link should point
          onboarding_url_base: "https://smartcoretechnology.co.uk/onboarding"
        });

        // If your backend returns { ok:true } you're done.
        // If it returns something else, still treat as success if no throw.
        closeModal($("hrModalBackdrop"));
        openModal($("sentModalBackdrop"));

        // Clear step 1 inputs
        $("addName").value = "";
        $("addPersonalEmail").value = "";
        $("addJobTitle").value = "";
        state.newEmpDraft = null;

        await loadEmployees();

      }catch(e){
        showErr($("hrMsg"), "Failed: " + (e.message || e));
      }finally{
        $("hrContinue").disabled = false;
        $("hrContinue").classList.remove("opacity-60");
      }
    }

    /******************************************************************
      Login / Logout
    ******************************************************************/
    async function login(){
      clearMsg($("liMsg"));
      $("liWrong").classList.add("hidden");

      const email = $("liEmail").value.trim().toLowerCase();
      const password = $("liPassword").value;

      if(!email) return showErr($("liMsg"), "Please enter your email.");
      if(!password) return showErr($("liMsg"), "Please enter your password.");

      $("liLogin").disabled = true;
      $("liLogin").classList.add("opacity-60");

      try{
        const { error } = await sb.auth.signInWithPassword({ email, password });
        if(error){
          $("liWrong").classList.remove("hidden");
          throw new Error(error.message);
        }

        closeModal($("loginModalBackdrop"));

        await loadSession();
        await loadProfile();
        await loadManageableCompanies();
        await loadEmployees();

        showOnly("adminPage");

      }catch(e){
        showErr($("liMsg"), String(e.message || "Login failed."));
      }finally{
        $("liLogin").disabled = false;
        $("liLogin").classList.remove("opacity-60");
      }
    }

    async function resetPassword(){
      clearMsg($("liMsg"));
      const email = $("liEmail").value.trim().toLowerCase();
      if(!email) return showErr($("liMsg"), "Enter your email above, then click again.");
      try{
        const { error } = await sb.auth.resetPasswordForEmail(email, {
          redirectTo: window.location.origin + window.location.pathname
        });
        if(error) throw new Error(error.message);
        showOk($("liMsg"), "Password reset email sent. Please check your inbox.");
      }catch(e){
        showErr($("liMsg"), String(e.message || "Failed to send reset email."));
      }
    }

    async function signOut(){
      await sb.auth.signOut();
      state.session = null;
      state.user = null;
      state.profile = null;
      state.companies = [];
      state.selectedCompanyId = null;
      state.employees = [];
      setAuthedUI(false);

      // Redirect to homepage (as requested)
      window.location.href = "https://smartcoretechnology.co.uk";
    }

    /******************************************************************
      Init dropdowns
    ******************************************************************/
    function initDropdowns(){
      state.ddStatusFilter = createDropdown({
        mountId: "ddStatusFilter",
        value: "active",
        items: [
          { value:"active", label:"Active", sub:"Show active employees" },
          { value:"archived", label:"Archived", sub:"Show archived employees" },
          { value:"all", label:"All", sub:"Show everyone" }
        ],
        onChange: () => renderEmployees()
      });

      // HR modal dropdowns (custom)
      state.ddHrIsAdmin = createDropdown({
        mountId: "ddHrIsAdmin",
        value: "no",
        items: [
          { value:"no", label:"No", sub:"Standard staff account" },
          { value:"yes", label:"Yes", sub:"Company admin permissions" }
        ]
      });

      state.ddHrStatus = createDropdown({
        mountId: "ddHrStatus",
        value: "active",
        items: [
          { value:"active", label:"Active", sub:"Employee is currently active" },
          { value:"archived", label:"Archived", sub:"Keep record but hidden by default" }
        ]
      });

      state.ddHrEmployment = createDropdown({
        mountId: "ddHrEmployment",
        value: "Full Time",
        items: [
          { value:"Full Time", label:"Full Time", sub:"Standard full time contract" },
          { value:"Part Time", label:"Part Time", sub:"Reduced hours / part time" }
        ]
      });
    }

    /******************************************************************
      Wiring
    ******************************************************************/
    function wire(){
      // Home -> login
      $("homeLogin").onclick = ()=> openModal($("loginModalBackdrop"));

      // Nav
      $("navLogin").onclick = ()=> openModal($("loginModalBackdrop"));
      $("navLogout").onclick = signOut;

      // Login modal
      $("liClose").onclick = ()=> closeModal($("loginModalBackdrop"));
      $("liEye").onclick = ()=>{
        const p = $("liPassword");
        const showNow = (p.type === "password");
        p.type = showNow ? "text" : "password";
        $("liEye").textContent = showNow ? "Hide" : "Show";
      };
      $("liLogin").onclick = login;
      $("liReset").onclick = resetPassword;

      $("loginModalBackdrop").addEventListener("click", (e)=>{
        if (e.target === $("loginModalBackdrop")) closeModal($("loginModalBackdrop"));
      });

      // HR modal close
      $("hrClose").onclick = ()=> closeModal($("hrModalBackdrop"));
      $("hrModalBackdrop").addEventListener("click", (e)=>{
        if (e.target === $("hrModalBackdrop")) closeModal($("hrModalBackdrop"));
      });

      // Sent modal close
      $("sentClose").onclick = ()=> closeModal($("sentModalBackdrop"));
      $("sentModalBackdrop").addEventListener("click", (e)=>{
        if (e.target === $("sentModalBackdrop")) closeModal($("sentModalBackdrop"));
      });

      // Refresh
      $("refreshCompanies").onclick = async ()=>{
        await loadProfile();
        await loadManageableCompanies();
        await loadEmployees();
      };
      $("refreshEmployees").onclick = loadEmployees;

      $("companySelect").addEventListener("change", async ()=>{
        state.selectedCompanyId = $("companySelect").value || null;
        await loadEmployees();
      });

      $("searchBox").addEventListener("input", renderEmployees);

      // Step1 -> Step2
      $("openHrStepBtn").onclick = openHrStep;

      // Step2 -> Create + Send
      $("hrContinue").onclick = createEmployeeAndSendOnboarding;

      // employee actions
      $("empTbody").addEventListener("click", async (e)=>{
        const btn = e.target.closest("button[data-action]");
        if (!btn) return;

        const action = btn.dataset.action;
        const id = btn.dataset.id;

        if (action === "archive") await setEmployeeStatus(id, "archived");
        if (action === "unarchive") await setEmployeeStatus(id, "active");
        if (action === "delete") await deleteEmployee(id);
      });
    }

    /******************************************************************
      INIT
    ******************************************************************/
    async function init(){
      initDropdowns();
      wire();

      await loadSession();
      await loadProfile();

      if (state.user){
        await loadManageableCompanies();
        await loadEmployees();
        showOnly("adminPage");
      } else {
        showOnly("home");
      }
    }

    init().catch(err=>{
      console.error(err);
      alert("Init error: " + (err.message || err));
    });
  </script>

</body>
</html>
