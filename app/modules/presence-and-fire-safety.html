<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Presence & Fire Safety • SmartCore</title>

  <!-- Supabase JS v2 -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <link rel="stylesheet" href="/app/styles/app.css"/>
</head>

<body>
  <div class="shell" role="application" aria-label="Presence & Fire Safety">
    <div class="head">
      <div class="brand">
        <div class="dot" aria-hidden="true"></div>
        <div>
          <h1>PRESENCE & FIRE SAFETY</h1>
          <p>Staff & Visitor Fire Safety Register — SmartCore Technology</p>
        </div>
      </div>

      <div class="meta">
        <div class="block">
          <span id="dateStr">—</span>
          <b id="timeStr">—</b>
        </div>

        <div class="pill" title="Company context (from profile)">
          <span>Company:</span>
          <b id="companyName" style="font-family:var(--mono); font-size:12px;">—</b>
          <span style="opacity:.35">|</span>
          <span>Site:</span>
          <select id="siteSelect" aria-label="Select site"></select>
        </div>

        <div class="pill" title="Logged in user">
          <span>User:</span> <b id="userEmail" style="font-family:var(--mono); font-size:12px;">—</b>
          <span style="opacity:.35">|</span>
          <span>Role:</span> <b id="userRole" style="font-family:var(--mono); font-size:12px;">—</b>
          <button class="btn" id="logoutBtn" style="padding:7px 12px;">Log out</button>
        </div>
      </div>
    </div>

    <div class="tabs" role="tablist">
      <div class="tab active" data-tab="staff">Staff</div>
      <div class="tab" data-tab="visitors">Visitors</div>
      <div class="tab" data-tab="admin">Roll Call</div>
    </div>

    <div class="content">
      <!-- STAFF -->
      <div id="tab_staff">
        <div class="grid">
          <div class="panel">
            <h2>Badge Scan</h2>
            <div class="subtle">Present your QR badge to sign in or out.</div>
            <div class="hr"></div>

            <div class="video">
              <video id="video" autoplay playsinline muted></video>
            </div>

            <div class="row" style="margin-top:10px;">
              <button class="btn primary" id="startCamBtn">Enable / Restart Camera</button>
              <button class="btn" id="stopCamBtn" disabled>Stop</button>
              <span class="badge" id="camStatus">idle</span>
            </div>

            <div class="hr"></div>

            <div class="field">
              <div class="label">Manual badge code</div>
              <div class="row">
                <input class="input" id="badgeCode" placeholder="Scan or type employee code (e.g. SMT000123)" autocomplete="off"/>
                <button class="btn primary" id="badgeSubmitBtn">Submit</button>
              </div>
              <div class="subtle" style="margin-top:6px;">
                If QR scanning isn’t supported on this device, use manual entry.
              </div>
            </div>
          </div>

          <div class="panel">
            <h2>Staff Sign-In / Out</h2>
            <div class="subtle">Use name or employee code if you can’t scan in.</div>

            <div class="field">
              <div class="label">Sign in</div>
              <div class="row">
                <input class="input" id="staffInInput" placeholder="Full name or employee code" autocomplete="off"/>
                <button class="btn primary" id="staffInBtn">Sign In</button>
              </div>
            </div>

            <div class="field">
              <div class="label">Sign out</div>
              <div class="row">
                <input class="input" id="staffOutInput" placeholder="Full name or employee code" autocomplete="off"/>
                <button class="btn" id="staffOutBtn">Sign Out</button>
              </div>
            </div>

            <div class="hr"></div>

            <div class="row" style="justify-content:space-between;">
              <h2 style="margin:0;">Evacuation List</h2>
              <button class="btn" id="refreshEvacBtn">Refresh</button>
            </div>
            <div class="subtle">Enter the evacuation PIN to open roll call.</div>

            <div class="field">
              <div class="row">
                <input class="input" id="evacPinInput" type="password" inputmode="numeric" placeholder="Enter 4+ digit PIN" autocomplete="off"/>
                <button class="btn bad" id="evacEnterBtn">Enter</button>
              </div>
            </div>

            <div class="list" id="evacSummaryList">
              <div class="subtle">Locked. Enter PIN to load the evacuation roll call.</div>
            </div>
          </div>
        </div>
      </div>

      <!-- VISITORS -->
      <div id="tab_visitors" class="hide">
        <div class="grid">
          <div class="panel">
            <h2>Visitor Sign-In</h2>
            <div class="subtle">Please sign in on arrival and sign out before leaving.</div>
            <div class="hr"></div>

            <div class="field">
              <div class="label">Visitor Name</div>
              <input class="input" id="vName" autocomplete="off"/>
            </div>

            <div class="row" style="margin-top:10px;">
              <div style="flex:1;">
                <div class="label">Company</div>
                <input class="input" id="vCompany" autocomplete="off"/>
              </div>
              <div style="flex:1;">
                <div class="label">Person/Department Visiting</div>
                <input class="input" id="vVisiting" autocomplete="off"/>
              </div>
            </div>

            <div class="field">
              <div class="label">Photo (optional)</div>
              <input class="input" id="vPhoto" type="file" accept="image/*" style="border-radius:12px; padding:9px 10px;"/>
              <div class="subtle" style="margin-top:6px;">Stored securely per company.</div>
            </div>

            <div class="row" style="margin-top:10px;">
              <button class="btn primary" id="visitorSignInBtn">Sign In Visitor</button>
              <button class="btn" id="visitorClearBtn">Clear</button>
            </div>

            <div class="hr"></div>

            <h2>Visitor Sign-Out</h2>
            <div class="subtle">Select a visitor currently signed in, then sign them out.</div>
            <div class="list" id="visitorsOnsiteList"></div>
          </div>

          <div class="panel" style="display:flex; align-items:center; justify-content:center; text-align:center; padding: 28px;">
            <div>
              <h2 style="margin:0 0 8px; color:var(--text); text-transform:none;">WELCOME</h2>
              <div class="subtle" style="max-width:420px;">
                Please ensure you have signed in on arrival and signed out when leaving.
                This helps keep everyone safe in the event of an evacuation.
              </div>
              <div class="footnote" style="margin-top:18px;">
                SmartCore Technology provides records and tools — it does not guarantee legal compliance.
                Responsibility remains with the customer.
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- ROLL CALL TAB (minimal admin) -->
      <div id="tab_admin" class="hide">
        <div class="grid">
          <div class="panel">
            <h2>Who’s On Site (Live)</h2>
            <div class="subtle">Live onsite list for the selected site.</div>
            <div class="hr"></div>
            <div class="row" style="justify-content:space-between;">
              <span class="badge" id="onsiteCountBadge">0 on site</span>
              <button class="btn" id="refreshOnsiteBtn">Refresh</button>
              <button class="btn primary" id="exportPresenceBtn">Download Presence CSV</button>
            </div>
            <div class="list" id="onsiteList"></div>
          </div>

          <div class="panel">
            <h2>Evacuation Session</h2>
            <div class="subtle">
              Roll call is PIN protected and role restricted.
              If you open roll call and no session exists, one will be created using an on-site snapshot.
            </div>
            <div class="hr"></div>

            <div class="row">
              <span class="badge" id="activeSessionBadge">no active session</span>
              <button class="btn bad" id="openRollCallBtn">Open Roll Call</button>
              <button class="btn" id="exportEvacBtn" disabled>Export Roll Call CSV</button>
            </div>

            <div class="footnote">
              This page blocks access if your company has not enabled this module.
              Data isolation is enforced by Supabase RLS, not frontend filtering.
            </div>
          </div>
        </div>
      </div>

      <div class="footnote">
        Note: This system records sign-ins/outs and roll calls. It provides tools and records, not legal compliance guarantees.
      </div>
    </div>
  </div>

  <!-- Roll Call Modal -->
  <div id="evacModalBackdrop" class="modal-backdrop hide" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-label="Evacuation Roll Call">
      <div class="mhead">
        <b>Evacuation Roll Call</b>
        <div class="row" style="gap:8px;">
          <span class="badge warn" id="evacSessionBadge">—</span>
          <button class="btn" id="evacCloseModalBtn">Close</button>
        </div>
      </div>
      <div class="mbody">
        <div class="subtle" id="evacModalSub">Loading…</div>
        <div class="hr"></div>
        <div class="list" id="rollCallList"></div>
      </div>
      <div class="mfoot">
        <button class="btn" id="evacRefreshBtn">Refresh</button>
        <button class="btn primary" id="evacMarkAllBtn">Mark All Safe</button>
        <button class="btn" id="evacExportBtn">Export CSV</button>
      </div>
    </div>
  </div>

  <div class="toastwrap" id="toastwrap"></div>

  <script type="module">
    import { supabaseClient } from "/app/shared/supabase.js";
    import { getMyProfile, logout } from "/app/shared/auth.js";
    import { requireModuleAccess, isEvacRole } from "/app/shared/guard.js";
    import { $, toast, fmtDateTime, downloadCSV, sha256Hex } from "/app/shared/ui.js";

    const MODULE_KEY = "presence-and-fire-safety";

    const state = {
      sb: null,
      profile: null,
      company: null,
      siteId: null,
      sites: [],
      evacUnlocked: false,
      activeSession: null,

      // Camera scan
      scanning: false,
      stream: null,
      detector: null,
      lastScanAt: 0,
      scanCooldownMs: 1800
    };

    function startClock(){
      const tick = () => {
        const d = new Date();
        const dd = String(d.getDate()).padStart(2,"0");
        const mm = String(d.getMonth()+1).padStart(2,"0");
        const yyyy = d.getFullYear();
        const hh = String(d.getHours()).padStart(2,"0");
        const mi = String(d.getMinutes()).padStart(2,"0");
        const ss = String(d.getSeconds()).padStart(2,"0");
        const dEl = $("dateStr");
const tEl = $("timeStr");
if (dEl) dEl.textContent = `${dd}/${mm}/${yyyy}`;
if (tEl) tEl.textContent = `${hh}:${mi}:${ss}`;

      };
      tick(); setInterval(tick, 1000);
    }

    async function loadCompany(){
      const { data, error } = await state.sb
        .from("companies")
        .select("id, name")
        .eq("id", state.profile.company_id)
        .single();
      if (error) throw error;
      state.company = data;
      $("companyName").textContent = data.name;
    }

    async function loadSites(){
      const { data, error } = await state.sb
        .from("sites")
        .select("id, name, is_default")
        .eq("company_id", state.profile.company_id)
        .order("name", { ascending: true });
      if (error) throw error;

      state.sites = data || [];
      if (!state.sites.length) throw new Error("No sites configured for your company.");

      // pick default site, else first
      const def = state.sites.find(s => s.is_default) || state.sites[0];
      state.siteId = def.id;

      const sel = $("siteSelect");
      sel.innerHTML = "";
      for (const s of state.sites) {
        const opt = document.createElement("option");
        opt.value = s.id;
        opt.textContent = s.name;
        if (s.id === state.siteId) opt.selected = true;
        sel.appendChild(opt);
      }
    }

    function setTab(name){
      document.querySelectorAll(".tab").forEach(t => {
        t.classList.toggle("active", t.dataset.tab === name);
      });
      $("tab_staff").classList.toggle("hide", name !== "staff");
      $("tab_visitors").classList.toggle("hide", name !== "visitors");
      $("tab_admin").classList.toggle("hide", name !== "admin");
    }

    async function audit(action, metadata){
      try{
        await state.sb.from("audit_log").insert([{
          company_id: state.profile.company_id,
          site_id: state.siteId,
          actor_user_id: state.profile.user_id,
          action,
          metadata: metadata || {}
        }]);
      }catch(_e){}
    }

    /* -------------------------
       Staff: toggle IN/OUT by badge (employee_code)
    ------------------------- */
    async function toggleByEmployeeCode(code, method){
      const badge = String(code||"").trim();
      if(!badge){
        toast("warn","Missing code","Enter or scan an employee code.");
        return;
      }

      const now = Date.now();
      if (now - state.lastScanAt < state.scanCooldownMs) return;
      state.lastScanAt = now;

      // IMPORTANT: company_id filter ALWAYS. Also enforced by RLS.
      const { data: emp, error: eErr } = await state.sb
        .from("employees")
        .select("id, first_name, last_name, employee_code, active")
        .eq("company_id", state.profile.company_id)
        .eq("employee_code", badge)
        .maybeSingle();

      if (eErr){ toast("bad","Error", eErr.message); await audit("presence.scan.error",{badge, error:eErr.message}); return; }
      if (!emp){ toast("warn","Not found","No employee matches that code."); await audit("presence.scan.not_found",{badge}); return; }
      if (emp.active !== true){ toast("warn","Inactive","Employee is inactive."); await audit("presence.scan.inactive",{employee_id:emp.id}); return; }

      const { data: cp, error: cpErr } = await state.sb
        .from("current_presence")
        .select("state")
        .eq("company_id", state.profile.company_id)
        .eq("site_id", state.siteId)
        .eq("person_type","employee")
        .eq("employee_id", emp.id)
        .maybeSingle();

      if (cpErr){ toast("bad","Error", cpErr.message); return; }

      const dir = (cp?.state === "in") ? "out" : "in";

      const { data: ev, error: evErr } = await state.sb
        .from("presence_events")
        .insert([{
          company_id: state.profile.company_id,
          site_id: state.siteId,
          person_type: "employee",
          employee_id: emp.id,
          visitor_id: null,
          direction: dir,
          method: method || "qr",
          raw_input: badge,
          occurred_at: new Date().toISOString(),
          actor_user_id: state.profile.user_id
        }])
        .select("id, occurred_at")
        .single();

      if (evErr){ toast("bad","Error", evErr.message); return; }

      const { error: upErr } = await state.sb
        .from("current_presence")
        .upsert([{
          company_id: state.profile.company_id,
          site_id: state.siteId,
          person_type: "employee",
          employee_id: emp.id,
          visitor_id: null,
          state: dir,
          last_event_id: ev.id,
          last_changed_at: ev.occurred_at
        }], { onConflict: "company_id,site_id,person_type,employee_id,visitor_id" });

      if (upErr){ toast("bad","Error", upErr.message); return; }

      const name = \`\${emp.first_name} \${emp.last_name}\`.trim();
      toast("ok","Recorded", \`\${name} is now \${dir.toUpperCase()}.\`);
      await audit("presence.toggle.success",{employee_id:emp.id, direction:dir, method:method||"qr"});

      await refreshOnsite();
      await refreshVisitorsOnsite();
      await refreshEvacSummary();
    }

    async function resolveEmployeeByInput(input){
      const q = String(input||"").trim();
      if(!q) return null;

      // exact employee_code
      const { data: exact, error: exErr } = await state.sb
        .from("employees")
        .select("id, employee_code, first_name, last_name, active")
        .eq("company_id", state.profile.company_id)
        .eq("employee_code", q)
        .limit(2);

      if (exErr) throw exErr;
      if (exact && exact.length === 1) return exact[0];

      // name search
      const { data: hits, error: hErr } = await state.sb
        .from("employees")
        .select("id, employee_code, first_name, last_name, active")
        .eq("company_id", state.profile.company_id)
        .or(\`first_name.ilike.%\${q}%,last_name.ilike.%\${q}%\`)
        .limit(6);

      if (hErr) throw hErr;
      if (!hits || hits.length === 0) return null;

      if (hits.length > 1){
        toast("warn","Ambiguous","Multiple matches. Use employee code.");
        return null;
      }

      return hits[0];
    }

    async function recordEmployeeDirection(input, direction){
      try{
        const emp = await resolveEmployeeByInput(input);
        if(!emp){ toast("warn","Not found","No matching employee found (or ambiguous)."); return; }
        if(emp.active !== true){ toast("warn","Inactive","Employee is inactive."); return; }

        const { data: ev, error: evErr } = await state.sb
          .from("presence_events")
          .insert([{
            company_id: state.profile.company_id,
            site_id: state.siteId,
            person_type: "employee",
            employee_id: emp.id,
            visitor_id: null,
            direction,
            method: "manual",
            raw_input: String(input||"").trim(),
            occurred_at: new Date().toISOString(),
            actor_user_id: state.profile.user_id
          }])
          .select("id, occurred_at")
          .single();

        if (evErr){ toast("bad","Error", evErr.message); return; }

        const { error: upErr } = await state.sb
          .from("current_presence")
          .upsert([{
            company_id: state.profile.company_id,
            site_id: state.siteId,
            person_type: "employee",
            employee_id: emp.id,
            visitor_id: null,
            state: direction,
            last_event_id: ev.id,
            last_changed_at: ev.occurred_at
          }], { onConflict: "company_id,site_id,person_type,employee_id,visitor_id" });

        if (upErr){ toast("bad","Error", upErr.message); return; }

        toast("ok","Recorded", \`\${emp.first_name} \${emp.last_name} marked \${direction.toUpperCase()}.\`);
        await audit("presence.manual.success",{employee_id:emp.id, direction});

        await refreshOnsite();
        await refreshEvacSummary();
      }catch(e){
        toast("bad","Error", e.message || String(e));
      }
    }

    /* -------------------------
       Visitors
    ------------------------- */
    async function visitorSignIn(){
      const full_name = String($("vName").value||"").trim();
      const visitor_company = String($("vCompany").value||"").trim();
      const visiting = String($("vVisiting").value||"").trim();
      const file = $("vPhoto").files?.[0] || null;

      if(!full_name){ toast("warn","Missing","Visitor name is required."); return; }

      const { data: v, error: vErr } = await state.sb
        .from("visitors")
        .insert([{
          company_id: state.profile.company_id,
          site_id: state.siteId,
          full_name,
          visitor_company: visitor_company || null,
          visiting: visiting || null,
          photo_path: null
        }])
        .select("id, full_name")
        .single();

      if (vErr){ toast("bad","Error", vErr.message); return; }

      // Optional photo (Supabase Storage)
      if(file){
        const safeName = file.name.replace(/[^\w.\-]+/g,"_").slice(0, 80);
        const path = \`company_\${state.profile.company_id}/visitors/\${v.id}/\${Date.now()}_\${safeName}\`;

        const { error: upErr } = await state.sb.storage
          .from("smartcore")
          .upload(path, file, { upsert:true, contentType:file.type });

        if(!upErr){
          await state.sb.from("visitors").update({ photo_path:path }).eq("id", v.id);
        } else {
          toast("warn","Photo not saved","Visitor signed in, but photo upload failed.");
        }
      }

      const { data: ev, error: evErr } = await state.sb
        .from("presence_events")
        .insert([{
          company_id: state.profile.company_id,
          site_id: state.siteId,
          person_type: "visitor",
          employee_id: null,
          visitor_id: v.id,
          direction: "in",
          method: "manual",
          raw_input: full_name,
          occurred_at: new Date().toISOString(),
          actor_user_id: state.profile.user_id
        }])
        .select("id, occurred_at")
        .single();

      if (evErr){ toast("bad","Error", evErr.message); return; }

      const { error: snapErr } = await state.sb
        .from("current_presence")
        .upsert([{
          company_id: state.profile.company_id,
          site_id: state.siteId,
          person_type:"visitor",
          employee_id:null,
          visitor_id: v.id,
          state:"in",
          last_event_id: ev.id,
          last_changed_at: ev.occurred_at
        }], { onConflict:"company_id,site_id,person_type,employee_id,visitor_id" });

      if (snapErr){ toast("bad","Error", snapErr.message); return; }

      toast("ok","Signed in", \`\${full_name} is now IN.\`);
      await audit("visitor.sign_in_success",{visitor_id:v.id});

      $("vName").value = "";
      $("vCompany").value = "";
      $("vVisiting").value = "";
      $("vPhoto").value = "";

      await refreshVisitorsOnsite();
      await refreshOnsite();
      await refreshEvacSummary();
    }

    async function visitorSignOut(visitorId){
      const { data: v, error: vErr } = await state.sb
        .from("visitors")
        .select("id, full_name")
        .eq("company_id", state.profile.company_id)
        .eq("id", visitorId)
        .single();

      if (vErr){ toast("bad","Error", vErr.message); return; }

      const { data: ev, error: evErr } = await state.sb
        .from("presence_events")
        .insert([{
          company_id: state.profile.company_id,
          site_id: state.siteId,
          person_type: "visitor",
          employee_id: null,
          visitor_id: v.id,
          direction: "out",
          method: "manual",
          raw_input: v.full_name,
          occurred_at: new Date().toISOString(),
          actor_user_id: state.profile.user_id
        }])
        .select("id, occurred_at")
        .single();

      if (evErr){ toast("bad","Error", evErr.message); return; }

      const { error: snapErr } = await state.sb
        .from("current_presence")
        .upsert([{
          company_id: state.profile.company_id,
          site_id: state.siteId,
          person_type:"visitor",
          employee_id:null,
          visitor_id: v.id,
          state:"out",
          last_event_id: ev.id,
          last_changed_at: ev.occurred_at
        }], { onConflict:"company_id,site_id,person_type,employee_id,visitor_id" });

      if (snapErr){ toast("bad","Error", snapErr.message); return; }

      toast("ok","Signed out", \`\${v.full_name} is now OUT.\`);
      await audit("visitor.sign_out_success",{visitor_id:v.id});

      await refreshVisitorsOnsite();
      await refreshOnsite();
      await refreshEvacSummary();
    }

    /* -------------------------
       Live onsite list
    ------------------------- */
    async function refreshOnsite(){
      const { data, error } = await state.sb
        .from("current_presence")
        .select(\`
          person_type, employee_id, visitor_id, state, last_changed_at,
          employees:employee_id ( first_name, last_name, employee_code ),
          visitors:visitor_id ( full_name, visitor_company )
        \`)
        .eq("company_id", state.profile.company_id)
        .eq("site_id", state.siteId)
        .eq("state","in")
        .order("last_changed_at", { ascending:false });

      if (error){ toast("bad","Error", error.message); return; }

      const list = $("onsiteList");
      list.innerHTML = "";

      const items = data || [];
      $("onsiteCountBadge").textContent = \`\${items.length} on site\`;

      if(items.length === 0){
        const d = document.createElement("div");
        d.className = "subtle";
        d.textContent = "No one currently signed in.";
        list.appendChild(d);
        return;
      }

      for(const r of items){
        const item = document.createElement("div");
        item.className = "item";

        const left = document.createElement("div");
        left.className = "left";

        let name = "—";
        let meta = "—";
        if(r.person_type === "employee"){
          name = \`\${r.employees?.first_name||""} \${r.employees?.last_name||""}\`.trim() || "Employee";
          meta = \`Staff • \${r.employees?.employee_code||"—"} • IN since \${fmtDateTime(r.last_changed_at)}\`;
        } else {
          name = r.visitors?.full_name || "Visitor";
          meta = \`Visitor • \${r.visitors?.visitor_company||"—"} • IN since \${fmtDateTime(r.last_changed_at)}\`;
        }

        const b = document.createElement("b"); b.textContent = name;
        const s = document.createElement("span"); s.textContent = meta;
        left.appendChild(b); left.appendChild(s);

        const right = document.createElement("div");
        right.className = "row";
        const badge = document.createElement("span");
        badge.className = "badge ok";
        badge.textContent = "ON SITE";
        right.appendChild(badge);

        item.appendChild(left);
        item.appendChild(right);
        list.appendChild(item);
      }
    }

    async function refreshVisitorsOnsite(){
      const { data, error } = await state.sb
        .from("current_presence")
        .select(\`
          visitor_id, last_changed_at,
          visitors:visitor_id ( full_name, visitor_company )
        \`)
        .eq("company_id", state.profile.company_id)
        .eq("site_id", state.siteId)
        .eq("person_type","visitor")
        .eq("state","in")
        .order("last_changed_at",{ascending:false});

      if (error){ toast("bad","Error", error.message); return; }

      const list = $("visitorsOnsiteList");
      list.innerHTML = "";

      const items = data || [];
      if(items.length === 0){
        const d = document.createElement("div");
        d.className = "subtle";
        d.textContent = "No visitors currently signed in.";
        list.appendChild(d);
        return;
      }

      for(const r of items){
        const item = document.createElement("div");
        item.className = "item";

        const left = document.createElement("div");
        left.className = "left";

        const b = document.createElement("b"); b.textContent = r.visitors?.full_name || "Visitor";
        const s = document.createElement("span");
        s.textContent = \`\${r.visitors?.visitor_company||"—"} • IN since \${fmtDateTime(r.last_changed_at)}\`;
        left.appendChild(b); left.appendChild(s);

        const right = document.createElement("div");
        right.className = "row";

        const btn = document.createElement("button");
        btn.className = "btn";
        btn.textContent = "Sign Out";
        btn.onclick = async () => await visitorSignOut(r.visitor_id);
        right.appendChild(btn);

        item.appendChild(left);
        item.appendChild(right);
        list.appendChild(item);
      }
    }

    /* -------------------------
       Evac: PIN + session + rollcall
    ------------------------- */
    async function verifyEvacPin(pin){
      const entered = String(pin||"").trim();
      if(!entered){ toast("warn","PIN required","Enter the evacuation PIN."); return false; }

      const enteredHash = await sha256Hex(entered);

      const { data, error } = await state.sb
        .from("company_settings")
        .select("evac_pin_sha256")
        .eq("company_id", state.profile.company_id)
        .single();

      if (error){ toast("bad","Error", error.message); return false; }

      const ok = (data?.evac_pin_sha256 || "").toLowerCase() === enteredHash.toLowerCase();
      if(!ok) toast("bad","Incorrect PIN","Access denied.");
      return ok;
    }

    async function loadActiveSession(){
      const { data, error } = await state.sb
        .from("evacuation_sessions")
        .select("id, started_at, status")
        .eq("company_id", state.profile.company_id)
        .eq("site_id", state.siteId)
        .eq("status","open")
        .order("started_at",{ascending:false})
        .limit(1);

      if (error) return null;

      state.activeSession = data?.[0] || null;
      $("activeSessionBadge").textContent = state.activeSession
        ? ("active: " + state.activeSession.id.slice(0,8) + "…")
        : "no active session";

      $("exportEvacBtn").disabled = !state.activeSession;
      return state.activeSession;
    }

    async function ensureSessionAndSnapshot(){
      let ses = await loadActiveSession();
      if(ses) return ses;

      // Create session
      const { data: created, error } = await state.sb
        .from("evacuation_sessions")
        .insert([{
          company_id: state.profile.company_id,
          site_id: state.siteId,
          status:"open",
          started_at: new Date().toISOString(),
          started_by_user_id: state.profile.user_id
        }])
        .select("id, started_at, status")
        .single();

      if (error){ toast("bad","Error", error.message); return null; }

      // Snapshot current onsite
      const { data: onsite, error: oErr } = await state.sb
        .from("current_presence")
        .select(\`
          person_type, employee_id, visitor_id, state,
          employees:employee_id ( first_name, last_name, employee_code ),
          visitors:visitor_id ( full_name, visitor_company, photo_path )
        \`)
        .eq("company_id", state.profile.company_id)
        .eq("site_id", state.siteId)
        .eq("state","in");

      if (oErr){ toast("bad","Error", oErr.message); return null; }

      const entries = (onsite || []).map(r => {
        if(r.person_type === "employee"){
          const display = \`\${r.employees?.first_name||""} \${r.employees?.last_name||""}\`.trim() || "Employee";
          const meta = \`Staff • \${r.employees?.employee_code||"—"}\`;
          return {
            company_id: state.profile.company_id,
            site_id: state.siteId,
            session_id: created.id,
            person_type: "employee",
            employee_id: r.employee_id,
            visitor_id: null,
            display_name: display,
            meta,
            photo_path: null,
            accounted_for: false
          };
        }
        const display = r.visitors?.full_name || "Visitor";
        const meta = \`Visitor • \${r.visitors?.visitor_company||"—"}\`;
        return {
          company_id: state.profile.company_id,
          site_id: state.siteId,
          session_id: created.id,
          person_type: "visitor",
          employee_id: null,
          visitor_id: r.visitor_id,
          display_name: display,
          meta,
          photo_path: r.visitors?.photo_path || null,
          accounted_for: false
        };
      });

      if(entries.length){
        const { error: insErr } = await state.sb
          .from("evacuation_rollcall_entries")
          .insert(entries);
        if (insErr){ toast("bad","Error", insErr.message); return null; }
      }

      state.activeSession = created;
      $("activeSessionBadge").textContent = "active: " + created.id.slice(0,8) + "…";
      $("exportEvacBtn").disabled = false;

      await audit("evac.session.started",{session_id:created.id, count:entries.length});
      return created;
    }

    async function refreshEvacSummary(){
      const box = $("evacSummaryList");
      box.innerHTML = "";

      if(!state.evacUnlocked){
        const d = document.createElement("div");
        d.className = "subtle";
        d.textContent = "Locked. Enter PIN to load the evacuation roll call.";
        box.appendChild(d);
        return;
      }

      await loadActiveSession();

      if(!state.activeSession){
        const d = document.createElement("div");
        d.className = "subtle";
        d.textContent = "Unlocked. No active session — opening roll call will create one.";
        box.appendChild(d);
        return;
      }

      const row = document.createElement("div");
      row.className = "item";

      const left = document.createElement("div");
      left.className = "left";

      const b = document.createElement("b");
      b.textContent = "Active evacuation session";

      const s = document.createElement("span");
      s.textContent = \`\${state.activeSession.id} • started \${fmtDateTime(state.activeSession.started_at)}\`;

      left.appendChild(b);
      left.appendChild(s);

      const right = document.createElement("div");
      right.className = "row";

      const badge = document.createElement("span");
      badge.className = "badge warn";
      badge.textContent = "OPEN";

      const openBtn = document.createElement("button");
      openBtn.className = "btn bad";
      openBtn.textContent = "Open Roll Call";
      openBtn.onclick = () => openEvacModal();

      right.appendChild(badge);
      right.appendChild(openBtn);

      row.appendChild(left);
      row.appendChild(right);
      box.appendChild(row);
    }

    async function openEvacModal(){
      if(!state.evacUnlocked){
        toast("warn","Locked","Enter the PIN first.");
        return;
      }
      if(!isEvacRole(state.profile.role)){
        toast("bad","Restricted","Only Fire Marshals / Admins can manage roll call.");
        return;
      }

      const ses = await ensureSessionAndSnapshot();
      if(!ses) return;

      $("evacSessionBadge").textContent = ses.id.slice(0,8) + "…";
      $("evacModalSub").textContent = \`Session started: \${fmtDateTime(ses.started_at)}\`;
      $("evacModalBackdrop").classList.remove("hide");

      await refreshRollCall();
    }

    function closeEvacModal(){
      $("evacModalBackdrop").classList.add("hide");
    }

    async function refreshRollCall(){
      const list = $("rollCallList");
      list.innerHTML = "";

      if(!state.activeSession){
        const d = document.createElement("div");
        d.className = "subtle";
        d.textContent = "No active session.";
        list.appendChild(d);
        return;
      }

      const { data, error } = await state.sb
        .from("evacuation_rollcall_entries")
        .select("id, display_name, meta, accounted_for, accounted_at, accounted_by_name")
        .eq("company_id", state.profile.company_id)
        .eq("site_id", state.siteId)
        .eq("session_id", state.activeSession.id)
        .order("accounted_for",{ascending:true});

      if (error){ toast("bad","Error", error.message); return; }

      const entries = data || [];
      if(!entries.length){
        const d = document.createElement("div");
        d.className = "subtle";
        d.textContent = "No one was on site at the moment roll call started.";
        list.appendChild(d);
        return;
      }

      let accounted = entries.filter(e => e.accounted_for).length;

      const summary = document.createElement("div");
      summary.className = "item";
      const sL = document.createElement("div"); sL.className="left";
      const sB = document.createElement("b"); sB.textContent = \`Roll call: \${accounted} / \${entries.length} accounted\`;
      const sS = document.createElement("span"); sS.textContent = \`Session: \${state.activeSession.id}\`;
      sL.appendChild(sB); sL.appendChild(sS);
      const sR = document.createElement("div"); sR.className="row";
      const sBadge = document.createElement("span"); sBadge.className="badge warn"; sBadge.textContent="LIVE";
      sR.appendChild(sBadge);
      summary.appendChild(sL); summary.appendChild(sR);
      list.appendChild(summary);

      for(const e of entries){
        const item = document.createElement("div");
        item.className = "item";

        const left = document.createElement("div");
        left.className = "left";

        const b = document.createElement("b"); b.textContent = e.display_name;
        const s = document.createElement("span");
        const when = e.accounted_for && e.accounted_at ? \` • \${new Date(e.accounted_at).toLocaleTimeString()}\` : "";
        const by = e.accounted_for && e.accounted_by_name ? \` • \${e.accounted_by_name}\` : "";
        s.textContent = \`\${e.meta||"—"}\${when}\${by}\`;

        left.appendChild(b); left.appendChild(s);

        const right = document.createElement("div");
        right.className = "row";

        const status = document.createElement("span");
        status.className = "badge " + (e.accounted_for ? "ok" : "bad");
        status.textContent = e.accounted_for ? "SAFE" : "MISSING";
        right.appendChild(status);

        const lab = document.createElement("label");
        lab.className = "check";
        const cb = document.createElement("input");
        cb.type = "checkbox";
        cb.checked = !!e.accounted_for;
        cb.onchange = async () => await setAccounted(e.id, cb.checked);
        lab.appendChild(cb);

        const t = document.createElement("span");
        t.className = "subtle";
        t.textContent = "Accounted";
        lab.appendChild(t);

        right.appendChild(lab);

        item.appendChild(left); item.appendChild(right);
        list.appendChild(item);
      }
    }

    async function setAccounted(entryId, accounted){
      if(!isEvacRole(state.profile.role)){
        toast("bad","Restricted","Only Fire Marshals / Admins can mark roll call.");
        return;
      }

      const patch = {
        accounted_for: !!accounted,
        accounted_at: accounted ? new Date().toISOString() : null,
        accounted_by_user_id: accounted ? state.profile.user_id : null,
        accounted_by_name: accounted ? (state.profile.full_name || $("userEmail").textContent) : null
      };

      const { error } = await state.sb
        .from("evacuation_rollcall_entries")
        .update(patch)
        .eq("company_id", state.profile.company_id)
        .eq("site_id", state.siteId)
        .eq("id", entryId);

      if (error){ toast("bad","Error", error.message); return; }

      await audit("evac.entry.updated",{entry_id:entryId, accounted_for:!!accounted});
      await refreshRollCall();
      await refreshEvacSummary();
    }

    async function markAllSafe(){
      if(!state.activeSession) return;
      if(!isEvacRole(state.profile.role)){
        toast("bad","Restricted","Only Fire Marshals / Admins can mark roll call.");
        return;
      }

      const { error } = await state.sb
        .from("evacuation_rollcall_entries")
        .update({
          accounted_for:true,
          accounted_at: new Date().toISOString(),
          accounted_by_user_id: state.profile.user_id,
          accounted_by_name: state.profile.full_name || $("userEmail").textContent
        })
        .eq("company_id", state.profile.company_id)
        .eq("site_id", state.siteId)
        .eq("session_id", state.activeSession.id)
        .eq("accounted_for", false);

      if (error){ toast("bad","Error", error.message); return; }

      toast("ok","Updated","All entries marked as safe.");
      await audit("evac.mark_all_success",{session_id:state.activeSession.id});
      await refreshRollCall();
      await refreshEvacSummary();
    }

    async function exportEvacCsv(){
      if(!state.activeSession){
        toast("warn","No session","No active evacuation session.");
        return;
      }

      const { data, error } = await state.sb
        .from("evacuation_rollcall_entries")
        .select("display_name, meta, accounted_for, accounted_at, accounted_by_name")
        .eq("company_id", state.profile.company_id)
        .eq("site_id", state.siteId)
        .eq("session_id", state.activeSession.id)
        .order("display_name",{ascending:true});

      if (error){ toast("bad","Error", error.message); return; }

      const rows = (data||[]).map(r => ({
        display_name: r.display_name,
        meta: r.meta || "",
        accounted_for: r.accounted_for ? "YES" : "NO",
        accounted_at: r.accounted_at || "",
        accounted_by: r.accounted_by_name || ""
      }));

      const start = new Date(state.activeSession.started_at).toISOString().slice(0,19).replace(/[:T]/g,"-");
      downloadCSV(`evac_rollcall_${start}.csv`, rows);
    }

    async function exportPresenceCsv(){
      const to = new Date();
      const from = new Date(to.getTime() - 24*60*60*1000); // last 24h default

      const { data, error } = await state.sb
        .from("presence_events")
        .select(\`
          occurred_at, person_type, direction, method, raw_input,
          employees:employee_id ( employee_code, first_name, last_name ),
          visitors:visitor_id ( full_name, visitor_company )
        \`)
        .eq("company_id", state.profile.company_id)
        .eq("site_id", state.siteId)
        .gte("occurred_at", from.toISOString())
        .lte("occurred_at", to.toISOString())
        .order("occurred_at", { ascending:true });

      if (error){ toast("bad","Error", error.message); return; }

      const rows = (data||[]).map(r => {
        let name = "";
        let ident = "";
        if(r.person_type === "employee"){
          name = `${r.employees?.first_name||""} ${r.employees?.last_name||""}`.trim();
          ident = r.employees?.employee_code || "";
        } else {
          name = r.visitors?.full_name || "";
          ident = r.visitors?.visitor_company || "";
        }
        return {
          occurred_at: r.occurred_at,
          person_type: r.person_type,
          name,
          identifier: ident,
          direction: r.direction,
          method: r.method,
          raw_input: r.raw_input || ""
        };
      });

      downloadCSV(`presence_last_24h.csv`, rows);
    }

    /* -------------------------
       Camera scan (BarcodeDetector QR)
    ------------------------- */
    async function startCamera(){
      if(state.scanning) return;
      if(!navigator.mediaDevices?.getUserMedia){
        toast("bad","Unsupported","Camera not available.");
        return;
      }

      try{
        const stream = await navigator.mediaDevices.getUserMedia({ video:{ facingMode:"environment" }, audio:false });
        state.stream = stream;
        $("video").srcObject = stream;

        if("BarcodeDetector" in window){
          try{ state.detector = new BarcodeDetector({ formats:["qr_code"] }); }catch{ state.detector = null; }
        } else state.detector = null;

        state.scanning = true;
        $("startCamBtn").disabled = true;
        $("stopCamBtn").disabled = false;
        $("camStatus").textContent = state.detector ? "scanning" : "camera on";

        if(state.detector) scanLoop();
        else toast("warn","Manual mode","QR detection not supported. Use manual badge code.");
      }catch(e){
        toast("bad","Camera error", e.message || String(e));
      }
    }

    async function stopCamera(){
      state.scanning = false;
      $("startCamBtn").disabled = false;
      $("stopCamBtn").disabled = true;
      $("camStatus").textContent = "idle";

      $("video").srcObject = null;

      if(state.stream){
        for(const t of state.stream.getTracks()){
          try{ t.stop(); }catch{}
        }
      }
      state.stream = null;
    }

    async function scanLoop(){
      while(state.scanning && state.detector){
        try{
          const v = $("video");
          if(v.readyState >= 2){
            const codes = await state.detector.detect(v);
            if(codes?.length){
              const raw = codes[0].rawValue;
              if(raw) await toggleByEmployeeCode(raw, "qr");
            }
          }
        }catch{}
        await new Promise(r => setTimeout(r, 160));
      }
    }

    function wireUI(){
      document.querySelectorAll(".tab").forEach(t => {
        t.addEventListener("click", () => setTab(t.dataset.tab));
      });

      $("logoutBtn").onclick = () => logout();

      $("siteSelect").onchange = async (e) => {
        state.siteId = e.target.value;
        state.evacUnlocked = false;
        state.activeSession = null;
        $("activeSessionBadge").textContent = "no active session";
        $("exportEvacBtn").disabled = true;
        await audit("site.changed",{site_id:state.siteId});
        await fullRefresh();
      };

      $("startCamBtn").onclick = startCamera;
      $("stopCamBtn").onclick = stopCamera;

      $("badgeSubmitBtn").onclick = () => toggleByEmployeeCode($("badgeCode").value, "manual");
      $("badgeCode").addEventListener("keydown", (e) => { if(e.key==="Enter") $("badgeSubmitBtn").click(); });

      $("staffInBtn").onclick = () => recordEmployeeDirection($("staffInInput").value, "in");
      $("staffOutBtn").onclick = () => recordEmployeeDirection($("staffOutInput").value, "out");

      $("visitorSignInBtn").onclick = visitorSignIn;
      $("visitorClearBtn").onclick = () => {
        $("vName").value=""; $("vCompany").value=""; $("vVisiting").value=""; $("vPhoto").value="";
      };

      $("refreshOnsiteBtn").onclick = refreshOnsite;

      $("refreshEvacBtn").onclick = async () => {
        if(!state.evacUnlocked){ toast("warn","Locked","Enter PIN to refresh roll call."); return; }
        await loadActiveSession();
        await refreshEvacSummary();
      };

      $("evacEnterBtn").onclick = async () => {
        if(!isEvacRole(state.profile.role)){
          toast("bad","Restricted","Only Fire Marshals / Admins can open evacuation roll call.");
          return;
        }
        const ok = await verifyEvacPin($("evacPinInput").value);
        if(!ok) return;
        state.evacUnlocked = true;
        toast("ok","Unlocked","Evacuation list unlocked.");
        await audit("evac.unlocked",{});
        await refreshEvacSummary();
        await openEvacModal();
      };
      $("evacPinInput").addEventListener("keydown", (e)=>{ if(e.key==="Enter") $("evacEnterBtn").click(); });

      $("openRollCallBtn").onclick = openEvacModal;
      $("exportEvacBtn").onclick = exportEvacCsv;

      $("evacCloseModalBtn").onclick = closeEvacModal;
      $("evacRefreshBtn").onclick = async () => { await loadActiveSession(); await refreshRollCall(); };
      $("evacMarkAllBtn").onclick = markAllSafe;
      $("evacExportBtn").onclick = exportEvacCsv;

      $("exportPresenceBtn").onclick = exportPresenceCsv;

      window.addEventListener("beforeunload", () => { try{ stopCamera(); }catch{} });
    }

    async function fullRefresh(){
      await refreshVisitorsOnsite();
      await refreshOnsite();
      await loadActiveSession();
      await refreshEvacSummary();
    }

    async function init(){
      startClock();
      state.sb = supabaseClient();

      try{
        // Module access enforced BEFORE doing anything else.
        state.profile = await requireModuleAccess(MODULE_KEY);

        $("userEmail").textContent = (await state.sb.auth.getUser()).data?.user?.email || "—";
        $("userRole").textContent = state.profile.role;

        await loadCompany();
        await loadSites();

        wireUI();
        await audit("module.opened",{module:MODULE_KEY});
        await fullRefresh();

        toast("ok","Ready","Presence & Fire Safety loaded.");
      }catch(e){
        if(String(e.message||"") === "MODULE_NOT_ENABLED"){
          document.body.innerHTML = `
            <div class="shell" style="padding:18px;">
              <div class="panel">
                <h2>Module not enabled</h2>
                <div class="subtle">Your company has not enabled <b>${MODULE_KEY}</b>. Please contact SmartCore support.</div>
                <div class="hr"></div>
                <button class="btn" onclick="window.location.href='/app/dashboard.html'">Back to dashboard</button>
              </div>
            </div>`;
          return;
        }

        toast("bad","Cannot load", e.message || String(e));
        console.error(e);
      }
    }

    init();
  </script>
</body>
</html>
